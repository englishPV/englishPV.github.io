<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Flashcards 9:16</title>
  <style>
    :root {
      --bg: #0b1020;
      --surface: #12172b;
      --card: #161c33;
      --muted: #8aa0d3;
      --text: #e6ecff;
      --primary: #6366f1;
      --primary-600: #5457e6;
      --green: #22c55e;
      --blue: #3b82f6;
      --amber: #f59e0b;
      --red: #ef4444;
      --ring: #e5e7eb;
      --border: #232a48;

      /* Variables globales UI (tailles, arrondis) */
      --fs-term: 20px;
      /* Front (recto) - un peu plus grand qu'avant */
      --fs-def: 24px;
      /* Back (verso) */
      --fs-front-list: 16px;
      /* Liste cartes: front */
      --fs-back-list: 18px;
      /* Liste cartes: back */
      --radius-md: 14px;
      /* Arrondi par défaut */
    }

    :root[data-theme="light"] {
      --bg: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
      --surface: #ffffff;
      --card: #ffffff;
      --text: #0f172a;
      /* Texte principal foncé */
      --muted: #475569;
      /* Texte secondaire lisible */
      --primary: #3b82f6;
      --primary-600: #2563eb;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
      /* jamais de scroll vertical global */
    }

    .wrapper {
      height: 100dvh;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .phone {
      aspect-ratio: 9/16;
      height: 100%;
      width: auto;
      max-width: 100%;
      max-height: 100%;
      display: grid;
      grid-template-rows: var(--row-top, 52px) var(--row-main, 1fr) var(--row-actions, 52px) var(--row-rev, 64px);
      /* top, main, actions, revision */
      background: transparent;
      /* fusion avec le fond */
      border-radius: 0;
      border: none;
      box-shadow: none;
      overflow: hidden;
      /* empêche tout scroll interne */
      position: relative;
      min-height: 0;
      /* pour les enfants flex */
      touch-action: pan-y;
      /* évite les overscroll */
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      padding: 0 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0));
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .topbar .back {
      appearance: none;
      border: 0;
      outline: 0;
      background: transparent;
      color: var(--text);
      padding: 8px 10px;
      margin-right: 4px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 700;
    }

    .topbar .back:hover {
      background: rgba(255, 255, 255, 0.06)
    }

    .topbar .title {
      font-weight: 800;
      font-size: 16px;
      letter-spacing: .2px;
      margin-left: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topbar .spacer {
      flex: 1
    }

    main#view {
      min-height: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      /* pas de scroll global pendant la révision */
      padding: 8px;
      gap: 10px;
      justify-content: flex-start;
      /* pour tout tenir d'un coup d'oeil */
    }

    /* Cards (conteneurs UI) */
    .card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.10)), var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25), inset 0 0 0 1px rgba(255, 255, 255, 0.04);
    }

    .section-title {
      font-weight: 800;
      font-size: 13px;
      color: #c9d4ff;
      letter-spacing: .3px;
      margin: 0 0 6px 0;
    }

    .kpi {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .kpi .k {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
    }

    .k .label {
      color: var(--muted);
      font-size: 11px
    }

    .k .value {
      font-weight: 900;
      font-size: 16px;
      margin-top: 2px
    }

    /* Deck list (pagination pour rester sans scroll) */
    .deck-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .navbtn {
      appearance: none;
      border: 1px solid var(--border);
      outline: 0;
      background: rgba(255, 255, 255, 0.04);
      color: #e8edff;
      padding: 8px 10px;
      border-radius: 10px;
      font-weight: 800;
      cursor: pointer;
      min-width: 44px;
    }

    .navbtn:disabled {
      opacity: .4;
      cursor: not-allowed
    }

    .decks {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      flex: 1;
    }

    .deck-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.12));
      cursor: pointer;
    }

    .deck-item:hover {
      outline: 1px solid rgba(255, 255, 255, 0.08)
    }

    .deck-meta {
      color: var(--muted);
      font-size: 12px
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: #dbe4ff;
      cursor: pointer;
      user-select: none;
    }

    .chip.toggle {
      opacity: .75
    }

    .chip.toggle.active {
      opacity: 1;
      border-color: #6b7cff;
      box-shadow: inset 0 0 0 1px rgba(107, 124, 255, .35)
    }

    .legend {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      margin-top: 6px
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 12px;
      color: #dbe4ff;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%
    }

    .dot.red {
      background: var(--red)
    }

    .dot.amber {
      background: var(--amber)
    }

    .dot.blue {
      background: var(--blue)
    }

    .dot.green {
      background: var(--green)
    }

    /* Diagramme */
    .chart-wrap {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px
    }

    canvas#gradeChart {
      width: 180px;
      height: 180px
    }

    /* Filtres */
    .filters {
      display: grid;
      gap: 8px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px
    }

    .presets {
      display: flex;
      flex-wrap: wrap;
      gap: 6px
    }

    /* Bottom actions (Cartes / Paramètres) */
    .bottom-actions {
      display: none;
      padding: 8px 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.04));
      gap: 8px;
      grid-template-columns: 1fr 1fr;
    }

    .bottom-actions .action {
      appearance: none;
      border: 1px solid var(--border);
      outline: 0;
      background: rgba(255, 255, 255, 0.04);
      color: #e8edff;
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      font-weight: 800;
      cursor: pointer;
      font-size: 14px;
    }

    .bottom-actions .action:hover {
      border-color: rgba(255, 255, 255, 0.12)
    }

    /* Revision sticky bar */
    .revision-bar {
      padding: 8px 10px calc(8px + env(safe-area-inset-bottom));
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15)), rgba(10, 15, 35, 0.7);
      backdrop-filter: blur(8px) saturate(140%);
      display: none;
    }

    .rev-btn {
      appearance: none;
      border: 0;
      outline: 0;
      width: 100%;
      background: linear-gradient(180deg, var(--primary), var(--primary-600));
      color: white;
      padding: 12px 14px;
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: .3px;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(99, 102, 241, 0.35);
      font-size: 14px;
    }

    .rev-btn[disabled] {
      opacity: .5;
      cursor: not-allowed;
      box-shadow: none
    }

    .review-actions-bar {
      display: none;
      /* masquée par défaut */
      grid-row: 4;
      /* même rangée que .revision-bar */
      padding: 8px 10px calc(8px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15)), rgba(10, 15, 35, 0.0);
      backdrop-filter: blur(8px) saturate(140%);
    }

    .review-actions-bar .btn {
      width: 100%;
      min-height: 44px
    }

    .review-actions-bar .row-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      width: 100%
    }

    /* Review view */
    .review-wrap {
      position: relative;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      padding-bottom: 0;
      /* pas d’espace réservé: on colle tout en bas */
    }

    .review-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--muted);
      font-size: 12px;
    }

    .review-card {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      border-radius: 14px;
      border: 1px dashed var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.10));
      text-align: center;
      cursor: ns-resize;
      /* Indice visuel: curseur redimension sur desktop */
    }

    /* Petite bulle de feedback (optionnel) */
    .size-toast {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(64px + env(safe-area-inset-bottom) + 8px);
      background: rgba(0, 0, 0, .55);
      color: #fff;
      font-weight: 800;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      pointer-events: none;
      z-index: 3;
    }

    :root[data-theme="light"] .size-toast {
      background: rgba(0, 0, 0, .15);
      color: #0f172a;
    }

    /* ANCIENNES ACTIONS DE REVIEW SUPPRIMÉES
    .review-actions {
      position: absolute; ...
    }
    */

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      outline: 0;
      background: rgba(255, 255, 255, 0.04);
      color: #e8edff;
      padding: 10px;
      border-radius: 12px;
      font-weight: 900;
      cursor: pointer;
      width: 100%;
      font-size: 14px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px
    }

    .btn.red {
      background: rgba(239, 68, 68, .12);
      border-color: rgba(239, 68, 68, .35);
      color: #fecaca
    }

    .btn.amber {
      background: rgba(245, 158, 11, .12);
      border-color: rgba(245, 158, 11, .35);
      color: #fde68a
    }

    .btn.blue {
      background: rgba(59, 130, 246, .12);
      border-color: rgba(59, 130, 246, .35);
      color: #bfdbfe
    }

    .btn.green {
      background: rgba(34, 197, 94, .12);
      border-color: rgba(34, 197, 94, .35);
      color: #bbf7d0
    }

    /* Cards view (sans scroll, pagination) */
    .cards-wrap {
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 100%
    }

    .cards-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--muted);
      font-size: 12px
    }

    .viewer {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.03);
      padding: 12px;
      text-align: center;
    }

    .viewer .front {
      font-weight: 900;
      font-size: 20px
    }

    .viewer .back {
      color: #d9e6ff;
      opacity: .95;
      font-size: 15px;
      margin-top: 6px
    }

    .viewer-actions {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6px
    }

    .small {
      font-size: 12px;
      color: var(--muted)
    }

    /* Recap */
    .recap {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .recap h2 {
      margin: 0;
      font-size: 18px
    }

    .recap .subtitle {
      color: var(--muted);
      margin-top: -2px;
      font-size: 12px
    }

    .recap .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px
    }

    .stat {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px
    }

    .label {
      color: var(--muted);
      font-size: 11px
    }

    .val {
      font-weight: 900;
      font-size: 16px;
      margin-top: 2px
    }

    .cta {
      margin-top: 4px
    }

    /* Helpers */
    .muted {
      color: var(--muted)
    }

    .hidden {
      display: none !important
    }

    .center {
      text-align: center
    }

    .mt6 {
      margin-top: 6px
    }

    .mt8 {
      margin-top: 8px
    }

    .scroll-y {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .face-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .3px
    }

    .flexcol {
      display: flex;
      flex-direction: column;
      min-height: 0
    }

    .row-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      width: 100%
    }

    /* Texte Q/R */
    .term {
      font-size: var(--fs-term) !important;
      font-weight: 600
    }

    .definition {
      font-size: var(--fs-def) !important;
      font-weight: 900
    }

    /* Liste des cartes (vue Cartes) */
    .card-item .front {
      font-size: var(--fs-front-list);
      font-weight: 600
    }

    .card-item .back {
      font-size: var(--fs-back-list);
      font-weight: 800;
      color: var(--text);
      opacity: .95
    }

    /* Arrondis pilotés par variable */
    .card,
    .deck-item,
    .review-card,
    .btn,
    .chip,
    .action,
    .viewer,
    .card-item {
      border-radius: var(--radius-md) !important;
    }

    .legend-item {
      cursor: pointer;
      user-select: none;
      transition: opacity .15s ease, filter .15s ease
    }

    .legend-item.inactive {
      opacity: .45;
      filter: grayscale(20%)
    }

    /* Assure la lisibilité en thème clair */
    :root[data-theme="light"] .definition,
    :root[data-theme="light"] .card-item .back {
      color: var(--text) !important;
      opacity: 1 !important;
    }

    :root[data-theme="light"] .muted {
      color: var(--muted) !important;
    }

    :root[data-theme="light"] .review-card {
      border-color: var(--border) !important;
      background: #ffffff !important;
    }

    :root[data-theme="light"] .btn,
    :root[data-theme="light"] .chip {
      color: var(--text) !important;
    }

    /* Wheel (contrôle de taille) */
    .wheel {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: rgba(255, 255, 255, 0.04);
      touch-action: none;
      user-select: none;
      cursor: ns-resize;
    }

    .wheel .name {
      font-weight: 800
    }

    .wheel .hint {
      color: var(--muted);
      font-size: 12px
    }

    .wheel .wheel-value {
      margin-left: auto;
      font-weight: 900
    }

    .dot.gray {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #9ca3af
    }

    @media (pointer: fine) and (min-width: 1024px) {
      .phone {
        aspect-ratio: auto;
        /* lève la contrainte 9:16 sur desktop */
        width: 100%;
        height: 100dvh;
      }

      .topbar,
      main#view,
      .bottom-actions,
      .revision-bar {
        max-width: 1200px;
        /* largeur confortable sur PC */
        margin: 0 auto;
        width: 100%;
      }

      main#view {
        padding: 16px 20px;
      }
    }
    
    .chip-pie {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      /* Le dégradé conique qui crée l'effet camembert */
      background: conic-gradient(
        var(--primary) var(--progress, 0%), 
        var(--border) var(--progress, 0%)
      );
      display: inline-block;
      vertical-align: middle; /* Pour bien l'aligner avec les autres carrés */
    }
  
    /* --- Flat UI Override --- */

    /* Flat mode: aucun fond/bordure/ombre sur les conteneurs */
    .card,
    .deck-item,
    .review-card,
    .viewer,
    .card-item,
    .legend-item,
    .kpi .k,
    .stat,
    .chip {
      background: transparent !important;
      border: 0 !important;
      box-shadow: none !important;
    }

    /* Supprimer l’outline au survol des items de Deck */
    .deck-item:hover {
      outline: none !important
    }

    /* Garder un peu d’air, sans boîte */
    .deck-item,
    .card-item {
      padding: 8px 0 !important;
      /* zone cliquable confortable */
    }

    /* Légende totalement “plate” */
    .legend-item {
      padding: 0 !important;
    }

    /* Les “chips” deviennent de simples libellés */
    .chip {
      padding: 0 !important;
      border-radius: 0 !important;
      color: var(--muted) !important;
    }

    /* Les KPI/statistiques sans tuiles */
    .kpi .k,
    .stat {
      padding: 0 !important;
    }

    /* Le viewer (liste cartes) sans encadré */
    .viewer {
      border: 0 !important;
    }

    /* Topbar plate (pas de trait ni de gradient) */
    .topbar {
      background: transparent !important;
      border-bottom: 0 !important;
    }

    /* Barres du bas totalement plates aussi */
    .bottom-actions,
    .revision-bar {
      background: transparent !important;
      border-top: 0 !important;
      box-shadow: none !important;
    }

    /* La zone centrale de révision est totalement plate */
    .review-card {
      border: 0 !important;
      background: transparent !important;
    }

    /* Thème clair: garantir lisibilité (textes bien visibles) */
    :root[data-theme="light"] .definition,
    :root[data-theme="light"] .card-item .back {
      color: var(--text) !important;
      opacity: 1 !important;
    }

    :root[data-theme="light"] .muted {
      color: var(--muted) !important;
    }
    
    /* Optionnel: densifier la liste Deck */
    #deckList .list {
      gap: 6px !important
    }

    /* au lieu de 8px */
    .deck-item>div .deck-meta {
      margin-top: 2px
    }

    /* resserre “description” */
    .section-title {
      margin-bottom: 4px !important
    }

  
/* ========== SETTINGS (Paramètres) ========== */
.settings-page {
  display: flex;
  flex-direction: column;
  gap: 14px;
  padding: 6px 4px
}

.settings-hero {
  font-weight: 900;
  font-size: 18px;
  letter-spacing: .2px;
  color: var(--text);
}

.settings-sub {
  color: var(--muted);
  font-size: 12px;
  margin-top: -2px
}

.settings-section {
  display: flex;
  flex-direction: column;
  gap: 8px
}

.settings-section .section-title {
  font-size: 12px;
  font-weight: 900;
  color: var(--primary);
  letter-spacing: .4px;
  text-transform: uppercase;
  margin: 10px 0 2px 0 !important;
}

/* Palette d'accent en pastilles */
.swatches {
  display: flex;
  gap: 8px;
  flex-wrap: wrap
}

.swatch {
  width: 26px;
  height: 26px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--sw, #6366f1);
  cursor: pointer;
  position: relative;
}

.swatch.is-active::after {
  content: '';
  position: absolute;
  inset: -3px;
  border: 2px solid var(--primary);
  border-radius: 10px;
}

/* Wheels affinés en paramètres */
.wheel {
  background: rgba(255, 255, 255, 0.04);
  border: 1px solid var(--border)
}

.wheel .name {
  font-size: 13px
}

.wheel .wheel-value {
  font-size: 13px
}

/* Boutons paramètres plus lisibles */
.settings-page .btn {
  font-size: 13px;
  font-weight: 800
}

/* Bar chart 7 jours */
.bar7-wrap {
  margin-top: 8px
}

canvas#bar7 {
  width: 100%;
  height: 68px;
  display: block
}

/* Preview: curseur resize et petite bulle de taille (optionnel) */
#typoPreview {
  cursor: ns-resize;
  position: relative
}

.size-toast {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 6px;
  background: rgba(0, 0, 0, .55);
  color: #fff;
  font-weight: 800;
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  pointer-events: none;
  z-index: 3;
  display: none;
}

:root[data-theme="light"] .size-toast {
  background: rgba(0, 0, 0, .15);
  color: #0f172a;
}

/* Un peu plus de couleur pour la hiérarchie */
.settings-hero {
  color: var(--primary)
}

.settings-section .section-title {
  color: var(--primary)
}

.bar7-wrap {
  margin-top: 8px
}

canvas#bar7 {
  width: 100%;
  height: 68px;
  display: block
}

.bar7-labels {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  margin-top: 4px;
  font-size: 11px;
  color: var(--muted);
  text-align: center;
}

.legend-item .count {
  font-weight: 900
}

.legend-item[data-key="unseen"] .count {
  color: #9ca3af
}

.legend-item[data-key="echec"] .count {
  color: var(--red)
}

.legend-item[data-key="difficile"] .count {
  color: var(--amber)
}

.legend-item[data-key="bien"] .count {
  color: var(--blue)
}

.legend-item[data-key="facile"] .count {
  color: var(--green)
}

/* Activité 7 jours: labels sous chaque barre */
.bar7-wrap {
  margin-top: 8px
}

canvas#bar7 {
  width: 100%;
  height: 68px;
  display: block
}

.bar7-labels {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 6px;
  margin-top: 4px;
  font-size: 11px;
  color: var(--muted);
  text-align: center;
}

/* Cartes en blocs (vue Cartes) */
.cards-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px
}

@media (min-width:480px) {
  .cards-grid {
    grid-template-columns: 1fr 1fr
  }
}

@media (min-width:900px) {
  .cards-grid {
    grid-template-columns: 1fr 1fr 1fr
  }
}

.card-block {
  position: relative;
  border: 2px solid transparent;
  border-radius: 14px;
  padding: 14px;
  background: transparent;
}

.card-block .term {
  text-align: center
}

.card-block .definition {
  display: none;
  text-align: center;
  margin-top: 6px
}

.card-block.flipped .definition {
  display: block
}

/* Temps (sans label) en bas du bloc */
.cb-time {
  position: absolute;
  right: 10px;
  bottom: 8px;
  font-size: 12px;
  color: var(--muted);
}

/* Bordures colorées selon la note */
.card-block.grade-echec {
  border-color: var(--red)
}

.card-block.grade-difficile {
  border-color: var(--amber)
}

.card-block.grade-bien {
  border-color: var(--blue)
}

.card-block.grade-facile {
  border-color: var(--green)
}

.card-block.grade-unseen {
  border-color: #9ca3af
}

/* gris pour Non vu */

/* Légende: chiffres colorés (plus lisible/“joli”) */
.legend-item .count {
  font-weight: 900
}

.legend-item[data-key="unseen"] .count {
  color: #9ca3af
}

.legend-item[data-key="echec"] .count {
  color: var(--red)
}

.legend-item[data-key="difficile"] .count {
  color: var(--amber)
}

.legend-item[data-key="bien"] .count {
  color: var(--blue)
}

.legend-item[data-key="facile"] .count {
  color: var(--green)
}

/* Thème clair: renfort de contrastes (boutons, puces, légendes) */
:root[data-theme="light"] .btn {
  background: #f1f5f9;
  border-color: #cbd5e1;
  color: #0f172a;
}

:root[data-theme="light"] .chip {
  color: #334155;
  border-color: #cbd5e1;
  background: #f8fafc;
}

:root[data-theme="light"] .legend-item {
  color: #0f172a;
  border-color: #e2e8f0;
  background: transparent;
}

:root[data-theme="light"] .muted {
  color: #475569 !important
}

/* ========== CORRECTIONS CONTRASTE & POLICES ========== */

/* --- Contrastes mode Clair --- */
:root[data-theme="light"] {
  --bg: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
  --surface: #ffffff;
  --card: #ffffff;
  --text: #0f172a;
  /* texte principal foncé */
  --muted: #475569;
  /* texte secondaire lisible */
  --primary: #3b82f6;
  --primary-600: #2563eb;
  --border: #cbd5e1;
  /* bordure plus contrastée */
}

/* Boutons d’action du bas (Cartes / Paramètres) en clair: fond visible, texte sombre */
:root[data-theme="light"] .bottom-actions .action {
  background: #f1f5f9 !important;
  border-color: #cbd5e1 !important;
  color: #0f172a !important;
}

:root[data-theme="light"] .bottom-actions .action:hover {
  background: #e2e8f0 !important;
  border-color: #94a3b8 !important;
}

/* Boutons génériques (dont Paramètres en page de stats) */
:root[data-theme="light"] .btn {
  background: #f1f5f9 !important;
  border-color: #cbd5e1 !important;
  color: #0f172a !important;
}

:root[data-theme="light"] .btn.red {
  color: #b91c1c !important
}

:root[data-theme="light"] .btn.amber {
  color: #a16207 !important
}

:root[data-theme="light"] .btn.blue {
  color: #1d4ed8 !important
}

:root[data-theme="light"] .btn.green {
  color: #166534 !important
}

/* Chips et légendes plus lisibles */
:root[data-theme="light"] .chip {
  color: #334155 !important;
  border-color: #cbd5e1 !important;
  background: #f8fafc !important;
}

:root[data-theme="light"] .legend-item {
  color: #0f172a !important;
  border-color: #e2e8f0 !important;
  background: transparent !important;
}

:root[data-theme="light"] .muted {
  color: #475569 !important
}

/* Barres bas (révision) et topbar plates mais lisibles */
:root[data-theme="light"] .revision-bar {
  background: linear-gradient(180deg, rgba(248, 250, 252, 0), rgba(241, 245, 249, 0.9)) !important;
  border-top: 1px solid #e2e8f0 !important;
}

:root[data-theme="light"] .topbar {
  background: transparent !important;
  border-bottom: 1px solid #e2e8f0 !important;
}


/* --- Polices globalement un peu plus grandes --- */
/* Base +1 (léger) */
body {
  font-size: 17px;
}

/* Renforcer lisibilité des petits textes */
.section-title {
  font-size: 14px !important
}

.deck-meta {
  font-size: 13px !important
}

.legend-item {
  font-size: 13px !important
}

.k .label {
  font-size: 12px !important
}

.k .value {
  font-size: 17px !important
}

.review-top {
  font-size: 13px !important
}

.small {
  font-size: 13px !important
}

/* Boutons un peu plus gros aussi */
.btn {
  font-size: 15px !important
}

.bottom-actions .action {
  font-size: 15px !important
}

/* Labels sous le bar-chart (activité 7j) */
.bar7-labels {
  font-size: 12px !important
}

/* Cartes (vue Cartes) – si tu utilises la grille “card-block” */
.card-block .term {
  font-size: calc(var(--fs-term) + 0px) !important
}

.card-block .definition {
  font-size: calc(var(--fs-def) + 0px) !important
}


/* Réglage direct des tailles en révision */
.review-card .term,
.review-card .definition {
  cursor: ns-resize;
  /* indique qu’on peut glisser ↑↓ pour changer la taille */
}
</style>
</head>
<body>
  <div class="wrapper">
    <div class="phone" id="app">
      <header class="topbar">
        <button class="back" id="backBtn" title="Retour"> <span aria-hidden="true">←</span> <span>Retour</span> </button>
        <div class="title" id="title">Deck</div>
        <div class="spacer"></div>
      </header>

      <main id="view"></main>

      <div class="bottom-actions" id="bottomActions">
        <button class="action" id="cardsBtn">Cartes</button>
        <button class="action" id="settingsBtn">Paramètres</button>
      </div>

      <footer class="revision-bar" id="revisionBar">
        <button id="startReviewBtn" class="rev-btn">Révision • 10 cartes</button>
      </footer>

      <footer id="reviewActionsBar" class="review-actions-bar" aria-live="polite"></footer>
    </div>
  </div>
  <script>
    // ------------------ Données & stockage ------------------
    const STORAGE_KEY = 'flash9x16_data_v3';

    // === ZONE DE COLLAGE DES DONNÉES BRUTES ===
    // Catégories (constantes)
    const CD = "Democracy",
      CG = "Genetics",
      CI = "Immigration",
      CIT = "International Relations",
      CU = "Labor",
      CR = "Crime",
      PC = "Capital Punishment", // ou "Death Penalty"
      CF = "Status of Women";     // ou "Women's Issues"// AJOUT : Constante pour le nouveau chapitre

    // Emoji par chapitre (optionnel pour l’affichage)
    const CHAPTER_EMOJIS = {
      [CD]: '🏛️',
      [CG]: '🧬',
      [CI]: '🧳',
      [CIT]: '🌐',
      [CU]: '💼',
      [CR]: '⚖️',
      [PC]: '💀',
      [CF]: '♀️', // AJOUT : Emoji pour le nouveau chapitre
      'Politique': '🏛️',
      'Business': '💼',
      'Education': '🎓',
      'Thanksgiving': '🦃'
    };

    // Collez ici votre longue liste (id|français|anglais|${CHAP})
    const cardsRawText = `
0|monarchie|monarchy|${CD}
1|monarque de droit divin|a monarch by divine right|${CD}
2|souverain|sovereign|${CD}
3|aristocratie|aristocracy|${CD}
4|oligarchie|oligarchy|${CD}
5|dictateur|a dictator|${CD}
6|dictature|dictatorship|${CD}
7|autoritaire|authoritarian|${CD}
8|autoritarisme|authoritarianism|${CD}
9|totalitaire|totalitarian|${CD}
10|totalitarisme|totalitarianism|${CD}
11|homme fort|a strongman|${CD}
12|tyran|a tyrant, an autocrat|${CD}
13|despote|a despot|${CD}
14|despote éclairé|an enlightened despot|${CD}
15|junte militaire|a military junta|${CD}
16|coup d'État|a coup, a coup d'état|${CD}
17|gouvernement autoritaire|a regime|${CD}
18|régime de Vichy / de Pinochet|the Vichy / Pinochet regime|${CD}
19|régime répressif|a repressive regime|${CD}
20|régime politique|a political system|${CD}
21|se démocratiser|to become more democratic|${CD}
22|prendre le pouvoir|to take, seize power|${CD}
23|arriver au pouvoir|to come to power|${CD}
24|arriver au pouvoir (démocratiquement)|to come into office|${CD}
25|être au pouvoir|to be in power|${CD}
26|rester au pouvoir|to remain, stay in power|${CD}
27|s'accrocher au pouvoir|to cling to power|${CD}
28|bonne gouvernance|good governance|${CD}
29|mal administrer, mal gérer|to misrule, mismanage|${CD}
30|mauvaise administration|misrule|${CD}
31|mauvaise gestion|mismanagement|${CD}
32|tenir un dirigeant pour responsable|to hold a leader to account|${CD}
33|être responsable devant les électeurs|to be accountable to the electorate|${CD}
34|responsabilité|accountability|${CD}
35|corruption|corruption, sleaze, bribery|${CD}
36|corrompu|corrupt|${CD}
37|pot-de-vin|a bribe|${CD}
38|acheter, soudoyer qn|to bribe sb|${CD}
39|état de droit, règne de la loi|the rule of law|${CD}
40|multipartisme|multi-party system|${CD}
41|système de parti unique|single-party system|${CD}
42|élections libres et régulières|free and fair elections|${CD}
43|fraude électorale|vote rigging, ballot rigging, electoral fraud|${CD}
44|l'élection était truquée|the election was rigged|${CD}
45|opposant politique|a political opponent|${CD}
46|dissident|a dissident|${CD}
47|bâillonner / museler la presse / l'opposition|to gag / muzzle the press / the opposition|${CD}
48|déclarer l'état d'urgence|to declare a state of emergency|${CD}
49|bafouer la constitution|to trample the constitution|${CD}
50|censurer|to censor|${CD}
51|censure|censorship|${CD}
52|bloquer / restreindre l'accès à internet|to block / restrict internet access|${CD}
53|contourner la censure|to circumvent, bypass censorship|${CD}
54|droits de l'homme|human rights|${CD}
55|atteintes aux droits de l'homme|human rights abuses, violations|${CD}
56|crime contre l'humanité|a crime against humanity|${CD}
57|devoir d'ingérence|the duty to interfere, to intervene|${CD}
58|association de défense des droits de l'homme|human Rights lobby|${CD}
59|passé de la Chine en matière de droits de l'homme|China's human rights record|${CD}
60|mécontentement, malaise|discontent|${CD}
61|provoquer des troubles|to spark unrest|${CD}
62|agitation|turmoil|${CD}
63|bouleversement|an upheaval|${CD}
64|fomenter des troubles|to stir up trouble|${CD}
65|insurgé|an insurgent|${CD}
66|insurrection|an insurgency|${CD}
67|manifestation|a demonstration, a protest march|${CD}
68|manifestant|a demonstrator, a protester|${CD}
69|organiser / participer à un rassemblement|to hold / attend a rally|${CD}
70|émeute|a riot|${CD}
71|émeutier, casseur|a rioter|${CD}
72|des émeutes ont éclaté|riots broke out|${CD}
73|CRS|anti-riot police|${CD}
74|cocktail Molotov|a petrol bomb, a Molotov cocktail|${CD}
75|gaz lacrymogène|tear gas|${CD}
76|heurt, affrontement|a clash|${CD}
77|échauffourée|a skirmish|${CD}
78|complot|a plot|${CD}
79|comploteur|a plotter|${CD}
80|se révolter|to revolt|${CD}
81|se rebeller|to rebel|${CD}
82|rebelle|a rebel|${CD}
83|rébellion, révolte|a rebellion|${CD}
84|déjouer les autorités|to defy the authorities|${CD}
85|soulèvement|an uprising|${CD}
86|se soulever contre|to rise up against|${CD}
87|renverser un dictateur|to overthrow, to topple a dictator|${CD}
88|évincer un dictateur|to oust a dictator|${CD}
89|renversement d'un dictateur|the overthrow of a dictator|${CD}
90|déposer un dirigeant|to depose a ruler|${CD}
91|s'effondrer|to collapse|${CD}
92|restaurer la démocratie|to restore democracy|${CD}
93|chute d'un gouvernement|the downfall of a government|${CD}
94|répression brutale|ruthless repression|${CD}
95|réprimer une rébellion|to put down, to suppress a rebellion|${CD}
96|réprimer, étouffer la contestation|to quell the protests|${CD}
97|mesures de répression|crackdown, clampdown|${CD}
98|mettre les gens en prison|to send people to prison|${CD}
99|passer qn à tabac|to beat sb up|${CD}
100|gène|a gene|${CG}
101|cellule|a cell|${CG}
102|cellules-souches|stem cells|${CG}
103|recherche sur les cellules souches|stem-cell research|${CG}
104|génome humain|the human genome|${CG}
105|cartographie du génome|genome mapping|${CG}
106|carte génétique|gene map, genetic map|${CG}
107|séquence génétique|gene sequence|${CG}
108|séquençage|sequencing|${CG}
109|épissage du gène|gene splicing|${CG}
110|patrimoine héréditaire|gene pool|${CG}
111|généticien|a geneticist|${CG}
112|eugénisme|eugenics|${CG}
113|eugéniste, partisan de l'eugénisme|a eugenicist|${CG}
114|ADN|DNA|${CG}
115|test génétique|a DNA test|${CG}
116|empreinte génétique|a DNA print, genetic print|${CG}
117|analyse ADN|DNA analysis|${CG}
118|prélèvement d'ADN|a DNA sample|${CG}
119|profil génétique|genetic make-up, genetic profile|${CG}
120|analyse de l'empreinte génétique|genetic profiling, DNA fingerprinting|${CG}
121|dépistage génétique|genetic screening|${CG}
122|subir un prélèvement d'ADN|to be DNA-swabbed|${CG}
123|manipulations génétiques, génie génétique|genetic engineering|${CG}
124|transgénique|transgenic|${CG}
125|organisme génétiquement modifié|a genetically modified organism|${CG}
126|OGM|GMOs|${CG}
127|aliments contenant des OGM|GM food|${CG}
128|pommes de terres génétiquement modifiées|GM potatoes|${CG}
129|produits transgéniques|biotech products|${CG}
130|semence, graines|seed|${CG}
131|soja|soyabeans|${CG}
132|colza|rapeseed|${CG}
133|maïs|maize (GB), corn (US)|${CG}
134|blé|wheat|${CG}
135|culture, récolte|a crop|${CG}
136|essais sur le terrain|field trials, crop trials|${CG}
137|culture OGM|a GM crop|${CG}
138|rendement|yield|${CG}
139|filière agroalimentaire|agribusiness|${CG}
140|augmenter, améliorer les rendements|to improve yields|${CG}
141|résistant aux maladies|resistant to disease|${CG}
142|insecticide / pesticide / herbicide|insecticide / pesticide / herbicide|${CG}
143|polliniser|to pollinate|${CG}
144|pollinisation croisée|cross-pollination|${CG}
145|contaminer|to contaminate|${CG}
146|contamination|contamination|${CG}
147|maladie génétique|a genetic disease|${CG}
148|gène défectueux|a faulty gene|${CG}
149|gène manquant|a missing gene|${CG}
150|héréditaire|hereditary|${CG}
151|chromosome X / Y|an X / Y chromosome|${CG}
152|clonage|cloning|${CG}
153|conseil génétique|genetic counselling|${CG}
154|entreprise pharmaceutique|a pharmaceutical company|${CG}
155|thérapie génique|gene therapy|${CG}
156|traitement génique|genetic treatment|${CG}
157|à des fins thérapeutiques|for therapeutic purposes|${CG}
158|agriculture au service de la médecine|pharming|${CG}
159|jouer à l'apprenti-sorcier|to play God|${CG}
160|toucher à la nature|to tamper with nature|${CG}
161|principe de précaution|the precautionary principle, the safety-first principle|${CG}
162|étiquette|a label|${CG}
163|étiquetter|to label|${CG}
164|étiquetage|labelling|${CG}
165|avertir|to warn|${CG}
166|avertissement|a warning|${CG}
167|dont l'origine peut être établie|traceable|${CG}
168|traçabilité|traceability|${CG}
169|effets à long terme|long-term effects|${CG}
170|chaîne alimentaire|the food chain|${CG}
171|sécurité alimentaire|food security|${CG}
172|lobby OGM|the pro-GM lobby|${CG}
173|militants contre les OGM|anti-GM activists|${CG}
174|campagne contre les OGM|an anti-GM campaign|${CG}
175|étranger|a foreigner|${CI}
176|inconnu|a stranger|${CI}
177|nationalité|nationality|${CI}
178|ressortissant étranger|a foreign national|${CI}
179|personnes de nationalité française|French citizens|${CI}
180|émigrer en Nouvelle-Zélande|to emigrate to New Zealand|${CI}
181|immigrer en France|to immigrate to France|${CI}
182|vague d'immigration|a wave of immigration|${CI}
183|immigration à grande échelle / de masse|large-scale / mass immigration|${CI}
184|exode|an exodus|${CI}
185|nouvel arrivant|a newcomer|${CI}
186|pays natal, pays d'origine|native country, home country|${CI}
187|patrie|homeland|${CI}
188|pays d'accueil|a host country|${CI}
189|pays d'adoption|an adoptive country, a country of adoption|${CI}
190|accueillir|to welcome|${CI}
191|accueillant|welcoming|${CI}
192|politique migratoire|immigration policy|${CI}
193|immigration choisie|selective immigration, controlled immigration|${CI}
194|flux migratoires|migration flows|${CI}
195|passager clandestin|a stowaway|${CI}
196|immigration clandestine, irrégulière|illegal immigration|${CI}
197|immigration sauvage|uncontrolled immigration|${CI}
198|immigrant clandestin, sans-papiers|an illegal immigrant, an illegal alien, an undocumented alien|${CI}
199|il est en situation irrégulière|his papers are not in order|${CI}
200|frontière|a border, a frontier|${CI}
201|fermer ses frontières|to close one's borders|${CI}
202|contrôles aux frontières|border controls|${CI}
203|contrôles d'identité|identity checks|${CI}
204|centre de rétention (administrative)|a holding centre, a detention facility|${CI}
205|passeport|a passport|${CI}
206|carte d'identité|an identity card|${CI}
207|visa|a visa|${CI}
208|réfugié|a refugee|${CI}
209|personne déplacée|a displaced person|${CI}
210|apatride|a stateless person|${CI}
211|se réfugier|to take refuge, take shelter|${CI}
212|demander l'asile politique|to seek political asylum|${CI}
213|demandeur d'asile|an asylum-seeker|${CI}
214|fuir la persécution / la misère|to flee persecution / destitution|${CI}
215|échapper à la pauvreté|to escape poverty|${CI}
216|chercher de meilleures conditions de vie|to be in search of better living conditions|${CI}
217|trafic des êtres humains|human trafficking|${CI}
218|contrebandier, passeur|a smuggler|${CI}
219|passeurs d'immigrants clandestins|people-smugglers|${CI}
220|réseau de passeurs|a smuggling ring|${CI}
221|faux passeport|a fake passport|${CI}
222|reconduire qn à la frontière|to escort sb back to the border|${CI}
223|renvoyer un immigrant dans son pays d'origine|to send an immigrant back to his native country|${CI}
224|expulser qn|to deport sb|${CI}
225|être refoulé à la frontière|to be turned away at the border|${CI}
226|être expulsé|to be ordered out of the country|${CI}
227|s'exiler|to go into exile|${CI}
228|exilé|an exile|${CI}
229|exiler, bannir qn|to exile, banish sb|${CI}
230|s'expatrier|to expatriate oneself|${CI}
231|expatrié|an expatriate, an expat|${CI}
232|passer à l'Ouest / à l'ennemi|to defect to the West / to the enemy|${CI}
233|fuite des cerveaux / afflux des cerveaux|brain drain / brain gain|${CI}
234|partir de rien|to start from scratch|${CI}
235|travail au noir|moonlighting|${CI}
236|atelier clandestin|a sweatshop|${CI}
237|exploiter les travailleurs immigrés|to exploit migrant workers|${CI}
238|permis de travail, carte de travail|a work permit|${CI}
239|permis de séjour, carte de séjour|a residence permit, a resident permit|${CI}
240|travailleur migrant|a migrant worker|${CI}
241|travailleur invité (disposant d'un visa temporaire)|a guest worker|${CI}
242|s'intégrer|to become integrated|${CI}
243|bien s'intégrer dans une société|to integrate well into a society|${CI}
244|insertion sociale|social integration|${CI}
245|régulariser la situation des clandestins|to regularise the status of illegal immigrants|${CI}
246|régularisation|regularisation|${CI}
247|se faire naturaliser britannique, être naturalisé britannique, obtenir la nationalité britannique|to be granted British citizenship, to become a British citizen|${CI}
248|quota|a quota|${CI}
249|regroupement familial|family reunion, reunification|${CI}
250|qn qui abuse du système des prestations sociales|a benefit cheat|${CI}
251|fraude aux prestations sociales|benefit fraud|${CI}
252|parasite|a freeloader|${CI}
253|mariage blanc|a sham marriage, a marriage of convenience|${CI}
254|inonder|to flood|${CI}
255|être envahi par les étrangers|to be swamped with foreigners|${CI}
256|arrivée massive, afflux de travailleurs|the influx of workers|${CI}
257|endiguer l'afflux d'immigrés|to stem the flow of immigrants|${CI}
258|limiter / freiner l'immigration|to restrict / curb immigration|${CI}
259|parti d'extrême-droite|a far-right party|${CI}
260|faire fuir les immigrants|to scare immigrants away|${CI}
261|empêcher les indésirables d'entrer|to keep out undesirables|${CI}
262|xénophobie|xenophobia|${CI}
263|xénophobe|xenophobic|${CI}
264|avoir un grand-père né à l'étranger|to have a foreign-born grandfather|${CI}
265|jeunes gens d'origine asiatique / portugaise|young men of Asian / Portuguese descent|${CI}
266|Français de naissance|a native of France|${CI}
267|New Yorkais de souche|a born and bred New Yorker|${CI}
268|il est français de souche|he's of French origin, of French extraction|${CI}
269|Maghreb|North Africa|${CI}
270|Maghrébins|North Africans|${CI}
271|pakistanais / du Bangladesh|Pakistani / Bangladeshi|${CI}
272|hispanophone / parlant le Hindi|Spanish-speaking / Hindi-speaking|${CI}
273|diaspora|diaspora|${CI}
274|affaires étrangères|foreign affairs|${CIT}
275|relations extérieures|foreign relations|${CIT}
276|communauté internationale|the international community|${CIT}
277|problème mondial, planétaire|a global issue|${CIT}
278|État souverain|a sovereign state|${CIT}
279|souveraineté|sovereignty|${CIT}
280|État-nation|a nation-state|${CIT}
281|frontière|a border, a frontier|${CIT}
282|droit international|international law|${CIT}
283|géopolitique|geopolitics|${CIT}
284|scène internationale|the international stage, the international scene, the world stage|${CIT}
285|jouer un rôle dans qch|to play a role, a part in sth|${CIT}
286|occidental / oriental|western / eastern|${CIT}
287|politique étrangère, extérieure|foreign policy|${CIT}
288|ambassadeur|an ambassador|${CIT}
289|ambassade|an embassy|${CIT}
290|attaché culturel / commercial / militaire|a cultural / commercial / military attaché|${CIT}
291|envoyé, émissaire|an envoy, an emissary|${CIT}
292|diplomate|a diplomat|${CIT}
293|diplomatie|diplomacy|${CIT}
294|rompre / reprendre les relations|to break off / resume diplomatic relations|${CIT}
295|relations tendues|tense, strained relations|${CIT}
296|réchauffement|a thaw|${CIT}
297|refroidissement|a chill, a cooling off|${CIT}
298|rappeler un ambassadeur|to recall an ambassador|${CIT}
299|normaliser les relations|to normalize relations|${CIT}
300|grande puissance|a great power|${CIT}
301|superpuissance / hyperpuissance|a superpower / a hyperpower|${CIT}
302|hégémonie|hegemony|${CIT}
303|impérialisme|imperialism|${CIT}
304|impérialiste|imperialistic|${CIT}
305|expansionisme|expansionism|${CIT}
306|unilatéralisme / multilatéralisme|unilateralism / multilateralism|${CIT}
307|bilatéral / multilatéral|bilateral / multilateral|${CIT}
308|bipolaire / multipolaire|bipolar / multipolar|${CIT}
309|bloc|a bloc|${CIT}
310|équilibre des forces|balance of power|${CIT}
311|système onusien|the UN system|${CIT}
312|État-membre, pays membre|a member state|${CIT}
313|membre fondateur|a founding member, founder member|${CIT}
314|cotisation|a contribution|${CIT}
315|discuter / voter une résolution|to debate / to pass a resolution|${CIT}
316|appliquer une résolution|to implement, enforce a resolution|${CIT}
317|autoriser l'usage de la force|to authorize the use of force|${CIT}
318|embargo|an embargo|${CIT}
319|majorité des deux-tiers|a two-thirds majority|${CIT}
320|maintenir la paix|to maintain peace|${CIT}
321|opération de maintien de la paix|a peace-keeping operation|${CIT}
322|soldat de la paix|a peacekeeper|${CIT}
323|casque bleu|a blue helmet|${CIT}
324|devoir d'ingérence|the duty to interfere, to intervene|${CIT}
325|intervention militaire|military intervention|${CIT}
326|OTAN|NATO, the North Atlantic Treaty Organization|${CIT}
327|négocier|to negotiate|${CIT}
328|négociations, pourparlers, discussions|negotiations, talks|${CIT}
329|table des négociations|negotiating table|${CIT}
330|table ronde|a round table|${CIT}
331|faire une déclaration|to make, issue, deliver a statement|${CIT}
332|communiqué|a communiqué|${CIT}
333|sous l'égide de|under the aegis of|${CIT}
334|réunion au sommet, sommet|a summit (meeting)|${CIT}
335|porte-parole|a spokesman, spokeswoman, spokesperson|${CIT}
336|homologue|a counterpart, an opposite number|${CIT}
337|impasse|a stalemate, a deadlock, a standoff, an impasse|${CIT}
338|aboutir à une impasse|to reach a stalemate|${CIT}
339|sortir d'une impasse|to break a stalemate|${CIT}
340|ultimatum|an ultimatum|${CIT}
341|médiateur|a mediator|${CIT}
342|négocier un accord|to broker an agreement|${CIT}
343|surmonter un obstacle|to overcome an obstacle|${CIT}
344|volonté politique|political will|${CIT}
345|compromis|a compromise|${CIT}
346|transiger|to compromise|${CIT}
347|faire une concession|to make a concession|${CIT}
348|s'engager à faire qch|to commit oneself to doing sth|${CIT}
349|promettre de faire, s'engager à faire qch|to pledge to do sth|${CIT}
350|signer / ratifier un traité|to sign / ratify a treaty|${CIT}
351|protocole|a protocol|${CIT}
352|accord|an agreement, an accord|${CIT}
353|conclure un accord|to reach a settlement|${CIT}
354|stipuler|to stipulate|${CIT}
355|parvenir à un consensus|to reach a consensus|${CIT}
356|interdire|to prohibit, to ban|${CIT}
357|mettre son véto à une décision|to veto a decision|${CIT}
358|Union Européenne, l'UE|the European Union, the EU|${CIT}
359|directive européenne|an EU directive|${CIT}
360|adhérer à l'UE|to join the EU|${CIT}
361|demander son adhésion à l'UE|to apply to join the EU, to apply for EU membership|${CIT}
362|pourparlers d'adhésion|membership negotiations|${CIT}
363|organisation non-gouvernementale, ONG|a non-governmental organization, an NGO|${CIT}
364|droits de l'homme|human rights|${CIT}
365|violations des droits de l'homme|human rights abuses, violations|${CIT}
366|faire respecter un principe|to uphold a principle|${CIT}
367|passé de la Chine en matière de droits de l'homme|China's human Rights record|${CIT}
368|décolonisation|decolonization|${CIT}
369|obtenir l'indépendance, devenir indépendant|to achieve, gain, attain independence|${CIT}
370|ancienne colonie|a former colony|${CIT}
371|puissance coloniale|a colonial power|${CIT}
372|du travail|work|${CU}
373|un travail, un emploi|a job|${CU}
374|une profession, une activité professionnelle|an occupation|${CU}
375|les professions libérales|the professions|${CU}
376|une carrière|a career|${CU}
377|le monde du travail|the world of work|${CU}
378|être au travail|to be at work|${CU}
379|le lieu de travail|the workplace|${CU}
380|travailler chez soi|to work from home|${CU}
381|travailler à temps partiel OU à mi-temps|to work part time|${CU}
382|travailler à plein temps|to work full time|${CU}
383|la classe ouvrière|the working class|${CU}
384|la population active|the working population|${CU}
385|la vie active|the working life|${CU}
386|conditions de travail|working conditions|${CU}
387|atelier|a workshop|${CU}
388|usine|a factory, a plant|${CU}
389|atelier clandestin (où la main d'œuvre est exploitée)|a sweatshop|${CU}
390|travailler beaucoup|to work hard|${CU}
391|être travailleur|to be hard-working|${CU}
392|travailleur acharné, bourreau de travail|a hard worker, a workaholic|${CU}
393|permis de travail|a work permit|${CU}
394|être / ne pas être de service OU de garde|to be on duty / off duty|${CU}
395|chômage|unemployment, joblessness|${CU}
396|être au chômage|to be unemployed, jobless, out of work|${CU}
397|taux de chômage|unemployment rate, jobless rate|${CU}
398|chômeurs|the unemployed, the jobless|${CU}
399|chômage de longue durée|long-term unemployment|${CU}
400|chômage des jeunes|youth unemployment|${CU}
401|allocation chômage|unemployment benefit|${CU}
402|toucher le chômage|to be on the dole (GB), to be on welfare (US)|${CU}
403|marché du travail, de l'emploi|job market, labour market|${CU}
404|contrat à durée déterminée, CDD|a fixed-term contract|${CU}
405|contrat à durée indéterminée, CDI|an open-ended contract|${CU}
406|flexibilité de l'emploi|job flexibility|${CU}
407|avoir des horaires flexibles|work flexitime (GB) flextime (US)|${CU}
408|sécurité / précarité de l'emploi|job security / insecurity|${CU}
409|stage|an internship, a work placement|${CU}
410|stagiaire|an intern, a trainee|${CU}
411|travailleur précaire|a casual worker|${CU}
412|petit boulot|an odd job, a casual job|${CU}
413|boulot d'été|a summer job|${CU}
414|intérimaire|a temporary worker|${CU}
415|faire de l'intérim|to temp, to work as a temp|${CU}
416|employer|to employ|${CU}
417|employeur|an employer|${CU}
418|employé|an employee|${CU}
419|changer de travail|to change jobs|${CU}
420|embaucher un travailleur|to hire, to take on a worker|${CU}
421|recruter|to recruit|${CU}
422|période d'essai|a trial period|${CU}
423|poste|a post, a position|${CU}
424|nommer qn à un poste|to appoint sb to a post|${CU}
425|muter qn|to transfer sb|${CU}
426|poste à responsabilité(s)|a responsible job|${CU}
427|emploi subalterne|a menial job|${CU}
428|demandeur d'emploi|a job-seeker|${CU}
429|agence Pôle emploi|a Jobcenter (GB)|${CU}
430|CV, curriculum vitae|a curriculum vitae, a CV, a résumé (US)|${CU}
431|expérience professionnelle|work experience|${CU}
432|compétences|skills|${CU}
433|être candidat à un emploi, faire une demande d'emploi|to apply for a job|${CU}
434|candidat à un poste|an applicant|${CU}
435|entretien d'embauche|a job interview|${CU}
436|offre d'emploi|a job offer, a job vacancy, a job opportunity|${CU}
437|travail OU main d'œuvre|labour|${CU}
438|main d'œuvre féminine / travail des enfants|female labour / child labour|${CU}
439|normes en matière d'emploi|labour standards|${CU}
440|main d'œuvre|manpower, workforce|${CU}
441|personnel|staff, personnel|${CU}
442|collègue, camarade de travail|a colleague, a co-worker, a workmate|${CU}
443|ressources humaines|human resources|${CU}
444|travail qualifié / peu qualifié / non qualifié|a skilled / low-skilled / an unskilled job|${CU}
445|ouvrier spécialisé, OS|an unskilled worker|${CU}
446|ouvrier|a blue-collar worker|${CU}
447|employé de bureau|a white-collar worker|${CU}
448|fonctionnaire|a state employee, a civil servant|${CU}
449|salarié du secteur public|a public-sector employee|${CU}
450|haut fonctionnaire|a high-ranking civil servant|${CU}
451|être indépendant, travailler à son compte|to be self-employed|${CU}
452|travailleurs indépendants|the self-employed|${CU}
453|honoraires|fees|${CU}
454|paie, paye|pay|${CU}
455|salaire|salary|${CU}
456|salaire (d'ouvrier)|wages|${CU}
457|gagner de l'argent|to earn money, to make money|${CU}
458|gagner sa vie|to earn a living, to earn one's living, to make a living|${CU}
459|Que fait-il dans la vie ?|What does he do for a living?|${CU}
460|travail mal payé|a badly-paid job, a low-paid job|${CU}
461|travail bien payé|a well-paid job, a highly-paid job|${CU}
462|salarié|a wage-earner|${CU}
463|prime|a bonus|${CU}
464|avantage (en nature), avantage annexe|a perk, a fringe benefit|${CU}
465|voiture de fonction|a company car|${CU}
466|salaire au rendement|performance-related pay|${CU}
467|être employé par une entreprise|to be on a company's payroll|${CU}
468|vacances|holiday, vacation (US)|${CU}
469|congés payés|paid holiday|${CU}
470|être en vacances|to be on holiday|${CU}
471|jour férié|a bank holiday|${CU}
472|être en congé maladie|to be on sick leave|${CU}
473|prendre deux jours de congé|to take two days off|${CU}
474|réduction du temps de travail, RTT|reduction of working hours|${CU}
475|les 35 heures, la semaine de 35 heures|the 35-hour working week|${CU}
476|supprimer des emplois|to cut jobs|${CU}
477|faire des coupes sombres, claires dans la main d'œuvre|to slash, to axe jobs|${CU}
478|pertes d'emploi, suppressions d'emploi|job losses|${CU}
479|rationaliser|to streamline|${CU}
480|dégraisser ses effectifs|to downsize|${CU}
481|licencier des salariés|to lay off workers, to make workers redundant|${CU}
482|licenciement (économique)|a redundancy|${CU}
483|départ volontaire|a voluntary redundancy|${CU}
484|plan social|a redundancy plan|${CU}
485|indemnité de licenciement, prime de départ|redundancy payment, severance pay, severance package|${CU}
486|parachute doré|a golden parachute, a golden handshake|${CU}
487|renvoyer, licencier, congédier qn|to dismiss sb|${CU}
488|mettre à la porte, renvoyer, virer|to fire, to sack, to give sb the sack|${CU}
489|être renvoyé|to get the sack|${CU}
490|conflit social|an industrial dispute|${CU}
491|se mettre / être en grève|to go on strike / be on strike|${CU}
492|gréviste|a striker|${CU}
493|direction et les salariés|management and workers|${CU}
494|délégué syndical|a shop steward|${CU}
495|syndicat|a (trade) union|${CU}
496|revendication|a claim|${CU}
497|revendications salariales|wage claims, wage demands|${CU}
498|augmentation de salaire|a payrise (GB), a payraise (US)|${CU}
499|reprendre le travail|to resume work|${CU}
500|prendre sa retraite|to retire|${CU}
501|démissionner|to resign, to step down|${CU}
502|retraité|a pensioner, an old age pensioner, a retiree (US)|${CU}
503|retraite|retirement|${CU}
504|partir en pré-retraite|to take early retirement|${CU}
505|âge de la retraite|retirement age|${CU}
506|bien réussir à l'école|to do well at school|Education
507|lire l'anglais couramment|to read English fluently|Education
508|être bon en sport|to be good at sports|Education
509|faire l'école buissonnière|to play truant|Education
510|absentéisme|truancy|Education
511|suivre un cours d'anglais|to take a class in English|Education
512|donner du travail à la maison|to set homework|Education
513|rendre un travail|to hand in a piece of work|Education
514|les subtilités de la langue anglaise|the intricacies of the English language|Education
515|se lancer|to get started|Education
516|se conformer à une règle|to obey a rule|Education
517|obéir à (qqn)|to obey (sone)|Education
518|avoir des difficultés en maths|to have difficulty with maths|Education
519|donner un coup de main à (qqn)|to give (sone) a hand|Education
520|obtenir un diplôme|to graduate|Education
521|une salle de classe|a classroom|Education
522|une leçon|a class|Education
523|rattraper un cours loupé|to catch up a missed lesson|Education
524|évaluer|to assess, appraise|Education
525|le programme scolaire|the school curriculum|Education
526|étudiant de premier cycle|undergraduate|Education
527|indiscipliné|unruly|Education
528|incontrôlable|unmanageable|Education
529|bâcler ses devoirs|to dash off one's work|Education
530|obtenir une bonne note|to get a good mark|Education
531|tricher sur son voisin|to eye over one's neighbour's work|Education
532|principal, directeur (école)|headmaster|Education
533|élève doué|gifted pupil|Education
534|réussir un examen haut la main|to pass a test with flying colors|Education
535|une matière (scolaire)|a (school) subject|Education
536|une pause de 20 minutes|a 20-minute break|Education
537|une heure de cours|a teaching-hour|Education
538|passer dans la classe supérieure|to pass the next grade|Education
539|travail de paperasse|paperwork|Education
540|passer un examen|to take an exam|Education
541|examen blanc|mock exam|Education
542|se préparer à un examen|to prepare for an exam|Education
543|échouer à un examen|to flunk a test|Education
544|recaler (qqn)|to flunk (sone)|Education
545|être reçu à un examen avec mention|to pass a degree with distinction|Education
546|abandonner l'école|to drop out of school|Education
547|un élève décrocheur|a dropout|Education
548|obtenir une bourse|to get a scholarship|Education
549|entrer en fac de médecine|to go to a medical school|Education
550|faire des études de médecine|to study medicine|Education
551|remettre un évènement à plus tard|to put off an event|Education
552|sortie scolaire|school trip|Education
553|faire des recherches sur (qqch)|to do research on (sthg)|Education
554|cour d'école|schoolyard|Education
555|un élève de terminale|[UK] a sixth-former|Education
556|méticuleux|painstaking|Education
557|sécher un cours|to skip a lesson|Education
558|se voir accorder la possibilité de [...]|to be provided with an opportunity to [...]|Education
559|tricher|to cheat|Education
560|un tricheur|a cheater|Education
561|être renvoyé|to be expelled|Education
562|rouler sur un examen|to sail through an exam|Education
563|sauce (tomate)|dressing|Thanksgiving
564|chuckle|laughter|Thanksgiving
565|to gather|to get together|Thanksgiving
566|a feast|a banquet|Thanksgiving
567|to reach accross|to make efforts to join|Thanksgiving
568|one another|each other|Thanksgiving
569|to winnow away|to filter out and remove|Thanksgiving
570|widely viewed as|largely regarded as|Thanksgiving
571|twice|two times|Thanksgiving
572|to provide|to give|Thanksgiving
573|the bulk of|the biggest part of|Thanksgiving
574|to depict|to describe|Thanksgiving
575|to feature|to represent, show|Thanksgiving
576|subservient|submissive, docile|Thanksgiving
577|pilgrims|migrants arriving in America from England in 17th|Thanksgiving
578|to outnumber|to surpass in number|Thanksgiving
579|to crouch|almost to sit on the floor|Thanksgiving
580|a harvest|a crop|Thanksgiving
581|likely|probably|Thanksgiving
582|a deed|an [bad] action|Thanksgiving
583|settlers|colons|Thanksgiving
584|in retaliation for|in revenge for|Thanksgiving
585|to broker|to organize, negotiate|Thanksgiving
586|to grab|to seize|Thanksgiving
587|gauzy|transparent|Thanksgiving
588|willfully|deliberately|Thanksgiving
589|How [s.one] would have it|What [s.one] would like to believe|Thanksgiving
590|druthers|inclination, penchant|Thanksgiving
591|blissfully|ecstatically|Thanksgiving
592|bleached out|washed out|Thanksgiving
593|to abid|to respect|Thanksgiving
594|altérer|alter|Thanksgiving
595|apprentissage en continu|lifelong learning|Thanksgiving
596|malaise|general feeling of discomfort|Business
597|stagflation|period of slow economic growth and high unemployment|Business
598|aftermath|the consequences of a significant unpleasant event|Business
599|hyperinflation|extremely high and accelerating inflation|Business
600|third-world countries|countries with lower economic development|Business
601|martial law|military control over civilian functions of government|Business
602|gleaming|shining brightly, describe something polished or new|Business
603|suburban area|residential area on the outskirts of the a city|Business
604|stagnation|lack of activity, growth, and development|Business
605|dispirited|having lost emthusiasm and hope|Business
606|fatalistic|believing that events are inevitable|Business
607|hollowed out|destroyed or weakened from within|Business
608|brimming|filled to the point of overflowing (with positive emotions and energy)|Business
609|rabais, ristourne|discount|Business
610|chaîne de montage|assembly line|Business
611|payer comptant|to pay cash|Business
612|pénurie de main d'oeuvre|labor shortage|Business
613|productivité|productivity|Business
614|soumettre sa candidature|to apply|Business
615|racheter|to buy out|Business
616|licencier|to lay off|Business
617|se mettre en grève|to go on strike|Business
618|service client|customer service|Business
619|représentant syndical|union representative|Business
620|commerćant|shopkeeper|Business
621|virer, mettre à la porte|to fire|Business
622|se mettre à son compte|to set up one's business|Business
623|démissionner|to resign|Business
624|en sureffectif|overstaffed|Business
625|contrat à durée indéterminée|permanent contract|Business
626|équipe de nuit|night shift|Business
627|service, département|department|Business
628|refondre, réorganiser|to revamp|Business
629|concurrent|competitor|Business
630|fusion|merger|Business
631|faire faillite|to go bankrupt, bust|Business
632|embaucher|to hire, take on|Business
633|fiche de paie|pay slip|Business
634|faire des heures supplémentaires|work overtime|Business
635|mettre la clé sous la porte|to go out of business, close up shop|Business
636|fait main|handmade|Business
637|artisan|craftsman|Business
638|ouvrier qualifié|skilled worker|Business
639|entreprise|business|Business
640|plein emploi|full employment|Business
641|un maire|a mayor|Politique
642|homme politique|politician|Politique
643|s'assurer une majorité|to secure a majority|Politique
644|déclencher des élections anticipées|to call an early election|Politique
645|(UK) les éléctions législatives|(UK) the general election|Politique
646|(US) les éléctions présidentielles|(US) the general election|Politique
647|les grands partis|mainstream parties|Politique
648|premier ministre|Prime Minister|Politique
649|le ministre de l'économie et des finances|(UK) the Chancellor of the Exchequer|Politique
650|remaniement ministériel|Cabinet reshuffle|Politique
651|ministre des Affaires étrangères|Foreign minister|Politique
652|pronncer un discours|to deliver a speech|Politique
653|une dictature|a dictatorship|Politique
654|museler, baîlloner|to gag, muzzle|Politique
655|société civile|civil society|Politique
656|(UK) syndicats|(UK) trade unions|Politique
657|(US) syndicats|(US) labor unions|Politique
658|élections de mi-mandat|mid-term elections|Politique
659|minisre "frondeur"|rebellious minister|Politique
660|démissionner|resign, step down|Politique
661|officier en tant que|to serve as|Politique
662|opposer son veto à (qqch)|to veto (sthg)|Politique
663|un projet de loi|a bill|Politique
664|un groupe de réflexion|a think-tank|Politique
665|(UK) un ministre|(UK) a Cabinet member|Politique
666|un directeur de cabinet|a chief of staff|Politique
667|impôts locaux|local taxes|Politique
668|cote de popularité|approval ratings|Politique
669|se présenter à une éléction|to run for election [office]|Politique
670|prêter serment|to take the oath, be sworn in|Politique
671|rendre homage à (qqn)|to pay tribute to (sone)|Politique
672|dirigeant|political leader|Politique
673|élection truquée|rigged election|Politique
674|les allocations|social benefits|Politique
675|revaloriser|to scale up, raise, increase|Politique
676|l'allocation familliale|the family allowance|Politique
677|le gel de la production|the production freeze|Politique
678|un bras de fer|a tug of war|Politique
679|chancelant|teetering, wavering|Politique
680|tailored|customized|Politique
681|rote memorisation|repetition-based learning|Politique
682|impoverished|cash-strapped|Politique
683|unencumbered|unburdened|Politique
684|inquisitiveness|interest, curiosity|Politique
685|substantially|notably, significatly|Politique
686|authoritarian|dictatorial, strict|Politique
687|minimally supervised|lightly monitored|Politique
688|crime, criminality|la criminalité|${CR}
689|the crime rate|le taux de criminalité|${CR}
690|organized crime|la criminalité organisée, le grand banditisme|${CR}
691|white-collar crime|la criminalité en col blanc|${CR}
692|juvenile delinquency|la délinquance juvénile|${CR}
693|a juvenile delinquent, a young offender|un délinquant juvénile|${CR}
694|petty crime|la petite délinquance|${CR}
695|a crime, a felony|un crime|${CR}
696|to commit a crime|commettre un crime|${CR}
697|a criminal, a felon|un criminel|${CR}
698|a criminal record|un casier judiciaire|${CR}
699|an offense|un délit, une infraction|${CR}
700|a misdemeanour|une infraction (GB), un délit (US)|${CR}
701|an offender|un délinquant, un contrevenant|${CR}
702|a repeat offender, a recidivist|un récidiviste|${CR}
703|murder|le meurtre|${CR}
704|a murderer|un meurtrier|${CR}
705|manslaughter|homicide|${CR}
706|a serial killer|un tueur en série|${CR}
707|theft|le vol|${CR}
708|a thief, a robber|un voleur|${CR}
709|to steal a watch|voler une montre|${CR}
710|to rob sb of sth|voler qch à qn|${CR}
711|rape|le viol|${CR}
712|armed robbery|vol à main armée|${CR}
713|a burglary|un cambriolage|${CR}
714|to mug sb, to attack sb|agresser qn|${CR}
715|money-laundering|le blanchiment d’argent|${CR}
716|to break a law|enfreindre une loi|${CR}
717|lawful / unlawful|légal / illégal|${CR}
718|a lawbreaker|un délinquant, une personne qui enfreint la loi|${CR}
719|wrongdoing|des méfaits|${CR}
720|a wrongdoer|un malfaiteur|${CR}
721|to flout the law|se moquer de la loi|${CR}
722|a no-go area|une zone de non-droit|${CR}
723|to obey the law|obéir à la loi|${CR}
724|to abide by the law|respecter la loi|${CR}
725|a law-abiding citizen|un citoyen respectueux des lois|${CR}
726|the justice system|la justice|${CR}
727|a court, a court of law|un tribunal|${CR}
728|a judge|un juge|${CR}
729|a lawyer, a barrister (GB), an attorney (US)|un avocat|${CR}
730|the jury|le jury|${CR}
731|to prosecute sb|poursuivre qn (en justice)|${CR}
732|to bring a lawsuit against sb, sue sb|intenter un procès à qn, engager des poursuites contre qn|${CR}
733|the prosecutor|le procureur|${CR}
734|a suspect|un suspect|${CR}
735|to charge sb with murder|accuser, inculper qn de meurtre|${CR}
736|a charge|une accusation, un chef d’inculpation|${CR}
737|to confess to a crime|avouer un crime|${CR}
738|to confess to embezzling money|avouer avoir détourné de l’argent|${CR}
739|confession|un aveu|${CR}
740|a defendant|un accusé, un prévenu|${CR}
741|a witness / an eye witness|un témoin / un témoin oculaire|${CR}
742|a case|une affaire|${CR}
743|a trial|un procès|${CR}
744|to be tried, stand trial|passer en jugement, être jugé|${CR}
745|to await trial|être en attente de jugement|${CR}
746|the principle that a defendant is innocent until proven guilty|la présomption d’innocence|${CR}
747|forensic evidence|preuves relevées lors d’une expertise|${CR}
748|a culprit|un coupable|${CR}
749|to acquit sb|acquitter qn|${CR}
750|acquittal|acquittement|${CR}
751|to find sb guilty|condamner qn, reconnaître qn coupable|${CR}
752|to convict sb of rape, murder|reconnaître qn coupable de viol, meurtre|${CR}
753|a conviction|une condamnation|${CR}
754|a fine|une amende|${CR}
755|to fine sb for sth|condamner qn à une amende pour qch|${CR}
756|to be sentenced to five years’ imprisonment, five years in jail|être condamné à cinq ans de prison|${CR}
757|a death sentence|une condamnation à mort|${CR}
758|a life sentence|une condamnation à perpétuité|${CR}
759|a suspended sentence|une condamnation avec sursis|${CR}
760|to be sent to prison|être mis en prison|${CR}
761|to incarcerate, to imprison sb|incarcérer qn|${CR}
762|the incarceration rate|le taux d’incarcération|${CR}
763|a cell|une cellule|${CR}
764|a prisoner, an inmate, a detainee|un détenu, un prisonnier|${CR}
765|a prison officer, a prison warder (GB)|un gardien de prison|${CR}
766|a high-security prison|une prison de haute sécurité|${CR}
767|solitary confinement|l’isolement carcéral|${CR}
768|prison overcrowding|la surpopulation carcérale|${CR}
769|a miscarriage of justice|une erreur judiciaire|${CR}
770|to fabricate evidence|fabriquer des preuves|${CR}
771|to be proved innocent, to be exonerated|être innocenté|${CR}
772|to free, to release a prisoner|libérer, relâcher un prisonnier|${CR}
773|to pardon a convict|grâcier un condamné|${CR}
774|to parole sb|mettre qn en liberté conditionnelle|${CR}
775|to be on parole|être en liberté conditionnelle|${CR}
776|to report to the police|se présenter à la police|${CR}
777|an electronic tag|un bracelet de surveillance électronique|${CR}
778|contre la peine de mort|against the death penalty|${PC}
779|le meurtre|murder|${PC}
780|être coupable de meurtre|to be guilty of murder|${PC}
781|un meurtrier|a murderer|${PC}
782|le viol|rape|${PC}
783|un violeur|a rapist|${PC}
784|un délinquant sexuel|a sex offender|${PC}
785|un récidiviste|a repeat offender, a recidivist|${PC}
786|la culpabilité|guilt|${PC}
787|appliquer la loi du talion|to demand an eye for an eye|${PC}
788|déclarer qn coupable, condamner qn|to convict sb, to find sb guilty|${PC}
789|une condamnation|a conviction|${PC}
790|une condamnation à tort|a wrongful conviction|${PC}
791|condamner qn à mort|to sentence sb to death|${PC}
792|condamner qn à 25 ans de prison|to sentence sb to 25 years imprisonment|${PC}
793|un coupable|a culprit|${PC}
794|dissuader qn de faire qch|to deter sb from doing sth|${PC}
795|avoir un effet dissuasif|to act as a deterrent|${PC}
796|une condamnation à mort|a death sentence|${PC}
797|une condamnation à perpétuité|a life sentence|${PC}
798|perpétuité sans possibilité de remise de peine|life without parole|${PC}
799|mettre qn en prison|to jail, imprison sb|${PC}
800|un détenu, un prisonnier|a prisoner, an inmate, a detainee|${PC}
801|être dans les couloirs de la mort|to be on death row|${PC}
802|une cellule|a cell|${PC}
803|un avocat|a lawyer|${PC}
804|un appel|an appeal|${PC}
805|faire appel d’une décision|to appeal against a decision|${PC}
806|casser une décision (de justice)|to quash, to overturn a decision|${PC}
807|commuer une condamnation à mort en réclusion à perpétuité|to commute a death sentence to life|${PC}
808|surseoir à l’exécution d’un condamné|to grant a convict a stay of execution, a reprieve|${PC}
809|gracier un criminel|to pardon a criminal|${PC}
810|executer un condamné|to execute a convict|${PC}
811|mettre qn à mort|to put sb to death|${PC}
812|un bourreau|an executioner|${PC}
813|une piqûre mortelle|a lethal injection|${PC}
814|faire une piqûre mortelle à qn|to inject sb with a lethal substance|${PC}
815|pendre qn|to hang sb|${PC}
816|la guillotine|the guillotine|${PC}
817|guillotiner qn|to guillotine sb|${PC}
818|électrocuter qn|to electrocute sb|${PC}
819|la chaise électrique|the electric chair|${PC}
820|lapider qn, tuer qn à coups de pierre|to stone sb to death|${PC}
821|abolir|to abolish, to do away with|${PC}
822|rétablir la peine de mort|to reinstate, to reintroduce, to restore the death penalty|${PC}
823|appliquer la peine de mort|to apply, to enforce the death penalty|${PC}
824|une erreur judiciaire|a miscarriage of justice|${PC}
825|les tests ADN|DNA analysis, DNA testing|${PC}
826|innocenter qn|to prove sb innocent, to exonerate sb|${PC}
827|être innocenté grâce à l’ADN|to be cleared by DNA|${PC}
828|un problème controversé|a controversial, contentious issue|${PC}
829|un problème sensible, qui suscite de vives réactions|a hot-button issue|${PC}
830|partisans de la peine de mort|advocates, supporters, proponents of the death penalty|${PC}
831|opposants à, adversaires de la peine de mort|critics, opponents of the death penalty|${PC}
832|être contre la peine de mort|to oppose the death penalty, to be opposed to the death penalty|${PC}
833|un abolitionniste|an abolitionist|${PC}
834|du sexe féminin|female|${CF}
835|le statut, la position, la place des femmes dans la société|women’s status in society|${CF}
836|le déséquilibre entre les sexes|gender imbalance|${CF}
837|les inégalités entre les hommes et les femmes|gender inequalities|${CF}
838|la guerre entre les sexes|gender war|${CF}
839|un phallocrate, un machiste|a (male) chauvinist|${CF}
840|le machisme|machismo|${CF}
841|la misogynie|misogyny|${CF}
842|un misogyne|a misogynist|${CF}
843|le sexisme|sexism|${CF}
844|des préjugés sexistes|sexist prejudices|${CF}
845|le féminisme|feminism|${CF}
846|le mouvement des femmes, le mouvement pour les droits de la femme|the Women’s Movement, the women’s rights movement|${CF}
847|s’émanciper|to become emancipated|${CF}
848|rendre les femmes autonomes|to empower women|${CF}
849|un mariage forcé / arrangé|a forced marriage / an arranged marriage|${CF}
850|un mariage blanc|a sham marriage, a marriage of convenience|${CF}
851|une dot|a dowry|${CF}
852|la polygamie|polygamy|${CF}
853|polygame|polygamous|${CF}
854|l’excision|female circumcision, female genital mutilation|${CF}
855|une femme battue|a battered wife|${CF}
856|violence conjugale, familiale|domestic violence|${CF}
857|être privé du droit de vote|to be disenfranchised|${CF}
858|le droit de vote|the right to vote|${CF}
859|tomber enceinte|to become pregnant|${CF}
860|les femmes en âge d’avoir des enfants|women of childbearing age|${CF}
861|la pilule (contraceptive)|the (contraceptive) pill|${CF}
862|prendre la pilule|to be on the pill|${CF}
863|partir en congé maternité|to go on maternity leave|${CF}
864|congé parental|parental leave, career break|${CF}
865|s’occuper de ses enfants|to look after one’s children|${CF}
866|élever un enfant|to bring up, to raise a child|${CF}
867|l’éducation des enfants|the upbringing of children, child rearing, parenting|${CF}
868|des enfants d’âge scolaire|school-age children|${CF}
869|une femme au foyer, une ménagère|a housewife|${CF}
870|faire le ménage|to do the housework|${CF}
871|faire la cuisine / la lessive / la vaisselle / les courses|to do the cooking / washing / washing-up / shopping|${CF}
872|passer l’aspirateur|to do the vacuuming / to vacuum|${CF}
873|les appareils ménagers|domestic appliances|${CF}
874|les tâches ménagères|household chores|${CF}
875|être confronté à un dilemme|to be faced with a dilemma|${CF}
876|une crèche, une garderie|a nursery, a day-care centre (GB), a child-care center|${CF}
877|une nounou, une nourrice|a nanny|${CF}
878|une assistante maternelle, une nourrice|a childminder|${CF}
879|trouver un équilibre entre travail et famille|to balance, combine work and family|${CF}
880|jongler pour concilier carrière et famille|to juggle a career and a family|${CF}
881|concilier|to reconcile|${CF}
882|les responsabilités familiales|family responsibilities|${CF}
883|être dépendant financièrement de qn|to be financially dependent on sb|${CF}
884|gagner sa vie|to earn a living, to make a living|${CF}
885|subvenir aux besoins de sa famille|to support one’s family|${CF}
886|nourrir ses enfants|to feed one’s children|${CF}
887|être celui qui fait vivre la famille|to be the breadwinner|${CF}
888|c’est elle qui fait vivre sa famille|she is the family wage earner|${CF}
889|faire bouillir la marmite|to bring home the bacon|${CF}
890|la main d’œuvre féminine|female labour|${CF}
891|l’emploi des femmes|female employment|${CF}
892|les femmes représentent x % de la main d’œuvre|women make up x% of the workforce|${CF}
893|faire carrière|to have a career|${CF}
894|être une femme qui travaille|to be a working woman|${CF}
895|une femme qui fait carrière|a career woman|${CF}
896|travailler à temps partiel OU à mi-temps|to work part time|${CF}
897|travailler à plein temps|to work full time|${CF}
898|l’égalité des salaires|equal pay|${CF}
899|le différentiel de salaire entre les sexes|the gender pay gap, the gender wage gap|${CF}
900|nommer qn à un poste|to appoint sb to a post|${CF}
901|être en concurrence avec les hommes|to compete with men|${CF}
902|un poste à responsabilités|a responsible job|${CF}
903|un poste de haut niveau|a top job|${CF}
904|un emploi subalterne|a menial job|${CF}
905|réussir sa carrière|to have a successful career|${CF}
906|les obstacles à la promotion des femmes|barriers to female advancement|${CF}
907|une chasse gardée pour les hommes|a male preserve|${CF}
908|introduire une discrimination contre qn|to discriminate against sb|${CF}
909|être victime de discrimination|to be discriminated against|${CF}
910|le harcèlement|harassment|${CF}
911|le harcèlement sexuel|sexual harassment|${CF}
912|la parité|parity|${CF}
913|sous-représenté|under-represented|${CF}
914|instaurer des quotas|to introduce quotas|${CF}
915|l’instauration de quotas|the introduction of quotas|${CF}
916|la discrimination positive|affirmative action|${CF}
917|l’égalité des chances|equal opportunity|${CF}
918|égalitaire|egalitarian|${CF}
919|l’égalitarisme|egalitarianism|${CF}
920|atteindre l’égalité avec les hommes|to achieve equality with men|${CF}
`.trim();


    // Parsing de la liste brute -> structure homogène
    const flashcardData = cardsRawText
      .trim()
      .split(/\r?\n/)
      .map(l => {
        const parts = l.split('|');
        if (parts.length === 4) {
          const [id, f, e, c] = parts;
          return {
            id: id.trim(),
            front: f.trim(), // FR
            back: e.trim(), // EN
            chapter: c.trim()
          };
        }
        return null;
      })
      .filter(Boolean);

    // Helpers pour construire les chapitres à partir de la liste brute
    function slugify(s) {
      return s.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    }

    function emojiFor(title) {
      return CHAPTER_EMOJIS[title] || '';
    }

    function buildChaptersFromFlashcards(list) {
      const byChap = {};
      list.forEach(row => {
        const name = row.chapter || 'Sans catégorie';
        (byChap[name] = byChap[name] || []).push(row);
      });

      const chapters = Object.keys(byChap).map(name => {
        const id = 'chap-' + slugify(name);
        const cards = byChap[name].map(row => ({
          id: `${slugify(name)}-${row.id}`,
          front: row.front,
          back: row.back,
          grade: 'unseen',
          timesReviewed: 0,
          lastReviewed: 0,
          lastMs: 0,
          avgMs: 0,
          perfEma: 0.5,
          ef: 2.5,
          intervalDays: 0,
          dueAt: 0,
          streak: 0,
          successes: 0,
          failures: 0
        }));
        return {
          id,
          title: name,
          // vous pouvez afficher l’emoji dans le titre ou en description
          description: emojiFor(name) ? `${emojiFor(name)} ${name}` : name,
          settings: {
            sessionSize: 10,
            dailyGoal: 10,
            reviewOrder: 'front-first'
          },
          filters: {
            grades: {
              unseen: true,
              echec: true,
              difficile: true,
              bien: true,
              facile: true
            }
          },
          stats: {
            gradeCounts: {
              unseen: cards.length,
              echec: 0,
              difficile: 0,
              bien: 0,
              facile: 0
            },
            totalReviews: 0,
            dailyReviews: {},
            dailyChanges: {},
            dailyDurMs: {},
            dailyDurCount: {}
          },
          cards
        };
      });

      return {
        chapters,
        app: {
          currentChapterId: chapters[0]?.id || null
        }
      };
    }

    let data = loadData();

    // ====== Cookies backup (secours) ======
    function setCookie(name, value, days = 365) {
      try {
        const v = encodeURIComponent(value);
        document.cookie = `${name}=${v}; max-age=${days*86400}; path=/; SameSite=Lax;`;
      } catch (e) { /* noop */ }
    }

    function getCookie(name) {
      try {
        const dec = decodeURIComponent;
        const m = document.cookie.split(';').map(s => s.trim()).find(s => s.startsWith(name + '='));
        return m ? dec(m.split('=').slice(1).join('=')) : null;
      } catch (e) {
        return null;
      }
    }

    function delCookie(name) {
      document.cookie = `${name}=; max-age=0; path=/; SameSite=Lax;`;
    }

    // sérialise en plusieurs cookies (3x ~3.5KB => ~10KB backup)
    function writeCookieBackup(str) {
      const CHUNK = 3400; // marge
      const parts = Math.ceil(str.length / CHUNK);
      for (let i = 0; i < parts; i++) {
        setCookie(`F9X16_B${i}`, str.slice(i * CHUNK, (i + 1) * CHUNK));
      }
      // nettoie surplus
      for (let i = parts; i < 10; i++) {
        delCookie(`F9X16_B${i}`);
      }
      setCookie('F9X16_BN', String(parts));
    }

    function readCookieBackup() {
      const n = parseInt(getCookie('F9X16_BN') || '0', 10);
      if (!n || n <= 0) return null;
      let out = '';
      for (let i = 0; i < n; i++) {
        const p = getCookie(`F9X16_B${i}`);
        if (p == null) return null;
        out += p;
      }
      return out;
    }

    function loadData() {
      // 1) localStorage prioritaire
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
      } catch (e) {
        console.warn('Storage parse error', e);
      }
      // 2) backup cookies
      try {
        const c = readCookieBackup();
        if (c) {
          return JSON.parse(c);
        }
      } catch (e) { /* ignore */ }
      // 3) fallback: construit depuis la liste collée
      return buildChaptersFromFlashcards(flashcardData);
    }


    function saveData() {
      try {
        const str = JSON.stringify(data);
        localStorage.setItem(STORAGE_KEY, str);
        writeCookieBackup(str); // backup secours
      } catch (e) {
        console.warn('Save error', e);
      }
    }
    // ------------------ Utilitaires ------------------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const ChartHit = {}; // { [canvasId]: { cx, cy, innerR, outerR, arcs:[{key,start,end}] } }
    const todayKey = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = (d.getMonth() + 1).toString().padStart(2, '0');
      const dd = d.getDate().toString().padStart(2, '0');
      return `${y}-${m}-${dd}`;
    };

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    function formatDuration(ms) {
      const sec = Math.round(ms / 1000);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${s.toString().padStart(2,'0')}`;
    }

    function avg(a) {
      if (!a || !a.length) return 0;
      return a.reduce((x, y) => x + y, 0) / a.length;
    }

    function pickN(arr, n) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }

    function deepClone(o) {
      return JSON.parse(JSON.stringify(o));
    }
    // ------------------ État UI + Navigation ------------------
    const State = {
      view: 'deck', // 'deck' | 'chapter' | 'cards' | 'review' | 'recap' | 'settings'
      chapterId: null,
      review: null, // { chapterId, queue:[ids], index, flipped, answers:[], start, end }
      cardsIndex: 0
    };
    const Nav = {
      stack: [],
      push() {
        this.stack.push(deepClone({
          view: State.view,
          chapterId: State.chapterId,
          review: State.review,
          cardsIndex: State.cardsIndex
        }));
      },
      back() {
        if (this.stack.length === 0) return;
        const prev = this.stack.pop();
        State.view = prev.view;
        State.chapterId = prev.chapterId;
        State.review = prev.review;
        State.cardsIndex = prev.cardsIndex || 0;
        renderByState(false);
      },
      clear() {
        this.stack = [];
      }
    };
    // ------------------ Éléments DOM persistants ------------------
    const backBtn = $('#backBtn');
    const titleEl = $('#title');
    const bottomActions = $('#bottomActions');
    const revisionBar = $('#revisionBar');
    const startReviewBtn = $('#startReviewBtn');
    backBtn.addEventListener('click', () => {
      // Si on quitte une révision en cours, demander une confirmation
      if (State.view === 'review' && State.review && State.review.end == null) {
        if (!confirm('Quitter la révision en cours ?')) return;
      }

      if (State.view !== 'chapter') {
        // Toujours ramener à la vue Statistiques du chapitre courant
        if (State.chapterId) {
          return goChapter(State.chapterId, false);
        }
        // S'il n'y a pas de chapitre, fallback deck
        return goDeck(false);
      } else {
        // Déjà dans statistiques -> menu des decks
        return goDeck(false);
      }
    });
    $('#cardsBtn').addEventListener('click', () => goCards(State.chapterId));
    $('#settingsBtn').addEventListener('click', () => openSettings(State.chapterId));
    startReviewBtn.addEventListener('click', () => startReview(State.chapterId));
    // ------------------ Rendu (views) ------------------
    function setTopbar({
      title,
      showBack
    } = {}) {
      const autoShow = (State.view !== 'deck'); // visible partout sauf en Deck
      const visible = (typeof showBack === 'boolean') ? showBack : autoShow;
      backBtn.classList.toggle('hidden', !visible);
      if (title) titleEl.textContent = title;
    }


    function setBottomVisibility({
      actions = false,
      revision = false,
      sessionSize = 10,
      enabled = true,
      available = null,
      chapterId = null
    }) {
      bottomActions.style.display = actions ? 'grid' : 'none';
      revisionBar.style.display = revision ? 'block' : 'none';

      // Ajuste la grille: rangée 3 (actions) et rangée 4 (révision)
      const phoneEl = document.getElementById('app');
      phoneEl.style.setProperty('--row-actions', actions ? '52px' : '0px');
      phoneEl.style.setProperty('--row-rev', revision ? '64px' : '0px');

      if (available == null && chapterId) {
        const chap = getChapter(chapterId);
        available = chap ? countAvailable(chap) : 0;
      }
      if (available == null) available = 0;

      const planned = available > 0 ? Math.min(sessionSize, available) : 0;
      startReviewBtn.textContent = `Révision • ${planned || sessionSize} cartes${revision ? (available>0? ` • ${available} dispo`:'') : ''}`;
      startReviewBtn.disabled = !enabled || available <= 0;
    }


    function renderByState(push = true) {
      if (State.view === 'deck') goDeck(push);
      else if (State.view === 'chapter') goChapter(State.chapterId, push);
      else if (State.view === 'cards') goCards(State.chapterId, push);
      else if (State.view === 'review') goReview(push);
      else if (State.view === 'recap') goRecap(push);
      else if (State.view === 'settings') openSettings(State.chapterId, push);
    }
    function hideReviewActionsBar() {
      const el = document.getElementById('reviewActionsBar');
      if (el) {
        el.style.display = 'none';
        el.innerHTML = '';
      }
    }
    // --- Vues
    function goDeck(push = true) {
      if (push) Nav.push();
      State.view = 'deck';
      State.chapterId = null;
      setTopbar({
        title: 'Deck',
        showBack: false
      });
      setBottomVisibility({
        actions: false,
        revision: false
      });
      hideReviewActionsBar();
      renderDeck();
    }

    function renderDeck() {
      const v = $('#view');
      const chapters = data.chapters;

      v.innerHTML = `
        <div class="card flexcol" style="flex:1;">
          <div class="section-title">Chapitres</div>
          <div id="deckList" class="scroll-y" style="flex:1; min-height:0; padding-right:4px;">
            <div class="list">
              ${chapters.map(ch => {
                const { unseen, echec, difficile, bien, facile } = getLiveGradeCounts(ch);
                const total = ch.cards?.length ?? 0;
                const viewed = Math.max(0, total - unseen);
                const pct = total ? Math.round((viewed / total) * 100) : 0;

                // IMPORTANT:
                // - Pas d’emoji dans le titre (nom du deck)
                // - On laisse l’emoji dans la description (ch.description) comme aujourd’hui
                return `
                  <div class="deck-item" data-id="${ch.id}">
                    <div style="min-width:0">
                      <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size: 18px;">
                        ${ch.description || ch.title}
                        </div>

                      <div class="mt6" style="display:flex; flex-wrap:wrap; gap:6px">
                        <div class="chip-pie" title="Progression : ${pct}%" style="--progress: ${pct}%"></div>
                        <span class="chip" title="Échec">🟥 ${echec}</span>
                        <span class="chip" title="Difficile">🟨 ${difficile}</span>
                        <span class="chip" title="Bien">🟦 ${bien}</span>
                        <span class="chip" title="Facile">🟩 ${facile}</span>
                      </div>
                    </div>
                    <div class="muted" style="font-size:18px">›</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;

      $$('.deck-item').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.getAttribute('data-id');
          goChapter(id);
        });
      });
    }


    function goChapter(chapterId, push = true) {
      if (push) Nav.push();
      State.view = 'chapter';
      State.chapterId = chapterId;
      const chap = getChapter(chapterId);
      setTopbar({
        title: chap?.title || 'Statistiques'
      });
      setBottomVisibility({
        actions: true,
        revision: true,
        sessionSize: chap.settings.sessionSize,
        enabled: (chap.cards && chap.cards.length > 0),
        available: countAvailable(chap),
        chapterId: chap.id
      });
      hideReviewActionsBar();
      renderChapter(chapterId);
    }

    function renderChapter(chapterId) {
      const v = $('#view');
      const chap = getChapter(chapterId);
      const sel = chap.filters.grades || {};
      const counts = getLiveGradeCounts(chap);
      const {
        unseen,
        echec,
        difficile,
        bien,
        facile
      } = counts;

      const today = getTodayCount(chap);
      const week = getWeekCount(chap);
      const success = getSuccessRate(chap);
      const avg7 = get7DayAvgMs(chap);
      const dueNow = getDueNow(chap);
      const streak = getStreakDays(chap);
      const emoji = emojiFor(chap.title);

      v.innerHTML = `
        <div class="card" style="flex:1; display:flex; flex-direction:column;">
          <div class="section-title">${emoji ? emoji+' ' : ''}Statistiques</div>
          <div class="kpi">
            <div class="k"><div class="label">Cartes non vues</div><div class="value">${unseen}</div></div>
            <div class="k"><div class="label">Total cartes</div><div class="value">${chap.cards.length}</div></div>
          </div>

          <div class="chart-wrap">
            <canvas id="gradeChart" width="180" height="180" aria-label="Diagramme des scores"></canvas>
          </div>

          <div class="legend" id="legend">
            <div class="legend-item ${sel.unseen ? '' : 'inactive'}" data-key="unseen"><span class="dot gray"></span> Non vus: <b class="count">${unseen}</b></div>
            <div class="legend-item ${sel.echec ? '' : 'inactive'}" data-key="echec"><span class="dot red"></span> Échec: <b class="count">${echec}</b></div>
            <div class="legend-item ${sel.difficile ? '' : 'inactive'}" data-key="difficile"><span class="dot amber"></span> Difficile: <b class="count">${difficile}</b></div>
            <div class="legend-item ${sel.bien ? '' : 'inactive'}" data-key="bien"><span class="dot blue"></span> Bien: <b class="count">${bien}</b></div>
            <div class="legend-item ${sel.facile ? '' : 'inactive'}" data-key="facile"><span class="dot green"></span> Facile: <b class="count">${facile}</b></div>
          </div>
          


          <div class="kpi mt8">
            <div class="k"><div class="label">Aujourd'hui</div><div class="value">${today}</div></div>
            <div class="k"><div class="label">Cette semaine</div><div class="value">${week}</div></div>
          </div>
          <div class="kpi mt8">
            <div class="k"><div class="label">Taux de réussite</div><div class="value">${success}%</div></div>
            <div class="k"><div class="label">Temps moyen (7j)</div><div class="value">${avg7? (Math.round(avg7/100)/10)+'s':'—'}</div></div>
          </div>
          <div class="kpi mt8">
            <div class="k"><div class="label">À réviser maintenant</div><div class="value">${dueNow}</div></div>
            <div class="k"><div class="label">Série (jours)</div><div class="value">${streak}</div></div>
          </div>
          
          <div class="bar7-wrap">
            <div class="label" style="color:var(--primary)">Activité 7 jours</div>
            <canvas id="bar7" width="220" height="60"></canvas>
            <div class="bar7-labels" id="bar7Labels"></div>
          </div>

        </div>
        `;

      // Dessiner le camembert (segments non sélectionnés atténués)
      drawGradeChart('gradeChart', {
        unseen,
        echec,
        difficile,
        bien,
        facile
      }, chap.filters.grades);

      // Clic sur camembert (toujours supporté)
      const canvas = $('#gradeChart');
      canvas.style.cursor = 'pointer';
      canvas.onclick = (ev) => handleChartClick(ev, 'gradeChart', chap, counts);

      // Clic sur la légende pour filtrer
      $$('#legend .legend-item').forEach(el => {
        const key = el.getAttribute('data-key');
        el.addEventListener('click', () => handleLegendClick(key, chap));
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleLegendClick(key, chap);
          }
        });
      });
      // Mettre à jour le bouton de révision (cartes dispo selon filtre)
      updateRevisionBarForChapter(chap);
      

      drawBars7('bar7', getLast7DaysArray(chap));
      const lbl = document.getElementById('bar7Labels');
      if (lbl) {
        const noms = getLast7DaysLabelsFR();
        lbl.innerHTML = noms.map(j => `<div>${j.substring(0,3)}</div>`).join('');
      }

      // Redessiner au resize (dé-bouncé)
      (function() {
        let t;
        const redraw = () => drawBars7('bar7', getLast7DaysArray(chap));
        window.removeEventListener('resize', window._bar7ResizeHandler || (() => {}));
        window._bar7ResizeHandler = () => {
          clearTimeout(t);
          t = setTimeout(redraw, 150);
        };
        window.addEventListener('resize', window._bar7ResizeHandler);
      })();
    }



    function updateRevisionBarForChapter(chap) {
      const available = countAvailable(chap);
      setBottomVisibility({
        actions: true,
        revision: true,
        sessionSize: chap.settings.sessionSize,
        enabled: available > 0,
        available
      });
    }

    function goCards(chapterId, push = true) {
      if (push) Nav.push();
      State.view = 'cards';
      State.chapterId = chapterId;
      const chap = getChapter(chapterId);
      setTopbar({
        title: `${chap.title} • Cartes`
      });
      setBottomVisibility({
        actions: false,
        revision: false
      });
      hideReviewActionsBar();
      renderCards(chapterId);
    }

    function renderCards(chapterId) {
      const v = $('#view');
      const chap = getChapter(chapterId);
      const sel = chap.filters.grades || {};
      const pool = chap.cards.filter(c => sel[(c.grade || 'unseen')]);

      // Préparer un indicateur de flip global

      v.innerHTML = `
        <div style="flex:1; display:flex; flex-direction:column; min-height:0;">
          <div class="section-title">Cartes (${pool.length})</div>
          <div id="cardsGrid" class="scroll-y" style="flex:1; min-height:0; padding-right:4px;">
            <div class="cards-grid">
              ${pool.map(c=>{
                const { frontText, backText } = getCardSides(c, chap);
                const gradeClass = `grade-${c.grade || 'unseen'}`;
                const timeStr = c.avgMs ? formatDuration(c.avgMs) : '';
                return `
                <div class="card-block ${gradeClass}" data-id="${c.id}">
                  <div class="term">${frontText}</div>
                  <div class="definition">${backText}</div>
                  ${timeStr ? `<div class="cb-time">${timeStr}</div>` : ``}
                </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;

      // Clic: ne flip QUE la carte cliquée (et referme les autres)
      const grid = $('#cardsGrid');
      grid.addEventListener('click', (e) => {
        const block = e.target.closest('.card-block');
        if (!block) return;

        // referme les autres pour n’en avoir qu’une ouverte
        $$('.card-block').forEach(b => {
          if (b !== block) {
            b.classList.remove('flipped');
          }
        });
        
        // flip uniquement celle-ci
        block.classList.toggle('flipped');
      });
    }


    function goReview(push = true) {
      if (push) Nav.push();
      State.view = 'review';
      const r = State.review;
      const chap = getChapter(r.chapterId);

      setTopbar({
        title: 'Révision'
      });

      // Conserve la rangée 4 visible (même Y), mais masque la barre "Révision" visuelle
      setBottomVisibility({
        actions: false,
        revision: true
      }); // 4e rangée = 64px (même que le bouton Révision)
      revisionBar.style.display = 'none'; // masque le bouton "Révision" pendant la révision
      document.getElementById('reviewActionsBar').style.display = 'block'; // affiche notre barre d'actions de révision

      renderReview();
    }


    function renderReviewFooter() {
      const bar = document.getElementById('reviewActionsBar');
      if (!bar) return;
      const r = State.review;
      if (!r.flipped) {
        bar.innerHTML = `<button class="btn" id="flipBtn">Retourner</button>`;
        document.getElementById('flipBtn').onclick = () => {
          r.flipped = true;
          renderReview();
        };
      } else {
        bar.innerHTML = `<div class="row-4"> <button class="btn red" id="grade_echec">Échec</button> <button class="btn amber" id="grade_difficile">Difficile</button> <button class="btn blue" id="grade_bien">Bien</button> <button class="btn green" id="grade_facile">Facile</button> </div>`;
        document.getElementById('grade_echec').onclick = () => submitGrade('echec');
        document.getElementById('grade_difficile').onclick = () => submitGrade('difficile');
        document.getElementById('grade_bien').onclick = () => submitGrade('bien');
        document.getElementById('grade_facile').onclick = () => submitGrade('facile');
      }
    }

    function renderReview() {
      const v = $('#view');
      const r = State.review;
      const chap = getChapter(r.chapterId);
      const total = r.queue.length;
      const current = getCurrentCard();
      const idx = r.index + 1;

      // Ordre d’affichage (Face→Dos par défaut, sinon Dos→Face)
      const {
        frontText,
        backText
      } = getCardSides(current, chap);
      const frontFirst = chap.settings.reviewOrder !== 'back-first';
      const prompt = frontFirst ? frontText : backText;
      const isPromptFront = frontFirst; // true si on affiche le recto en premier
      const promptClass = isPromptFront ? 'term' : 'definition';
      const promptFace = isPromptFront ? 'front' : 'back';

      v.innerHTML = `
        <div class="review-wrap">
          <div class="review-top">
            <div>${chap.title}</div>
            <div>${idx} / ${total}</div>
          </div>

          <div class="review-card">
            <div>
              ${!r.flipped
                ? `<div class="${promptClass}" data-face="${promptFace}">${prompt}</div>`
                : `
                  <div class="stack">
                    <div class="term" data-face="front">${frontText}</div>
                    <div class="definition" data-face="back" style="margin-top:6px">${backText}</div>
                  </div>
                `
              }
            </div>
          </div>
        </div>
        `;
      bindReviewSizeControls();
      renderReviewFooter();
    }


    function goRecap(push = true) {
      if (push) Nav.push();
      State.view = 'recap';
      setTopbar({
        title: 'Récapitulatif'
      });
      setBottomVisibility({
        actions: false,
        revision: false
      });
      hideReviewActionsBar();
      renderRecap();
    }

    function renderRecap() {
      const v = $('#view');
      const r = State.review;
      const chap = getChapter(r.chapterId);
      const totalSession = r.answers.length;
      const duration = r.end - r.start;
      const avgPerCard = totalSession ? duration / totalSession : 0;
      const todayChange = getTodayChange(chap);
      const todayReviews = getTodayCount(chap);
      v.innerHTML = `
        <div class="card recap" style="flex:1">
          <div>
            <h2>Récapitulatif</h2>
            <div class="subtitle">${chap.title}</div>
          </div>
          <div class="grid2">
            <div class="stat">
              <div class="label">Révisions/jour (7j)</div>
              <div class="val">${get7DayAverage(chap)}</div>
            </div>
            <div class="stat">
              <div class="label">Changement de classe aujourd'hui</div>
              <div class="val">${todayChange.total>0 ? Math.round( (todayChange.changed / todayChange.total)*100 ) : 0}%</div>
            </div>
            <div class="stat">
              <div class="label">Objectif quotidien</div>
              <div class="val">${chap.settings.dailyGoal}</div>
            </div>
            <div class="stat">
              <div class="label">Révisions aujourd'hui</div>
              <div class="val">${todayReviews}/${chap.settings.dailyGoal}</div>
            </div>
          </div>
          <div class="grid2">
            <div class="stat">
              <div class="label">Total révisions (session)</div>
              <div class="val">${totalSession}</div>
            </div>
            <div class="stat">
              <div class="label">Durée (session)</div>
              <div class="val">${formatDuration(duration)}</div>
            </div>
            <div class="stat">
              <div class="label">Temps moyen/carte</div>
              <div class="val">${formatDuration(avgPerCard)}</div>
            </div>
          </div>
          <div class="cta">
            <button class="btn" id="continueBtn">Continuer</button>
          </div>
        </div>
      `;
      $('#continueBtn').addEventListener('click', () => {
        // Relance une nouvelle session avec les mêmes filtres
        startReview(r.chapterId);
      });
    }
    // ------------------ Logique Révision ------------------
    function startReview(chapterId) {
      if (!chapterId) return;
      const chap = getChapter(chapterId);
      const sel = chap.filters.grades;
      const pool = chap.cards.filter(c => sel[(c.grade || 'unseen')]);
      const size = Math.min(chap.settings.sessionSize, pool.length);

      if (size <= 0) {
        alert('Aucune carte disponible avec les filtres sélectionnés.');
        return;
      }

      const queue = buildSmartQueue(chap, pool, size).map(c => c.id);

      State.review = {
        chapterId,
        queue,
        index: 0,
        flipped: false,
        answers: [],
        start: Date.now(),
        end: null,
        cardStart: Date.now()
      };
      goReview();
    }


    function buildSmartQueue(chap, pool, size) {
      const now = Date.now();
      // Poids de base selon le grade courant
      const baseWMap = {
        unseen: 6,
        echec: 5,
        difficile: 3.5,
        bien: 2,
        facile: 1
      };

      const scored = pool.map(c => {
        const g = c.grade || 'unseen';
        const baseW = baseWMap[g] ?? 1;

        // Échéance: si en retard, boost; si à venir, légère pénalisation
        let dueBoost = 1;
        if (c.dueAt && c.dueAt > 0) {
          const delta = now - c.dueAt; // >0 si en retard
          if (delta > 0) {
            const overdueDays = delta / 864e5;
            dueBoost = 1 + Math.min(3, overdueDays); // jusqu’à x4
          } else {
            // pas en retard: pas prioritaire, mais pas exclu
            dueBoost = 0.85;
          }
        } else {
          // jamais planifié: priorité légère
          dueBoost = 1.15;
        }

        // Performance moyenne (plus la perf est basse, plus on priorise)
        const ema = (typeof c.perfEma === 'number') ? c.perfEma : 0.5;
        const perfBoost = 1 + (1 - ema) * 1.6; // 1..2.6

        // Streak: longues séries de succès => léger downweight; séries d’échecs => upweight
        const s = c.streak || 0;
        const streakAdj = s >= 3 ? (1 / (1 + 0.12 * (s - 2))) : (s < 0 ? (1 + 0.18 * Math.min(8, Math.abs(s))) : 1);

        // Temps moyen (plus c’est long, plus on priorise)
        const t = c.avgMs || 0;
        const timeBoost = 1 + Math.min(2, t / 3000); // max x3

        // Légère randomisation
        const jitter = 0.9 + Math.random() * 0.2;

        const weight = baseW * dueBoost * perfBoost * streakAdj * timeBoost * jitter;
        return {
          card: c,
          weight
        };
      });

      scored.sort((a, b) => b.weight - a.weight);
      return scored.slice(0, size).map(x => x.card);
    }


    function getCurrentCard() {
      const r = State.review;
      const chap = getChapter(r.chapterId);
      const id = r.queue[r.index];
      return chap.cards.find(c => c.id === id);
    }

    function submitGrade(nextGrade) {
      const r = State.review;
      const chap = getChapter(r.chapterId);
      const card = getCurrentCard();
      const now = Date.now();

      // 1) Durée de réponse
      const duration = Math.max(0, now - (r.cardStart || now));

      // 2) Comptages grades chapitre
      const prevGrade = card.grade || 'unseen';
      const next = nextGrade;

      const wasZeroBeforeNext = (chap.stats.gradeCounts[next] || 0) === 0;

      card.grade = next;

      syncGradeCounts(chap);


      // 3) Progression carte (EMA perf, E‑Factor, intervalle, streak)
      const alpha = 0.3; // EMA lissage
      const q01 = gradeNorm01(next);
      card.perfEma = (1 - alpha) * (card.perfEma ?? 0.5) + alpha * q01;

      scheduleNext(card, next, now);

      // 4) Temps / succès / échecs
      card.lastReviewed = now;
      card.lastMs = duration;
      card.avgMs = card.avgMs ? Math.round(card.avgMs * 0.7 + duration * 0.3) : duration;
      card.timesReviewed = (card.timesReviewed || 0) + 1;
      if (isSuccess(next)) card.successes += 1;
      else card.failures += 1;

      // 5) Stats globales jour (déjà présentes)
      chap.stats.totalReviews += 1;
      const tk = todayKey();
      chap.stats.dailyReviews[tk] = (chap.stats.dailyReviews[tk] || 0) + 1;
      chap.stats.dailyDurMs[tk] = (chap.stats.dailyDurMs[tk] || 0) + duration;
      chap.stats.dailyDurCount[tk] = (chap.stats.dailyDurCount[tk] || 0) + 1;
      const dc = chap.stats.dailyChanges[tk] || {
        changed: 0,
        total: 0
      };
      dc.total += 1;
      if (prevGrade !== next) dc.changed += 1;
      chap.stats.dailyChanges[tk] = dc;

      // 6) Auto-sélection filtre si première apparition de cette note (si fonction déjà en place)
      if (wasZeroBeforeNext && next !== 'unseen') {
        chap.filters.grades[next] = true;
      }

      // 7) Traces session et navigation
      r.answers.push({
        cardId: card.id,
        prev: prevGrade,
        next,
        ms: duration
      });

      if (r.index < r.queue.length - 1) {
        r.index += 1;
        r.flipped = false;
        r.cardStart = Date.now();
        saveData();
        renderReview();
      } else {
        r.end = Date.now();
        saveData();
        goRecap();
      }
    }


    function getLiveGradeCounts(chap) {
      const counts = {
        unseen: 0,
        echec: 0,
        difficile: 0,
        bien: 0,
        facile: 0
      };
      (chap.cards || []).forEach(c => {
        const g = c.grade || 'unseen';
        if (counts[g] != null) counts[g] += 1;
        else counts.unseen += 1;
      });
      return counts;
    }



    function syncGradeCounts(chap) {
      chap.stats = chap.stats || {};
      chap.stats.gradeCounts = getLiveGradeCounts(chap);
    }
    // ------------------ Helpers Chapitre/Stats ------------------
    function getChapter(id) {
      return data.chapters.find(c => c.id === id);
    }

    function getCardSides(card, chap) {
      if (chap?.settings?.langSwap) {
        return {
          frontText: card.back,
          backText: card.front
        }; // EN→FR
      }
      return {
        frontText: card.front,
        backText: card.back
      }; // FR→EN (par défaut)
    }

    function labelForGrade(g) {
      return ({
        unseen: 'Non vu',
        echec: 'Échec',
        difficile: 'Difficile',
        bien: 'Bien',
        facile: 'Facile'
      })[g] || g;
    }

    function getTodayCount(chap) {
      const tk = todayKey();
      return chap.stats.dailyReviews[tk] || 0;
    }

    function getTodayChange(chap) {
      const tk = todayKey();
      const x = chap.stats.dailyChanges[tk] || {
        changed: 0,
        total: 0
      };
      return x;
    }

    function get7DayAverage(chap) {
      const days = [];
      const base = new Date();
      for (let i = 6; i >= 0; i--) {
        const d = new Date(base);
        d.setDate(base.getDate() - i);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const key = `${y}-${m}-${dd}`;
        days.push(chap.stats.dailyReviews[key] || 0);
      }
      return Math.round(avg(days));
    }

    function getWeekCount(chap) {
      // Somme des 7 derniers jours (aujourd'hui inclus)
      const base = new Date();
      let sum = 0;
      for (let i = 0; i < 7; i++) {
        const d = new Date(base);
        d.setDate(base.getDate() - i);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const key = `${y}-${m}-${dd}`;
        sum += (chap.stats.dailyReviews[key] || 0);
      }
      return sum;
    }

    function getSuccessRate(chap) {
      const gc = chap.stats.gradeCounts || {};
      const good = (gc.bien || 0) + (gc.facile || 0);
      const attempt = good + (gc.echec || 0) + (gc.difficile || 0);
      if (attempt === 0) return 0;
      return Math.round((good / attempt) * 100);
    }

    function get7DayAvgMs(chap) {
      if (!chap.stats.dailyDurMs || !chap.stats.dailyDurCount) return 0;
      const base = new Date();
      let sum = 0,
        cnt = 0;
      for (let i = 0; i < 7; i++) {
        const d = new Date(base);
        d.setDate(base.getDate() - i);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const key = `${y}-${m}-${dd}`;
        const s = chap.stats.dailyDurMs[key] || 0;
        const c = chap.stats.dailyDurCount[key] || 0;
        sum += s;
        cnt += c;
      }
      return cnt ? Math.round(sum / cnt) : 0;
    }

    function activeGradesLabel(sel) {
      const keys = Object.keys(sel || {}).filter(k => sel[k]);
      if (keys.length === 0) return 'Aucun';
      if (keys.length === 5) return 'Tous';
      const map = {
        unseen: 'Jamais',
        echec: 'Échec',
        difficile: 'Difficile',
        bien: 'Bien',
        facile: 'Facile'
      };
      return keys.map(k => map[k] || k).join(' + ');
    }


    function countAvailable(chap) {
      const sel = chap.filters.grades;
      return chap.cards.filter(c => sel[(c.grade || 'unseen')]).length;
    }

    function getDueNow(chap) {
      const now = Date.now();
      return chap.cards.filter(c => c.dueAt && c.dueAt > 0 && c.dueAt <= now).length;
    }

    function getStreakDays(chap) {
      // Nombre de jours consécutifs (en remontant) avec au moins 1 révision/jour
      const base = new Date();
      let streak = 0;
      for (let i = 0; i < 365; i++) {
        const d = new Date(base);
        d.setDate(base.getDate() - i);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const n = chap.stats.dailyReviews[key] || 0;
        if (n > 0) streak++;
        else break;
      }
      return streak;
    }

    function getLast7DaysArray(chap) {
      const arr = [];
      const base = new Date();
      for (let i = 6; i >= 0; i--) {
        const d = new Date(base);
        d.setDate(base.getDate() - i);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        arr.push(chap.stats.dailyReviews[key] || 0);
      }
      return arr;
    }

    function getLast7DaysLabelsFR() {
      const arr = [];
      const base = new Date();
      const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(base);
        d.setDate(base.getDate() - i);
        arr.push(jours[d.getDay()]);
      }
      return arr;
    }

    function drawBars7(canvasId, values) {
      const el = document.getElementById(canvasId);
      if (!el) return;
      const ctx = el.getContext('2d');

      // DPR + taille CSS réelle
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const cssW = Math.round(el.clientWidth || el.getBoundingClientRect().width || 220);
      const cssH = Math.round(parseFloat(getComputedStyle(el).height) || el.height || 60);

      if (el.width !== cssW * dpr || el.height !== cssH * dpr) {
        el.width = cssW * dpr;
        el.height = cssH * dpr;
      }

      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, el.width, el.height);
      ctx.scale(dpr, dpr);

      const w = cssW,
        h = cssH;

      const max = Math.max(1, ...values);
      const n = values.length;
      const gap = 6;
      const totalGap = gap * (n - 1);
      const barW = Math.max(6, Math.floor((w - totalGap) / n));

      const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#6366f1';
      const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#0f172a';

      // Police plus petite et bande texte en bas
      const fontPx = Math.max(9, Math.min(10, Math.floor(barW * 0.7)));
      const textPad = fontPx + 4; // bande réservée pour les chiffres
      const baseY = h - textPad - 2; // ligne de base des barres (au-dessus des chiffres)
      const minH = 3; // petite barre min

      // Ligne de base (au-dessus des chiffres)
      ctx.strokeStyle = 'rgba(148,163,184,0.35)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, baseY + 0.5);
      ctx.lineTo(w, baseY + 0.5);
      ctx.stroke();

      // Paramètres texte (en bas)
      ctx.font = `bold ${fontPx}px ui-sans-serif, system-ui`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top'; // on écrit depuis le haut de la bande

      let x = 0;
      values.forEach(v => {
        const bhRaw = Math.round((v / max) * (h - textPad - 8));
        const bh = Math.max(minH, bhRaw);
        const y = baseY - bh;

        // Barre
        ctx.fillStyle = primary;
        ctx.globalAlpha = 0.95;
        ctx.fillRect(x, y, barW, bh);
        ctx.globalAlpha = 1;

        // Nombre en bas du diagramme (dans la bande réservée)
        ctx.fillStyle = textColor;
        ctx.fillText(String(v), x + barW / 2, baseY + 2);

        // ombre subtile au pied des barres
        ctx.fillStyle = 'rgba(0,0,0,0.15)';
        ctx.fillRect(x, baseY, barW, 2);

        x += barW + gap;
      });
    }
    // ------------------ Diagramme donut ------------------
    function drawGradeChart(canvasId, counts, activeKeys = null) {
      const el = document.getElementById(canvasId);
      if (!el) return;
      const ctx = el.getContext('2d');
      const w = el.width,
        h = el.height;
      ctx.clearRect(0, 0, w, h);

      const centerX = w / 2,
        centerY = h / 2;
      const outerR = Math.min(w, h) / 2 - 6;
      const innerR = outerR * 0.65;

      const segments = [{
        key: 'unseen',
        color: '#9ca3af'
      }, {
        key: 'echec',
        color: getComputedStyle(document.documentElement).getPropertyValue('--red').trim()
      }, {
        key: 'difficile',
        color: getComputedStyle(document.documentElement).getPropertyValue('--amber').trim()
      }, {
        key: 'bien',
        color: getComputedStyle(document.documentElement).getPropertyValue('--blue').trim()
      }, {
        key: 'facile',
        color: getComputedStyle(document.documentElement).getPropertyValue('--green').trim()
      }];
      const total = segments.reduce((s, seg) => s + (counts[seg.key] || 0), 0);

      const arcs = [];
      if (total === 0) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, outerR, 0, Math.PI * 2);
        ctx.arc(centerX, centerY, innerR, 0, Math.PI * 2, true);
        ctx.fillStyle = '#cbd5e1';
        ctx.globalAlpha = 0.25;
        ctx.fill();
        ctx.globalAlpha = 1;
        ctx.fillStyle = '#475569';
        ctx.font = 'bold 12px ui-sans-serif, system-ui';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Aucune donnée', centerX, centerY);
        ChartHit[canvasId] = {
          cx: centerX,
          cy: centerY,
          innerR,
          outerR,
          arcs: []
        };
        return;
      }

      let startAngle = -Math.PI / 2;
      segments.forEach(seg => {
        const value = counts[seg.key] || 0;
        if (value <= 0) return;
        const angle = (value / total) * Math.PI * 2;
        const endAngle = startAngle + angle;

        const isActive = !activeKeys || !!activeKeys[seg.key];

        ctx.beginPath();
        ctx.arc(centerX, centerY, outerR, startAngle, endAngle);
        ctx.arc(centerX, centerY, innerR, endAngle, startAngle, true);
        ctx.fillStyle = seg.color;
        ctx.globalAlpha = isActive ? 0.9 : 0.22;
        ctx.fill();
        ctx.globalAlpha = 1;

        arcs.push({
          key: seg.key,
          start: startAngle,
          end: endAngle
        });
        startAngle = endAngle;
      });

      // Centre label
      ctx.fillStyle = '#0ea5e9';
      ctx.font = 'bold 18px ui-sans-serif, system-ui';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(total.toString(), centerX, centerY - 4);
      ctx.fillStyle = '#64748b';
      ctx.font = '10px ui-sans-serif, system-ui';
      ctx.fillText('cartes', centerX, centerY + 10);

      // Hitmap pour clic
      ChartHit[canvasId] = {
        cx: centerX,
        cy: centerY,
        innerR,
        outerR,
        arcs
      };
    }

    function toggleFilterKey(chap, key) {
      const sel = chap.filters.grades;
      const total = Object.keys(sel).length;
      const active = Object.keys(sel).filter(k => sel[k]);
      const isSelected = !!sel[key];

      if (active.length === total) {
        Object.keys(sel).forEach(k => sel[k] = false);
        sel[key] = true;
      } else if (active.length === 1 && isSelected) {
        sel[key] = true;
      } else {
        sel[key] = !isSelected;
        if (Object.keys(sel).filter(k => sel[k]).length === 0) {
          sel[key] = true;
        }
      }
    }

    function handleChartClick(evt, canvasId, chap, countsRef) {
      const map = ChartHit[canvasId];
      if (!map || !map.arcs || map.arcs.length === 0) return;

      const rect = evt.target.getBoundingClientRect();
      const scaleX = evt.target.width / rect.width;
      const scaleY = evt.target.height / rect.height;
      const x = (evt.clientX - rect.left) * scaleX;
      const y = (evt.clientY - rect.top) * scaleY;

      const dx = x - map.cx;
      const dy = y - map.cy;
      const r = Math.hypot(dx, dy);
      if (r < map.innerR || r > map.outerR) return;

      let a = Math.atan2(dy, dx);
      while (a < -Math.PI / 2) a += 2 * Math.PI;
      while (a > 3 * Math.PI / 2) a -= 2 * Math.PI;

      const hit = map.arcs.find(s => a >= s.start && a <= s.end);
      if (!hit) return;

      toggleFilterKey(chap, hit.key);
      saveData();
      renderChapter(chap.id);
    }

    function handleLegendClick(key, chap) {
      toggleFilterKey(chap, key);
      saveData();
      renderChapter(chap.id);
    }

    function applyTheme() {
      const theme = (data?.app?.theme) || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
    }

    function applyUI() {
      const p = data.app.prefs || {};
      // Tailles de police
      document.documentElement.style.setProperty('--fs-term', (p.fsTerm || 20) + 'px');
      document.documentElement.style.setProperty('--fs-def', (p.fsDef || 24) + 'px');
      // Arrondis
      document.documentElement.style.setProperty('--radius-md', (p.radius || 14) + 'px');
      // Accent (met à jour --primary)
      const palette = {
        indigo: ['#6366f1', '#5457e6'],
        blue: ['#3b82f6', '#2563eb'],
        teal: ['#14b8a6', '#0d9488'],
        emerald: ['#10b981', '#059669'],
        rose: ['#f43f5e', '#e11d48'],
        amber: ['#f59e0b', '#d97706'],
        violet: ['#8b5cf6', '#7c3aed']
      };
      const acc = palette[p.accent] || palette.indigo;
      document.documentElement.style.setProperty('--primary', acc[0]);
      document.documentElement.style.setProperty('--primary-600', acc[1]);
    }

    // Mise à jour des données
    function upgradeData() {
      data.app = data.app || {};
      if (!('theme' in data.app)) data.app.theme = 'dark';
      data.app.prefs = data.app.prefs || {};
      // Préférences UI par défaut
      if (typeof data.app.prefs.fsTerm !== 'number') data.app.prefs.fsTerm = 22; // px
      if (typeof data.app.prefs.fsDef !== 'number') data.app.prefs.fsDef = 24; // px
      if (!data.app.prefs.accent) data.app.prefs.accent = 'indigo'; // palette
      if (typeof data.app.prefs.showEmoji !== 'boolean') data.app.prefs.showEmoji = true;

      data.chapters.forEach(ch => {
        ch.settings = ch.settings || {};
        if (typeof ch.settings.langSwap !== 'boolean') ch.settings.langSwap = false; // false = FR→EN (par défaut)
        ch.cards.forEach(c => {
          if (typeof c.perfEma !== 'number') c.perfEma = 0.5; // moyenne mobile exp des notes (0..1)
          if (typeof c.ef !== 'number') c.ef = 2.5; // E‑Factor (SM‑2), min 1.3
          if (typeof c.intervalDays !== 'number') c.intervalDays = 0; // intervalle en jours
          if (typeof c.dueAt !== 'number') c.dueAt = 0; // timestamp prochain passage
          if (typeof c.streak !== 'number') c.streak = 0; // série (+ succès / - échecs), bornée
          if (typeof c.successes !== 'number') c.successes = 0;
          if (typeof c.failures !== 'number') c.failures = 0;
        });
        syncGradeCounts(ch);
      });
      saveData();
    }
    // ------------------ Paramètres (placeholder) ------------------
    function openSettings(chapterId, push = true) {
      if (!chapterId) chapterId = State.chapterId; // fallback sûr
      const chap = getChapter(chapterId);
      if (!chap) return;

      if (push) Nav.push();
      const v = $('#view');
      State.view = 'settings';
      setTopbar({
        title: `${chap.title} • Paramètres`
      });
      setBottomVisibility({
        actions: false,
        revision: false
      });
      hideReviewActionsBar();
      v.innerHTML = `
        <div class="settings-page scroll-y" style="flex:1; min-height:0;">
          <div>
            <div class="settings-hero">Paramètres</div>
            <div class="settings-sub">Personnalisez l’affichage, les langues et vos objectifs</div>
          </div>

          <div class="settings-section">
            <div class="section-title">Apparence</div>
            <div class="mt6 muted" style="font-size:13px">
              • Thème: <b id="themeLbl">${data.app.theme==='light'?'Clair':'Sombre'}</b>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn" id="toggleTheme">Basculer Clair/Sombre</button>
            </div>

            <div class="mt6 muted" style="font-size:13px">Couleur d’accent</div>
            <div class="swatches" id="accentSwatches">
              <button class="swatch" data-accent="indigo" style="--sw:#6366f1"></button>
              <button class="swatch" data-accent="blue" style="--sw:#3b82f6"></button>
              <button class="swatch" data-accent="teal" style="--sw:#14b8a6"></button>
              <button class="swatch" data-accent="emerald" style="--sw:#10b981"></button>
              <button class="swatch" data-accent="rose" style="--sw:#f43f5e"></button>
              <button class="swatch" data-accent="amber" style="--sw:#f59e0b"></button>
              <button class="swatch" data-accent="violet" style="--sw:#8b5cf6"></button>
            </div>
          </div>

          <div class="settings-section">
            <div class="section-title">Langues</div>
            <div class="mt6 muted" style="font-size:13px">Recto → Verso: <b id="langOrderLbl">${chap.settings.langSwap ? 'EN → FR' : 'FR → EN'}</b></div>
            <button class="btn" id="toggleLangSwap">Basculer FR ↔ EN</button>
          </div>
          
          <div class="settings-section">
            <div class="section-title">Typographie</div>
            <div class="card" id="typoPreview" style="margin-bottom:8px; padding:10px">
              <div class="term">Exemple recto (Front)</div>
              <div class="definition" style="margin-top:6px">Exemple verso (Back)</div>
              <div class="muted" style="font-size:12px; margin-top:6px">Ajustez via les roues ci‑dessous.</div>
            </div>
            <div class="wheel" id="wheelFsTerm"><div class="name">Recto (Front)</div><div class="hint">Glissez ↑↓</div><div class="wheel-value"></div></div>
            <div class="wheel mt6" id="wheelFsDef"><div class="name">Verso (Back)</div><div class="hint">Glissez ↑↓</div><div class="wheel-value"></div></div>
          </div>

          <div class="settings-section">
            <div class="section-title">Session & Objectif</div>
            <div class="wheel" id="wheelSession"><div class="name">Taille session</div><div class="hint">Glissez ↑↓</div><div class="wheel-value"></div></div>
            <div class="wheel mt6" id="wheelGoal"><div class="name">Objectif quotidien</div><div class="hint">Glissez ↑↓</div><div class="wheel-value"></div></div>
          </div>

          <div class="settings-section">
            <div class="section-title">Réinitialiser</div>
            <div class="mt6 muted" style="font-size:13px">
              Remettre à zéro la progression (grades, stats, temps) du chapitre courant ou de toute l’application.
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
              <button class="btn" id="resetChapterBtn">Reset chapitre</button>
              <button class="btn red" id="resetAllBtn">Reset application</button>
            </div>
          </div>
        </div>
      `;

      const P = data.app.prefs;

      const refreshTheme = () => {
        const theme = data.app.theme === 'light' ? 'Clair' : 'Sombre';
        $('#themeLbl').textContent = theme;
      };

      const refreshLang = () => {
        const lbl = document.getElementById('langOrderLbl');
        if (lbl) lbl.textContent = chap.settings.langSwap ? 'EN → FR' : 'FR → EN';
      };
      refreshLang();

      $('#toggleLangSwap').onclick = () => {
        chap.settings.langSwap = !chap.settings.langSwap;
        saveData();
        refreshLang();
        // Re-rendre la vue courante pour voir l’effet immédiatement si besoin
        renderByState(false);
      };

      $('#toggleTheme').onclick = () => {
        data.app.theme = data.app.theme === 'light' ? 'dark' : 'light';
        saveData();
        applyTheme();
        refreshTheme();
      };

      const activeAccent = data.app.prefs.accent || 'indigo';
      $$('#accentSwatches .swatch').forEach(sw => {
        const key = sw.getAttribute('data-accent');
        if (key === activeAccent) sw.classList.add('is-active');
        sw.onclick = () => {
          data.app.prefs.accent = key;
          saveData();
          applyUI(); // refresh visuel
          $$('#accentSwatches .swatch').forEach(x => x.classList.toggle('is-active', x.getAttribute('data-accent') === key));
        };
      });

      bindWheel($('#wheelFsTerm'), {
        get: () => P.fsTerm,
        set: (v) => {
          P.fsTerm = v
        },
        min: 12,
        max: 44,
        step: 1,
        unit: 'px'
      });
      bindWheel($('#wheelFsDef'), {
        get: () => P.fsDef,
        set: (v) => {
          P.fsDef = v
        },
        min: 14,
        max: 52,
        step: 1,
        unit: 'px'
      });

      bindWheel($('#wheelSession'), {
        get: () => chap.settings.sessionSize,
        set: (v) => {
          chap.settings.sessionSize = v
        },
        min: 5,
        max: 200,
        step: 5,
        unit: ' cartes'
      });
      bindWheel($('#wheelGoal'), {
        get: () => chap.settings.dailyGoal,
        set: (v) => {
          chap.settings.dailyGoal = v
        },
        min: 5,
        max: 500,
        step: 5,
        unit: ' cartes'
      });

      $('#resetChapterBtn').onclick = () => {
        if (!confirm('Réinitialiser la progression de ce chapitre ?')) return;
        resetChapter(chap.id);
        saveData();
        // rafraîchit la vue de paramètres (et stats à la prochaine ouverture)
        openSettings(chapterId, false);
      };

      $('#resetAllBtn').onclick = resetAll;

      bindTypoPreviewDrag();
    }

    function syncFromRawFlashcards() {
      if (!Array.isArray(flashcardData) || flashcardData.length === 0) return;
      const byTitle = {};
      data.chapters.forEach(ch => byTitle[ch.title] = ch);

      // Index des cartes existantes par id pour chaque chapitre
      const ensureChapter = (title) => {
        if (byTitle[title]) return byTitle[title];
        // Créer un nouveau chapitre
        const id = 'chap-' + slugify(title);
        const newChap = {
          id,
          title,
          description: emojiFor(title) ? `${emojiFor(title)} ${title}` : title,
          settings: {
            sessionSize: 10,
            dailyGoal: 10,
            reviewOrder: 'front-first'
          },
          filters: {
            grades: {
              unseen: true,
              echec: true,
              difficile: true,
              bien: true,
              facile: true
            }
          },
          stats: {
            gradeCounts: {
              unseen: 0,
              echec: 0,
              difficile: 0,
              bien: 0,
              facile: 0
            },
            totalReviews: 0,
            dailyReviews: {},
            dailyChanges: {},
            dailyDurMs: {},
            dailyDurCount: {}
          },
          cards: []
        };
        data.chapters.push(newChap);
        byTitle[title] = newChap;
        return newChap;
      };

      let added = 0;
      flashcardData.forEach(row => {
        const title = row.chapter || 'Sans catégorie';
        const ch = ensureChapter(title);
        const cardId = `${slugify(title)}-${row.id}`;
        if (!ch.cards.find(c => c.id === cardId)) {
          ch.cards.push({
            id: cardId,
            front: row.front,
            back: row.back,
            grade: 'unseen',
            timesReviewed: 0,
            lastReviewed: 0,
            lastMs: 0,
            avgMs: 0,
            perfEma: 0.5,
            ef: 2.5,
            intervalDays: 0,
            dueAt: 0,
            streak: 0,
            successes: 0,
            failures: 0
          });
          added++;
        }
      });

      if (added > 0) {
        data.chapters.forEach(ch => syncGradeCounts(ch));
        // S’assurer que le chapitre courant est cohérent
        if (!data.app.currentChapterId && data.chapters[0]) {
          data.app.currentChapterId = data.chapters[0].id;
        }
        saveData();
      }
    }



    function bindReviewSizeControls() {
      const faces = document.querySelectorAll('.review-card [data-face]');
      if (!faces || !faces.length) return;

      const P = data.app.prefs || {};
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

      // applique immédiatement les variables CSS (live)
      const applyVars = () => {
        document.documentElement.style.setProperty('--fs-term', (P.fsTerm || 20) + 'px');
        document.documentElement.style.setProperty('--fs-def', (P.fsDef || 24) + 'px');
      };

      faces.forEach(el => {
        const face = el.getAttribute('data-face'); // 'front' | 'back'
        let startY = null,
          startVal = null;

        const getVal = () => face === 'front' ? (P.fsTerm || 20) : (P.fsDef || 24);
        const setVal = (v) => {
          if (face === 'front') P.fsTerm = clamp(v, 12, 60);
          else P.fsDef = clamp(v, 14, 72);
          applyVars(); // mise à jour en direct
        };
        const commit = () => saveData();

        // Pointer (mobile + desktop)
        el.addEventListener('pointerdown', e => {
          startY = e.clientY;
          startVal = getVal();
          el.setPointerCapture?.(e.pointerId); // ← correct (sans espace)
          e.preventDefault();
          e.stopPropagation();
        });
        el.addEventListener('pointermove', e => {
          if (startY == null) return;
          const dy = startY - e.clientY; // glisser vers le haut => augmente
          const delta = Math.round(dy / 6); // 6px de déplacement => +1px
          setVal(startVal + delta);
          e.preventDefault();
          e.stopPropagation();
        });
        const end = e => {
          if (startY != null) commit();
          startY = null;
          startVal = null;
          e.preventDefault();
          e.stopPropagation();
        };
        el.addEventListener('pointerup', end);
        el.addEventListener('pointercancel', end);

        // Molette (desktop)
        el.addEventListener('wheel', e => {
          e.preventDefault();
          const dir = e.deltaY > 0 ? -1 : 1;
          setVal(getVal() + dir);
          commit();
        }, {
          passive: false
        });
      });
    }

    function bindTypoPreviewDrag() {
      const box = document.getElementById('typoPreview');
      if (!box) return;
      const termEl = box.querySelector('.term');
      const defEl = box.querySelector('.definition');
      const toast = document.getElementById('typoToast');
      const P = data.app.prefs || {};
      const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

      let startY = null,
        startTerm = null,
        startDef = null,
        target = 'both';

      const showToast = (msg) => {
        if (!toast) return;
        toast.textContent = msg;
        toast.style.display = 'block';
      };
      const hideToast = () => {
        if (toast) toast.style.display = 'none';
      };

      const updateVars = () => {
        document.documentElement.style.setProperty('--fs-term', (P.fsTerm || 20) + 'px');
        document.documentElement.style.setProperty('--fs-def', (P.fsDef || 24) + 'px');
      };

      const start = (e) => {
        const t = e.target.closest('.term, .definition, #typoPreview');
        if (!t) return;
        startY = (e.touches ? e.touches[0].clientY : e.clientY);
        startTerm = P.fsTerm || 20;
        startDef = P.fsDef || 24;
        if (t.classList.contains('term')) target = 'term';
        else if (t.classList.contains('definition')) target = 'def';
        else target = 'both';
        e.preventDefault();
      };
      const move = (e) => {
        if (startY == null) return;
        const y = (e.touches ? e.touches[0].clientY : e.clientY);
        const dy = startY - y; // haut => grand
        const delta = Math.round(dy / 6);

        if (target === 'term' || target === 'both') {
          P.fsTerm = clamp(startTerm + delta, 12, 60);
        }
        if (target === 'def' || target === 'both') {
          P.fsDef = clamp(startDef + delta, 14, 72);
        }
        updateVars(); // LIVE
        showToast(`Recto ${P.fsTerm}px • Verso ${P.fsDef}px`);
      };
      const end = () => {
        if (startY != null) {
          saveData();
        }
        startY = null;
        startTerm = null;
        startDef = null;
        target = 'both';
        setTimeout(hideToast, 200);
      };

      // Pointer/touch
      box.addEventListener('pointerdown', start);
      box.addEventListener('pointermove', move);
      box.addEventListener('pointerup', end);
      box.addEventListener('pointercancel', end);
      box.addEventListener('touchstart', start, {
        passive: false
      });
      box.addEventListener('touchmove', move, {
        passive: false
      });
      box.addEventListener('touchend', end, {
        passive: false
      });

      // Molette: term si sur term, def si sur def, sinon both
      const wheelOn = (el, which) => {
        el.addEventListener('wheel', (e) => {
          e.preventDefault();
          const dir = e.deltaY > 0 ? -1 : 1;
          if (which === 'term' || which === 'both') {
            P.fsTerm = clamp((P.fsTerm || 20) + dir, 12, 60);
          }
          if (which === 'def' || which === 'both') {
            P.fsDef = clamp((P.fsDef || 24) + dir, 14, 72);
          }
          updateVars();
          saveData();
          showToast(`Recto ${P.fsTerm}px • Verso ${P.fsDef}px`);
          setTimeout(hideToast, 250);
        }, {
          passive: false
        });
      };
      wheelOn(termEl, 'term');
      wheelOn(defEl, 'def');
      wheelOn(box, 'both');
    }

    function bindWheel(node, {
      get,
      set,
      min,
      max,
      step = 1,
      unit = 'px',
      onApply
    }) {
      const valueEl = node.querySelector('.wheel-value');
      const render = () => {
        valueEl.textContent = get() + (unit || '');
      };
      const clampv = (v) => Math.max(min, Math.min(max, v));
      let startY = null,
        startV = null;

      const commit = () => {
        saveData();
        applyUI();
        if (onApply) onApply();
      };

      const setVal = (v) => {
        set(clampv(v));
        render();
        // LIVE update (sans attendre "commit")
        applyUI();
      };

      const pd = (e) => {
        e.preventDefault();
        e.stopPropagation();
      };

      node.addEventListener('pointerdown', (e) => {
        startY = e.clientY;
        startV = get();
        node.setPointerCapture?.(e.pointerId);
        pd(e);
      });
      node.addEventListener('pointermove', (e) => {
        if (startY == null) return;
        const dy = startY - e.clientY;
        const delta = Math.round(dy / 6) * step; // 6px ~ 1 step
        setVal(startV + delta);
        pd(e);
      });
      const end = (e) => {
        if (startY != null) commit();
        startY = null;
        startV = null;
        pd(e);
      };
      node.addEventListener('pointerup', end);
      node.addEventListener('pointercancel', end);

      // Molette (desktop)
      node.addEventListener('wheel', (e) => {
        e.preventDefault();
        const dir = e.deltaY > 0 ? -step : step;
        setVal(get() + dir);
        commit();
      }, {
        passive: false
      });

      render();
    }

    function gradeQuality5(g) {
      switch (g) {
        case 'facile':
          return 5;
        case 'bien':
          return 4;
        case 'difficile':
          return 2;
        case 'echec':
          return 1;
        default:
          return 0;
      }
    }

    function gradeNorm01(g) {
      switch (g) {
        case 'facile':
          return 1.0;
        case 'bien':
          return 0.75;
        case 'difficile':
          return 0.35;
        case 'echec':
          return 0.0;
        default:
          return 0.5;
      }
    }

    function isSuccess(g) {
      return g === 'facile' || g === 'bien';
    }

    // Planification SM‑2 simplifiée + streak
    function scheduleNext(card, grade, now = Date.now()) {
      const q = gradeQuality5(grade);
      // E‑Factor
      let EF = card.ef || 2.5;
      EF = EF + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
      if (EF < 1.3) EF = 1.3;
      card.ef = EF;

      // Intervalle (jours) + due date
      if (q < 3) { // mauvaise réponse (échec/difficile)
        card.intervalDays = (grade === 'echec') ? 0.02 : 0.5; // ~30 min ou 12h
        card.dueAt = now + card.intervalDays * 864e5;
        card.streak = (card.streak <= 0 ? card.streak - 1 : -1);
      } else { // bonne réponse (bien/facile)
        let next;
        if (card.intervalDays < 1e-6) next = 1;
        else if (card.intervalDays < 1.5) next = 6;
        else next = Math.round(card.intervalDays * EF);
        card.intervalDays = next;
        card.dueAt = now + next * 864e5;
        card.streak = (card.streak >= 0 ? card.streak + 1 : 1);
      }
      // Borne le streak
      card.streak = Math.max(-8, Math.min(12, card.streak));
    }

    // ------------------ Init ------------------
    function init() {
      // Demande un stockage persistant (évite l'éviction)
      if (navigator.storage && navigator.storage.persist) {
        navigator.storage.persist().then(granted => console.log('persist granted?', granted));
      }

      // Sauvegarde sur changements de visibilité / fermeture
      window.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'hidden') saveData();
      });
      window.addEventListener('pagehide', saveData);
      window.addEventListener('beforeunload', saveData);

      // Autosave périodique (toutes les 15s)
      setInterval(() => {
        saveData();
      }, 15000);

      // Sync multi-onglets: recharge si une autre tab a sauvé
      window.addEventListener('storage', (e) => {
        if (e.key === STORAGE_KEY && e.newValue) {
          try {
            data = JSON.parse(e.newValue);
            // re-rendu non intrusif
            renderByState(false);
          } catch (err) {}
        }
      });

      upgradeData();
      applyTheme();
      applyUI();
      syncFromRawFlashcards();
      Nav.clear();
      goDeck(false);
    }
    init();
  </script>
</body>
</html>
