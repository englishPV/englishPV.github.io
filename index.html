
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Flashcards 9:16</title>
  <style>
    :root{
      --bg:#0b1020;
      --surface:#12172b;
      --card:#161c33;
      --text:#e6ecff;
      --muted:#8aa0d3;
      --primary:#6366f1;
      --primary-600:#5457e6;
      --green:#22c55e;
      --blue:#3b82f6;
      --amber:#f59e0b;
      --red:#ef4444;
      --ring:#e5e7eb;
      --border:#232a48;

      --fs-term:20px;
      --fs-def:24px;
      --fs-front-list:16px;
      --fs-back-list:18px;
      --radius-md:14px;

      /* Tokens Boutons Dark (par d√©faut) */
      --btn-neutral-bg: rgba(255,255,255,.06);
      --btn-neutral-fg: #e6ecff;
      --btn-neutral-bd: #232a48;
      --btn-neutral-bg-h: rgba(255,255,255,.10);

      --btn-soft-primary-bg: color-mix(in srgb, var(--primary) 22%, transparent);
      --btn-soft-primary-bg-h: color-mix(in srgb, var(--primary) 34%, transparent);
      --btn-soft-primary-fg: #dbe4ff;
      --btn-soft-primary-bd: color-mix(in srgb, var(--primary) 55%, transparent);

      --btn-soft-red-bg: rgba(239,68,68,.18);
      --btn-soft-red-bg-h: rgba(239,68,68,.28);
      --btn-soft-red-fg: #fecaca;
      --btn-soft-red-bd: rgba(239,68,68,.45);

      --btn-soft-amber-bg: rgba(245,158,11,.18);
      --btn-soft-amber-bg-h: rgba(245,158,11,.28);
      --btn-soft-amber-fg: #fde68a;
      --btn-soft-amber-bd: rgba(245,158,11,.45);

      --btn-soft-blue-bg: rgba(59,130,246,.18);
      --btn-soft-blue-bg-h: rgba(59,130,246,.28);
      --btn-soft-blue-fg: #bfdbfe;
      --btn-soft-blue-bd: rgba(59,130,246,.45);

      --btn-soft-green-bg: rgba(34,197,94,.18);
      --btn-soft-green-bg-h: rgba(34,197,94,.28);
      --btn-soft-green-fg: #bbf7d0;
      --btn-soft-green-bd: rgba(34,197,94,.45);

      --btn-solid-primary-bg: var(--primary);
      --btn-solid-primary-bg-h: var(--primary-600);
      --btn-solid-primary-fg: #fff;
      --btn-solid-primary-bd: var(--primary-600);

      --btn-solid-red-bg:#ef4444;  --btn-solid-red-bg-h:#dc2626;  --btn-solid-red-fg:#fff;  --btn-solid-red-bd:#dc2626;
      --btn-solid-amber-bg:#f59e0b;--btn-solid-amber-bg-h:#d97706;--btn-solid-amber-fg:#0f172a;--btn-solid-amber-bd:#d97706;
      --btn-solid-blue-bg:#3b82f6; --btn-solid-blue-bg-h:#2563eb; --btn-solid-blue-fg:#fff;  --btn-solid-blue-bd:#2563eb;
      --btn-solid-green-bg:#22c55e;--btn-solid-green-bg-h:#16a34a;--btn-solid-green-fg:#0f172a;--btn-solid-green-bd:#16a34a;
    }

    :root[data-theme="light"]{
      --bg:linear-gradient(180deg,#f8fafc 0%,#eef2f7 100%);
      --surface:#ffffff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --primary:#3b82f6;
      --primary-600:#2563eb;
      --border:#cbd5e1;

      /* Tokens Boutons Light */
      --btn-neutral-bg:#f1f5f9;
      --btn-neutral-fg:#0f172a;
      --btn-neutral-bd:#cbd5e1;
      --btn-neutral-bg-h:#e2e8f0;

      --btn-soft-primary-bg: color-mix(in srgb, var(--primary) 14%, white 86%);
      --btn-soft-primary-bg-h: color-mix(in srgb, var(--primary) 22%, white 78%);
      --btn-soft-primary-fg: color-mix(in srgb, var(--primary) 78%, black 22%);
      --btn-soft-primary-bd: color-mix(in srgb, var(--primary) 35%, white 65%);

      --btn-soft-red-bg:#fee2e2;   --btn-soft-red-bg-h:#fecaca;   --btn-soft-red-fg:#991b1b;   --btn-soft-red-bd:#fca5a5;
      --btn-soft-amber-bg:#fef3c7; --btn-soft-amber-bg-h:#fde68a; --btn-soft-amber-fg:#92400e; --btn-soft-amber-bd:#fcd34d;
      --btn-soft-blue-bg:#dbeafe;  --btn-soft-blue-bg-h:#bfdbfe;  --btn-soft-blue-fg:#1e3a8a;  --btn-soft-blue-bd:#93c5fd;
      --btn-soft-green-bg:#dcfce7; --btn-soft-green-bg-h:#bbf7d0; --btn-soft-green-fg:#14532d; --btn-soft-green-bd:#86efac;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
      font-size:17px;
    }

    .wrapper{
      height:100dvh; width:100%;
      display:flex; align-items:center; justify-content:center;
      padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .phone{
      aspect-ratio:9/16;
      height:100%; width:auto; max-width:100%; max-height:100%;
      display:grid;
      grid-template-rows: var(--row-top,52px) var(--row-main,1fr) var(--row-actions,52px) var(--row-rev,64px);
      position:relative; min-height:0; touch-action:pan-y; overflow:hidden; background:transparent; border:0; border-radius:0; box-shadow:none;
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; padding:0 10px;
      background:transparent; border-bottom:0;
    }

    .topbar .back{
      appearance:none; border:0; outline:0; background:transparent; color:var(--text);
      padding:8px 10px; margin-right:4px; border-radius:10px;
      display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:700;
    }
    .topbar .back:hover{background:rgba(255,255,255,.06)}
    .topbar .title{font-weight:800; font-size:16px; letter-spacing:.2px; margin-left:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer;}
    .topbar .spacer{flex:1}

    main#view{
      min-height:0; height:100%;
      display:flex; flex-direction:column; overflow:hidden;
      padding:8px; gap:10px; justify-content:flex-start;
    }

    /* Utilities */
    .hidden{display:none!important}
    .muted{color:var(--muted)}
    .center{text-align:center}
    .mt6{margin-top:6px}
    .mt8{margin-top:8px}
    .scroll-y{overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; touch-action:pan-y;}
    .list{display:flex; flex-direction:column; gap:8px}
    .stack{display:flex; flex-direction:column; gap:6px}
    .flexcol{display:flex; flex-direction:column; min-height:0}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:6px}
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row-4{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; width:100%}
    .face-label{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.3px}

    /* Cards/containers base (flat) */
    .card,.deck-item,.review-card,.viewer,.card-item,.legend-item,.kpi .k,.stat,.chip{
      background:transparent; border:0; box-shadow:none;
      border-radius:var(--radius-md);
    }

    .section-title{font-weight:900; font-size:14px; color:var(--primary); letter-spacing:.3px; margin:0 0 6px}

    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .kpi .k{padding:0}
    .k .label{color:var(--muted); font-size:12px}
    .k .value{font-weight:900; font-size:17px; margin-top:2px}

    /* Deck list */
    .deck-wrap{display:flex; align-items:center; gap:8px}
    .decks{display:grid; grid-template-columns:1fr; gap:8px; flex:1}
    .deck-item{display:flex; align-items:center; justify-content:space-between; padding:0 8px; cursor:pointer; user-select:none; touch-action:pan-y;}
    .deck-item:hover{outline:none}
    .deck-meta{color:var(--muted); font-size:13px}

    /* Chips */
    .chip{display:inline-flex; align-items:center; gap:8px; padding:0; border-radius:0; color:var(--muted); cursor:pointer; user-select:none; font-size:12px}
    .chip.toggle{opacity:.75}
    .chip.toggle.active{opacity:1; border-color:#6b7cff; box-shadow:inset 0 0 0 1px rgba(107,124,255,.35)}
    .chip-pie{width:18px; height:18px; border-radius:50%;
      background:conic-gradient(var(--primary) var(--progress,0%), var(--border) var(--progress,0%)); display:inline-block; vertical-align:middle}
    .legend{display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:6px}
    .legend-item{display:flex; align-items:center; gap:6px; padding:0; font-size:13px; color:#dbe4ff; cursor:pointer; user-select:none; transition:opacity .15s ease, filter .15s ease}
    .legend-item.inactive{opacity:.45; filter:grayscale(20%)}
    .legend-item .count{font-weight:900}
    .legend-item[data-key="unseen"] .count{color:#9ca3af}
    .legend-item[data-key="echec"] .count{color:var(--red)}
    .legend-item[data-key="difficile"] .count{color:var(--amber)}
    .legend-item[data-key="bien"] .count{color:var(--blue)}
    .legend-item[data-key="facile"] .count{color:var(--green)}

    /* Dots */
    .dot{width:10px; height:10px; border-radius:50%}
    .dot.gray{background:#9ca3af}
    .dot.red{background:var(--red)}
    .dot.amber{background:var(--amber)}
    .dot.blue{background:var(--blue)}
    .dot.green{background:var(--green)}

    /* Chart */
    .chart-wrap{display:flex; align-items:center; justify-content:center; height:200px}
    canvas#gradeChart{width:180px; height:180px}

    /* Bottom bars */
    .bottom-actions{display:none; padding:8px 10px; gap:8px; grid-template-columns:1fr 1fr; background:transparent; border-top:0; box-shadow:none}
    .revision-bar{padding:8px 10px calc(8px + env(safe-area-inset-bottom)); background:transparent; border-top:0; box-shadow:none; display:none}
    .review-actions-bar{display:none; grid-row:4; padding:8px 10px calc(8px + env(safe-area-inset-bottom)); backdrop-filter:blur(8px) saturate(140%);}

    /* Review view */
    .review-wrap{position:relative; flex:1; min-height:0; display:flex; flex-direction:column; padding-bottom:0}
    .review-top{display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:13px}
    .review-card{flex:1; display:flex; align-items:center; justify-content:center; padding:8px; text-align:center; min-height:0; cursor:auto;}
    .review-card .review-scroller {
      max-height:100%; width:100%;
      overflow:auto; -webkit-overflow-scrolling:touch;
    }

    .size-toast{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:calc(64px + env(safe-area-inset-bottom) + 8px);
      background:rgba(0,0,0,.55); color:#fff; font-weight:800; font-size:12px; padding:6px 10px; border-radius:999px;
      pointer-events:none; z-index:3; display:none;
    }
    :root[data-theme="light"] .size-toast{background:rgba(0,0,0,.15); color:#0f172a}

    /* Cards view */
    .cards-wrap{display:flex; flex-direction:column; gap:8px; height:100%}
    .cards-top{display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px}
    .viewer{flex:1; display:flex; align-items:center; justify-content:center; padding:12px; text-align:center}
    .viewer .front{font-weight:900; font-size:20px}
    .viewer .back{color:#d9e6ff; opacity:.95; font-size:15px; margin-top:6px}
    .viewer-actions{display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px}
    .small{font-size:13px; color:var(--muted)}

    /* Recap */
    .recap{display:flex; flex-direction:column; gap:8px}
    .recap h2{margin:0; font-size:18px}
    .recap .subtitle{color:var(--muted); margin-top:-2px; font-size:12px}
    .stat{padding:0}
    .label{color:var(--muted); font-size:11px}
    .val{font-weight:900; font-size:16px; margin-top:2px}
    .cta{margin-top:4px}

    /* Typo sizes */
    .term{font-size:var(--fs-term)!important; font-weight:600}
    .definition{font-size:var(--fs-def)!important; font-weight:900}
    .card-item .front{font-size:var(--fs-front-list); font-weight:600}
    .card-item .back{font-size:var(--fs-back-list); font-weight:800; color:var(--text); opacity:.95}

    /* Wheel control */
    .wheel{
      display:flex; align-items:center; gap:12px; padding:10px 12px;
      border:1px solid var(--border); border-radius:var(--radius-md);
      background:rgba(255,255,255,.04); touch-action:none; user-select:none; cursor:ns-resize;
    }
    .wheel .name{font-weight:800; font-size:13px}
    .wheel .hint{color:var(--muted); font-size:12px}
    .wheel .wheel-value{margin-left:auto; font-weight:900; font-size:13px}

    /* Settings */
    .settings-page{display:flex; flex-direction:column; gap:14px; padding:6px 4px}
    .settings-hero{font-weight:900; font-size:18px; letter-spacing:.2px; color:var(--primary)}
    .settings-sub{color:var(--muted); font-size:12px; margin-top:-2px}
    .settings-section{display:flex; flex-direction:column; gap:8px}
    .settings-section .section-title{font-size:12px; font-weight:900; color:var(--primary); letter-spacing:.4px; text-transform:uppercase; margin:10px 0 2px!important}
    .swatches{display:flex; gap:8px; flex-wrap:wrap}
    .swatch{width:26px; height:26px; border-radius:8px; border:1px solid var(--border); background:var(--sw,#6366f1); cursor:pointer; position:relative}
    .swatch.is-active::after{content:''; position:absolute; inset:-3px; border:2px solid var(--primary); border-radius:10px}

    /* 7-day activity */
    .bar7-wrap{margin-top:8px}
    canvas#bar7{width:100%; height:68px; display:block}
    .bar7-labels{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:4px; font-size:12px; color:var(--muted); text-align:center}
    .bar7-labels > div { cursor: pointer; }

    /* Cards grid */
    .cards-grid{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:480px){.cards-grid{grid-template-columns:1fr 1fr}}
    @media(min-width:900px){.cards-grid{grid-template-columns:1fr 1fr 1fr}}
    .card-block{position:relative; border:2px solid transparent; border-radius:14px; padding:14px; background:transparent; overflow-x: auto;}
    .card-block .term{text-align:center}
    .card-block .definition{display:none; text-align:center; margin-top:6px}
    .card-block.flipped .definition{display:block}
    .cb-time{position:absolute; right:10px; bottom:8px; font-size:12px; color:var(--muted)}
    .card-block.grade-echec{border-color:var(--red)}
    .card-block.grade-difficile{border-color:var(--amber)}
    .card-block.grade-bien{border-color:var(--blue)}
    .card-block.grade-facile{border-color:var(--green)}
    .card-block.grade-unseen{border-color:#9ca3af}

    /* Styles consolid√©s pour les images */
    .review-card img,
    .card-block img {
      display: block;
      max-width: 100%;
      height: auto;
      margin: 10px auto;
      border-radius: 8px;
      background: var(--border);
      -webkit-user-drag: none;
      user-select: none;
    }
    .review-card img {
      cursor: zoom-in;
      touch-action: none; /* Les gestes sont g√©r√©s par JS pour la Lightbox */
    }
    .card-block img {
       touch-action: pan-y; /* Permet le scroll vertical dans la liste de cartes */
    }

    /* Wrapper pour le zoom d'image en r√©vision */
    .zoom-wrap {
      display: inline-block;
      max-width: none;
    }

    /* Light theme boosts */
    :root[data-theme="light"] .definition,
    :root[data-theme="light"] .card-item .back{color:var(--text)!important; opacity:1!important}
    :root[data-theme="light"] .muted{color:#475569!important}
    :root[data-theme="light"] .legend-item{color:#0f172a!important; border-color:#e2e8f0!important; background:transparent!important}
    :root[data-theme="light"] .chip{color:#334155!important; border-color:#cbd5e1!important; background:#f8fafc!important}
    :root[data-theme="light"] .revision-bar,
    :root[data-theme="light"] .review-actions-bar {
      background:rgba(241,245,249,.9) !important;
      border-top:1px solid #e2e8f0!important;
    }
    :root[data-theme="light"] .topbar{
      background:transparent!important;
      border-bottom:1px solid #e2e8f0!important;
    }

    /* === SYST√àME DE BOUTONS AVEC VARIANTES (SOFT/SOLID) === */
    .btn,
    .bottom-actions .action,
    .navbtn,
    .review-actions-bar .btn,
    .rev-btn{
      background: var(--btn-bg, var(--btn-neutral-bg));
      color: var(--btn-fg, var(--btn-neutral-fg));
      border: 1px solid var(--btn-bd, var(--btn-neutral-bd));
      border-radius: var(--radius-md);
      padding: 10px 12px;
      font-weight: 900;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, color .15s ease, box-shadow .15s ease;
      width: 100%;
      appearance: none;
      outline: 0;
      font-size: 15px;
    }
    .btn:hover,
    .bottom-actions .action:hover,
    .navbtn:hover,
    .review-actions-bar .btn:hover,
    .rev-btn:hover{
      background: var(--btn-bg-h, var(--btn-bg, var(--btn-neutral-bg-h)));
    }
    .btn:disabled, .rev-btn:disabled, .navbtn:disabled, .action:disabled {opacity:.6; cursor:not-allowed}
    .btn:focus-visible{outline:2px solid var(--btn-bd, var(--btn-neutral-bd)); outline-offset:2px}

    /* Variantes SOFT (pastel) */
    .btn--primary{ --btn-bg:var(--btn-soft-primary-bg); --btn-bg-h:var(--btn-soft-primary-bg-h); --btn-fg:var(--btn-soft-primary-fg); --btn-bd:var(--btn-soft-primary-bd); }
    .btn--red    { --btn-bg:var(--btn-soft-red-bg);     --btn-bg-h:var(--btn-soft-red-bg-h);     --btn-fg:var(--btn-soft-red-fg);     --btn-bd:var(--btn-soft-red-bd); }
    .btn--amber  { --btn-bg:var(--btn-soft-amber-bg);   --btn-bg-h:var(--btn-soft-amber-bg-h);   --btn-fg:var(--btn-soft-amber-fg);   --btn-bd:var(--btn-soft-amber-bd); }
    .btn--blue   { --btn-bg:var(--btn-soft-blue-bg);    --btn-bg-h:var(--btn-soft-blue-bg-h);    --btn-fg:var(--btn-soft-blue-fg);    --btn-bd:var(--btn-soft-blue-bd); }
    .btn--green  { --btn-bg:var(--btn-soft-green-bg);   --btn-bg-h:var(--btn-soft-green-bg-h);   --btn-fg:var(--btn-soft-green-fg);   --btn-bd:var(--btn-soft-green-bd); }

    /* Ton SOLID (plein) ‚Äì combine avec la couleur */
    .btn--solid.btn--primary{ --btn-bg:var(--btn-solid-primary-bg); --btn-bg-h:var(--btn-solid-primary-bg-h); --btn-fg:var(--btn-solid-primary-fg); --btn-bd:var(--btn-solid-primary-bd); }
    .btn--solid.btn--red    { --btn-bg:var(--btn-solid-red-bg);     --btn-bg-h:var(--btn-solid-red-bg-h);     --btn-fg:var(--btn-solid-red-fg);     --btn-bd:var(--btn-solid-red-bd); }
    .btn--solid.btn--amber  { --btn-bg:var(--btn-solid-amber-bg);   --btn-bg-h:var(--btn-solid-amber-bg-h);   --btn-fg:var(--btn-solid-amber-fg);   --btn-bd:var(--btn-solid-amber-bd); }
    .btn--solid.btn--blue   { --btn-bg:var(--btn-solid-blue-bg);    --btn-bg-h:var(--btn-solid-blue-bg-h);    --btn-fg:var(--btn-solid-blue-fg);    --btn-bd:var(--btn-solid-blue-bd); }
    .btn--solid.btn--green  { --btn-bg:var(--btn-solid-green-bg);   --btn-bg-h:var(--btn-solid-green-bg-h);   --btn-fg:var(--btn-solid-green-fg);   --btn-bd:var(--btn-solid-green-bd); }

    /* Desktop wide */
    @media (pointer:fine) and (min-width:1024px){
      .phone{aspect-ratio:auto; width:100%; height:100dvh}
      .topbar, main#view, .bottom-actions, .revision-bar{max-width:1200px; margin:0 auto; width:100%}
      main#view{padding:16px 20px}
    }

    /* Subject menu (s√©lecteur de mati√®re) */
    .subject-menu{
      position: absolute;
      top: 52px;
      left: 10px;
      background: var(--surface);
      color: var(--text);
      border:1px solid var(--border);
      border-radius: var(--radius-md);
      min-width: 220px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding: 6px;
      z-index: 1000;
      display:none;
    }
    .subject-item{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:10px; cursor:pointer;
    }
    .subject-item:hover{ background: rgba(255,255,255,.06) }
    .subject-item .name{ font-weight:800; flex:1 }
    .subject-item .meta{ font-size:12px; color:var(--muted) }
    :root[data-theme="light"] .subject-item:hover{ background: rgba(0,0,0,.06) }

    /* === LIGHTBOX IMAGE VIEWER === */
    .img-lightbox{
      position:fixed; inset:0;
      display:none; /* on affiche via .open */
      background:transparent; /* pas de flou, pas d'assombrissement */
      z-index:10000;
    }
    .img-lightbox.open{ display:block; }

    /* Surface de geste: 100% de l‚Äô√©cran, drag/pinch/zoom partout */
    .img-stage{
      position:absolute; inset:0;
      width:100%; height:100%;
      overflow:hidden;
      touch-action:none;      /* on g√®re le pan/zoom nous-m√™mes */
      cursor:grab;
    }

    /* Canvas transform√© (pan/zoom via translate+scale) */
    .img-canvas{
      position:absolute; top:0; left:0;
      transform:translate(0px,0px) scale(1);
      transform-origin:0 0;
      will-change:transform;
    }
    .img-canvas img{
      display:block;
      width:100%; height:auto;
      user-select:none; -webkit-user-drag:none;
      pointer-events:none; /* toute la surface sert aux gestes */
    }
    .img-counter{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:16px; z-index:2;
      background:rgba(255,255,255,.9); color:#0f172a;
      padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px;
    }
    
    /* Light/clair */
    :root[data-theme="light"] .img-close,
    :root[data-theme="light"] .img-nav{ color:#0f172a; background:rgba(255,255,255,.9); border-color:#e2e8f0; }
    :root[data-theme="light"] .img-counter{ background:rgba(255,255,255,.9); color:#0f172a; }

    /* NOUVEAUX STYLES */
    /* Boutons decks minimalistes */
    .btn--ghost { --btn-bg:transparent; --btn-bg-h:rgba(255,255,255,.06); --btn-fg:var(--muted); --btn-bd:var(--border); }
    :root[data-theme="light"] .btn--ghost{ --btn-bg-h:rgba(0,0,0,.06); }
    .btn--tiny { padding:6px 8px; font-size:13px; border-radius:8px; }

    /* En-t√™te deck */
    .deck-head{ display:flex; align-items:center; justify-content:space-between; gap:8px }
    .deck-head .actions{ display:flex; gap:6px }
    .deck-item .title-line {
  -webkit-user-select: none; /* Safari, Chrome */
  -moz-user-select: none;    /* Firefox */
  -ms-user-select: none;     /* IE/Edge */
  user-select: none;         /* Standard */
}
    /* Indicateur groupe */
    .deck-item .folder-badge{ font-size:12px; color:var(--muted) }

    /* Swipe gauche pour supprimer */
    .deck-item{ position:relative; overflow:hidden; }
    .deck-item .slide{ display:flex; align-items:center; gap:8px; padding:8px 0; transition: transform .18s ease; will-change: transform; }
    .deck-item .right-action{ position:absolute; top:0; right:0; height:100%; width:92px; display:flex; align-items:center; justify-content:center; }
    .deck-item.reveal-delete .slide{ transform: translateX(-92px); }

    /* Drag & drop */
    .drag-ghost{
      position: fixed; left:0; top:0; pointer-events:none; z-index: 9999;
      transform: translate(-9999px,-9999px) scale(1.02);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      border-radius: var(--radius-md);
      background: rgba(0,0,0,.08);
    }
    :root[data-theme="light"] .drag-ghost{ background: rgba(0,0,0,.06) }

    .deck-item.drop-target{ outline: 2px dashed var(--primary); outline-offset: -2px; border-radius: var(--radius-md); background: color-mix(in srgb, var(--primary) 8%, transparent); }
    .deck-item.dragging-origin{ opacity:.3 }

    body.dragging-active, .dragging-active * {
      cursor: grabbing !important;
    }

  </style>
</head>
<body>
  <div class="wrapper">
    <div class="phone" id="app">
      <header class="topbar">
        <button class="back" id="backBtn" title="Retour"><span aria-hidden="true">‚Üê</span><span>Retour</span></button>
        <div class="title" id="title">Deck</div>
        <div class="spacer"></div>
      </header>

      <main id="view"></main>

      <div class="bottom-actions" id="bottomActions">
        <button class="action btn" id="cardsBtn">Cartes</button>
        <button class="action btn" id="settingsBtn">Param√®tres</button>
      </div>

      <footer class="revision-bar" id="revisionBar">
        <button id="startReviewBtn" class="rev-btn btn btn--solid btn--primary">R√©vision ‚Ä¢ 10 cartes</button>
      </footer>

      <footer id="reviewActionsBar" class="review-actions-bar" aria-live="polite"></footer>
    </div>
  </div>

  <script>
    // ---------- Donn√©es & stockage ----------
    const STORAGE_KEY = 'flash9x16_data_v3';
    const APP_VERSION = '2025-10-02-1'; // incr√©mente √† chaque publication de contenu
    // Cat√©gories Anglais
    const CD="Democracy",CG="Genetics",CI="Immigration",CIT="International Relations",CU="Labor",CR="Crime",PC="Capital Punishment",CF="Status of Women";
    // Chapitres Physique (constantes pratiques pour le raw)
    const PM = "M2";
    const PM3 = "M3";

    // Emojis chapitres
    const CHAPTER_EMOJIS = {
      [CD]:'üèõÔ∏è',[CG]:'üß¨',[CI]:'üß≥',[CIT]:'üåê',[CU]:'üíº',[CR]:'‚öñÔ∏è',[PC]:'üíÄ',[CF]:'‚ôÄÔ∏è',
      'Politique':'üèõÔ∏è','Business':'üíº','Education':'üéì','Thanksgiving':'ü¶É',
      // === Physique (nouvelles mati√®res/chapitres) ===
      'M2':'‚öôÔ∏è',
      'M3':'üåç',

    };

    // Liste brute Anglais (id|fr|en|chap)
    const cardsRawText = `
0|monarchie|monarchy|${CD}
1|monarque de droit divin|a monarch by divine right|${CD}
2|souverain|sovereign|${CD}
3|aristocratie|aristocracy|${CD}
4|oligarchie|oligarchy|${CD}
5|dictateur|a dictator|${CD}
6|dictature|dictatorship|${CD}
7|autoritaire|authoritarian|${CD}
8|autoritarisme|authoritarianism|${CD}
9|totalitaire|totalitarian|${CD}
10|totalitarisme|totalitarianism|${CD}
11|homme fort|a strongman|${CD}
12|tyran|a tyrant, an autocrat|${CD}
13|despote|a despot|${CD}
14|despote √©clair√©|an enlightened despot|${CD}
15|junte militaire|a military junta|${CD}
16|coup d'√âtat|a coup, a coup d'√©tat|${CD}
17|gouvernement autoritaire|a regime|${CD}
18|r√©gime de Vichy / de Pinochet|the Vichy / Pinochet regime|${CD}
19|r√©gime r√©pressif|a repressive regime|${CD}
20|r√©gime politique|a political system|${CD}
21|se d√©mocratiser|to become more democratic|${CD}
22|prendre le pouvoir|to take, seize power|${CD}
23|arriver au pouvoir|to come to power|${CD}
24|arriver au pouvoir (d√©mocratiquement)|to come into office|${CD}
25|√™tre au pouvoir|to be in power|${CD}
26|rester au pouvoir|to remain, stay in power|${CD}
27|s'accrocher au pouvoir|to cling to power|${CD}
28|bonne gouvernance|good governance|${CD}
29|mal administrer, mal g√©rer|to misrule, mismanage|${CD}
30|mauvaise administration|misrule|${CD}
31|mauvaise gestion|mismanagement|${CD}
32|tenir un dirigeant pour responsable|to hold a leader to account|${CD}
33|√™tre responsable devant les √©lecteurs|to be accountable to the electorate|${CD}
34|responsabilit√©|accountability|${CD}
35|corruption|corruption, sleaze, bribery|${CD}
36|corrompu|corrupt|${CD}
37|pot-de-vin|a bribe|${CD}
38|acheter, soudoyer qn|to bribe sb|${CD}
39|√©tat de droit, r√®gne de la loi|the rule of law|${CD}
40|multipartisme|multi-party system|${CD}
41|syst√®me de parti unique|single-party system|${CD}
42|√©lections libres et r√©guli√®res|free and fair elections|${CD}
43|fraude √©lectorale|vote rigging, ballot rigging, electoral fraud|${CD}
44|l'√©lection √©tait truqu√©e|the election was rigged|${CD}
45|opposant politique|a political opponent|${CD}
46|dissident|a dissident|${CD}
47|b√¢illonner / museler la presse / l'opposition|to gag / muzzle the press / the opposition|${CD}
48|d√©clarer l'√©tat d'urgence|to declare a state of emergency|${CD}
49|bafouer la constitution|to trample the constitution|${CD}
50|censurer|to censor|${CD}
51|censure|censorship|${CD}
52|bloquer / restreindre l'acc√®s √† internet|to block / restrict internet access|${CD}
53|contourner la censure|to circumvent, bypass censorship|${CD}
54|droits de l'homme|human rights|${CD}
55|atteintes aux droits de l'homme|human rights abuses, violations|${CD}
56|crime contre l'humanit√©|a crime against humanity|${CD}
57|devoir d'ing√©rence|the duty to interfere, to intervene|${CD}
58|association de d√©fense des droits de l'homme|human Rights lobby|${CD}
59|pass√© de la Chine en mati√®re de droits de l'homme|China's human rights record|${CD}
60|m√©contentement, malaise|discontent|${CD}
61|provoquer des troubles|to spark unrest|${CD}
62|agitation|turmoil|${CD}
63|bouleversement|an upheaval|${CD}
64|fomenter des troubles|to stir up trouble|${CD}
65|insurg√©|an insurgent|${CD}
66|insurrection|an insurgency|${CD}
67|manifestation|a demonstration, a protest march|${CD}
68|manifestant|a demonstrator, a protester|${CD}
69|organiser / participer √† un rassemblement|to hold / attend a rally|${CD}
70|√©meute|a riot|${CD}
71|√©meutier, casseur|a rioter|${CD}
72|des √©meutes ont √©clat√©|riots broke out|${CD}
73|CRS|anti-riot police|${CD}
74|cocktail Molotov|a petrol bomb, a Molotov cocktail|${CD}
75|gaz lacrymog√®ne|tear gas|${CD}
76|heurt, affrontement|a clash|${CD}
77|√©chauffour√©e|a skirmish|${CD}
78|complot|a plot|${CD}
79|comploteur|a plotter|${CD}
80|se r√©volter|to revolt|${CD}
81|se rebeller|to rebel|${CD}
82|rebelle|a rebel|${CD}
83|r√©bellion, r√©volte|a rebellion|${CD}
84|d√©jouer les autorit√©s|to defy the authorities|${CD}
85|soul√®vement|an uprising|${CD}
86|se soulever contre|to rise up against|${CD}
87|renverser un dictateur|to overthrow, to topple a dictator|${CD}
88|√©vincer un dictateur|to oust a dictator|${CD}
89|renversement d'un dictateur|the overthrow of a dictator|${CD}
90|d√©poser un dirigeant|to depose a ruler|${CD}
91|s'effondrer|to collapse|${CD}
92|restaurer la d√©mocratie|to restore democracy|${CD}
93|chute d'un gouvernement|the downfall of a government|${CD}
94|r√©pression brutale|ruthless repression|${CD}
95|r√©primer une r√©bellion|to put down, to suppress a rebellion|${CD}
96|r√©primer, √©touffer la contestation|to quell the protests|${CD}
97|mesures de r√©pression|crackdown, clampdown|${CD}
98|mettre les gens en prison|to send people to prison|${CD}
99|passer qn √† tabac|to beat sb up|${CD}
100|g√®ne|a gene|${CG}
101|cellule|a cell|${CG}
102|cellules-souches|stem cells|${CG}
103|recherche sur les cellules souches|stem-cell research|${CG}
104|g√©nome humain|the human genome|${CG}
105|cartographie du g√©nome|genome mapping|${CG}
106|carte g√©n√©tique|gene map, genetic map|${CG}
107|s√©quence g√©n√©tique|gene sequence|${CG}
108|s√©quen√ßage|sequencing|${CG}
109|√©pissage du g√®ne|gene splicing|${CG}
110|patrimoine h√©r√©ditaire|gene pool|${CG}
111|g√©n√©ticien|a geneticist|${CG}
112|eug√©nisme|eugenics|${CG}
113|eug√©niste, partisan de l'eug√©nisme|a eugenicist|${CG}
114|ADN|DNA|${CG}
115|test g√©n√©tique|a DNA test|${CG}
116|empreinte g√©n√©tique|a DNA print, genetic print|${CG}
117|analyse ADN|DNA analysis|${CG}
118|pr√©l√®vement d'ADN|a DNA sample|${CG}
119|profil g√©n√©tique|genetic make-up, genetic profile|${CG}
120|analyse de l'empreinte g√©n√©tique|genetic profiling, DNA fingerprinting|${CG}
121|d√©pistage g√©n√©tique|genetic screening|${CG}
122|subir un pr√©l√®vement d'ADN|to be DNA-swabbed|${CG}
123|manipulations g√©n√©tiques, g√©nie g√©n√©tique|genetic engineering|${CG}
124|transg√©nique|transgenic|${CG}
125|organisme g√©n√©tiquement modifi√©|a genetically modified organism|${CG}
126|OGM|GMOs|${CG}
127|aliments contenant des OGM|GM food|${CG}
128|pommes de terres g√©n√©tiquement modifi√©es|GM potatoes|${CG}
129|produits transg√©niques|biotech products|${CG}
130|semence, graines|seed|${CG}
131|soja|soyabeans|${CG}
132|colza|rapeseed|${CG}
133|ma√Øs|maize (GB), corn (US)|${CG}
134|bl√©|wheat|${CG}
135|culture, r√©colte|a crop|${CG}
136|essais sur le terrain|field trials, crop trials|${CG}
137|culture OGM|a GM crop|${CG}
138|rendement|yield|${CG}
139|fili√®re agroalimentaire|agribusiness|${CG}
140|augmenter, am√©liorer les rendements|to improve yields|${CG}
141|r√©sistant aux maladies|resistant to disease|${CG}
142|insecticide / pesticide / herbicide|insecticide / pesticide / herbicide|${CG}
143|polliniser|to pollinate|${CG}
144|pollinisation crois√©e|cross-pollination|${CG}
145|contaminer|to contaminate|${CG}
146|contamination|contamination|${CG}
147|maladie g√©n√©tique|a genetic disease|${CG}
148|g√®ne d√©fectueux|a faulty gene|${CG}
149|g√®ne manquant|a missing gene|${CG}
150|h√©r√©ditaire|hereditary|${CG}
151|chromosome X / Y|an X / Y chromosome|${CG}
152|clonage|cloning|${CG}
153|conseil g√©n√©tique|genetic counselling|${CG}
154|entreprise pharmaceutique|a pharmaceutical company|${CG}
155|th√©rapie g√©nique|gene therapy|${CG}
156|traitement g√©nique|genetic treatment|${CG}
157|√† des fins th√©rapeutiques|for therapeutic purposes|${CG}
158|agriculture au service de la m√©decine|pharming|${CG}
159|jouer √† l'apprenti-sorcier|to play God|${CG}
160|toucher √† la nature|to tamper with nature|${CG}
161|principe de pr√©caution|the precautionary principle, the safety-first principle|${CG}
162|√©tiquette|a label|${CG}
163|√©tiquetter|to label|${CG}
164|√©tiquetage|labelling|${CG}
165|avertir|to warn|${CG}
166|avertissement|a warning|${CG}
167|dont l'origine peut √™tre √©tablie|traceable|${CG}
168|tra√ßabilit√©|traceability|${CG}
169|effets √† long terme|long-term effects|${CG}
170|cha√Æne alimentaire|the food chain|${CG}
171|s√©curit√© alimentaire|food security|${CG}
172|lobby OGM|the pro-GM lobby|${CG}
173|militants contre les OGM|anti-GM activists|${CG}
174|campagne contre les OGM|an anti-GM campaign|${CG}
175|√©tranger|a foreigner|${CI}
176|inconnu|a stranger|${CI}
177|nationalit√©|nationality|${CI}
178|ressortissant √©tranger|a foreign national|${CI}
179|personnes de nationalit√© fran√ßaise|French citizens|${CI}
180|√©migrer en Nouvelle-Z√©lande|to emigrate to New Zealand|${CI}
181|immigrer en France|to immigrate to France|${CI}
182|vague d'immigration|a wave of immigration|${CI}
183|immigration √† grande √©chelle / de masse|large-scale / mass immigration|${CI}
184|exode|an exodus|${CI}
185|nouvel arrivant|a newcomer|${CI}
186|pays natal, pays d'origine|native country, home country|${CI}
187|patrie|homeland|${CI}
188|pays d'accueil|a host country|${CI}
189|pays d'adoption|an adoptive country, a country of adoption|${CI}
190|accueillir|to welcome|${CI}
191|accueillant|welcoming|${CI}
192|politique migratoire|immigration policy|${CI}
193|immigration choisie|selective immigration, controlled immigration|${CI}
194|flux migratoires|migration flows|${CI}
195|passager clandestin|a stowaway|${CI}
196|immigration clandestine, irr√©guli√®re|illegal immigration|${CI}
197|immigration sauvage|uncontrolled immigration|${CI}
198|immigrant clandestin, sans-papiers|an illegal immigrant, an illegal alien, an undocumented alien|${CI}
199|il est en situation irr√©guli√®re|his papers are not in order|${CI}
200|fronti√®re|a border, a frontier|${CI}
201|fermer ses fronti√®res|to close one's borders|${CI}
202|contr√¥les aux fronti√®res|border controls|${CI}
203|contr√¥les d'identit√©|identity checks|${CI}
204|centre de r√©tention (administrative)|a holding centre, a detention facility|${CI}
205|passeport|a passport|${CI}
206|carte d'identit√©|an identity card|${CI}
207|visa|a visa|${CI}
208|r√©fugi√©|a refugee|${CI}
209|personne d√©plac√©e|a displaced person|${CI}
210|apatride|a stateless person|${CI}
211|se r√©fugier|to take refuge, take shelter|${CI}
212|demander l'asile politique|to seek political asylum|${CI}
213|demandeur d'asile|an asylum-seeker|${CI}
214|fuir la pers√©cution / la mis√®re|to flee persecution / destitution|${CI}
215|√©chapper √† la pauvret√©|to escape poverty|${CI}
216|chercher de meilleures conditions de vie|to be in search of better living conditions|${CI}
217|trafic des √™tres humains|human trafficking|${CI}
218|contrebandier, passeur|a smuggler|${CI}
219|passeurs d'immigrants clandestins|people-smugglers|${CI}
220|r√©seau de passeurs|a smuggling ring|${CI}
221|faux passeport|a fake passport|${CI}
222|reconduire qn √† la fronti√®re|to escort sb back to the border|${CI}
223|renvoyer un immigrant dans son pays d'origine|to send an immigrant back to his native country|${CI}
224|expulser qn|to deport sb|${CI}
225|√™tre refoul√© √† la fronti√®re|to be turned away at the border|${CI}
226|√™tre expuls√©|to be ordered out of the country|${CI}
227|s'exiler|to go into exile|${CI}
228|exil√©|an exile|${CI}
229|exiler, bannir qn|to exile, banish sb|${CI}
230|s'expatrier|to expatriate oneself|${CI}
231|expatri√©|an expatriate, an expat|${CI}
232|passer √† l'Ouest / √† l'ennemi|to defect to the West / to the enemy|${CI}
233|fuite des cerveaux / afflux des cerveaux|brain drain / brain gain|${CI}
234|partir de rien|to start from scratch|${CI}
235|travail au noir|moonlighting|${CI}
236|atelier clandestin|a sweatshop|${CI}
237|exploiter les travailleurs immigr√©s|to exploit migrant workers|${CI}
238|permis de travail, carte de travail|a work permit|${CI}
239|permis de s√©jour, carte de s√©jour|a residence permit, a resident permit|${CI}
240|travailleur migrant|a migrant worker|${CI}
241|travailleur invit√© (disposant d'un visa temporaire)|a guest worker|${CI}
242|s'int√©grer|to become integrated|${CI}
243|bien s'int√©grer dans une soci√©t√©|to integrate well into a society|${CI}
244|insertion sociale|social integration|${CI}
245|r√©gulariser la situation des clandestins|to regularise the status of illegal immigrants|${CI}
246|r√©gularisation|regularisation|${CI}
247|se faire naturaliser britannique, √™tre naturalis√© britannique, obtenir la nationalit√© britannique|to be granted British citizenship, to become a British citizen|${CI}
248|quota|a quota|${CI}
249|regroupement familial|family reunion, reunification|${CI}
250|qn qui abuse du syst√®me des prestations sociales|a benefit cheat|${CI}
251|fraude aux prestations sociales|benefit fraud|${CI}
252|parasite|a freeloader|${CI}
253|mariage blanc|a sham marriage, a marriage of convenience|${CI}
254|inonder|to flood|${CI}
255|√™tre envahi par les √©trangers|to be swamped with foreigners|${CI}
256|arriv√©e massive, afflux de travailleurs|the influx of workers|${CI}
257|endiguer l'afflux d'immigr√©s|to stem the flow of immigrants|${CI}
258|limiter / freiner l'immigration|to restrict / curb immigration|${CI}
259|parti d'extr√™me-droite|a far-right party|${CI}
260|faire fuir les immigrants|to scare immigrants away|${CI}
261|emp√™cher les ind√©sirables d'entrer|to keep out undesirables|${CI}
262|x√©nophobie|xenophobia|${CI}
263|x√©nophobe|xenophobic|${CI}
264|avoir un grand-p√®re n√© √† l'√©tranger|to have a foreign-born grandfather|${CI}
265|jeunes gens d'origine asiatique / portugaise|young men of Asian / Portuguese descent|${CI}
266|Fran√ßais de naissance|a native of France|${CI}
267|New Yorkais de souche|a born and bred New Yorker|${CI}
268|il est fran√ßais de souche|he's of French origin, of French extraction|${CI}
269|Maghreb|North Africa|${CI}
270|Maghr√©bins|North Africans|${CI}
271|pakistanais / du Bangladesh|Pakistani / Bangladeshi|${CI}
272|hispanophone / parlant le Hindi|Spanish-speaking / Hindi-speaking|${CI}
273|diaspora|diaspora|${CI}
274|affaires √©trang√®res|foreign affairs|${CIT}
275|relations ext√©rieures|foreign relations|${CIT}
276|communaut√© internationale|the international community|${CIT}
277|probl√®me mondial, plan√©taire|a global issue|${CIT}
278|√âtat souverain|a sovereign state|${CIT}
279|souverainet√©|sovereignty|${CIT}
280|√âtat-nation|a nation-state|${CIT}
281|fronti√®re|a border, a frontier|${CIT}
282|droit international|international law|${CIT}
283|g√©opolitique|geopolitics|${CIT}
284|sc√®ne internationale|the international stage, the international scene, the world stage|${CIT}
285|jouer un r√¥le dans qch|to play a role, a part in sth|${CIT}
286|occidental / oriental|western / eastern|${CIT}
287|politique √©trang√®re, ext√©rieure|foreign policy|${CIT}
288|ambassadeur|an ambassador|${CIT}
289|ambassade|an embassy|${CIT}
290|attach√© culturel / commercial / militaire|a cultural / commercial / military attach√©|${CIT}
291|envoy√©, √©missaire|an envoy, an emissary|${CIT}
292|diplomate|a diplomat|${CIT}
293|diplomatie|diplomacy|${CIT}
294|rompre / reprendre les relations|to break off / resume diplomatic relations|${CIT}
295|relations tendues|tense, strained relations|${CIT}
296|r√©chauffement|a thaw|${CIT}
297|refroidissement|a chill, a cooling off|${CIT}
298|rappeler un ambassadeur|to recall an ambassador|${CIT}
299|normaliser les relations|to normalize relations|${CIT}
300|grande puissance|a great power|${CIT}
301|superpuissance / hyperpuissance|a superpower / a hyperpower|${CIT}
302|h√©g√©monie|hegemony|${CIT}
303|imp√©rialisme|imperialism|${CIT}
304|imp√©rialiste|imperialistic|${CIT}
305|expansionisme|expansionism|${CIT}
306|unilat√©ralisme / multilat√©ralisme|unilateralism / multilateralism|${CIT}
307|bilat√©ral / multilat√©ral|bilateral / multilateral|${CIT}
308|bipolaire / multipolaire|bipolar / multipolar|${CIT}
309|bloc|a bloc|${CIT}
310|√©quilibre des forces|balance of power|${CIT}
311|syst√®me onusien|the UN system|${CIT}
312|√âtat-membre, pays membre|a member state|${CIT}
313|membre fondateur|a founding member, founder member|${CIT}
314|cotisation|a contribution|${CIT}
315|discuter / voter une r√©solution|to debate / to pass a resolution|${CIT}
316|appliquer une r√©solution|to implement, enforce a resolution|${CIT}
317|autoriser l'usage de la force|to authorize the use of force|${CIT}
318|embargo|an embargo|${CIT}
319|majorit√© des deux-tiers|a two-thirds majority|${CIT}
320|maintenir la paix|to maintain peace|${CIT}
321|op√©ration de maintien de la paix|a peace-keeping operation|${CIT}
322|soldat de la paix|a peacekeeper|${CIT}
323|casque bleu|a blue helmet|${CIT}
324|devoir d'ing√©rence|the duty to interfere, to intervene|${CIT}
325|intervention militaire|military intervention|${CIT}
326|OTAN|NATO, the North Atlantic Treaty Organization|${CIT}
327|n√©gocier|to negotiate|${CIT}
328|n√©gociations, pourparlers, discussions|negotiations, talks|${CIT}
329|table des n√©gociations|negotiating table|${CIT}
330|table ronde|a round table|${CIT}
331|faire une d√©claration|to make, issue, deliver a statement|${CIT}
332|communiqu√©|a communiqu√©|${CIT}
333|sous l'√©gide de|under the aegis of|${CIT}
334|r√©union au sommet, sommet|a summit (meeting)|${CIT}
335|porte-parole|a spokesman, spokeswoman, spokesperson|${CIT}
336|homologue|a counterpart, an opposite number|${CIT}
337|impasse|a stalemate, a deadlock, a standoff, an impasse|${CIT}
338|aboutir √† une impasse|to reach a stalemate|${CIT}
339|sortir d'une impasse|to break a stalemate|${CIT}
340|ultimatum|an ultimatum|${CIT}
341|m√©diateur|a mediator|${CIT}
342|n√©gocier un accord|to broker an agreement|${CIT}
343|surmonter un obstacle|to overcome an obstacle|${CIT}
344|volont√© politique|political will|${CIT}
345|compromis|a compromise|${CIT}
346|transiger|to compromise|${CIT}
347|faire une concession|to make a concession|${CIT}
348|s'engager √† faire qch|to commit oneself to doing sth|${CIT}
349|promettre de faire, s'engager √† faire qch|to pledge to do sth|${CIT}
350|signer / ratifier un trait√©|to sign / ratify a treaty|${CIT}
351|protocole|a protocol|${CIT}
352|accord|an agreement, an accord|${CIT}
353|conclure un accord|to reach a settlement|${CIT}
354|stipuler|to stipulate|${CIT}
355|parvenir √† un consensus|to reach a consensus|${CIT}
356|interdire|to prohibit, to ban|${CIT}
357|mettre son v√©to √† une d√©cision|to veto a decision|${CIT}
358|Union Europ√©enne, l'UE|the European Union, the EU|${CIT}
359|directive europ√©enne|an EU directive|${CIT}
360|adh√©rer √† l'UE|to join the EU|${CIT}
361|demander son adh√©sion √† l'UE|to apply to join the EU, to apply for EU membership|${CIT}
362|pourparlers d'adh√©sion|membership negotiations|${CIT}
363|organisation non-gouvernementale, ONG|a non-governmental organization, an NGO|${CIT}
364|droits de l'homme|human rights|${CIT}
365|violations des droits de l'homme|human rights abuses, violations|${CIT}
366|faire respecter un principe|to uphold a principle|${CIT}
367|pass√© de la Chine en mati√®re de droits de l'homme|China's human Rights record|${CIT}
368|d√©colonisation|decolonization|${CIT}
369|obtenir l'ind√©pendance, devenir ind√©pendant|to achieve, gain, attain independence|${CIT}
370|ancienne colonie|a former colony|${CIT}
371|puissance coloniale|a colonial power|${CIT}
372|du travail|work|${CU}
373|un travail, un emploi|a job|${CU}
374|une profession, une activit√© professionnelle|an occupation|${CU}
375|les professions lib√©rales|the professions|${CU}
376|une carri√®re|a career|${CU}
377|le monde du travail|the world of work|${CU}
378|√™tre au travail|to be at work|${CU}
379|le lieu de travail|the workplace|${CU}
380|travailler chez soi|to work from home|${CU}
381|travailler √† temps partiel OU √† mi-temps|to work part time|${CU}
382|travailler √† plein temps|to work full time|${CU}
383|la classe ouvri√®re|the working class|${CU}
384|la population active|the working population|${CU}
385|la vie active|the working life|${CU}
386|conditions de travail|working conditions|${CU}
387|atelier|a workshop|${CU}
388|usine|a factory, a plant|${CU}
389|atelier clandestin (o√π la main d'≈ìuvre est exploit√©e)|a sweatshop|${CU}
390|travailler beaucoup|to work hard|${CU}
391|√™tre travailleur|to be hard-working|${CU}
392|travailleur acharn√©, bourreau de travail|a hard worker, a workaholic|${CU}
393|permis de travail|a work permit|${CU}
394|√™tre / ne pas √™tre de service OU de garde|to be on duty / off duty|${CU}
395|ch√¥mage|unemployment, joblessness|${CU}
396|√™tre au ch√¥mage|to be unemployed, jobless, out of work|${CU}
397|taux de ch√¥mage|unemployment rate, jobless rate|${CU}
398|ch√¥meurs|the unemployed, the jobless|${CU}
399|ch√¥mage de longue dur√©e|long-term unemployment|${CU}
400|ch√¥mage des jeunes|youth unemployment|${CU}
401|allocation ch√¥mage|unemployment benefit|${CU}
402|toucher le ch√¥mage|to be on the dole (GB), to be on welfare (US)|${CU}
403|march√© du travail, de l'emploi|job market, labour market|${CU}
404|contrat √† dur√©e d√©termin√©e, CDD|a fixed-term contract|${CU}
405|contrat √† dur√©e ind√©termin√©e, CDI|an open-ended contract|${CU}
406|flexibilit√© de l'emploi|job flexibility|${CU}
407|avoir des horaires flexibles|work flexitime (GB) flextime (US)|${CU}
408|s√©curit√© / pr√©carit√© de l'emploi|job security / insecurity|${CU}
409|stage|an internship, a work placement|${CU}
410|stagiaire|an intern, a trainee|${CU}
411|travailleur pr√©caire|a casual worker|${CU}
412|petit boulot|an odd job, a casual job|${CU}
413|boulot d'√©t√©|a summer job|${CU}
414|int√©rimaire|a temporary worker|${CU}
415|faire de l'int√©rim|to temp, to work as a temp|${CU}
416|employer|to employ|${CU}
417|employeur|an employer|${CU}
418|employ√©|an employee|${CU}
419|changer de travail|to change jobs|${CU}
420|embaucher un travailleur|to hire, to take on a worker|${CU}
421|recruter|to recruit|${CU}
422|p√©riode d'essai|a trial period|${CU}
423|poste|a post, a position|${CU}
424|nommer qn √† un poste|to appoint sb to a post|${CU}
425|muter qn|to transfer sb|${CU}
426|poste √† responsabilit√©(s)|a responsible job|${CU}
427|emploi subalterne|a menial job|${CU}
428|demandeur d'emploi|a job-seeker|${CU}
429|agence P√¥le emploi|a Jobcenter (GB)|${CU}
430|CV, curriculum vitae|a curriculum vitae, a CV, a r√©sum√© (US)|${CU}
431|exp√©rience professionnelle|work experience|${CU}
432|comp√©tences|skills|${CU}
433|√™tre candidat √† un emploi, faire une demande d'emploi|to apply for a job|${CU}
434|candidat √† un poste|an applicant|${CU}
435|entretien d'embauche|a job interview|${CU}
436|offre d'emploi|a job offer, a job vacancy, a job opportunity|${CU}
437|travail OU main d'≈ìuvre|labour|${CU}
438|main d'≈ìuvre f√©minine / travail des enfants|female labour / child labour|${CU}
439|normes en mati√®re d'emploi|labour standards|${CU}
440|main d'≈ìuvre|manpower, workforce|${CU}
441|personnel|staff, personnel|${CU}
442|coll√®gue, camarade de travail|a colleague, a co-worker, a workmate|${CU}
443|ressources humaines|human resources|${CU}
444|travail qualifi√© / peu qualifi√© / non qualifi√©|a skilled / low-skilled / an unskilled job|${CU}
445|ouvrier sp√©cialis√©, OS|an unskilled worker|${CU}
446|ouvrier|a blue-collar worker|${CU}
447|employ√© de bureau|a white-collar worker|${CU}
448|fonctionnaire|a state employee, a civil servant|${CU}
449|salari√© du secteur public|a public-sector employee|${CU}
450|haut fonctionnaire|a high-ranking civil servant|${CU}
451|√™tre ind√©pendant, travailler √† son compte|to be self-employed|${CU}
452|travailleurs ind√©pendants|the self-employed|${CU}
453|honoraires|fees|${CU}
454|paie, paye|pay|${CU}
455|salaire|salary|${CU}
456|salaire (d'ouvrier)|wages|${CU}
457|gagner de l'argent|to earn money, to make money|${CU}
458|gagner sa vie|to earn a living, to earn one's living, to make a living|${CU}
459|Que fait-il dans la vie ?|What does he do for a living?|${CU}
460|travail mal pay√©|a badly-paid job, a low-paid job|${CU}
461|travail bien pay√©|a well-paid job, a highly-paid job|${CU}
462|salari√©|a wage-earner|${CU}
463|prime|a bonus|${CU}
464|avantage (en nature), avantage annexe|a perk, a fringe benefit|${CU}
465|voiture de fonction|a company car|${CU}
466|salaire au rendement|performance-related pay|${CU}
467|√™tre employ√© par une entreprise|to be on a company's payroll|${CU}
468|vacances|holiday, vacation (US)|${CU}
469|cong√©s pay√©s|paid holiday|${CU}
470|√™tre en vacances|to be on holiday|${CU}
471|jour f√©ri√©|a bank holiday|${CU}
472|√™tre en cong√© maladie|to be on sick leave|${CU}
473|prendre deux jours de cong√©|to take two days off|${CU}
474|r√©duction du temps de travail, RTT|reduction of working hours|${CU}
475|les 35 heures, la semaine de 35 heures|the 35-hour working week|${CU}
476|supprimer des emplois|to cut jobs|${CU}
477|faire des coupes sombres, claires dans la main d'≈ìuvre|to slash, to axe jobs|${CU}
478|pertes d'emploi, suppressions d'emploi|job losses|${CU}
479|rationaliser|to streamline|${CU}
480|d√©graisser ses effectifs|to downsize|${CU}
481|licencier des salari√©s|to lay off workers, to make workers redundant|${CU}
482|licenciement (√©conomique)|a redundancy|${CU}
483|d√©part volontaire|a voluntary redundancy|${CU}
484|plan social|a redundancy plan|${CU}
485|indemnit√© de licenciement, prime de d√©part|redundancy payment, severance pay, severance package|${CU}
486|parachute dor√©|a golden parachute, a golden handshake|${CU}
487|renvoyer, licencier, cong√©dier qn|to dismiss sb|${CU}
488|mettre √† la porte, renvoyer, virer|to fire, to sack, to give sb the sack|${CU}
489|√™tre renvoy√©|to get the sack|${CU}
490|conflit social|an industrial dispute|${CU}
491|se mettre / √™tre en gr√®ve|to go on strike / be on strike|${CU}
492|gr√©viste|a striker|${CU}
493|direction et les salari√©s|management and workers|${CU}
494|d√©l√©gu√© syndical|a shop steward|${CU}
495|syndicat|a (trade) union|${CU}
496|revendication|a claim|${CU}
497|revendications salariales|wage claims, wage demands|${CU}
498|augmentation de salaire|a payrise (GB), a payraise (US)|${CU}
499|reprendre le travail|to resume work|${CU}
500|prendre sa retraite|to retire|${CU}
501|d√©missionner|to resign, to step down|${CU}
502|retrait√©|a pensioner, an old age pensioner, a retiree (US)|${CU}
503|retraite|retirement|${CU}
504|partir en pr√©-retraite|to take early retirement|${CU}
505|√¢ge de la retraite|retirement age|${CU}
506|bien r√©ussir √† l'√©cole|to do well at school|Education
507|lire l'anglais couramment|to read English fluently|Education
508|√™tre bon en sport|to be good at sports|Education
509|faire l'√©cole buissonni√®re|to play truant|Education
510|absent√©isme|truancy|Education
511|suivre un cours d'anglais|to take a class in English|Education
512|donner du travail √† la maison|to set homework|Education
513|rendre un travail|to hand in a piece of work|Education
514|les subtilit√©s de la langue anglaise|the intricacies of the English language|Education
515|se lancer|to get started|Education
516|se conformer √† une r√®gle|to obey a rule|Education
517|ob√©ir √† (qqn)|to obey (sone)|Education
518|avoir des difficult√©s en maths|to have difficulty with maths|Education
519|donner un coup de main √† (qqn)|to give (sone) a hand|Education
520|obtenir un dipl√¥me|to graduate|Education
521|une salle de classe|a classroom|Education
522|une le√ßon|a class|Education
523|rattraper un cours loup√©|to catch up a missed lesson|Education
524|√©valuer|to assess, appraise|Education
525|le programme scolaire|the school curriculum|Education
526|√©tudiant de premier cycle|undergraduate|Education
527|indisciplin√©|unruly|Education
528|incontr√¥lable|unmanageable|Education
529|b√¢cler ses devoirs|to dash off one's work|Education
530|obtenir une bonne note|to get a good mark|Education
531|tricher sur son voisin|to eye over one's neighbour's work|Education
532|principal, directeur (√©cole)|headmaster|Education
533|√©l√®ve dou√©|gifted pupil|Education
534|r√©ussir un examen haut la main|to pass a test with flying colors|Education
535|une mati√®re (scolaire)|a (school) subject|Education
536|une pause de 20 minutes|a 20-minute break|Education
537|une heure de cours|a teaching-hour|Education
538|passer dans la classe sup√©rieure|to pass the next grade|Education
539|travail de paperasse|paperwork|Education
540|passer un examen|to take an exam|Education
541|examen blanc|mock exam|Education
542|se pr√©parer √† un examen|to prepare for an exam|Education
543|√©chouer √† un examen|to flunk a test|Education
544|recaler (qqn)|to flunk (sone)|Education
545|√™tre re√ßu √† un examen avec mention|to pass a degree with distinction|Education
546|abandonner l'√©cole|to drop out of school|Education
547|un √©l√®ve d√©crocheur|a dropout|Education
548|obtenir une bourse|to get a scholarship|Education
549|entrer en fac de m√©decine|to go to a medical school|Education
550|faire des √©tudes de m√©decine|to study medicine|Education
551|remettre un √©v√®nement √† plus tard|to put off an event|Education
552|sortie scolaire|school trip|Education
553|faire des recherches sur (qqch)|to do research on (sthg)|Education
554|cour d'√©cole|schoolyard|Education
555|un √©l√®ve de terminale|[UK] a sixth-former|Education
556|m√©ticuleux|painstaking|Education
557|s√©cher un cours|to skip a lesson|Education
558|se voir accorder la possibilit√© de [...]|to be provided with an opportunity to [...]|Education
559|tricher|to cheat|Education
560|un tricheur|a cheater|Education
561|√™tre renvoy√©|to be expelled|Education
562|rouler sur un examen|to sail through an exam|Education
563|sauce (tomate)|dressing|Thanksgiving
564|chuckle|laughter|Thanksgiving
565|to gather|to get together|Thanksgiving
566|a feast|a banquet|Thanksgiving
567|to reach accross|to make efforts to join|Thanksgiving
568|one another|each other|Thanksgiving
569|to winnow away|to filter out and remove|Thanksgiving
570|widely viewed as|largely regarded as|Thanksgiving
571|twice|two times|Thanksgiving
572|to provide|to give|Thanksgiving
573|the bulk of|the biggest part of|Thanksgiving
574|to depict|to describe|Thanksgiving
575|to feature|to represent, show|Thanksgiving
576|subservient|submissive, docile|Thanksgiving
577|pilgrims|migrants arriving in America from England in 17th|Thanksgiving
578|to outnumber|to surpass in number|Thanksgiving
579|to crouch|almost to sit on the floor|Thanksgiving
580|a harvest|a crop|Thanksgiving
581|likely|probably|Thanksgiving
582|a deed|an [bad] action|Thanksgiving
583|settlers|colons|Thanksgiving
584|in retaliation for|in revenge for|Thanksgiving
585|to broker|to organize, negotiate|Thanksgiving
586|to grab|to seize|Thanksgiving
587|gauzy|transparent|Thanksgiving
588|willfully|deliberately|Thanksgiving
589|How [s.one] would have it|What [s.one] would like to believe|Thanksgiving
590|druthers|inclination, penchant|Thanksgiving
591|blissfully|ecstatically|Thanksgiving
592|bleached out|washed out|Thanksgiving
593|to abid|to respect|Thanksgiving
594|alt√©rer|alter|Thanksgiving
595|apprentissage en continu|lifelong learning|Thanksgiving
596|malaise|general feeling of discomfort|Business
597|stagflation|period of slow economic growth and high unemployment|Business
598|aftermath|the consequences of a significant unpleasant event|Business
599|hyperinflation|extremely high and accelerating inflation|Business
600|third-world countries|countries with lower economic development|Business
601|martial law|military control over civilian functions of government|Business
602|gleaming|shining brightly, describe something polished or new|Business
603|suburban area|residential area on the outskirts of the a city|Business
604|stagnation|lack of activity, growth, and development|Business
605|dispirited|having lost emthusiasm and hope|Business
606|fatalistic|believing that events are inevitable|Business
607|hollowed out|destroyed or weakened from within|Business
608|brimming|filled to the point of overflowing (with positive emotions and energy)|Business
609|rabais, ristourne|discount|Business
610|cha√Æne de montage|assembly line|Business
611|payer comptant|to pay cash|Business
612|p√©nurie de main d'oeuvre|labor shortage|Business
613|productivit√©|productivity|Business
614|soumettre sa candidature|to apply|Business
615|racheter|to buy out|Business
616|licencier|to lay off|Business
617|se mettre en gr√®ve|to go on strike|Business
618|service client|customer service|Business
619|repr√©sentant syndical|union representative|Business
620|commerƒáant|shopkeeper|Business
621|virer, mettre √† la porte|to fire|Business
622|se mettre √† son compte|to set up one's business|Business
623|d√©missionner|to resign|Business
624|en sureffectif|overstaffed|Business
625|contrat √† dur√©e ind√©termin√©e|permanent contract|Business
626|√©quipe de nuit|night shift|Business
627|service, d√©partement|department|Business
628|refondre, r√©organiser|to revamp|Business
629|concurrent|competitor|Business
630|fusion|merger|Business
631|faire faillite|to go bankrupt, bust|Business
632|embaucher|to hire, take on|Business
633|fiche de paie|pay slip|Business
634|faire des heures suppl√©mentaires|work overtime|Business
635|mettre la cl√© sous la porte|to go out of business, close up shop|Business
636|fait main|handmade|Business
637|artisan|craftsman|Business
638|ouvrier qualifi√©|skilled worker|Business
639|entreprise|business|Business
640|plein emploi|full employment|Business
641|un maire|a mayor|Politique
642|homme politique|politician|Politique
643|s'assurer une majorit√©|to secure a majority|Politique
644|d√©clencher des √©lections anticip√©es|to call an early election|Politique
645|(UK) les √©l√©ctions l√©gislatives|(UK) the general election|Politique
646|(US) les √©l√©ctions pr√©sidentielles|(US) the general election|Politique
647|les grands partis|mainstream parties|Politique
648|premier ministre|Prime Minister|Politique
649|le ministre de l'√©conomie et des finances|(UK) the Chancellor of the Exchequer|Politique
650|remaniement minist√©riel|Cabinet reshuffle|Politique
651|ministre des Affaires √©trang√®res|Foreign minister|Politique
652|pronncer un discours|to deliver a speech|Politique
653|une dictature|a dictatorship|Politique
654|museler, ba√Ælloner|to gag, muzzle|Politique
655|soci√©t√© civile|civil society|Politique
656|(UK) syndicats|(UK) trade unions|Politique
657|(US) syndicats|(US) labor unions|Politique
658|√©lections de mi-mandat|mid-term elections|Politique
659|minisre "frondeur"|rebellious minister|Politique
660|d√©missionner|resign, step down|Politique
661|officier en tant que|to serve as|Politique
662|opposer son veto √† (qqch)|to veto (sthg)|Politique
663|un projet de loi|a bill|Politique
664|un groupe de r√©flexion|a think-tank|Politique
665|(UK) un ministre|(UK) a Cabinet member|Politique
666|un directeur de cabinet|a chief of staff|Politique
667|imp√¥ts locaux|local taxes|Politique
668|cote de popularit√©|approval ratings|Politique
669|se pr√©senter √† une √©l√©ction|to run for election [office]|Politique
670|pr√™ter serment|to take the oath, be sworn in|Politique
671|rendre homage √† (qqn)|to pay tribute to (sone)|Politique
672|dirigeant|political leader|Politique
673|√©lection truqu√©e|rigged election|Politique
674|les allocations|social benefits|Politique
675|revaloriser|to scale up, raise, increase|Politique
676|l'allocation familliale|the family allowance|Politique
677|le gel de la production|the production freeze|Politique
678|un bras de fer|a tug of war|Politique
679|chancelant|teetering, wavering|Politique
680|tailored|customized|Politique
681|rote memorisation|repetition-based learning|Politique
682|impoverished|cash-strapped|Politique
683|unencumbered|unburdened|Politique
684|inquisitiveness|interest, curiosity|Politique
685|substantially|notably, significatly|Politique
686|authoritarian|dictatorial, strict|Politique
687|minimally supervised|lightly monitored|Politique
688|crime, criminality|la criminalit√©|${CR}
689|the crime rate|le taux de criminalit√©|${CR}
690|organized crime|la criminalit√© organis√©e, le grand banditisme|${CR}
691|white-collar crime|la criminalit√© en col blanc|${CR}
692|juvenile delinquency|la d√©linquance juv√©nile|${CR}
693|a juvenile delinquent, a young offender|un d√©linquant juv√©nile|${CR}
694|petty crime|la petite d√©linquance|${CR}
695|a crime, a felony|un crime|${CR}
696|to commit a crime|commettre un crime|${CR}
697|a criminal, a felon|un criminel|${CR}
698|a criminal record|un casier judiciaire|${CR}
699|an offense|un d√©lit, une infraction|${CR}
700|a misdemeanour|une infraction (GB), un d√©lit (US)|${CR}
701|an offender|un d√©linquant, un contrevenant|${CR}
702|a repeat offender, a recidivist|un r√©cidiviste|${CR}
703|murder|le meurtre|${CR}
704|a murderer|un meurtrier|${CR}
705|manslaughter|homicide|${CR}
706|a serial killer|un tueur en s√©rie|${CR}
707|theft|le vol|${CR}
708|a thief, a robber|un voleur|${CR}
709|to steal a watch|voler une montre|${CR}
710|to rob sb of sth|voler qch √† qn|${CR}
711|rape|le viol|${CR}
712|armed robbery|vol √† main arm√©e|${CR}
713|a burglary|un cambriolage|${CR}
714|to mug sb, to attack sb|agresser qn|${CR}
715|money-laundering|le blanchiment d‚Äôargent|${CR}
716|to break a law|enfreindre une loi|${CR}
717|lawful / unlawful|l√©gal / ill√©gal|${CR}
718|a lawbreaker|un d√©linquant, une personne qui enfreint la loi|${CR}
719|wrongdoing|des m√©faits|${CR}
720|a wrongdoer|un malfaiteur|${CR}
721|to flout the law|se moquer de la loi|${CR}
722|a no-go area|une zone de non-droit|${CR}
723|to obey the law|ob√©ir √† la loi|${CR}
724|to abide by the law|respecter la loi|${CR}
725|a law-abiding citizen|un citoyen respectueux des lois|${CR}
726|the justice system|la justice|${CR}
727|a court, a court of law|un tribunal|${CR}
728|a judge|un juge|${CR}
729|a lawyer, a barrister (GB), an attorney (US)|un avocat|${CR}
730|the jury|le jury|${CR}
731|to prosecute sb|poursuivre qn (en justice)|${CR}
732|to bring a lawsuit against sb, sue sb|intenter un proc√®s √† qn, engager des poursuites contre qn|${CR}
733|the prosecutor|le procureur|${CR}
734|a suspect|un suspect|${CR}
735|to charge sb with murder|accuser, inculper qn de meurtre|${CR}
736|a charge|une accusation, un chef d‚Äôinculpation|${CR}
737|to confess to a crime|avouer un crime|${CR}
738|to confess to embezzling money|avouer avoir d√©tourn√© de l‚Äôargent|${CR}
739|confession|un aveu|${CR}
740|a defendant|un accus√©, un pr√©venu|${CR}
741|a witness / an eye witness|un t√©moin / un t√©moin oculaire|${CR}
742|a case|une affaire|${CR}
743|a trial|un proc√®s|${CR}
744|to be tried, stand trial|passer en jugement, √™tre jug√©|${CR}
745|to await trial|√™tre en attente de jugement|${CR}
746|the principle that a defendant is innocent until proven guilty|la pr√©somption d‚Äôinnocence|${CR}
747|forensic evidence|preuves relev√©es lors d‚Äôune expertise|${CR}
748|a culprit|un coupable|${CR}
749|to acquit sb|acquitter qn|${CR}
750|acquittal|acquittement|${CR}
751|to find sb guilty|condamner qn, reconna√Ætre qn coupable|${CR}
752|to convict sb of rape, murder|reconna√Ætre qn coupable de viol, meurtre|${CR}
753|a conviction|une condamnation|${CR}
754|a fine|une amende|${CR}
755|to fine sb for sth|condamner qn √† une amende pour qch|${CR}
756|to be sentenced to five years‚Äô imprisonment, five years in jail|√™tre condamn√© √† cinq ans de prison|${CR}
757|a death sentence|une condamnation √† mort|${CR}
758|a life sentence|une condamnation √† perp√©tuit√©|${CR}
759|a suspended sentence|une condamnation avec sursis|${CR}
760|to be sent to prison|√™tre mis en prison|${CR}
761|to incarcerate, to imprison sb|incarc√©rer qn|${CR}
762|the incarceration rate|le taux d‚Äôincarc√©ration|${CR}
763|a cell|une cellule|${CR}
764|a prisoner, an inmate, a detainee|un d√©tenu, un prisonnier|${CR}
765|a prison officer, a prison warder (GB)|un gardien de prison|${CR}
766|a high-security prison|une prison de haute s√©curit√©|${CR}
767|solitary confinement|l‚Äôisolement carc√©ral|${CR}
768|prison overcrowding|la surpopulation carc√©rale|${CR}
769|a miscarriage of justice|une erreur judiciaire|${CR}
770|to fabricate evidence|fabriquer des preuves|${CR}
771|to be proved innocent, to be exonerated|√™tre innocent√©|${CR}
772|to free, to release a prisoner|lib√©rer, rel√¢cher un prisonnier|${CR}
773|to pardon a convict|gr√¢cier un condamn√©|${CR}
774|to parole sb|mettre qn en libert√© conditionnelle|${CR}
775|to be on parole|√™tre en libert√© conditionnelle|${CR}
776|to report to the police|se pr√©senter √† la police|${CR}
777|an electronic tag|un bracelet de surveillance √©lectronique|${CR}
778|contre la peine de mort|against the death penalty|${PC}
779|le meurtre|murder|${PC}
780|√™tre coupable de meurtre|to be guilty of murder|${PC}
781|un meurtrier|a murderer|${PC}
782|le viol|rape|${PC}
783|un violeur|a rapist|${PC}
784|un d√©linquant sexuel|a sex offender|${PC}
785|un r√©cidiviste|a repeat offender, a recidivist|${PC}
786|la culpabilit√©|guilt|${PC}
787|appliquer la loi du talion|to demand an eye for an eye|${PC}
788|d√©clarer qn coupable, condamner qn|to convict sb, to find sb guilty|${PC}
789|une condamnation|a conviction|${PC}
790|une condamnation √† tort|a wrongful conviction|${PC}
791|condamner qn √† mort|to sentence sb to death|${PC}
792|condamner qn √† 25 ans de prison|to sentence sb to 25 years imprisonment|${PC}
793|un coupable|a culprit|${PC}
794|dissuader qn de faire qch|to deter sb from doing sth|${PC}
795|avoir un effet dissuasif|to act as a deterrent|${PC}
796|une condamnation √† mort|a death sentence|${PC}
797|une condamnation √† perp√©tuit√©|a life sentence|${PC}
798|perp√©tuit√© sans possibilit√© de remise de peine|life without parole|${PC}
799|mettre qn en prison|to jail, imprison sb|${PC}
800|un d√©tenu, un prisonnier|a prisoner, an inmate, a detainee|${PC}
801|√™tre dans les couloirs de la mort|to be on death row|${PC}
802|une cellule|a cell|${PC}
803|un avocat|a lawyer|${PC}
804|un appel|an appeal|${PC}
805|faire appel d‚Äôune d√©cision|to appeal against a decision|${PC}
806|casser une d√©cision (de justice)|to quash, to overturn a decision|${PC}
807|commuer une condamnation √† mort en r√©clusion √† perp√©tuit√©|to commute a death sentence to life|${PC}
808|surseoir √† l‚Äôex√©cution d‚Äôun condamn√©|to grant a convict a stay of execution, a reprieve|${PC}
809|gracier un criminel|to pardon a criminal|${PC}
810|executer un condamn√©|to execute a convict|${PC}
811|mettre qn √† mort|to put sb to death|${PC}
812|un bourreau|an executioner|${PC}
813|une piq√ªre mortelle|a lethal injection|${PC}
814|faire une piq√ªre mortelle √† qn|to inject sb with a lethal substance|${PC}
815|pendre qn|to hang sb|${PC}
816|la guillotine|the guillotine|${PC}
817|guillotiner qn|to guillotine sb|${PC}
818|√©lectrocuter qn|to electrocute sb|${PC}
819|la chaise √©lectrique|the electric chair|${PC}
820|lapider qn, tuer qn √† coups de pierre|to stone sb to death|${PC}
821|abolir|to abolish, to do away with|${PC}
822|r√©tablir la peine de mort|to reinstate, to reintroduce, to restore the death penalty|${PC}
823|appliquer la peine de mort|to apply, to enforce the death penalty|${PC}
824|une erreur judiciaire|a miscarriage of justice|${PC}
825|les tests ADN|DNA analysis, DNA testing|${PC}
826|innocenter qn|to prove sb innocent, to exonerate sb|${PC}
827|√™tre innocent√© gr√¢ce √† l‚ÄôADN|to be cleared by DNA|${PC}
828|un probl√®me controvers√©|a controversial, contentious issue|${PC}
829|un probl√®me sensible, qui suscite de vives r√©actions|a hot-button issue|${PC}
830|partisans de la peine de mort|advocates, supporters, proponents of the death penalty|${PC}
831|opposants √†, adversaires de la peine de mort|critics, opponents of the death penalty|${PC}
832|√™tre contre la peine de mort|to oppose the death penalty, to be opposed to the death penalty|${PC}
833|un abolitionniste|an abolitionist|${PC}
834|du sexe f√©minin|female|${CF}
835|le statut, la position, la place des femmes dans la soci√©t√©|women‚Äôs status in society|${CF}
836|le d√©s√©quilibre entre les sexes|gender imbalance|${CF}
837|les in√©galit√©s entre les hommes et les femmes|gender inequalities|${CF}
838|la guerre entre les sexes|gender war|${CF}
839|un phallocrate, un machiste|a (male) chauvinist|${CF}
840|le machisme|machismo|${CF}
841|la misogynie|misogyny|${CF}
842|un misogyne|a misogynist|${CF}
843|le sexisme|sexism|${CF}
844|des pr√©jug√©s sexistes|sexist prejudices|${CF}
845|le f√©minisme|feminism|${CF}
846|le mouvement des femmes, le mouvement pour les droits de la femme|the Women‚Äôs Movement, the women‚Äôs rights movement|${CF}
847|s‚Äô√©manciper|to become emancipated|${CF}
848|rendre les femmes autonomes|to empower women|${CF}
849|un mariage forc√© / arrang√©|a forced marriage / an arranged marriage|${CF}
850|un mariage blanc|a sham marriage, a marriage of convenience|${CF}
851|une dot|a dowry|${CF}
852|la polygamie|polygamy|${CF}
853|polygame|polygamous|${CF}
854|l‚Äôexcision|female circumcision, female genital mutilation|${CF}
855|une femme battue|a battered wife|${CF}
856|violence conjugale, familiale|domestic violence|${CF}
857|√™tre priv√© du droit de vote|to be disenfranchised|${CF}
858|le droit de vote|the right to vote|${CF}
859|tomber enceinte|to become pregnant|${CF}
860|les femmes en √¢ge d‚Äôavoir des enfants|women of childbearing age|${CF}
861|la pilule (contraceptive)|the (contraceptive) pill|${CF}
862|prendre la pilule|to be on the pill|${CF}
863|partir en cong√© maternit√©|to go on maternity leave|${CF}
864|cong√© parental|parental leave, career break|${CF}
865|s‚Äôoccuper de ses enfants|to look after one‚Äôs children|${CF}
866|√©lever un enfant|to bring up, to raise a child|${CF}
867|l‚Äô√©ducation des enfants|the upbringing of children, child rearing, parenting|${CF}
868|des enfants d‚Äô√¢ge scolaire|school-age children|${CF}
869|une femme au foyer, une m√©nag√®re|a housewife|${CF}
870|faire le m√©nage|to do the housework|${CF}
871|faire la cuisine / la lessive / la vaisselle / les courses|to do the cooking / washing / washing-up / shopping|${CF}
872|passer l‚Äôaspirateur|to do the vacuuming / to vacuum|${CF}
873|les appareils m√©nagers|domestic appliances|${CF}
874|les t√¢ches m√©nag√®res|household chores|${CF}
875|√™tre confront√© √† un dilemme|to be faced with a dilemma|${CF}
876|une cr√®che, une garderie|a nursery, a day-care centre (GB), a child-care center|${CF}
877|une nounou, une nourrice|a nanny|${CF}
878|une assistante maternelle, une nourrice|a childminder|${CF}
879|trouver un √©quilibre entre travail et famille|to balance, combine work and family|${CF}
880|jongler pour concilier carri√®re et famille|to juggle a career and a family|${CF}
881|concilier|to reconcile|${CF}
882|les responsabilit√©s familiales|family responsibilities|${CF}
883|√™tre d√©pendant financi√®rement de qn|to be financially dependent on sb|${CF}
884|gagner sa vie|to earn a living, to make a living|${CF}
885|subvenir aux besoins de sa famille|to support one‚Äôs family|${CF}
886|nourrir ses enfants|to feed one‚Äôs children|${CF}
887|√™tre celui qui fait vivre la famille|to be the breadwinner|${CF}
888|c‚Äôest elle qui fait vivre sa famille|she is the family wage earner|${CF}
889|faire bouillir la marmite|to bring home the bacon|${CF}
890|la main d‚Äô≈ìuvre f√©minine|female labour|${CF}
891|l‚Äôemploi des femmes|female employment|${CF}
892|les femmes repr√©sentent x % de la main d‚Äô≈ìuvre|women make up x% of the workforce|${CF}
893|faire carri√®re|to have a career|${CF}
894|√™tre une femme qui travaille|to be a working woman|${CF}
895|une femme qui fait carri√®re|a career woman|${CF}
896|travailler √† temps partiel OU √† mi-temps|to work part time|${CF}
897|travailler √† plein temps|to work full time|${CF}
898|l‚Äô√©galit√© des salaires|equal pay|${CF}
899|le diff√©rentiel de salaire entre les sexes|the gender pay gap, the gender wage gap|${CF}
900|nommer qn √† un poste|to appoint sb to a post|${CF}
901|√™tre en concurrence avec les hommes|to compete with men|${CF}
902|un poste √† responsabilit√©s|a responsible job|${CF}
903|un poste de haut niveau|a top job|${CF}
904|un emploi subalterne|a menial job|${CF}
905|r√©ussir sa carri√®re|to have a successful career|${CF}
906|les obstacles √† la promotion des femmes|barriers to female advancement|${CF}
907|une chasse gard√©e pour les hommes|a male preserve|${CF}
908|introduire une discrimination contre qn|to discriminate against sb|${CF}
909|√™tre victime de discrimination|to be discriminated against|${CF}
910|le harc√®lement|harassment|${CF}
911|le harc√®lement sexuel|sexual harassment|${CF}
912|la parit√©|parity|${CF}
913|sous-repr√©sent√©|under-represented|${CF}
914|instaurer des quotas|to introduce quotas|${CF}
915|l‚Äôinstauration de quotas|the introduction of quotas|${CF}
916|la discrimination positive|affirmative action|${CF}
917|l‚Äô√©galit√© des chances|equal opportunity|${CF}
918|√©galitaire|egalitarian|${CF}
919|l‚Äô√©galitarisme|egalitarianism|${CF}
920|atteindre l‚Äô√©galit√© avec les hommes|to achieve equality with men|${CF}
`.trim();

    const physicsRawText = `10000|<span style="color: rgb(255, 170, 0);">(Shems)</span> Qu'est-ce qu'un referentiel galil√©en?|Un r√©f√©rentiel galil√©en est un r√©f√©rentiel dans lequel le principe d'inertie est v√©rifi√©e, √† savoir que tout objet isol√© ou pseudiisol√© est soit immobile soit en mouvement rectiligne uniforme dans ce r√©f√©rentiel .&nbsp;&nbsp;|${PM}
10001|<span style="color: rgb(0, 255, 0);">V.Iulian</span> <br>Tout r√©f√©rentiel [...] rapport √† un r√©f√©rentiel galil√©en est galil√©en|<b>en translation rectiligne et uniforme par</b>|${PM}
10002|<span style="color: rgb(0, 255, 0);">V.Iulian</span><br>Si la translation de R' par rapport a R galil√©en n‚Äôest pas rectiligne ou pas uniforme, R‚Ä≤ [...]|<b>n‚Äôest pas galil√©en</b>|${PM}
10003|<span style="color: rgb(0, 255, 0);">V.Iulian</span> <br>Un r√©f√©rentiel en rotation autour d‚Äôun axe fixe d‚Äôun r√©f√©rentiel galil√©en [...]|<b>n‚Äôest jamais galil√©en.</b>|${PM}
10004|<span style="color: rgb(0, 255, 0);"><u><b>(MAG)</b></u></span><img src="images/paste-9cd3560a5f9a5c4100721b04ab4c28ceaaaf93e5.jpg">|<img src="images/paste-5a57528bd9551b29f65139e8d4887065d643d4ac.jpg">|${PM}
10005|<span style="color: rgb(0, 255, 0);"><u><b>(MAG)</b></u></span><img src="images/paste-d77f3722e5a6b97cce4097de2c62d12a8d197b00.jpg">|<img src="images/paste-94c2181742a47574197e38c01becf17fe5e14056.jpg"><br>Avec O' un point fixe de R'|${PM}
10006|<span style="color: rgb(0, 255, 0);"><u><b>(MAG)</b></u></span><img src="images/paste-cb677b12d3a6508a44f3f9b492a67a4a71774fca.jpg">|Cas de R' en translation par rapport √† R: $\\vec{f_{ic}}=\\vec{0}$ donc&nbsp;$P(\\vec{f_{ic}})=0$<br><br>Cas de R' en rotation par rapport √† R: $P(\\vec{f_ic}) = (-2m \\vec{\\Omega}_{R'/R} \\wedge \\vec{v}_{M/R'} ). \\vec{v}_{M/R'}=0$<br><br>TPC:&nbsp;$\\frac{dEc_{/R'}}{dt}=\\sum_i P(\\vec{F_i})/R'+P(\\vec{f_{ie}})/R'$|${PM}
10007|<span style="color: rgb(255, 170, 0);"><u><b>(MAG)</b></u></span>Justifier que fic ne travaille pas et exprimer le TEC dans R' non gal.|$P(\\vec{f_ic}) = 0$<br>En effet lorsque&nbsp;R' est en translation par rapport √† R $\\vec{f_{ic}}=\\vec{0}$ donc&nbsp;$P(\\vec{f_{ic}})=0$<br><br>et lorsque R' en rotation par rapport √† R: $P(\\vec{f_ic}) = (-2m \\vec{\\Omega}_{R'/R} \\wedge \\vec{v}_{M/R'} ). \\vec{v}_{M/R'}=0$<br>csq1:&nbsp;$W(\\vec{f_{ic}})=\\int P(\\vec{f_{ic}}).dt=0$ i.e.&nbsp;$\\vec{f_{ic}}$ ne travaille pas.<br><br>csq2: TEC dans R':&nbsp;$\\Delta Ec_{/R'}=\\sum_i W(\\vec{F_i})/R'+W(\\vec{f_{ie}})/R'$|${PM}
10008|<b><span style="color: rgb(255, 170, 0);">(MAG)</span></b><span style="color: rgb(0, 85, 255);">&nbsp;sur l'expl d'un man√®ge avec si√®ges suspendus √† des cha√Ænes:</span><span style="color: rgb(255, 170, 0);"><u><br></u></span><img src="images/paste-a933d76dcbeef4f62508fa32bd894eade0892cea.jpg"><br><img src="images/paste-162500c424b12166f0f9f7c8345e074e19a42672.jpg">|<img src="images/paste-7d986b294569fcc662beb25c0076c304bcdbb34e.jpg">|${PM}
10009|<span style="color: rgb(255, 170, 0);">(Orlan M) </span>Exprimer la force d'inertie de Coriolis et la force d'inertie d'entrainement dans le cas d'une rotation de R' par rapport √† R|$\\vec{f_ic} = -2m \\vec{\\Omega}_{R'/R} \\wedge \\vec{v}_{M/R'}&nbsp;$<br>et<br>$\\vec{f_ie} = m \\Omega^2 \\overrightarrow{HM}&nbsp;$|${PM}
10010|<span style="color: rgb(0, 255, 0);">(INC)</span> TEM dans R' rep√®re non galil√©en|<br>[latex] Si $\\vec{f_{ie}} $ est conservative, $\\vec{f_{ie}}$ d√©rive d'une √©nergie potentielle $E_{p,f_{ie}}$ qui est contenue dans $E_m$ et qui est tq: $W(\\vec{f_{ie}})=-\\Delta E_{p,f_{ie}}$ \\newline<br><br>Alors TEM: $\\Delta Em_{/R'}=\\sum_i W(\\vec{F}_{iNC/R'}) $ \\newline<br><br>Si $\\vec{f}_{ie}$ est non conservative \\newline<br>TEM: $\\Delta Em_{/R'}=\\sum_i W(\\vec{F}_{iNC/R'})+W(\\vec{f_{ie/R'}}) $[/latex]<br>|${PM}
10011|<span style="color: rgb(255, 170, 0);">(Orlan M) </span>En partant du PFD √©crit dans un r√©f√©rentiel galil√©en R, √©tablir l'expression du PFD dans un r√©frentiel R' non galileen.|On part de la loi de composition des vitesses $m \\vec{a}_{M/R} = m \\vec{a}_{M/R'} + \\vec{a_c} + \\vec{a_e}&nbsp;&nbsp;$<br>de plus $m \\vec{a}_{M/R} = \\sum_i \\vec{F_i} $<br>En r√©arrangant les termes on a $m \\vec{a}_{M/R'} = \\sum_i \\vec{F_i} -m \\vec{a_c} - m \\vec{a_e} $<br>avec $ - m \\vec{a_e} $ qui est la force d'inertie d'entrainement et $&nbsp;- m \\vec{a_c} $ qui est la force d'inertie de coriolis|${PM}
10012|<span style="color: rgb(255, 170, 0);">(Orlan M)</span> Exprimer $ \\vec{f_{ic}} $ et $ \\vec{f_{ie}} $ dans le cas d'une translation de R' par rapport √† R|&nbsp;$ \\vec{f_{ic}} = \\vec{0} $ et&nbsp;&nbsp;$ \\vec{a_c} = \\vec{0} $ dans ce cas<br>et<br>$ \\vec{f_{ie}} = -m(\\frac{d^2 \\vec{OO'}}{dt^2})_R $|${PM}
10013|<span style="color: rgb(255, 170, 0);">(LPB)</span><span style="color: rgb(0, 255, 0);"> </span>Comment est d√©fini r√©ellement le poids?|On def le poids d'un corps M de masse m de mani√®re exp√©rimentale: C'est la force oppos√©e √† la tension d'un fil au bout duquel est accroch√© le corps, ce dernier √©tant en √©quilibre dans le r√©f√©rentiel terrestre (\\(\\vec{P} = \\vec{F_G}+\\vec{f_{ie}}\\)&nbsp;)|${PM3}
10014|<span style="color: rgb(0, 255, 0);">(LPB)</span>Donner un exemple de manifestation du caract√®re non galil√©en du r√©f√©rentiel g√©ocentrique|L'existence de deux mar√©es hautes et deux mar√©es basses par jour sur Terre<br>&nbsp;<img src="images/Capture d‚Äô√©cran 2023-10-07 161935.png">|${PM3}
10015|<span style="color: rgb(0, 255, 0);">(TS) </span>Donner des exemples qui mettent en √©vidence le caract√®re non galil√©en du r√©f√©rentiel terrestre.|La d√©viation vers l'est,<br>Le sens de rotation des cyclones,<br>Le pendule de Foucault|${PM3}
10016|<span style="color: rgb(255, 170, 0);">(TS)</span> Donner la vitesse angulaire de rotation du r√©f√©rentiel terrestre par rapport au r√©f√©rentiel g√©ocentrique|\\(\\omega\\)= \\(\\frac{2\\pi}{24√ó3600}\\)rad/s=7.3√ó10\\(^{-5}\\) rad/s|${PM3}
10017|<span style="color: rgb(255, 170, 0);">(TS)</span> Donner la vitesse angulaire caract√©risant la translation elliptique du r√©f√©rentiel g√©ocentrique par rapport au r√©f√©rentiel de Copernic|\\(\\Omega\\)=\\(\\frac{2\\pi}{365√ó24√ó3600}\\)rad/s=2.0√ó10\\(^{-7}\\) rad/s|${PM3}
10018|<span style="color: rgb(255, 170, 0);">(TS) </span>Quelles forces fera apparaitre le PFD dans R<sub>T</sub> non galil√©en|Le poids (qui contient [$] \\overrightarrow {f_{ie}}[/$])<br>La force d'inertie de Cariolis [$] \\overrightarrow {f_{ic}}[/$]<br>D'√©ventuelles autres forces|${PM3}
10019|(B.K.)<img src="images/paste-1baa446cfecd2e569059adbdf3a1b56a2baa1f9d.jpg"><br>Qu'est-ce qui est √† l'origine de cette d√©viation vers l'Est?<br>Dans l'h√©misph√®re Sud, cette d√©viation se ferait-elle √©galement vers l'Est?|C'est la force d'inertie de Coriolis qui est responsable de cette d√©viation vers l'Est.<br>La d√©viation se ferait √©galement vers l'Est dans l'h√©misph√®re sud.|${PM3}
10020|<span style="color: rgb(0, 255, 0);">(enzo m) </span><u>Contexte : Appli 3 Pendule de Foucault</u><br><br>On a les deux √©quations suivantes :<br>&nbsp;&nbsp;\\(\\begin{cases} \\ddot x +\\omega_0^2 x \\approx 2\\Omega sin(\\lambda)\\dot y \\space\\space\\space\\space\\space\\space\\space\\space(1)\\\\  \\ddot y +\\omega_0^2 y \\approx  -2\\Omega sin(\\lambda)\\dot x\\space\\space\\space\\space\\space(2)  \\end{cases}\\)<br><br>Quelle est la <b>m√©thode </b>afin d'obtenir une √©quation diff√©rentielle selon&nbsp;<u>Z</u>&nbsp;= x+jy o√π j<sup>2&nbsp;</sup>= -1 ?|<u>M√©thode</u> : il faut faire (1)+j(2)&nbsp;<br><br>Ce qui nous donne&nbsp;\\(\\underline {\\ddot Z} + \\omega_0^2\\underline{Z} = -2j\\Omega sin(\\lambda)\\underline{\\dot Z}\\)<br><br>Apr√®s avoir r√©solu cette √©quation diff√©rentielle, on peut trouver x et y avec x=Re(<u>Z</u>) et y=Im(<u>Z</u>).|${PM3}
10021|<span style="color: rgb(0, 255, 0);">(enzo m)</span>&nbsp;<u>Contexte : Appli 3 Pendule de Foucault</u>&nbsp;<br><br><img src="images/paste-bbc6e2689d77ff19edb0d95f4b86e2d6c46539ea.jpg" width="495"><br><br>On obtient pour les √©quations du mouvement du pendule de Foucault :<br><br>\\(\\begin{cases} x(t) = x_0cos(\\omega_0t)cos(-\\Omega sin\\lambda t)\\\\  y(t) = x_0cos(\\omega_0t)sin(-\\Omega sin\\lambda t)\\end{cases}\\)<br><br>Quelle est alors l'expression de la p√©riode T de rotation du plan d'oscillation du pendule? et la p√©riode T<sub>0 </sub>propre des oscillations ?|On a&nbsp;\\(T = \\left|\\frac{2\\pi}{\\Omega sin\\lambda}\\right|\\)&nbsp;&lt;-- p√©riode de rotation du plan d'oscillation<br><br>et&nbsp;\\(T = \\frac{2\\pi}{\\omega_0}\\)&nbsp;&lt;-- p√©riode propre des oscillations.|${PM3}
10022|<img src="images/anki appli 2.png"><span style="color: rgb(255, 170, 0);">Ziad&nbsp;SABRI<br></span><img src="images/paste-bf200bd2295b0763724fe5a90ee2df44dbf94cbc.jpg" style="float: left;">Donner en fonction de&nbsp;\\(\\lambda \\)&nbsp;l'expression de l'intensit√© de pesanteur (\\(\\vec{g}\\)) en un point √† la surface de la Terre situ√© √† la latitude&nbsp;\\(\\lambda\\). A quel endroit&nbsp;\\(g\\)&nbsp;est-elle max? min?<br><br>R√©f√©rentiel terrestre: non gal<br>R√©f√©rentiel g√©ocentrique: gal<br>Vitesse angulaire de rotation de la Terre autour de l'axe des p√¥le:&nbsp;&nbsp;\\(\\Omega\\)<br>Masse et rayon de la Terre:&nbsp;\\(m_T\\)&nbsp;et&nbsp;\\(R_T\\)|Poids d'un objet de masse&nbsp;\\(m\\)&nbsp;√† la surface de la Terre:<br>Donc&nbsp;\\(\\vec{g}=-G \\frac{ m_T}{R_T^2} \\vec{e_{z_{P}}}-\\vec{a_e}=-G \\frac{ m_T}{R_T^2} \\vec{e_{z_{P}}}+\\Omega^2\\overrightarrow{HM}\\)<br>Or&nbsp;\\(HM=R_T \\ cos(\\lambda)\\)&nbsp;et&nbsp;\\(\\frac {\\overrightarrow{HM}}{HM}=cos(\\lambda)\\overrightarrow{e_{z_{P}}}-sin(\\lambda)\\overrightarrow{e_{y_{P}}}\\)<br>Donc&nbsp;\\(\\vec{g}=-G \\frac{ m_T}{R_T^2} \\vec{e_{z_{P}}}+\\Omega^2 \\ R_T \\ cos(\\lambda) (cos(\\lambda)\\overrightarrow{e_{z_{P}}}-sin(\\lambda)\\overrightarrow{e_{y_{P}}})\\)<br><br>\\(g\\)&nbsp;est max au p√¥le sud et min √† l'√©quateur.|${PM3}
10023|(B.K.) Quelle force d'inertie permet d'expliquer l'existence de deux mar√©es oc√©aniques hautes par jour sur Terre?|C'est la force d'inertie d'entrainement due au fait que le r√©f√©rentiel g√©ocentrique (en translation elliptique dans le r√©f. H√©liocentrique) est consid√©r√© comme non galil√©en (en consid√©rant le r√©f. H√©liocentrique galil√©en).|${PM3}
10024|(B.K.) Quelle force d'inertie permet d'expliquer le sens de rotation des cyclones?<br>Dans quel sens tourne les cyclones dans l'h√©misph√®re Nord? Sud? Expliquer par un sch√©ma.|C'est la force d'inertie de Coriolis (en consid√©rant le ref. Terrestre non galil√©en et le r√©f g√©ocentrique galil√©en).<br>Dans le Nord: rotation dans le sens trigo.<br>Dans le Sud: Rotation dans le sens horaire<br><img src="images/paste-71cc5358ce5c51ce02d2e63300dba80598.jpg">|${PM3}
`.trim();

    // === LIGHTBOX IMAGE VIEWER ===
    // === LIGHTBOX IMAGE VIEWER (overlay sombre l√©ger, pas de boutons) ===
    const LB = {
      el:null, stage:null, canvas:null, img:null,
      counter:null,
      images:[], idx:0,
      baseW:0, baseH:0,
      s:1, minS:1, maxS:5, x:0, y:0,
      pointers:new Map(), startDist:0, startS:1, startX:0, startY:0, panStartX:0, panStartY:0,
      tapMoved:false
    };

    function ensureLightbox(){
      if (LB.el) return LB.el;
      const el = document.createElement('div');
      el.className = 'img-lightbox';
      el.innerHTML = `
        <div class="img-stage" id="lbStage" tabindex="-1" aria-label="Image viewer">
          <div class="img-canvas" id="lbCanvas"><img id="lbImg" alt=""></div>
        </div>
        <div class="img-counter" id="lbCounter">1/1</div>
      `;
      document.body.appendChild(el);
      LB.el = el;
      LB.stage = el.querySelector('#lbStage');
      LB.canvas = el.querySelector('#lbCanvas');
      LB.img = el.querySelector('#lbImg');
      LB.counter = el.querySelector('#lbCounter');

      // Gestes (pan/zoom partout)
      LB.stage.addEventListener('pointerdown', e=>{
        LB.stage.setPointerCapture?.(e.pointerId);
        LB.pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
        if (LB.pointers.size===1){
          LB.panStartX = LB.x; LB.panStartY = LB.y;
          LB.startX = e.clientX; LB.startY = e.clientY;
          LB.startS = LB.s; LB.tapMoved = false;
        }else if(LB.pointers.size===2){
          const pts=[...LB.pointers.values()];
          LB.startDist = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y) || 1;
          LB.startS = LB.s; LB.tapMoved = true; // pinch ‚â† clic
        }
        e.preventDefault();
      });

      LB.stage.addEventListener('pointermove', e=>{
        if(!LB.pointers.has(e.pointerId)) return;
        LB.pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
        const dx = e.clientX - LB.startX;
        const dy = e.clientY - LB.startY;
        if (Math.abs(dx)>6 || Math.abs(dy)>6) LB.tapMoved = true;

        if(LB.pointers.size>=2){
          // Pinch = zoom centr√© √©cran
          const pts=[...LB.pointers.values()];
          const dist=Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y) || LB.startDist;
          setLBScaleCentered(LB.startS * (dist/LB.startDist));
        }else{
          // 1 doigt = pan
          setLBPan(LB.panStartX + dx, LB.panStartY + dy);
        }
        e.preventDefault();
      });

      const endPtr = e=>{
        if(LB.pointers.has(e.pointerId)) LB.pointers.delete(e.pointerId);
        if(LB.pointers.size===0){
          // Clic dans le vide -> fermer
          if (!LB.tapMoved){
            const r = LB.img.getBoundingClientRect();
            if (!(e.clientX>=r.left && e.clientX<=r.right && e.clientY>=r.top && e.clientY<=r.bottom)) {
              closeLightbox();
            }
          }
          LB.startDist=0;
        }else if(LB.pointers.size===1){
          const p=[...LB.pointers.values()][0];
          LB.startX=p.x; LB.startY=p.y;
          LB.panStartX = LB.x; LB.panStartY = LB.y;
          LB.startS = LB.s; LB.startDist=0;
        }
      };
      LB.stage.addEventListener('pointerup', endPtr);
      LB.stage.addEventListener('pointercancel', endPtr);
      LB.stage.addEventListener('lostpointercapture', endPtr);

      // Double-tap/clic = toggle fit <-> zoom 2.2x (centr√© √©cran)
      let lastTap=0;
      LB.stage.addEventListener('pointerdown', e=>{
        const now=Date.now();
        if(now-lastTap<250){
          if (LB.s > LB.minS+0.001) setLBScaleCentered(LB.minS);
          else setLBScaleCentered(Math.min(LB.maxS, LB.minS*2.2));
          LB.tapMoved = true; // √©viter la fermeture juste apr√®s
        }
        lastTap=now;
      });

      // Molette = zoom centr√© √©cran (desktop)
      LB.stage.addEventListener('wheel', e=>{
        e.preventDefault();
        const step = (e.deltaY>0 ? -0.15 : 0.15);
        setLBScaleCentered(LB.s + step*LB.s);
      }, {passive:false});

      // Refit sur resize
      window.addEventListener('resize', ()=>{
        if(LB.el.classList.contains('open')) refitLB();
      });

      return el;
    }

    function openLightboxFor(imgEl, scopeEl){
      ensureLightbox();
      // Images pr√©sentes dans la carte en cours
      const list = Array.from(scopeEl.querySelectorAll('img'));
      LB.images = list.map(i=>({src:i.currentSrc||i.src, alt:i.alt||'', w:i.naturalWidth||i.width||800, h:i.naturalHeight||i.height||600}));
      LB.idx = Math.max(0, list.indexOf(imgEl));
      LB.el.classList.add('open');
      document.body.dataset._oriOverflow = document.body.style.overflow || '';
      document.body.style.overflow = 'hidden'; // bloque le scroll derri√®re
      LB.el.focus?.();
      showLB(LB.idx, true);
    }

    function closeLightbox(){
      LB.el.classList.remove('open');
      LB.images=[]; LB.idx=0;
      document.body.style.overflow = document.body.dataset._oriOverflow || '';
    }

    function showLB(idx, initial=false){
      if(!LB.images.length) return;
      LB.idx = (idx+LB.images.length) % LB.images.length;
      const it = LB.images[LB.idx];
      LB.img.src = it.src;
      LB.img.alt = it.alt;
      LB.baseW = it.w; LB.baseH = it.h;
      if (LB.counter) LB.counter.textContent = `${LB.idx+1}/${LB.images.length}`;
      refitLB(initial);
    }

    function refitLB(initial=false){
      const sw = LB.stage.clientWidth, sh = LB.stage.clientHeight;
      const fit = Math.min(sw/LB.baseW, sh/LB.baseH);
      LB.minS = fit;
      if (initial){
        LB.s = fit;
        LB.x = (sw - LB.s*LB.baseW)/2;
        LB.y = (sh - LB.s*LB.baseH)/2;
        applyLB();
      }else{
        setLBScaleCentered(fit, true);
      }
    }

    function applyLB(){
      const sw=LB.stage.clientWidth, sh=LB.stage.clientHeight;
      const w=LB.s*LB.baseW, h=LB.s*LB.baseH;
      if (w <= sw) LB.x = (sw - w)/2; else LB.x = clamp(LB.x, sw - w, 0);
      if (h <= sh) LB.y = (sh - h)/2; else LB.y = clamp(LB.y, sh - h, 0);
      LB.canvas.style.width = LB.baseW + 'px';
      LB.canvas.style.height = LB.baseH + 'px';
      LB.canvas.style.transform = `translate(${LB.x}px, ${LB.y}px) scale(${LB.s})`;
    }

    function setLBPan(nx, ny){
      LB.x = nx; LB.y = ny;
      applyLB();
    }

    function setLBScaleCentered(newS, force=false){
      const oldS = LB.s;
      let s = clamp(newS, LB.minS, LB.maxS);
      if (!force && Math.abs(s-oldS)<1e-4) return;
      const cx = LB.stage.clientWidth/2, cy = LB.stage.clientHeight/2;
      const imgCx = (cx - LB.x) / oldS;
      const imgCy = (cy - LB.y) / oldS;
      LB.s = s;
      LB.x = cx - LB.s * imgCx;
      LB.y = cy - LB.s * imgCy;
      applyLB();
    }

    // Parsing g√©n√©rique multi-mati√®res
    function parseCardsRaw(raw){
      return raw.split(/\r?\n/).map(l=>{
        const p=l.split('|'); if(p.length!==4) return null;
        const [id,f,e,c]=p;
        return {id:id.trim(),front:f.trim(),back:e.trim(),chapter:c.trim()};
      }).filter(Boolean);
    }
    const flashcardDataEN  = parseCardsRaw(cardsRawText);
    const flashcardDataPHY = parseCardsRaw(physicsRawText);
    
    // ---------- Utils ----------
    const Media = {
      db:null,
      cache:new Map(), // key -> objectURL
      async open(){
        if (this.db) return this.db;
        this.db = await new Promise((resolve,reject)=>{
          const req = indexedDB.open('flash9x16_media', 1);
          req.onupgradeneeded = e=>{
            const db = req.result;
            if (!db.objectStoreNames.contains('files')){
              db.createObjectStore('files', { keyPath:'key' });
            }
          };
          req.onsuccess = ()=>resolve(req.result);
          req.onerror = ()=>reject(req.error);
        });
        return this.db;
      },
      async save(key, blob, meta={}){
        const db = await this.open();
        await new Promise((res,rej)=>{
          const tx = db.transaction('files','readwrite');
          tx.objectStore('files').put({ key, blob, meta, ts:Date.now() });
          tx.oncomplete = res; tx.onerror = ()=>rej(tx.error);
        });
        data.mediaIndex = data.mediaIndex || {}; // petite index light c√¥t√© localStorage
        data.mediaIndex[key] = { name: meta.name||key, type: blob.type, size: blob.size };
        saveData();
      },
      async urlFor(key){
        if (this.cache.has(key)) return this.cache.get(key);
        const db = await this.open();
        const rec = await new Promise((res,rej)=>{
          const tx = db.transaction('files','readonly');
          const rq = tx.objectStore('files').get(key);
          rq.onsuccess = ()=>res(rq.result);
          rq.onerror = ()=>rej(rq.error);
        });
        if (!rec || !rec.blob) throw new Error('Media manquant: '+key);
        const url = URL.createObjectURL(rec.blob);
        this.cache.set(key, url);
        return url;
      },
      revokeAll(){
        for (const url of this.cache.values()) URL.revokeObjectURL(url);
        this.cache.clear();
      },
      async clearAll(){
        const db = await this.open();
        await new Promise((res,rej)=>{
          const tx = db.transaction('files','readwrite');
          tx.objectStore('files').clear();
          tx.oncomplete=res; tx.onerror=()=>rej(tx.error);
        });
        this.revokeAll();
        data.mediaIndex = {};
        saveData();
      },
      rewriteHTMLToPlaceholders(html, nameMap){
        if (!html) return html;
        // remplace src="fichier" par src="media://cl√©" si connu
        return String(html).replace(/(<img\b[^>]?\bsrc=["'])([^"']+)(["'][^>]*>)/gi, (m,prefix,src,suffix)=>{
          const clean = src.replace(/^.*[\\\/]/, '').replace(/^_+/, '');
          const key = nameMap[clean] || nameMap[decodeURIComponent(clean)] || null;
          return key ? `${prefix}media://${key}${suffix}` : m;
        });
      },
      async resolveMediaInElement(el){
        const imgs = Array.from(el.querySelectorAll('img[src^="media://"]'));
        await Promise.all(imgs.map(async img=>{
          const key = img.getAttribute('src').replace(/^media:\/\//,'');
          try { img.src = await Media.urlFor(key); } catch(e){ console.warn('media url fail', key, e); }
        }));
      }
    };
    const ensureSQL = (()=> {
      let p=null;
      return ()=> {
        if (p) return p;
        p = initSqlJs({ locateFile: f => `https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/${f}` });
        return p;
      };
    })();

    async function importFiles(files){
      for (const file of files){
        const name=file.name.toLowerCase();
        if (name.endsWith('.apkg')) await importApkg(file);
        else if (name.endsWith('.csv') || name.endsWith('.tsv')) await importDelimited(file);
        else if (name.endsWith('.json')) await importJSON(file);
        else console.warn('Format non g√©r√©:', file.name);
      }
    }

    async function importApkg(file){
      // 1) D√©zipper
      const buf = await file.arrayBuffer();
      const zip = await JSZip.loadAsync(buf);

      // 2) Media map
      let mediaMap={};
      const mediaEntry = zip.file(/^media(\.json)?$/i)[0];
      if (mediaEntry) try { mediaMap = JSON.parse(await mediaEntry.async('string')); } catch(e){ console.warn('media parse', e); }

      const importId = `apkg-${slugify(file.name.replace(/\.[^.]+$/,''))}-${Date.now()}`;
      const mediaNameToKey = {};
      for (const [numStr, realName] of Object.entries(mediaMap)){
        const num = String(numStr);
        const entry = zip.file(new RegExp(`^${num}$`))[0];
        if (!entry) continue;
        const blob = await entry.async('blob');
        const key = `${importId}/${realName||num}`;
        await Media.save(key, blob, { name: realName||num });
        mediaNameToKey[realName] = key;
        mediaNameToKey[num] = key;
      }

      // 3) SQLite
      const colEntry = zip.file(/collection\.anki2|collection\.anki21/i)[0];
      if(!colEntry) throw new Error('collection.anki2/anki21 introuvable');
      const dbBytes = new Uint8Array(await colEntry.async('uint8array'));
      const SQL = await ensureSQL();
      const db = new SQL.Database(dbBytes);

      // 4) Decks
      let deckById = {};
      try {
        const res = db.exec('select decks from col limit 1');
        if (res && res[0] && res[0].values && res[0].values[0] && res[0].values[0][0]) {
          deckById = JSON.parse(res[0].values[0][0]||'{}');
        }
      } catch(e){ console.warn('col.decks JSON', e); }

      // 5) Cartes (join cards+notes)
      const q = `select cards.id as cid, cards.nid, cards.did, cards.ord, notes.flds from cards join notes on notes.id = cards.nid`;
      const rows = db.exec(q);
      if (!rows || !rows[0]) { db.close(); throw new Error('Aucune carte trouv√©e'); }
      const cols = rows[0].columns;
      const vals = rows[0].values;

      const byDeck = new Map();
      for (const r of vals){
        const row = Object.fromEntries(cols.map((c,i)=>[c,r[i]]));
        const did = String(row.did);
        const deckName = (deckById[did]?.name)||(`Deck ${did}`);
        const name = deckName.replace(/::/g,' ‚Ä∫ ');
        const flds = String(row.flds||'').split('\x1f');
        const frontRaw = flds[0]||'';
        const backRaw = flds[1]||'';
        const front = Media.rewriteHTMLToPlaceholders(frontRaw, mediaNameToKey);
        const back = Media.rewriteHTMLToPlaceholders(backRaw, mediaNameToKey);
        const chapArr = byDeck.get(name) || [];
        chapArr.push({ id: String(row.cid), front, back, deckName:name });
        byDeck.set(name, chapArr);
      }
      db.close();

      // 6) Construire un Subject + chapitres
      const subjectId = `import-${slugify(file.name.replace(/\.[^.]+$/,''))}`;
      const chapters = [];
      for (const [name, arr] of byDeck.entries()){
        const cards = arr.map(r=>({
          id:`${slugify(name)}-${r.id}`,
          front:r.front, back:r.back, grade:'unseen',
          timesReviewed:0, lastReviewed:0, lastMs:0, avgMs:0,
          perfEma:0.5, ef:2.5, intervalDays:0, dueAt:0, streak:0, successes:0, failures:0
        }));
        const ch = {
          id: 'chap-'+slugify(name),
          title: name,
          description: `${emojiFor(name)||'üì¶'} ${name}`,
          settings:{sessionSize:10, dailyGoal:10, reviewOrder:'front-first', langSwap:false},
          filters:{grades:{unseen:true,echec:true,difficile:true,bien:true,facile:true}},
          stats:{
            gradeCounts:{unseen:cards.length,echec:0,difficile:0,bien:0,facile:0},
            totalReviews:0, dailyReviews:{}, dailyChanges:{}, dailyDurMs:{}, dailyDurCount:{}, dailyLog:{}
          },
          cards
        };
        chapters.push(ch);
      }
      
      const subject = { id: subjectId, title: file.name.replace(/\.[^.]+$/,''), chapters, imported:true };
      chapters.forEach(ch=> ch.imported = true);

      data.subjects = data.subjects || [];
      data.subjects.push(subject);
      data.app.currentSubjectId = subjectId;
      saveData();
    }

    async function importDelimited(file){
      const text = await file.text();
      const isTSV = file.name.toLowerCase().endsWith('.tsv');
      const sep = isTSV ? '\t' : (text.includes('\t') ? '\t' : (text.includes(';')?';':','));
      const lines = text.split(/\r?\n/).filter(Boolean);
      let header = lines[0].split(sep).map(s=>s.trim().toLowerCase());
      let start = 0;
      let hasHeader = header.includes('front') && header.includes('back');
      if (!hasHeader){
        header = ['front','back','chapter'];
      } else {
        start = 1;
      }
      const recs = [];
      for (let i=start;i<lines.length;i++){
        const cols = lines[i].split(sep);
        const row = Object.fromEntries(header.map((h,j)=>[h, cols[j]||'']));
        recs.push({
          front: row.front||cols[0]||'',
          back: row.back||cols[1]||'',
          chapter: row.chapter||'G√©n√©ral'
        });
      }
      await importAsSimpleSubject(file.name.replace(/\.[^.]+$/,''), recs);
    }

    async function importJSON(file){
      const obj = JSON.parse(await file.text());
      if (Array.isArray(obj)) {
        await importAsSimpleSubject(file.name.replace(/\.[^.]+$/,''), obj);
      } else if (obj && Array.isArray(obj.cards)){
        await importAsSimpleSubject(obj.subject||file.name.replace(/\.[^.]+$/,''), obj.cards);
      } else {
        throw new Error('JSON non reconnu');
      }
    }

    async function importAsSimpleSubject(subjectName, list){
      const byChap = {};
      list.forEach(x=>{
        const ch = (x.chapter||'G√©n√©ral').trim() || 'G√©n√©ral';
        (byChap[ch]=byChap[ch]||[]).push({
          front: Media.rewriteHTMLToPlaceholders(String(x.front||''), {}),
          back: Media.rewriteHTMLToPlaceholders(String(x.back||''), {})
        });
      });
      const subjectId = `import-${slugify(subjectName)}-${Date.now()}`;
      const chapters = Object.entries(byChap).map(([name, arr])=>{
        const cards = arr.map((r,i)=>({
          id:`${slugify(name)}-${i}-${Date.now()}`,
          front:r.front, back:r.back, grade:'unseen',
          timesReviewed:0, lastReviewed:0, lastMs:0, avgMs:0,
          perfEma:0.5, ef:2.5, intervalDays:0, dueAt:0, streak:0, successes:0, failures:0
        }));
        return {
          id:'chap-'+slugify(name),
          title:name,
          description:`üì¶ ${name}`,
          settings:{sessionSize:10, dailyGoal:10, reviewOrder:'front-first', langSwap:false},
          filters:{grades:{unseen:true,echec:true,difficile:true,bien:true,facile:true}},
          stats:{
            gradeCounts:{unseen:cards.length,echec:0,difficile:0,bien:0,facile:0},
            totalReviews:0, dailyReviews:{}, dailyChanges:{}, dailyDurMs:{}, dailyDurCount:{}, dailyLog:{}
          },
          cards
        };
      });
      const subject = { id:subjectId, title:subjectName, chapters, imported:true };
      chapters.forEach(ch=> ch.imported = true);
      data.subjects.push(subject);
      data.app.currentSubjectId = subjectId;
      saveData();
      goDeck(false);
    }

    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const ChartHit = {}; // hitmap donut
    const Bar7Hit = {}; // { [canvasId]: { cssW, cssH, bars: [{x,w}] } }

    const dateKey = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const todayKey = ()=>dateKey(new Date());
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const formatDuration = (ms)=>{const sec=Math.round(ms/1000); const m=Math.floor(sec/60); const s=sec%60; return `${m}:${String(s).padStart(2,'0')}`;};
    const avg = a=>!a?.length?0:a.reduce((x,y)=>x+y,0)/a.length;
    const deepClone = o=>JSON.parse(JSON.stringify(o));
    const pickN = (arr,n)=>{const c=arr.slice(); for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [c[i],c[j]]=[c[j],c[i]];} return c.slice(0,n);};
    const isSuccess = g=>g==='facile'||g==='bien';

    function preprocessLaTeX(s){
      if (!s) return s;
      return s
        .replace(/\[latex\]/gi, '')
        .replace(/\[\/latex\]/gi, '')
        .replace(/\\newline\s*/g, '<br/>');
    }

    function typesetLatex(container){
      if (window.MathJax && window.MathJax.typesetPromise) {
        const el = (typeof container === 'string') ? $(container) : container;
        if (el) {
          return window.MathJax.typesetPromise([el]).catch(err=>console.warn('MathJax error:', err));
        }
      }
      return Promise.resolve();
    }


    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[', '\\]']],
        processEscapes: true,
        packages: {'[+]': ['noerrors', 'noundefined']}
      },
      options: {
        skipHtmlTags: ['script','noscript','style','textarea','pre','code']
      },
      startup: { typeset: false }
    };

    function formatDayKeyFR(key){
      const [Y,M,D]=key.split('-').map(Number);
      const d=new Date(Y, M-1, D);
      const jours=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
      const mois=['janv.','f√©vr.','mars','avr.','mai','juin','juil.','ao√ªt','sept.','oct.','nov.','d√©c.'];
      return `${jours[d.getDay()]} ${String(D).padStart(2,'0')} ${mois[M-1]} ${Y}`;
    }

    const slugify=s=>s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const emojiFor=title=>CHAPTER_EMOJIS[title]||'';

    function extractRowId(cardId) {
      const m = String(cardId).match(/-(\d+)$/);
      return m ? m[1] : null;
    }

    // ---------- Construction donn√©es ----------
    function buildChaptersFromFlashcards(list){
      const byChap={}; list.forEach(r=>{const n=r.chapter||'Sans cat√©gorie'; (byChap[n]=byChap[n]||[]).push(r);});
      const chapters = Object.keys(byChap).map(name=>{
        const id='chap-'+slugify(name);
        const cards=byChap[name].map(r=>({
          id:`${slugify(name)}-${r.id}`, front:r.front, back:r.back,
          grade:'unseen', timesReviewed:0, lastReviewed:0, lastMs:0, avgMs:0,
          perfEma:0.5, ef:2.5, intervalDays:0, dueAt:0, streak:0, successes:0, failures:0
        }));
        return {
          id, title:name, description: emojiFor(name)?`${emojiFor(name)} ${name}`:name,
          settings:{sessionSize:10, dailyGoal:10, reviewOrder:'front-first', langSwap:false},
          filters:{grades:{unseen:true, echec:true, difficile:true, bien:true, facile:true}},
          stats:{
            gradeCounts:{unseen:cards.length,echec:0,difficile:0,bien:0,facile:0},
            totalReviews:0, dailyReviews:{}, dailyChanges:{}, dailyDurMs:{}, dailyDurCount:{}, dailyLog: {}
          },
          cards
        };
      });
      return {chapters, app:{currentChapterId:chapters[0]?.id||null, theme:'dark', prefs:{fsTerm:22, fsDef:24, accent:'indigo', showEmoji:true, radius:14}}};
    }

    function buildSubjectFromList(title, list){
      const built = buildChaptersFromFlashcards(list);
      return { id: slugify(title), title, chapters: built.chapters, groups: [] };
    }

    function buildCanonicalSubjects(){
      const en  = buildSubjectFromList('Anglais',  flashcardDataEN);
      const phy = buildSubjectFromList('Physique', flashcardDataPHY);
      return [en, phy];
    }

    function loadData(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed.subjects)) return parsed;
          if (Array.isArray(parsed.chapters)) {
            return {
              subjects: [{ id:'anglais', title:'Anglais', chapters: parsed.chapters, groups:[] }],
              app: parsed.app || { theme:'dark', prefs:{ fsTerm:22, fsDef:24, accent:'indigo', showEmoji:true, radius:14 }, currentSubjectId:'anglais' }
            };
          }
        }
      }catch(e){}

      try{
        const c = readCookieBackup();
        if(c){
          const parsed = JSON.parse(c);
          if (Array.isArray(parsed.subjects)) return parsed;
          if (Array.isArray(parsed.chapters)) {
            return {
              subjects: [{ id:'anglais', title:'Anglais', chapters: parsed.chapters, groups:[] }],
              app: parsed.app || { theme:'dark', prefs:{ fsTerm:22, fsDef:24, accent:'indigo', showEmoji:true, radius:14 }, currentSubjectId:'anglais' }
            };
          }
        }
      }catch(e){}

      const subjects = buildCanonicalSubjects();
      return {
        subjects,
        app:{
          currentSubjectId: subjects[0]?.id || null,
          theme:'dark',
          prefs:{ fsTerm:22, fsDef:24, accent:'indigo', showEmoji:true, radius:14 }
        }
      };
    }

    function saveData(){
      try{
        const str=JSON.stringify(data);
        localStorage.setItem(STORAGE_KEY,str);
        writeCookieBackup(str);
      }catch(e){console.warn('Save error',e);}
    }

    // Cookies backup
    function setCookie(name,value,days=365){try{document.cookie=`${name}=${encodeURIComponent(value)}; max-age=${days*86400}; path=/; SameSite=Lax;`;}catch(e){}}
    function getCookie(name){try{const m=document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith(name+'=')); return m?decodeURIComponent(m.split('=').slice(1).join('=')):null;}catch(e){return null;}}
    function delCookie(name){document.cookie=`${name}=; max-age=0; path=/; SameSite=Lax;`;}
    function writeCookieBackup(str){const CHUNK=3400; const parts=Math.ceil(str.length/CHUNK); for(let i=0;i<parts;i++) setCookie(`F9X16_B${i}`,str.slice(i*CHUNK,(i+1)*CHUNK)); for(let i=parts;i<10;i++) delCookie(`F9X16_B${i}`); setCookie('F9X16_BN',String(parts));}
    function readCookieBackup(){const n=parseInt(getCookie('F9X16_BN')||'0',10); if(!n) return null; let out=''; for(let i=0;i<n;i++){const p=getCookie(`F9X16_B${i}`); if(p==null) return null; out+=p;} return out;}

    let data = loadData();

    // ---------- Helpers de mati√®re ----------
    function getCurrentSubject(){
      const id = data?.app?.currentSubjectId;
      const s = data?.subjects?.find(x=>x.id===id);
      return s || data?.subjects?.[0] || null;
    }
    function setCurrentSubject(id){
      if (!data?.subjects?.find(s=>s.id===id)) return;
      data.app.currentSubjectId = id;
      saveData();
    }
    function getCurrentChapters(){
      const s=getCurrentSubject();
      return s?.chapters || [];
    }

    // ===== GROUPES ("fichiers") =====
    function getSubject(){ return getCurrentSubject(); }
    function ensureGroups(subj){ if (!Array.isArray(subj.groups)) subj.groups = []; return subj.groups; }
    function findGroupById(subj, gid){ return ensureGroups(subj).find(g=>g.id===gid)||null; }
    function findGroupByChapter(subj, chapId){ return ensureGroups(subj).find(g=>g.chapIds.includes(chapId))||null; }

    function groupEmojiList(subj, group){
      const set = new Set();
      group.chapIds.forEach(id=>{
        const ch = subj.chapters.find(c=>c.id===id);
        const em = ch ? emojiFor(ch.title) : '';
        if (em) set.add(em);
      });
      return Array.from(set).join(', ');
    }

    function buildGroupStats(subj, group){
      const chs = group.chapIds.map(id=>subj.chapters.find(c=>c.id===id)).filter(Boolean);
      const counts={unseen:0,echec:0,difficile:0,bien:0,facile:0};
      chs.forEach(ch=>{
        const g=getLiveGradeCounts(ch);
        counts.unseen+=g.unseen; counts.echec+=g.echec; counts.difficile+=g.difficile; counts.bien+=g.bien; counts.facile+=g.facile;
      });
      const stats={ totalReviews:0, dailyReviews:{}, dailyDurMs:{}, dailyDurCount:{}, dailyChanges:{} };
      const base=new Date();
      stats.totalReviews = chs.reduce((s,ch)=>s+(ch.stats.totalReviews||0),0);
      for(let i=0;i<60;i++){
        const d=new Date(base); d.setDate(base.getDate()-i); const k=dateKey(d);
        stats.dailyReviews[k]=chs.reduce((s,ch)=>s+(ch.stats.dailyReviews[k]||0),0);
        stats.dailyDurMs[k]=chs.reduce((s,ch)=>s+(ch.stats.dailyDurMs[k]||0),0);
        stats.dailyDurCount[k]=chs.reduce((s,ch)=>s+(ch.stats.dailyDurCount[k]||0),0);
        const agg = chs.reduce((acc,ch)=>{ const v=ch.stats.dailyChanges[k];
        if(v){acc.changed+=v.changed||0; acc.total+=v.total||0;} return acc;},{changed:0,total:0});
        stats.dailyChanges[k]=agg;
      }
      return { counts, stats };
    }

    function buildVirtualFromGroup(subj, group){
      const chs = group.chapIds.map(id=>subj.chapters.find(c=>c.id===id)).filter(Boolean);
      const cards=[];
      chs.forEach(ch=>{
        ch.cards.forEach(c=>{
          cards.push({
            id:`virt-${ch.id}-${c.id}`,
            front:c.front, back:c.back, grade:c.grade||'unseen',
            timesReviewed:c.timesReviewed||0, lastReviewed:c.lastReviewed||0, lastMs:c.lastMs||0, avgMs:c.avgMs||0,
            perfEma:c.perfEma||0.5, ef:c.ef||2.5, intervalDays:c.intervalDays||0, dueAt:c.dueAt||0,
            streak:c.streak||0, successes:c.successes||0, failures:c.failures||0,
            _origin: { chapId: ch.id, cardId: c.id }
          });
        });
      });
      const avgSize = Math.round(chs.reduce((s,ch)=>s+(ch.settings.sessionSize||10),0)/Math.max(1,chs.length))||10;
      const avgGoal = Math.round(chs.reduce((s,ch)=>s+(ch.settings.dailyGoal||10),0)/Math.max(1,chs.length))||10;
      const { counts, stats } = buildGroupStats(subj, group);
      const title = `Fichier (${groupEmojiList(subj, group)})`;
      return {
        id: 'group-'+group.id,
        title, description: title,
        virtual:true, _ids: group.chapIds.slice(),
        settings:{ sessionSize:avgSize, dailyGoal:avgGoal, reviewOrder:'front-first', langSwap:false },
        filters:{ grades:{unseen:true,echec:true,difficile:true,bien:true,facile:true} },
        stats: { gradeCounts: counts, ...stats },
        cards
      };
    }

    function addGroup(subj, chapIds){
      const ids = Array.from(new Set(chapIds)).filter(Boolean);
      if (ids.length<2) return null;
      const id = 'g'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);
      const g = { id, chapIds: ids, createdAt: Date.now() };
      ensureGroups(subj).push(g); return g;
    }
    function addToGroup(subj, groupId, chapId){
      const g = findGroupById(subj, groupId); if(!g) return;
      if(!g.chapIds.includes(chapId)) g.chapIds.push(chapId);
    }
    function removeFromGroup(subj, groupId, chapIds){
      const g = findGroupById(subj, groupId); if(!g) return;
      g.chapIds = g.chapIds.filter(id=>!chapIds.includes(id));
    }
    function deleteGroup(subj, groupId){
      subj.groups = ensureGroups(subj).filter(g=>g.id!==groupId);
    }
    function ensureValidGroups(subj){
      const set = new Set((subj.chapters||[]).map(c=>c.id));
      subj.groups = ensureGroups(subj).map(g=>({...g, chapIds: g.chapIds.filter(id=>set.has(id))}))
        .filter(g=>g.chapIds.length>=2);
    }
    
    // ---------- √âtat UI + Nav ----------
    const State = {view:'deck', chapterId:null, review:null, cardsIndex:0, dailyKey: null};
    State.virtualChapter = null;

    // getChapter doit aussi renvoyer un chapitre virtuel si actif
    const _getChapterReal = (id) => getCurrentChapters().find(c=>c.id===id);
    function getChapter(id){
      if (State.virtualChapter && State.virtualChapter.id===id) return State.virtualChapter;
      return _getChapterReal(id);
    }

    function deleteImportedChapter(chId){
      const subj = getCurrentSubject();
      const idx = subj?.chapters?.findIndex(c=>c.id===chId) ?? -1;
      if (idx<0) return false;
      const ch = subj.chapters[idx];
      if (!ch.imported){ alert('Seuls les chapitres import√©s peuvent √™tre supprim√©s.'); return false; }
      if (!confirm(`Supprimer le chapitre "${ch.title}" ?`)) return false;

      // retirer des groupes
      ensureGroups(subj).forEach(g=>{
        g.chapIds = g.chapIds.filter(id=>id!==chId);
      });
      ensureValidGroups(subj);

      subj.chapters.splice(idx,1);

      // supprimer le sujet s'il devient vide (pour sujets import√©s)
      if (subj.chapters.length===0 && subj.imported){
        data.subjects = (data.subjects||[]).filter(s=>s.id!==subj.id);
        if (data.app.currentSubjectId === subj.id){
          data.app.currentSubjectId = data.subjects[0]?.id || null;
        }
      }
      saveData();
      return true;
    }


    const Nav = {
      stack:[],
      push(){
        this.stack.push(deepClone({
          view:State.view, chapterId:State.chapterId, review:State.review,
          cardsIndex:State.cardsIndex, dailyKey: State.dailyKey
        }));
      },
      back(){
        if(!this.stack.length) return;
        State.virtualChapter = null; // Important: quitter un chapitre virtuel le d√©truit
        const prev=this.stack.pop();
        State.view=prev.view; State.chapterId=prev.chapterId; State.review=prev.review;
        State.cardsIndex=prev.cardsIndex||0; State.dailyKey=prev.dailyKey||null;
        renderByState(false);
      },
      clear(){this.stack=[];}
    };

    // ---------- DOM persistants ----------
    const backBtn=$('#backBtn');
    const titleEl=$('#title');
    const bottomActions=$('#bottomActions');
    const revisionBar=$('#revisionBar');
    const startReviewBtn=$('#startReviewBtn');

    // ----- Subject menu (UI) -----
    const subjectMenuId = 'subjectMenu';
    function ensureSubjectMenu(){
      let m = document.getElementById(subjectMenuId);
      if(!m){
        m = document.createElement('div');
        m.id = subjectMenuId;
        m.className = 'subject-menu';
        document.body.appendChild(m);
      }
      return m;
    }
    function renderSubjectMenu(){
      const m = ensureSubjectMenu();
      const list = data.subjects || [];
      const currentId = data.app.currentSubjectId;
      m.innerHTML = list.map(s=>`
        <div class="subject-item" data-id="${s.id}">
          <div class="name">${s.title}</div>
          <div class="meta">${s.chapters?.length||0} chap.</div>
          ${s.id===currentId ? '<div class="muted">‚úì</div>': ''}
        </div>
      `).join('');
      m.querySelectorAll('.subject-item').forEach(el=>{
        el.addEventListener('click', (e)=>{
          const id = el.getAttribute('data-id');
          if(id && id!==currentId){
            setCurrentSubject(id);
            closeSubjectMenu();
            goDeck(false);
          }else{
            closeSubjectMenu();
          }
          e.stopPropagation();
        });
      });
    }
    function positionSubjectMenu(){
      const m = ensureSubjectMenu();
      const rect = titleEl.getBoundingClientRect();
      const top = rect.bottom + 6 + window.scrollY;
      const left = rect.left + window.scrollX;
      m.style.top = `${top}px`;
      m.style.left = `${Math.max(8, left - 10)}px`;
    }
    function openSubjectMenu(){
      renderSubjectMenu();
      positionSubjectMenu();
      const m = ensureSubjectMenu();
      m.style.display='block';
      setTimeout(()=>document.addEventListener('click', onDocClickClose), 0);
    }
    function closeSubjectMenu(){
      const m = ensureSubjectMenu();
      m.style.display='none';
      document.removeEventListener('click', onDocClickClose);
    }
    function onDocClickClose(e){
      const m = document.getElementById(subjectMenuId);
      if(!m) return;
      if(m.contains(e.target) || e.target===titleEl) return;
      closeSubjectMenu();
    }
    titleEl.addEventListener('click', ()=>{
      if(State.view!=='deck'){ goDeck(false); return; }
      const m = document.getElementById(subjectMenuId);
      if(m && m.style.display==='block') closeSubjectMenu();
      else openSubjectMenu();
    });


    backBtn.addEventListener('click',()=>{
      if(State.view==='review' && State.review && State.review.end==null){
        if(!confirm('Quitter la r√©vision en cours ?')) return;
      }
      Nav.back();
    });
    $('#cardsBtn').addEventListener('click',()=>goCards(State.chapterId));
    $('#settingsBtn').addEventListener('click',()=>openSettings(State.chapterId));
    startReviewBtn.addEventListener('click',() => startReview(State.chapterId));

    // ---------- Rendu ----------
    function setTopbar({title,showBack}={}){
      const visible = typeof showBack==='boolean' ? showBack : (State.view!=='deck');
      backBtn.classList.toggle('hidden',!visible);
      if(title) titleEl.textContent=title;
    }

    function setBottomVisibility({actions=false, revision=false, sessionSize=10, enabled=true, available=null, chapterId=null}={}){
      bottomActions.style.display = actions?'grid':'none';
      revisionBar.style.display = revision?'block':'none';
      const phoneEl=$('#app');
      phoneEl.style.setProperty('--row-actions', actions?'52px':'0px');
      phoneEl.style.setProperty('--row-rev', revision?'64px':'0px');

      if(available==null && chapterId){
        const chap=getChapter(chapterId); available = chap?countAvailable(chap):0;
      }
      if(available==null) available=0;
      const planned = available>0 ? Math.min(sessionSize,available):0;
      startReviewBtn.textContent = `R√©vision ‚Ä¢ ${planned||sessionSize} cartes${revision ? (available>0? ` ‚Ä¢ ${available} dispo`:'') : ''}`;
      startReviewBtn.disabled = !enabled || available<=0;
    }

    function renderByState(push=true){
      switch(State.view){
        case 'deck': return goDeck(push);
        case 'chapter': return goChapter(State.chapterId,push);
        case 'cards': return goCards(State.chapterId,push);
        case 'review': return goReview(push);
        case 'recap': return goRecap(push);
        case 'settings': return openSettings(State.chapterId,push);
        case 'daily': return goDaily(State.chapterId, State.dailyKey, push);
      }
    }
    function hideReviewActionsBar(){const el=$('#reviewActionsBar'); if(el){el.style.display='none'; el.innerHTML='';}}

    // Deck
    function goDeck(push=true){
      Media.revokeAll();
      if(push) Nav.push();
      State.view='deck';
      State.chapterId=null;
      const subj = getCurrentSubject();
      setTopbar({title:`Deck ‚Ä¢ ${subj?.title||''}`, showBack:false});
      setBottomVisibility({actions:false, revision:false});
      hideReviewActionsBar();
      renderDeck();
    }
    
    // ====================================================================
    // MODIFICATION: renderDeck() enti√®rement r√©vis√©e
    // ====================================================================
    function renderDeck(){
      const v=$('#view');
      const subj = getCurrentSubject();
      const groups = ensureGroups(subj);
      
      // Cr√©er un Set avec les IDs de tous les chapitres qui sont dans un fichier
      const chapterIdsInGroups = new Set(groups.flatMap(g => g.chapIds));
      
      const allChapters = (subj.chapters || []).slice();

      v.innerHTML = `
      <div class="card flexcol" style="flex:1;">
        <div class="deck-head">
          <div class="section-title">Chapitres & Fichiers</div>
          <div class="actions">
            <button class="btn btn--ghost btn--tiny" id="importBtn">Importer</button>
            <input id="importInput" type="file" class="hidden" accept=".apkg,.csv,.tsv,.json" multiple />
          </div>
        </div>

        <div id="deckList" class="scroll-y" style="flex:1; min-height:0; padding-right:4px;">
          <div class="list">
            ${groups.map(g => {
              const { counts } = buildGroupStats(subj, g);
              const total = counts.unseen + counts.echec + counts.difficile + counts.bien + counts.facile;
              const viewed = Math.max(0, total - counts.unseen);
              const pct = total ? Math.round(viewed * 100 / total) : 0;
              const emojis = groupEmojiList(subj, g);
              return `
                <div class="deck-item" data-type="group" data-id="${g.id}">
                  <div class="slide">
                    <div style="min-width:0; flex:1">
                      <div class="title-line" style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:18px;">
                        üìÅ Fichier (${emojis})
                      </div>
                      <div class="mt6" style="display:flex; flex-wrap:wrap; gap:6px">
                        <span class="chip-pie" title="Progression : ${pct}%" style="--progress:${pct}%"></span>
                        <span class="chip">üü• ${counts.echec}</span>
                        <span class="chip">üü® ${counts.difficile}</span>
                        <span class="chip">üü¶ ${counts.bien}</span>
                        <span class="chip">üü© ${counts.facile}</span>
                        <span class="folder-badge">‚Ä¢ ${g.chapIds.length} chap.</span>
                      </div>
                    </div>
                    <div class="muted" style="font-size:18px; padding-left: 8px;">‚Ä∫</div>
                  </div>
                </div>
              `;
            }).join('')}

            ${allChapters
              .filter(ch => !chapterIdsInGroups.has(ch.id)) // Ne montrer que les chapitres qui ne sont PAS dans un fichier
              .map(ch => {
                const counts = getLiveGradeCounts(ch);
                const total = ch.cards?.length ?? 0;
                const viewed = Math.max(0, total - counts.unseen);
                const pct = total ? Math.round((viewed / total) * 100) : 0;
                return `
                  <div class="deck-item" data-type="chapter" data-id="${ch.id}">
                    ${ch.imported ? `<div class="right-action"><button class="btn btn--solid btn--red btn--tiny deleteChBtn" data-chap-id="${ch.id}">Supprimer</button></div>` : ''}
                    <div class="slide">
                      <div style="min-width:0; flex:1">
                        <div class="title-line" style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:18px;">
                          ${ch.description || ch.title}
                        </div>
                        <div class="mt6" style="display:flex; flex-wrap:wrap; gap:6px">
                          <span class="chip-pie" title="Progression : ${pct}%" style="--progress:${pct}%"></span>
                          <span class="chip">üü• ${counts.echec}</span>
                          <span class="chip">üü® ${counts.difficile}</span>
                          <span class="chip">üü¶ ${counts.bien}</span>
                          <span class="chip">üü© ${counts.facile}</span>
                        </div>
                      </div>
                      <div class="muted" style="font-size:18px; padding-left: 8px;">‚Ä∫</div>
                    </div>
                  </div>
                `;
              }).join('')}
          </div>
        </div>
      </div>
      `;

      // Bouton d'import
      const importBtn = $('#importBtn');
      const importInput = $('#importInput');
      if (importBtn && importInput) {
        importBtn.addEventListener('click', () => importInput.click());
        importInput.addEventListener('change', async (e) => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;
          try {
            await importFiles(files);
            alert('Import termin√© ‚úÖ');
            saveData();
            goDeck(false);
          } catch (err) {
            console.error(err);
            alert('Erreur import: ' + (err?.message || err));
          } finally {
            importInput.value = '';
          }
        });
      }

      bindDeckInteractions();
    }
    
    // ====================================================================
    // MODIFICATION: bindDeckInteractions() enti√®rement r√©√©crite
    // ====================================================================
    function bindDeckInteractions() {
      const list = $('#deckList');
      if (!list) return;
      const subj = getCurrentSubject();

      // Clics sur les boutons de suppression (r√©v√©l√©s par swipe)
      list.addEventListener('click', (e) => {
          if (e.target.matches('.deleteChBtn')) {
              e.stopPropagation();
              const id = e.target.getAttribute('data-chap-id');
              if (deleteImportedChapter(id)) renderDeck();
          }
      });

      const items = $$('.deck-item');
      items.forEach(el => {
        const type = el.getAttribute('data-type');
        const id = el.getAttribute('data-id');
        let sx = 0, sy = 0, dx = 0, dy = 0;
        let interactionState = 'idle'; // idle, pressed, dragging, swiping
        let longPressTimer = null;
        let ghost = null;

        const startDrag = () => {
          if (interactionState !== 'pressed' || type !== 'chapter') return;
          interactionState = 'dragging';
          el.classList.add('dragging-origin');
          document.body.classList.add('dragging-active');
          ghost = el.cloneNode(true);
          ghost.classList.add('drag-ghost');
          ghost.style.width = el.getBoundingClientRect().width + 'px';
          document.body.appendChild(ghost);
        };
        
        const moveGhost = (x, y) => {
          if (!ghost) return;
          ghost.style.transform = `translate(${x - 18}px, ${y - 18}px) scale(1.02)`;
        };

        const onDown = e => {
          sx = e.clientX;
          sy = e.clientY;
          dx = 0;
          dy = 0;
          interactionState = 'pressed';
          el.setPointerCapture?.(e.pointerId);

          clearTimeout(longPressTimer);
          if (type === 'chapter') {
            // Maintenir pour glisser-d√©poser un chapitre
            longPressTimer = setTimeout(() => {
                startDrag();
                moveGhost(e.clientX, e.clientY);
            }, 500); // 500ms pour initier le drag
          } else if (type === 'group') {
            // Maintenir pour d√©composer un fichier
            longPressTimer = setTimeout(() => {
                interactionState = 'idle'; // Emp√™che le clic apr√®s le long press
                handleDecompose(id);
            }, 700); // 700ms pour d√©composer
          }
        };

        const onMove = e => {
          if (interactionState === 'idle') return;
          
          dx = e.clientX - sx;
          dy = e.clientY - sy;

          if (interactionState === 'pressed' && (Math.abs(dx) > 10 || Math.abs(dy) > 10)) {
            clearTimeout(longPressTimer);
            
            // Si on bouge horizontalement plus que verticalement -> swipe
            if (Math.abs(dx) > Math.abs(dy) * 1.5 && Math.abs(dx) > 20) {
              if (dx < 0 && (type === 'chapter' && el.querySelector('.deleteChBtn') || type === 'group')) {
                interactionState = 'swiping';
                el.classList.add('reveal-delete');
                // R√©v√©ler le bouton de suppression sur un swipe gauche
              }
            }
          }
          
          if (interactionState === 'dragging') {
            moveGhost(e.clientX, e.clientY);
            $$('.deck-item').forEach(n => n.classList.remove('drop-target'));
            const target = document.elementFromPoint(e.clientX, e.clientY)?.closest('.deck-item');
            if (target && target !== el) {
                target.classList.add('drop-target');
            }
          }
        };

        const onUp = e => {
          clearTimeout(longPressTimer);

          if (interactionState === 'dragging') {
            const targetEl = document.elementFromPoint(e.clientX, e.clientY)?.closest('.deck-item');
            if (targetEl && targetEl !== el) {
              const tType = targetEl.getAttribute('data-type');
              const tId = targetEl.getAttribute('data-id');
              handleDrop(subj, { type, id }, { type: tType, id: tId });
            }
          } else if (interactionState === 'pressed') {
            // C'est un clic simple
            if (type === 'group') {
              openGroup(subj, id);
            } else {
              goChapter(id);
            }
          }
          
          // Cleanup
          interactionState = 'idle';
          if (ghost) ghost.remove();
          ghost = null;
          el.classList.remove('dragging-origin');
          document.body.classList.remove('dragging-active');
          $$('.deck-item').forEach(n => n.classList.remove('drop-target'));
        };

        el.addEventListener('pointerdown', onDown);
        el.addEventListener('pointermove', onMove);
        el.addEventListener('pointerup', onUp);
        el.addEventListener('pointercancel', onUp);
      });

      // Fermer les actions de swipe au scroll
      list.addEventListener('scroll', () => {
        $$('.deck-item.reveal-delete').forEach(n => n.classList.remove('reveal-delete'));
      }, { passive: true });
    }

    // NOUVELLE FONCTION: G√©rer la d√©composition d'un fichier
    function handleDecompose(groupId) {
        const subj = getCurrentSubject();
        const group = findGroupById(subj, groupId);
        if (!group) return;
        
        if (confirm("D√©composer ce fichier ? Les chapitres deviendront ind√©pendants.")) {
            deleteGroup(subj, groupId); // `deleteGroup` retire juste le groupe, les chapitres r√©appara√Ætront
            saveData();
            renderDeck();
        }
    }


    function handleDrop(subj, src, dst){
      // src: {type:'chapter', id:chapId}, dst: {type:'chapter'|'group', id}
      if (src.type!=='chapter') return;
      const srcG = findGroupByChapter(subj, src.id);

      if (dst.type==='chapter'){
        if (src.id === dst.id) return;
        const dstG = findGroupByChapter(subj, dst.id);
        if (!srcG && !dstG){
          // cr√©er un nouveau fichier avec 2 chapitres
          addGroup(subj, [src.id, dst.id]);
        }else if (srcG && !dstG){
          // ajouter dst au fichier source
          addToGroup(subj, srcG.id, dst.id);
        }else if (!srcG && dstG){
          // ajouter src au fichier cible
          addToGroup(subj, dstG.id, src.id);
        }else if (srcG && dstG && srcG.id!==dstG.id){
          // d√©placer src dans le fichier de dst
          removeFromGroup(subj, srcG.id, [src.id]);
          addToGroup(subj, dstG.id, src.id);
          ensureValidGroups(subj);
        }
      }else if (dst.type==='group'){
        const g = findGroupById(subj, dst.id);
        if (!g) return;
        const srcG = findGroupByChapter(subj, src.id);
        if (srcG && srcG.id!==g.id){
          removeFromGroup(subj, srcG.id, [src.id]);
          ensureValidGroups(subj);
        }
        addToGroup(subj, g.id, src.id);
      }
      ensureValidGroups(subj);
      saveData();
      renderDeck();
    }

    function openGroup(subj, groupId){
      const g = findGroupById(subj, groupId); if(!g) return;
      State.virtualChapter = buildVirtualFromGroup(subj, g);
      goChapter(State.virtualChapter.id);
    }
    
    // Chapter
    function goChapter(chapterId,push=true){
      Media.revokeAll();
      if(push) Nav.push();
      State.view='chapter'; State.chapterId=chapterId;
      const chap=getChapter(chapterId);
      if(!chap) { console.warn("Chapitre non trouv√©:", chapterId); Nav.back(); return; }
      setTopbar({title:chap?.title||'Statistiques'});
      setBottomVisibility({
        actions:true, revision:true, sessionSize:chap.settings.sessionSize,
        enabled:(chap.cards && chap.cards.length>0),
        available:countAvailable(chap), chapterId:chap.id
      });
      hideReviewActionsBar();
      renderChapter(chapterId);
    }

    function renderChapter(chapterId){
      const v=$('#view'); const chap=getChapter(chapterId);
      const sel=chap.filters.grades||{};
      const counts=getLiveGradeCounts(chap);
      const {unseen,echec,difficile,bien,facile}=counts;

      const today=getTodayCount(chap);
      const week=getWeekCount(chap);
      const success=getSuccessRate(chap);
      const avg7=get7DayAvgMs(chap);
      const dueNow=getDueNow(chap);
      const streak=getStreakDays(chap);
      const emoji=emojiFor(chap.title);

      v.innerHTML = `
        <div class="card" style="flex:1; display:flex; flex-direction:column;">
          <div class="section-title">${chap.virtual ? chap.description : (emoji?emoji+' ':'')}Statistiques</div>
          <div class="kpi">
            <div class="k"><div class="label">Cartes non vues</div><div class="value">${unseen}</div></div>
            <div class="k"><div class="label">Total cartes</div><div class="value">${chap.cards.length}</div></div>
          </div>

          <div class="chart-wrap"><canvas id="gradeChart" width="180" height="180" aria-label="Diagramme des scores"></canvas></div>

          <div class="legend" id="legend">
            <div class="legend-item ${sel.unseen?'':'inactive'}" data-key="unseen"><span class="dot gray"></span> Non vus: <b class="count">${unseen}</b></div>
            <div class="legend-item ${sel.echec?'':'inactive'}" data-key="echec"><span class="dot red"></span> √âchec: <b class="count">${echec}</b></div>
            <div class="legend-item ${sel.difficile?'':'inactive'}" data-key="difficile"><span class="dot amber"></span> Difficile: <b class="count">${difficile}</b></div>
            <div class="legend-item ${sel.bien?'':'inactive'}" data-key="bien"><span class="dot blue"></span> Bien: <b class="count">${bien}</b></div>
            <div class="legend-item ${sel.facile?'':'inactive'}" data-key="facile"><span class="dot green"></span> Facile: <b class="count">${facile}</b></div>
          </div>

          <div class="kpi mt8">
            <div class="k"><div class="label">Aujourd'hui</div><div class="value">${today}</div></div>
            <div class="k"><div class="label">Cette semaine</div><div class="value">${week}</div></div>
          </div>
          <div class="kpi mt8">
            <div class="k"><div class="label">Taux de r√©ussite</div><div class="value">${success}%</div></div>
            <div class="k"><div class="label">Temps moyen (7j)</div><div class="value">${avg7? (Math.round(avg7/100)/10)+'s':'‚Äî'}</div></div>
          </div>
          <div class="kpi mt8">
            <div class="k"><div class="label">√Ä r√©viser maintenant</div><div class="value">${dueNow}</div></div>
            <div class="k"><div class="label">S√©rie (jours)</div><div class="value">${streak}</div></div>
          </div>

          <div class="bar7-wrap">
            <div class="label" style="color:var(--primary)">Activit√© 7 jours</div>
            <canvas id="bar7" width="220" height="60"></canvas>
            <div class="bar7-labels" id="bar7Labels"></div>
          </div>
        </div>
      `;

      drawGradeChart('gradeChart',counts,chap.filters.grades);
      const canvas=$('#gradeChart'); canvas.style.cursor='pointer';
      canvas.onclick=(ev)=>handleChartClick(ev,'gradeChart',chap,counts);

      $$('#legend .legend-item').forEach(el=>{
        const key=el.getAttribute('data-key');
        const act=()=>{handleLegendClick(key,chap);};
        el.addEventListener('click',act);
        el.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' ') {e.preventDefault(); act();}});
        el.setAttribute('tabindex','0');
        el.setAttribute('role','button');
      });

      updateRevisionBarForChapter(chap);
      drawBars7('bar7', getLastNDaysArray(chap,7));
      const lbl=$('#bar7Labels');
      if(lbl){const noms=getLastNDaysLabelsFR(7); lbl.innerHTML=noms.map(j=>`<div>${j.substring(0,3)}</div>`).join('');}

      const barCanvas = document.getElementById('bar7');
      if (barCanvas) {
        barCanvas.style.cursor = 'pointer';
        barCanvas.onclick = (ev) => openDayFromBarClick(ev, 'bar7', chap.id, 7);
      }

      const labelsWrap = document.getElementById('bar7Labels');
      if (labelsWrap) {
        Array.from(labelsWrap.children).forEach((el, i) => {
          el.style.cursor = 'pointer';
          el.title = 'Voir les cartes de ce jour';
          el.onclick = () => goDaily(chap.id, dayKeyFromIndex(7, i));
        });
      }

      (function(){
        let t; const redraw=()=>drawBars7('bar7',getLastNDaysArray(chap,7));
        window.removeEventListener('resize', window._bar7ResizeHandler || (()=>{}));
        window._bar7ResizeHandler=()=>{clearTimeout(t); t=setTimeout(redraw,150);};
        window.addEventListener('resize', window._bar7ResizeHandler);
      })();
    }

    function updateRevisionBarForChapter(chap){
      const available=countAvailable(chap);
      setBottomVisibility({actions:true, revision:true, sessionSize:chap.settings.sessionSize, enabled:available>0, available});
    }

    // Cards
    async function goCards(chapterId,push=true){
      Media.revokeAll();
      if(push) Nav.push();
      State.view='cards'; State.chapterId=chapterId;
      const chap=getChapter(chapterId);
      setTopbar({title:`${chap.title} ‚Ä¢ Cartes`});
      setBottomVisibility({actions:false, revision:false});
      hideReviewActionsBar();
      await renderCards(chapterId);
    }

    async function renderCards(chapterId){
      const v=$('#view'); const chap=getChapter(chapterId);
      const sel=chap.filters.grades||{};
      const pool=chap.cards.filter(c=>sel[(c.grade||'unseen')]);

      v.innerHTML = `
        <div style="flex:1; display:flex; flex-direction:column; min-height:0;">
          <div class="section-title">Cartes (${pool.length})</div>
          <div id="cardsGrid" class="scroll-y" style="flex:1; min-height:0; padding-right:4px;">
            <div class="cards-grid">
              ${pool.map(c=>{
                const {frontText,backText}=getCardSides(c,chap);
                const f = preprocessLaTeX(frontText);
                const b = preprocessLaTeX(backText);
                const gradeClass=`grade-${c.grade||'unseen'}`;
                const timeStr=c.avgMs?formatDuration(c.avgMs):'';
                return `
                  <div class="card-block ${gradeClass}" data-id="${c.id}">
                    <div class="term">${f}</div>
                    <div class="definition">${b}</div>
                    ${timeStr?`<div class="cb-time">${timeStr}</div>`:''}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;

      await Media.resolveMediaInElement(v);
      await typesetLatex(v);
      const grid=$('#cardsGrid');
      grid.addEventListener('click',e=>{
        const block=e.target.closest('.card-block'); if(!block) return;
        $$('.card-block').forEach(b=>{if(b!==block) b.classList.remove('flipped');});
        block.classList.toggle('flipped');
      });
    }
    
    // Daily Activity View
    function getCombinedDailyLogFor(chap, dayKey){
      const logs=[];
      (chap._ids||[]).forEach(cid=>{
        const real = _getChapterReal(cid);
        const arr = real?.stats?.dailyLog?.[dayKey] || [];
        arr.forEach(e=> logs.push({ ...e, _chapId: cid }));
      });
      return logs;
    }
    function getCombinedDailyLogForGroup(subj, group, dayKey){
      const logs=[];
      (group.chapIds||[]).forEach(cid=>{
        const ch = subj.chapters.find(c=>c.id===cid);
        const arr = ch?.stats?.dailyLog?.[dayKey] || [];
        arr.forEach(e=> logs.push({ ...e, _chapId: cid }));
      });
      return logs;
    }
    async function goDaily(chapterId, dayKey, push=true){
      Media.revokeAll();
      if (push) Nav.push();
      State.view='daily';
      State.chapterId=chapterId;
      State.dailyKey=dayKey;
      const chap=getChapter(chapterId);
      setTopbar({ title:`Activit√© ‚Ä¢ ${formatDayKeyFR(dayKey)}` });
      setBottomVisibility({ actions:false, revision:false });
      hideReviewActionsBar();
      await renderDaily(chap, dayKey);
    }

    async function renderDaily(chap, dayKey){
      const subj = getCurrentSubject();
      let log;
      if (chap.virtual && chap.id.startsWith('group-')){
        const gid = chap.id.slice('group-'.length);
        const g = findGroupById(subj, gid);
        log = g ? getCombinedDailyLogForGroup(subj, g, dayKey) : [];
      } else {
        log = (chap.stats.dailyLog && chap.stats.dailyLog[dayKey]) ? chap.stats.dailyLog[dayKey].slice() : [];
      }

      const v = document.getElementById('view');
      if (!log.length){
        v.innerHTML = `
          <div class="card" style="flex:1; display:flex; flex-direction:column;">
            <div class="section-title">Activit√© du ${formatDayKeyFR(dayKey)}</div>
            <div class="muted">Aucune donn√©e pour ce jour.</div>
          </div>
        `;
        return;
      }

      log.sort((a,b)=>a.ts-b.ts);
      const byCard = new Map();
      for (const e of log){
        const curr = byCard.get(e.cardId) || { firstPrev:null, firstTs:Infinity, lastNext:null, lastTs:-Infinity, events:[], _chapId: e._chapId };
        if (e.ts < curr.firstTs){ curr.firstTs = e.ts; curr.firstPrev = e.prev; }
        if (e.ts > curr.lastTs) { curr.lastTs = e.ts; curr.lastNext = e.next; }
        curr.events.push(e);
        byCard.set(e.cardId, curr);
      }

      const rows = [];
      for (const [cardId, info] of byCard){
        const baseChap = chap.virtual ? _getChapterReal(info._chapId) : chap;
        const card = baseChap.cards.find(c=>c.id===cardId);
        if (!card) continue;

        const {frontText, backText} = getCardSides(card, baseChap);
        rows.push({
          id: cardId,
          term: preprocessLaTeX(frontText),
          def:  preprocessLaTeX(backText),
          before: info.firstPrev || 'unseen',
          after: info.lastNext || (card.grade || 'unseen')
        });
      }

      rows.sort((a,b)=>{
        const ca = (a.before!==a.after), cb=(b.before!==b.after);
        if (ca!==cb) return ca? -1: 1;
        return a.term.localeCompare(b.term, 'fr');
      });

      v.innerHTML = `
        <div class="card" style="flex:1; display:flex; flex-direction:column; min-height:0;">
          <div class="section-title">Activit√© du ${formatDayKeyFR(dayKey)} ‚Ä¢ ${rows.length} carte(s)</div>
          <div id="dailyList" class="scroll-y" style="flex:1; min-height:0; padding-right:4px;">
            <div class="list" style="gap:10px">
              ${rows.map(r=>`
                <div class="grid2">
                  <div class="card-block grade-${r.before}" data-id="${r.id}" data-side="before" title="Avant ce jour">
                    <div class="term">${r.term}</div>
                    <div class="definition">${r.def}</div>
                  </div>
                  <div class="card-block grade-${r.after}" data-id="${r.id}" data-side="after" title="Apr√®s ce jour">
                    <div class="term">${r.term}</div>
                    <div class="definition">${r.def}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="small muted mt6">Astuce: touchez une carte pour afficher/masquer la d√©finition.</div>
        </div>
      `;

      await Media.resolveMediaInElement(v);
      await typesetLatex(v);
      const list = document.getElementById('dailyList');
      list.addEventListener('click', (e)=>{
        const block = e.target.closest('.card-block');
        if (!block) return;
        block.classList.toggle('flipped');
      });
    }

    // Review
    function goReview(push=true){
      Media.revokeAll();
      if(push) Nav.push();
      State.view='review';
      setTopbar({title:'R√©vision'});
      setBottomVisibility({actions:false, revision:true});
      revisionBar.style.display='none';
      $('#reviewActionsBar').style.display='block';
      renderReview();
    }

    function renderReviewFooter(){
      const bar=$('#reviewActionsBar'); if(!bar) return;
      const r=State.review;
      if(!r.flipped){
        bar.innerHTML=`<button class="btn btn--solid btn--primary" id="flipBtn">Retourner</button>`;
        $('#flipBtn').onclick=()=>{r.flipped=true; renderReview();};
      }else{
        bar.innerHTML=`
          <div class="row-4">
            <button class="btn btn--red" id="grade_echec">√âchec</button>
            <button class="btn btn--amber" id="grade_difficile">Difficile</button>
            <button class="btn btn--blue" id="grade_bien">Bien</button>
            <button class="btn btn--green" id="grade_facile">Facile</button>
          </div>`;
        $('#grade_echec').onclick=()=>submitGrade('echec');
        $('#grade_difficile').onclick=()=>submitGrade('difficile');
        $('#grade_bien').onclick=()=>submitGrade('bien');
        $('#grade_facile').onclick=()=>submitGrade('facile');
      }
    }

    function renderReview(){
      const v=$('#view'); const r=State.review;
      const { card: current, chap } = getCurrentCard();
      const total=r.queue.length; const idx=r.index+1;

      const {frontText,backText}=getCardSides(current,chap);
      const frontHTML = preprocessLaTeX(frontText);
      const backHTML  = preprocessLaTeX(backText);

      const frontFirst = chap.settings.reviewOrder!=='back-first';
      const prompt = frontFirst ? frontHTML : backHTML;
      const isPromptFront=frontFirst; const promptClass=isPromptFront?'term':'definition'; const promptFace=isPromptFront?'front':'back';

      v.innerHTML = `
        <div class="review-wrap">
          <div class="review-top"><div>${r.mode==='multi' ? ('Multi ‚Ä¢ '+chap.title) : chap.title}</div><div>${idx} / ${total}</div></div>
          <div class="review-card">
            <div class="review-scroller">
              ${!r.flipped
                ? `<div class="${promptClass}" data-face="${promptFace}">${prompt}</div>`
                : `<div class="stack"><div class="term" data-face="front">${frontHTML}</div><div class="definition" data-face="back" style="margin-top:6px">${backHTML}</div></div>`
              }
            </div>
          </div>
        </div>
      `;

      typesetLatex(v).then(async ()=>{
        await Media.resolveMediaInElement(v);
        initReviewGestures();
      });
      renderReviewFooter();
    }

    // Recap
    function goRecap(push=true){
      Media.revokeAll();
      if(push) Nav.push();
      State.view='recap';
      const chap = getChapter(State.review.chapterId) || State.virtualChapter || getChapter(State.review.multiChaps[0]);
      setTopbar({title:'R√©capitulatif'});
      setBottomVisibility({actions:false, revision:false});
      hideReviewActionsBar();
      renderRecap(chap);
    }

    function renderRecap(chap){
      const v=$('#view'); const r=State.review;
      const totalSession=r.answers.length; const duration=r.end-r.start; const avgPerCard=totalSession?duration/totalSession:0;
      const todayChange=getTodayChange(chap); const todayReviews=getTodayCount(chap);
      v.innerHTML = `
        <div class="card recap" style="flex:1">
          <div><h2>R√©capitulatif</h2><div class="subtitle">${chap.title}</div></div>
          <div class="grid2">
            <div class="stat"><div class="label">R√©visions/jour (7j)</div><div class="val">${get7DayAverage(chap)}</div></div>
            <div class="stat"><div class="label">Changement de classe aujourd'hui</div><div class="val">${todayChange.total>0?Math.round((todayChange.changed/todayChange.total)*100):0}%</div></div>
            <div class="stat"><div class="label">Objectif quotidien</div><div class="val">${chap.settings.dailyGoal}</div></div>
            <div class="stat"><div class="label">R√©visions aujourd'hui</div><div class="val">${todayReviews}/${chap.settings.dailyGoal}</div></div>
          </div>
          <div class="grid2">
            <div class="stat"><div class="label">Total r√©visions (session)</div><div class="val">${totalSession}</div></div>
            <div class="stat"><div class="label">Dur√©e (session)</div><div class="val">${formatDuration(duration)}</div></div>
            <div class="stat"><div class="label">Temps moyen/carte</div><div class="val">${formatDuration(avgPerCard)}</div></div>
          </div>
          <div class="cta"><button class="btn btn--solid btn--primary" id="continueBtn">Continuer</button></div>
        </div>
      `;
      $('#continueBtn').addEventListener('click',()=>startReview(r.chapterId));
    }

    function startReviewMulti(chapIds){
      const all = chapIds.map(_getChapterReal).filter(Boolean);
      if (!all.length) return;
      // pool filtr√© par filtres propres √† chaque chapitre
      const pool = [];
      all.forEach(ch=>{
        const sel = ch.filters.grades;
        ch.cards.forEach(c=>{ if (sel[c.grade||'unseen']) pool.push({ chapId: ch.id, card: c }); });
      });
      if (!pool.length){ alert('Aucune carte disponible avec les filtres actuels.'); return; }

      const scored = pool.map(({chapId,card})=>{
        const g=card.grade||'unseen';
        const baseWMap={unseen:6,echec:5,difficile:3.5,bien:2,facile:1};
        const now=Date.now();
        const baseW=baseWMap[g]??1;
        let dueBoost=1;
        if(card.dueAt && card.dueAt>0){
          const delta=now-card.dueAt;
          dueBoost = delta>0 ? (1+Math.min(3,delta/864e5)) : 0.85;
        }else{ dueBoost=1.15; }
        const ema=typeof card.perfEma=='number' ? card.perfEma : 0.5;
        const perfBoost=1+(1-ema)*1.6;
        const s=card.streak||0;
        const streakAdj = s>=3 ? (1/(1+0.12*(s-2))) : (s<0 ? (1+0.18*Math.min(8,Math.abs(s))) : 1);
        const t=card.avgMs||0; const timeBoost=1+Math.min(2,t/3000);
        const jitter=0.9+Math.random()*0.2;
        const weight=baseW*dueBoost*perfBoost*streakAdj*timeBoost*jitter;
        return { chapId, cardId: card.id, weight };
      });
      scored.sort((a,b)=>b.weight-a.weight);
      // Taille session: moyenne des sessionSize des chapitres, plafonn√©e par le disponible
      const avgSize = Math.round(all.reduce((s,ch)=>s+(ch.settings.sessionSize||10),0)/all.length);
      const size = Math.min(avgSize||10, scored.length);
      const queue = scored.slice(0,size).map(x=>({ chapId:x.chapId, cardId:x.cardId }));

      State.review = { mode:'multi', chapterId:null, multiChaps: chapIds.slice(), queue, index:0, flipped:false, answers:[], start:Date.now(), end:null, cardStart:Date.now() };
      goReview();
    }
    // ---------- Logique r√©vision ----------
    function startReview(chapterId){
      if(!chapterId) return;
      const chap=getChapter(chapterId);
      if (chap && chap.virtual && Array.isArray(chap._ids)) {
        return startReviewMulti(chap._ids);
      }
      
      const sel=chap.filters.grades;
      const pool=chap.cards.filter(c=>sel[(c.grade||'unseen')]);
      const size=Math.min(chap.settings.sessionSize,pool.length);
      if(size<=0){alert('Aucune carte disponible avec les filtres s√©lectionn√©s.'); return;}
      const queue=buildSmartQueue(chap,pool,size).map(c=>c.id);
      State.review={chapterId, queue, index:0, flipped:false, answers:[], start:Date.now(), end:null, cardStart:Date.now()};
      goReview();
    }

    function buildSmartQueue(chap,pool,size){
      const now=Date.now();
      const baseWMap={unseen:6,echec:5,difficile:3.5,bien:2,facile:1};
      const scored=pool.map(c=>{
        const g=c.grade||'unseen'; const baseW=baseWMap[g]??1;
        let dueBoost=1;
        if(c.dueAt && c.dueAt>0){
          const delta=now-c.dueAt;
          dueBoost = delta>0 ? (1+Math.min(3,delta/864e5)) : 0.85;
        }else{ dueBoost=1.15; }
        const ema=typeof c.perfEma=='number' ? c.perfEma : 0.5;
        const perfBoost=1+(1-ema)*1.6;
        const s=c.streak||0;
        const streakAdj = s>=3 ? (1/(1+0.12*(s-2))) : (s<0 ? (1+0.18*Math.min(8,Math.abs(s))) : 1);
        const t=c.avgMs||0; const timeBoost=1+Math.min(2,t/3000);
        const jitter=0.9+Math.random()*0.2;
        return {card:c, weight:baseW*dueBoost*perfBoost*streakAdj*timeBoost*jitter};
      });
      scored.sort((a,b)=>b.weight-a.weight);
      return scored.slice(0,size).map(x=>x.card);
    }

    function getCurrentCard(){
      const r=State.review;
      if (r?.mode==='multi'){
        const item = r.queue[r.index];
        const chap = _getChapterReal(item.chapId);
        const card = chap.cards.find(c=>c.id===item.cardId);
        return { card, chap };
      }else{
        const chap=getChapter(r.chapterId);
        const id=r.queue[r.index];
        return { card: chap.cards.find(c=>c.id===id), chap };
      }
    }

    function submitGrade(nextGrade){
      const r=State.review; const now=Date.now();
      const {card: currentCard, chap: currentChap} = getCurrentCard();

      const origin = currentCard._origin || { chapId: r.chapterId, cardId: currentCard.id };
      const chap = _getChapterReal(origin.chapId);
      const card = chap.cards.find(c => c.id === origin.cardId);

      const duration=Math.max(0, now-(r.cardStart||now));
      const prevGrade=card.grade||'unseen';
      const next=nextGrade;

      const wasZeroBeforeNext=(chap.stats.gradeCounts[next]||0)===0;
      card.grade=next;
      syncGradeCounts(chap);

      const alpha=0.3; const q01=gradeNorm01(next);
      card.perfEma = (1-alpha)*(card.perfEma??0.5) + alpha*q01;
      scheduleNext(card,next,now);

      card.lastReviewed=now; card.lastMs=duration;
      card.avgMs = card.avgMs ? Math.round(card.avgMs*0.7 + duration*0.3) : duration;
      card.timesReviewed=(card.timesReviewed||0)+1;
      if(isSuccess(next)) card.successes+=1; else card.failures+=1;

      chap.stats.totalReviews += 1;
      const tk=todayKey();
      chap.stats.dailyReviews[tk]=(chap.stats.dailyReviews[tk]||0)+1;
      chap.stats.dailyDurMs[tk]=(chap.stats.dailyDurMs[tk]||0)+duration;
      chap.stats.dailyDurCount[tk]=(chap.stats.dailyDurCount[tk]||0)+1;
      const dc=chap.stats.dailyChanges[tk]||{changed:0,total:0};
      dc.total+=1; if(prevGrade!==next) dc.changed+=1; chap.stats.dailyChanges[tk]=dc;

      const log = chap.stats.dailyLog[tk] || [];
      log.push({ cardId: card.id, prev: prevGrade, next, ms: duration, ts: now });
      chap.stats.dailyLog[tk] = log;

      if(wasZeroBeforeNext && next!=='unseen'){ chap.filters.grades[next]=true; }

      r.answers.push({cardId:card.id, prev:prevGrade, next, ms:duration});
      if(r.index < r.queue.length-1){
        r.index+=1; r.flipped=false; r.cardStart=Date.now();
        saveData(); renderReview();
      }else{
        r.end=Date.now(); saveData(); goRecap();
      }
    }

    // ---------- Helpers chapitres/stats ----------
    function getCardSides(card,chap){
      return chap?.settings?.langSwap ? {frontText:card.back, backText:card.front} : {frontText:card.front, backText:card.back};
    }
    function getLiveGradeCounts(chap){
      const c={unseen:0,echec:0,difficile:0,bien:0,facile:0};
      (chap.cards||[]).forEach(x=>{const g=x.grade||'unseen'; c[g]!=null ? c[g]++ : c.unseen++;});
      return c;
    }
    function syncGradeCounts(chap){chap.stats=chap.stats||{}; chap.stats.gradeCounts=getLiveGradeCounts(chap);}

    function getTodayCount(chap){return chap.stats.dailyReviews[todayKey()]||0;}
    function getTodayChange(chap){return chap.stats.dailyChanges[todayKey()]||{changed:0,total:0};}
    function get7DayAverage(chap){
      const base=new Date(); const days=[];
      for(let i=6;i>=0;i--){const d=new Date(base); d.setDate(base.getDate()-i); days.push(chap.stats.dailyReviews[dateKey(d)]||0);}
      return Math.round(avg(days));
    }
    function getWeekCount(chap){
      const base=new Date(); let sum=0;
      for(let i=0;i<7;i++){const d=new Date(base); d.setDate(base.getDate()-i); sum+=(chap.stats.dailyReviews[dateKey(d)]||0);}
      return sum;
    }
    function getSuccessRate(chap){
      const gc=chap.stats.gradeCounts||{};
      const good=(gc.bien||0)+(gc.facile||0);
      const attempt=good+(gc.echec||0)+(gc.difficile||0);
      return attempt===0?0:Math.round((good/attempt)*100);
    }
    function get7DayAvgMs(chap){
      if(!chap.stats.dailyDurMs||!chap.stats.dailyDurCount) return 0;
      const base=new Date(); let sum=0,cnt=0;
      for(let i=0;i<7;i++){
        const d=new Date(base); d.setDate(base.getDate()-i);
        const k=dateKey(d); sum+=(chap.stats.dailyDurMs[k]||0); cnt+=(chap.stats.dailyDurCount[k]||0);
      }
      return cnt?Math.round(sum/cnt):0;
    }
    function countAvailable(chap){const sel=chap.filters.grades; return chap.cards.filter(c=>sel[(c.grade||'unseen')]).length;}
    function getDueNow(chap){const now=Date.now(); return chap.cards.filter(c=>c.dueAt && c.dueAt>0 && c.dueAt<=now).length;}
    function getStreakDays(chap){
      const base=new Date(); let streak=0;
      for(let i=0;i<365;i++){const d=new Date(base); d.setDate(base.getDate()-i); const n=chap.stats.dailyReviews[dateKey(d)]||0; if(n>0) streak++; else break;}
      return streak;
    }

    function getLastNDaysArray(chap,n){
      const arr=[]; const base=new Date();
      for(let i=n-1;i>=0;i--){const d=new Date(base); d.setDate(base.getDate()-i); arr.push(chap.stats.dailyReviews[dateKey(d)]||0);}
      return arr;
    }
    function getLastNDaysLabelsFR(n){
      const noms=[]; const base=new Date(); const J=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
      for(let i=n-1;i>=0;i--){const d=new Date(base); d.setDate(base.getDate()-i); noms.push(J[d.getDay()]);}
      return noms;
    }

    function dayKeyFromIndex(n, index) {
      const base = new Date();
      const offset = (n - 1) - index;
      const d = new Date(base);
      d.setHours(0,0,0,0);
      d.setDate(base.getDate() - offset);
      return dateKey(d);
    }

    function openDayFromBarClick(evt, canvasId, chapId, n=7) {
      const hit = Bar7Hit[canvasId];
      if (!hit) return;
      const rect = evt.target.getBoundingClientRect();
      const xCSS = (evt.clientX - rect.left) * (hit.cssW / rect.width);
      const i = hit.bars.findIndex(b => xCSS >= b.x && xCSS <= b.x + b.w);
      if (i < 0) return;
      const key = dayKeyFromIndex(n, i);
      goDaily(chapId, key);
    }

    // ---------- Bar chart ----------
    function drawBars7(canvasId, values) {
      const el = document.getElementById(canvasId);
      if (!el) return;
      const ctx = el.getContext('2d');

      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const cssW = Math.round(el.clientWidth || el.getBoundingClientRect().width || 220);
      const cssH = Math.round(parseFloat(getComputedStyle(el).height) || el.height || 60);

      if (el.width !== cssW * dpr || el.height !== cssH * dpr) {
        el.width = cssW * dpr;
        el.height = cssH * dpr;
      }

      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, el.width, el.height);
      ctx.scale(dpr, dpr);

      const w = cssW, h = cssH;
      const max = Math.max(1, ...values);
      const n = values.length;
      const gap = 6;
      const totalGap = gap * (n - 1);
      const barW = Math.max(6, Math.floor((w - totalGap) / n));

      const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#6366f1';
      const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#0f172a';

      const fontPx = Math.max(9, Math.min(10, Math.floor(barW * 0.7)));
      const textPad = fontPx + 4;
      const baseY = h - textPad - 2;
      const minH = 3;

      ctx.strokeStyle = 'rgba(148,163,184,0.35)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, baseY + 0.5);
      ctx.lineTo(w, baseY + 0.5);
      ctx.stroke();

      ctx.font = `bold ${fontPx}px ui-sans-serif, system-ui`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';

      let x = 0;
      const bars = [];
      values.forEach(v => {
        const bhRaw = Math.round((v / max) * (h - textPad - 8));
        const bh = Math.max(minH, bhRaw);
        const y = baseY - bh;

        ctx.fillStyle = primary;
        ctx.globalAlpha = 0.95;
        ctx.fillRect(x, y, barW, bh);
        ctx.globalAlpha = 1;

        ctx.fillStyle = textColor;
        ctx.fillText(String(v), x + barW / 2, baseY + 2);

        ctx.fillStyle = 'rgba(0,0,0,0.15)';
        ctx.fillRect(x, baseY, barW, 2);

        bars.push({ x, w: barW });
        x += barW + gap;
      });

      Bar7Hit[canvasId] = { cssW: w, cssH: h, bars };
    }


    // ---------- Donut ----------
    function drawGradeChart(canvasId,counts,activeKeys=null){
      const el=document.getElementById(canvasId); if(!el) return;
      const ctx=el.getContext('2d'); const w=el.width,h=el.height;
      ctx.clearRect(0,0,w,h);
      const cx=w/2, cy=h/2; const outerR=Math.min(w,h)/2-6; const innerR=outerR*0.65;

      const css=getComputedStyle(document.documentElement);
      const segments=[
        {key:'unseen',color:'#9ca3af'},
        {key:'echec',color:css.getPropertyValue('--red').trim()},
        {key:'difficile',color:css.getPropertyValue('--amber').trim()},
        {key:'bien',color:css.getPropertyValue('--blue').trim()},
        {key:'facile',color:css.getPropertyValue('--green').trim()},
      ];
      const total=segments.reduce((s,seg)=>s+(counts[seg.key]||0),0);
      const arcs=[];
      if(total===0){
        ctx.beginPath(); ctx.arc(cx,cy,outerR,0,Math.PI*2); ctx.arc(cx,cy,innerR,0,Math.PI*2,true);
        ctx.fillStyle='#cbd5e1'; ctx.globalAlpha=.25; ctx.fill(); ctx.globalAlpha=1;
        ctx.fillStyle='#64748b'; ctx.font='bold 12px ui-sans-serif, system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText('Aucune donn√©e',cx,cy);
        ChartHit[canvasId]={cx,cy,innerR,outerR,arcs:[]}; return;
      }
      let start=-Math.PI/2;
      segments.forEach(seg=>{
        const val=counts[seg.key]||0; if(val<=0) return;
        const a=(val/total)*Math.PI*2; const end=start+a;
        const active=!activeKeys || !!activeKeys[seg.key];

        ctx.beginPath(); ctx.arc(cx,cy,outerR,start,end); ctx.arc(cx,cy,innerR,end,start,true);
        ctx.fillStyle=seg.color; ctx.globalAlpha=active?0.9:0.22; ctx.fill(); ctx.globalAlpha=1;

        arcs.push({key:seg.key,start,end}); start=end;
      });

      ctx.fillStyle='#0ea5e9'; ctx.font='bold 18px ui-sans-serif, system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(String(total),cx,cy-4);
      ctx.fillStyle='#64748b'; ctx.font='10px ui-sans-serif, system-ui'; ctx.fillText('cartes',cx,cy+10);

      ChartHit[canvasId]={cx,cy,innerR,outerR,arcs};
    }

    function toggleFilterKey(chap,key){
      const sel=chap.filters.grades; const total=Object.keys(sel).length; const active=Object.keys(sel).filter(k=>sel[k]); const isSelected=!!sel[key];
      if(active.length===total){Object.keys(sel).forEach(k=>sel[k]=false); sel[key]=true;}
      else if(active.length===1 && isSelected){sel[key]=true;}
      else{
        sel[key]=!isSelected;
        if(Object.keys(sel).filter(k=>sel[k]).length===0){sel[key]=true;}
      }
    }
    function handleChartClick(evt,canvasId,chap){
      const map=ChartHit[canvasId]; if(!map||!map.arcs.length) return;
      const rect=evt.target.getBoundingClientRect(); const scaleX=evt.target.width/rect.width; const scaleY=evt.target.height/rect.height;
      const x=(evt.clientX-rect.left)*scaleX; const y=(evt.clientY-rect.top)*scaleY;
      const dx=x-map.cx, dy=y-map.cy; const r=Math.hypot(dx,dy); if(r<map.innerR||r>map.outerR) return;
      let a=Math.atan2(dy,dx); while(a<-Math.PI/2) a+=2*Math.PI; while(a>3*Math.PI/2) a-=2*Math.PI;
      const hit=map.arcs.find(s=>a>=s.start && a<=s.end); if(!hit) return;
      toggleFilterKey(chap,hit.key); saveData(); renderChapter(chap.id);
    }
    function handleLegendClick(key,chap){toggleFilterKey(chap,key); saveData(); renderChapter(chap.id);}

    // ---------- Th√®me / UI ----------
    function applyTheme(){document.documentElement.setAttribute('data-theme', (data?.app?.theme)||'dark');}
    function applyUI(){
      const p=data.app.prefs||{};
      document.documentElement.style.setProperty('--fs-term',(p.fsTerm||20)+'px');
      document.documentElement.style.setProperty('--fs-def',(p.fsDef||24)+'px');
      document.documentElement.style.setProperty('--radius-md',(p.radius||14)+'px');
      const palette={
        indigo:['#6366f1','#5457e6'], blue:['#3b82f6','#2563eb'], teal:['#14b8a6','#0d9488'],
        emerald:['#10b981','#059669'], rose:['#f43f5e','#e11d48'], amber:['#f59e0b','#d97706'], violet:['#8b5cf6','#7c3aed']
      };
      const acc=palette[p.accent]||palette.indigo;
      document.documentElement.style.setProperty('--primary',acc[0]);
      document.documentElement.style.setProperty('--primary-600',acc[1]);
    }

    function upgradeData(){
      data.app=data.app||{};
      if(!('theme' in data.app)) data.app.theme='dark';
      data.app.prefs=data.app.prefs||{};
      if(typeof data.app.prefs.fsTerm!=='number') data.app.prefs.fsTerm=22;
      if(typeof data.app.prefs.fsDef!=='number') data.app.prefs.fsDef=24;
      if(!data.app.prefs.accent) data.app.prefs.accent='indigo';
      if(typeof data.app.prefs.showEmoji!=='boolean') data.app.prefs.showEmoji=true;
      if(typeof data.app.prefs.radius!=='number') data.app.prefs.radius=14;
      if (!data.mediaIndex) data.mediaIndex = {};

      if(!Array.isArray(data.subjects)){
        data.subjects = [{ id:'anglais', title:'Anglais', chapters: data.chapters||[], groups: [] }];
        delete data.chapters;
        if(!data.app.currentSubjectId) data.app.currentSubjectId='anglais';
      }

      data.subjects.forEach(subj=>{
        if (!Array.isArray(subj.groups)) subj.groups = [];
        ensureValidGroups(subj);
        (subj.chapters||[]).forEach(ch=>{
          ch.settings=ch.settings||{};
          if(typeof ch.settings.langSwap!=='boolean') ch.settings.langSwap=false;
          ch.stats=ch.stats||{};
          if (!ch.stats.dailyLog) ch.stats.dailyLog = {};
          (ch.cards||[]).forEach(c=>{
            if(typeof c.perfEma!=='number') c.perfEma=0.5;
            if(typeof c.ef!=='number') c.ef=2.5;
            if(typeof c.intervalDays!=='number') c.intervalDays=0;
            if(typeof c.dueAt!=='number') c.dueAt=0;
            if(typeof c.streak!=='number') c.streak=0;
            if(typeof c.successes!=='number') c.successes=0;
            if(typeof c.failures!=='number') c.failures=0;
          });
          syncGradeCounts(ch);
        });
      });
      saveData();
    }

    // ---------- Param√®tres ----------
    function openSettings(chapterId,push=true){
      Media.revokeAll();
      if(!chapterId) chapterId=State.chapterId;
      const chap=getChapter(chapterId); if(!chap) return;

      if(push) Nav.push();
      const v=$('#view'); State.view='settings';
      setTopbar({title:`${chap.title} ‚Ä¢ Param√®tres`});
      setBottomVisibility({actions:false, revision:false});
      hideReviewActionsBar();

      v.innerHTML = `
        <div class="settings-page scroll-y" style="flex:1; min-height:0;">
          <div>
            <div class="settings-hero">Param√®tres</div>
            <div class="settings-sub">Personnalisez l‚Äôaffichage, les langues et vos objectifs</div>
          </div>

          <div class="settings-section">
            <div class="section-title">Apparence</div>
            <div class="mt6 muted" style="font-size:13px">‚Ä¢ Th√®me: <b id="themeLbl">${data.app.theme==='light'?'Clair':'Sombre'}</b></div>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn" id="toggleTheme">Basculer Clair/Sombre</button>
            </div>
            <div class="mt6 muted" style="font-size:13px">Couleur d‚Äôaccent</div>
            <div class="swatches" id="accentSwatches">
              <button class="swatch" data-accent="indigo" style="--sw:#6366f1" aria-label="Indigo"></button>
              <button class="swatch" data-accent="blue" style="--sw:#3b82f6" aria-label="Bleu"></button>
              <button class="swatch" data-accent="teal" style="--sw:#14b8a6" aria-label="Teal"></button>
              <button class="swatch" data-accent="emerald" style="--sw:#10b981" aria-label="√âmeraude"></button>
              <button class="swatch" data-accent="rose" style="--sw:#f43f5e" aria-label="Rose"></button>
              <button class="swatch" data-accent="amber" style="--sw:#f59e0b" aria-label="Ambre"></button>
              <button class="swatch" data-accent="violet" style="--sw:#8b5cf6" aria-label="Violet"></button>
            </div>
          </div>

          <div class="settings-section">
            <div class="section-title">Langues</div>
            <div class="mt6 muted" style="font-size:13px">Recto ‚Üí Verso: <b id="langOrderLbl">${chap.settings.langSwap?'EN ‚Üí FR':'FR ‚Üí EN'}</b></div>
            <button class="btn" id="toggleLangSwap">Basculer FR ‚Üî EN</button>
          </div>

          <div class="settings-section">
            <div class="section-title">Typographie</div>
            <div class="card" id="typoPreview" style="margin-bottom:8px; padding:10px; position:relative;">
              <div class="term">Exemple recto (Front)</div>
              <div class="definition" style="margin-top:6px">Exemple verso (Back)</div>
              <div class="muted" style="font-size:12px; margin-top:6px">Glissez ‚Üë‚Üì pour ajuster via les roues ou directement ici.</div>
              <div id="typoToast" class="size-toast"></div>
            </div>
            <div class="wheel" id="wheelFsTerm"><div class="name">Recto (Front)</div><div class="hint">Glissez ‚Üë‚Üì</div><div class="wheel-value"></div></div>
            <div class="wheel mt6" id="wheelFsDef"><div class="name">Verso (Back)</div><div class="hint">Glissez ‚Üë‚Üì</div><div class="wheel-value"></div></div>
          </div>

          <div class="settings-section">
            <div class="section-title">Session & Objectif</div>
            <div class="wheel" id="wheelSession"><div class="name">Taille session</div><div class="hint">Glissez ‚Üë‚Üì</div><div class="wheel-value"></div></div>
            <div class="wheel mt6" id="wheelGoal"><div class="name">Objectif quotidien</div><div class="hint">Glissez ‚Üë‚Üì</div><div class="wheel-value"></div></div>
          </div>

          <div class="settings-section">
            <div class="section-title">R√©initialiser</div>
            <div class="mt6 muted" style="font-size:13px">Remettre √† z√©ro la progression (grades, stats, temps).</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
              <button class="btn" id="resetChapterBtn">Reset chapitre</button>
              <button class="btn btn--solid btn--red" id="resetAllBtn">Reset application</button>
            </div>
          </div>
        </div>
      `;

      const P=data.app.prefs;

      const refreshTheme=()=>{$('#themeLbl').textContent=data.app.theme==='light'?'Clair':'Sombre';};
      const refreshLang=()=>{$('#langOrderLbl').textContent=chap.settings.langSwap?'EN ‚Üí FR':'FR ‚Üí EN';};

      $('#toggleLangSwap').onclick=()=>{chap.settings.langSwap=!chap.settings.langSwap; saveData(); refreshLang(); renderByState(false);};
      $('#toggleTheme').onclick=()=>{data.app.theme=data.app.theme==='light'?'dark':'light'; saveData(); applyTheme(); refreshTheme();};

      const activeAccent=data.app.prefs.accent||'indigo';
      $$('#accentSwatches .swatch').forEach(sw=>{
        const key=sw.getAttribute('data-accent');
        sw.classList.toggle('is-active', key===activeAccent);
        sw.onclick=()=>{data.app.prefs.accent=key; saveData(); applyUI(); $$('#accentSwatches .swatch').forEach(x=>x.classList.toggle('is-active', x.getAttribute('data-accent')===key));};
      });

      bindWheel($('#wheelFsTerm'),{get:()=>P.fsTerm, set:v=>{P.fsTerm=v}, min:12,max:60,step:1,unit:'px'});
      bindWheel($('#wheelFsDef'),{get:()=>P.fsDef, set:v=>{P.fsDef=v}, min:14,max:72,step:1,unit:'px'});
      bindWheel($('#wheelSession'),{get:()=>chap.settings.sessionSize,set:v=>{chap.settings.sessionSize=v}, min:5,max:200,step:5,unit:' cartes'});
      bindWheel($('#wheelGoal'),{get:()=>chap.settings.dailyGoal,set:v=>{chap.settings.dailyGoal=v}, min:5,max:500,step:5,unit:' cartes'});

      $('#resetChapterBtn').onclick=()=>{
        if(!confirm('R√©initialiser la progression de ce chapitre ?')) return;
        resetChapter(chap.id); saveData(); openSettings(chapterId,false);
      };
      $('#resetAllBtn').onclick=resetAll;

      bindTypoPreviewDrag();
    }

    function reconcileChaptersWithCanonical(canonChapters, oldChapters){
      const savedCardByRowId = new Map();
      for (const ch of (oldChapters||[])) {
        for (const c of (ch.cards||[])) {
          const rid = extractRowId(c.id);
          if (rid != null && !savedCardByRowId.has(rid)) savedCardByRowId.set(rid, c);
        }
      }
      const PROG_KEYS = [
        'grade','timesReviewed','lastReviewed','lastMs','avgMs',
        'perfEma','ef','intervalDays','dueAt','streak','successes','failures'
      ];

      return canonChapters.map(cCh => {
        const sCh = (oldChapters||[]).find(x => x.title === cCh.title) || null;
        const merged = {
          id: cCh.id,
          title: cCh.title,
          description: cCh.description,
          settings: { ...cCh.settings, ...(sCh?.settings || {}) },
          filters: { grades: { ...cCh.filters.grades, ...(sCh?.filters?.grades || {}) } },
          stats: sCh?.stats ? { ...sCh.stats } : { ...cCh.stats },
          cards: []
        };
        const byRowId = new Map();
        if (sCh) {
          (sCh.cards||[]).forEach(sc => {
            const rid = extractRowId(sc.id);
            if (rid!=null) byRowId.set(rid, sc);
          });
        }
        merged.cards = cCh.cards.map(cc=>{
          const rid = extractRowId(cc.id);
          const sc = byRowId.get(rid) || savedCardByRowId.get(rid);
          if (sc){
            const copy = { ...cc };
            PROG_KEYS.forEach(k => { if (sc[k] !== undefined) copy[k] = sc[k]; });
            return copy;
          }
          return { ...cc };
        });
        merged.stats.gradeCounts = getLiveGradeCounts(merged);
        return merged;
      });
    }

    function reconcileAllSubjectsWithCanonical(){
      const canonSubjects = buildCanonicalSubjects();
      const oldSubjects = Array.isArray(data.subjects) ? data.subjects : [];

      const newSubjects = [];
      canonSubjects.forEach(cSub=>{
        const sSub = oldSubjects.find(s => s.id===cSub.id || s.title===cSub.title);
        const merged = {
          id: cSub.id,
          title: cSub.title,
          chapters: reconcileChaptersWithCanonical(cSub.chapters, sSub?.chapters || []),
          groups: Array.isArray(sSub?.groups) ? sSub.groups.slice() : []
        };
        ensureValidGroups(merged);
        newSubjects.push(merged);
      });

      oldSubjects.forEach(sSub=>{
        if(!newSubjects.find(ns=>ns.id===sSub.id)) newSubjects.push(sSub);
      });

      data.subjects = newSubjects;
      if (!data.app.currentSubjectId || !data.subjects.find(s=>s.id===data.app.currentSubjectId)) {
        data.app.currentSubjectId = data.subjects[0]?.id || null;
      }
      saveData();
    }

    function initReviewGestures(){
        const view = document.getElementById('view');
        if (!view) return;
        const scroller = view.querySelector('.review-scroller, .review-card > div');
        if (!scroller) return;

        bindReviewSizeControls();
        enableImageLightboxInReview(scroller);
    }

    function bindReviewSizeControls(){
      const faces = document.querySelectorAll('.review-card [data-face]');
      if (!faces.length) return;

      const P = data.app.prefs || {};
      const applyVars = ()=>{
        document.documentElement.style.setProperty('--fs-term',(P.fsTerm||20)+'px');
        document.documentElement.style.setProperty('--fs-def',(P.fsDef||24)+'px');
      };

      faces.forEach(el=>{
        const face = el.getAttribute('data-face');
        let startY=null, startVal=null;
        const getVal = () => face==='front' ? (P.fsTerm||20) : (P.fsDef||24);
        const setVal = v => {
          if (face==='front') P.fsTerm = clamp(v,12,60);
          else               P.fsDef = clamp(v,14,72);
          applyVars();
        };
        const commit = ()=>saveData();

        el.addEventListener('pointerdown', e=>{
          if (e.target.closest('img, video, svg, canvas, mjx-container, a, pre, code')) return;
          const scroller = el.closest('.review-card')?.querySelector('.review-scroller, .review-card > div');
          if (scroller && scroller.scrollHeight > scroller.clientHeight) return;

          startY=e.clientY;
          startVal=getVal();
          el.setPointerCapture?.(e.pointerId);
          e.preventDefault();
          e.stopPropagation();
        });

        el.addEventListener('pointermove', e=>{
          if (startY==null) return;
          const dy = startY - e.clientY;
          const delta = Math.round(dy/6);
          setVal(startVal + delta);
          e.preventDefault();
          e.stopPropagation();
        });

        const end = e=>{
          if (startY!=null) commit();
          startY=null; startVal=null;
        };
        el.addEventListener('pointerup', end);
        el.addEventListener('pointercancel', end);

        el.addEventListener('wheel', e=>{
          e.preventDefault();
          const dir = e.deltaY>0 ? -1 : 1;
          setVal(getVal()+dir);
          commit();
        },{passive:false});
      });
    }

    function bindTypoPreviewDrag(){
      const box=$('#typoPreview'); if(!box) return;
      const termEl=box.querySelector('.term'); const defEl=box.querySelector('.definition'); const toast=$('#typoToast'); const P=data.app.prefs||{};
      let startY=null,startTerm=null,startDef=null,target='both';
      const showToast=msg=>{if(!toast) return; toast.textContent=msg; toast.style.display='block';};
      const hideToast=()=>{if(toast) toast.style.display='none';};
      const updateVars=()=>{
        document.documentElement.style.setProperty('--fs-term',(P.fsTerm||20)+'px');
        document.documentElement.style.setProperty('--fs-def',(P.fsDef||24)+'px');
      };
      const start=e=>{
        const t=e.target.closest('.term, .definition, #typoPreview'); if(!t) return;
        startY=(e.touches?e.touches[0].clientY:e.clientY); startTerm=P.fsTerm||20; startDef=P.fsDef||24;
        target = t.classList.contains('term')?'term' : t.classList.contains('definition')?'def':'both';
        e.preventDefault();
      };
      const move=e=>{
        if(startY==null) return;
        const y=(e.touches?e.touches[0].clientY:e.clientY);
        const dy=startY-y; const delta=Math.round(dy/6);
        if(target==='term'||target==='both') P.fsTerm=clamp(startTerm+delta,12,60);
        if(target==='def'||target==='both') P.fsDef=clamp(startDef+delta,14,72);
        updateVars(); showToast(`Recto ${P.fsTerm}px ‚Ä¢ Verso ${P.fsDef}px`);
      };
      const end=()=>{
        if(startY!=null) saveData();
        startY=null; startTerm=null; startDef=null; target='both'; setTimeout(hideToast,200);
      };
      box.addEventListener('pointerdown',start);
      box.addEventListener('pointermove',move);
      box.addEventListener('pointerup',end);
      box.addEventListener('pointercancel',end);
      box.addEventListener('touchstart',start,{passive:false});
      box.addEventListener('touchmove',move,{passive:false});
      box.addEventListener('touchend',end,{passive:false});

      const wheelOn=(el,which)=>{
        el.addEventListener('wheel',(e)=>{
          e.preventDefault();
          const dir=e.deltaY>0?-1:1;
          if(which==='term'||which==='both') P.fsTerm=clamp((P.fsTerm||20)+dir,12,60);
          if(which==='def'||which==='both') P.fsDef=clamp((P.fsDef||24)+dir,14,72);
          updateVars(); saveData(); showToast(`Recto ${P.fsTerm}px ‚Ä¢ Verso ${P.fsDef}px`); setTimeout(hideToast,250);
        },{passive:false});
      };
      wheelOn(termEl,'term'); wheelOn(defEl,'def'); wheelOn(box,'both');
    }

    function bindWheel(node,{get,set,min,max,step=1,unit='px',onApply}){
      const valueEl=node.querySelector('.wheel-value');
      const render=()=>{valueEl.textContent=get()+unit;};
      const commit=()=>{saveData(); applyUI(); if(onApply) onApply();};
      const setVal=v=>{set(clamp(v,min,max)); render(); applyUI();};
      const pd=e=>{e.preventDefault(); e.stopPropagation();};

      let startY=null,startV=null;
      node.addEventListener('pointerdown',e=>{startY=e.clientY; startV=get(); node.setPointerCapture?.(e.pointerId); pd(e);});
      node.addEventListener('pointermove',e=>{if(startY==null) return; const dy=startY-e.clientY; const delta=Math.round(dy/6)*step; setVal(startV+delta); pd(e);});
      const end=e=>{if(startY!=null) commit(); startY=null; startV=null;};
      node.addEventListener('pointerup',end); node.addEventListener('pointercancel',end);
      node.addEventListener('wheel',e=>{e.preventDefault(); const dir=e.deltaY>0?-step:step; setVal(get()+dir); commit();},{passive:false});
      render();
    }

    function gradeQuality5(g){switch(g){case'facile':return 5; case'bien':return 4; case'difficile':return 2; case'echec':return 1; default:return 0;}}
    function gradeNorm01(g){switch(g){case'facile':return 1.0; case'bien':return 0.75; case'difficile':return 0.35; case'echec':return 0.0; default:return 0.5;}}

    function scheduleNext(card,grade,now=Date.now()){
      const q=gradeQuality5(grade);
      let EF=card.ef||2.5; EF = EF + (0.1 - (5-q)*(0.08+(5-q)*0.02)); if(EF<1.3) EF=1.3; card.ef=EF;
      if(q<3){
        card.intervalDays = (grade==='echec')?0.02:0.5;
        card.dueAt=now+card.intervalDays*864e5;
        card.streak=(card.streak<=0?card.streak-1:-1);
      }else{
        let next; if(card.intervalDays<1e-6) next=1; else if(card.intervalDays<1.5) next=6; else next=Math.round(card.intervalDays*EF);
        card.intervalDays=next; card.dueAt=now+next*864e5;
        card.streak=(card.streak>=0?card.streak+1:1);
      }
      card.streak=Math.max(-8,Math.min(12,card.streak));
    }

    // ---------- Reset helpers ----------
    function resetChapter(chapId){
      const chap=getChapter(chapId); if(!chap) return;
      chap.cards.forEach(c=>{
        c.grade='unseen'; c.timesReviewed=0; c.lastReviewed=0; c.lastMs=0; c.avgMs=0; c.perfEma=0.5;
        c.ef=2.5; c.intervalDays=0; c.dueAt=0; c.streak=0; c.successes=0; c.failures=0;
      });
      chap.stats.gradeCounts={unseen:chap.cards.length,echec:0,difficile:0,bien:0,facile:0};
      chap.stats.totalReviews=0;
      chap.stats.dailyReviews = {};
      chap.stats.dailyChanges = {};
      chap.stats.dailyDurMs = {};
      chap.stats.dailyDurCount = {};
      chap.stats.dailyLog = {};
      saveData(); alert('Chapitre r√©initialis√©.');
    }

    function enableImageLightboxInReview(scroller){
      const imgs = Array.from(scroller.querySelectorAll('img'));
      imgs.forEach(img=>{
        img._moved = false;
        img.addEventListener('pointerdown', e=>{
          img._moved = false;
          img._sx = e.clientX; img._sy = e.clientY;
        });
        img.addEventListener('pointermove', e=>{
          if (img._sx!=null && (Math.abs(e.clientX - img._sx)>6 || Math.abs(e.clientY - img._sy)>6)){
            img._moved = true;
          }
        });
        img.addEventListener('click', e=>{
          if (img._moved) return; // c'√©tait un drag -> ne pas ouvrir
          e.preventDefault();
          openLightboxFor(img, scroller);
        });
      });
    }

    async function resetAll(){
      if(!confirm('R√©initialiser toute l‚Äôapplication ?')) return;
      await Media.clearAll();
      const theme=data.app?.theme||'dark';
      const prefs=deepClone(data.app?.prefs||{});
      const subjects = buildCanonicalSubjects();
      data = { subjects, app: { theme, prefs, currentSubjectId: subjects[0]?.id || null } };
      upgradeData();
      applyTheme();
      applyUI();
      saveData();
      goDeck(false);
      alert('Application r√©initialis√©e.');
    }



    function init(){
      Media.open().catch(console.warn);
      if(navigator.storage && navigator.storage.persist){
        navigator.storage.persist().then(granted=>console.log('persist granted?',granted));
      }
      window.addEventListener('visibilitychange',()=>{if(document.visibilityState==='hidden') saveData();});
      window.addEventListener('pagehide',saveData);
      window.addEventListener('beforeunload',saveData);
      setInterval(saveData,15000);
      window.addEventListener('storage',(e)=>{
        if(e.key===STORAGE_KEY && e.newValue){
          try{data=JSON.parse(e.newValue); renderByState(false);}catch(err){}
        }
      });
    
      // Forcer migration + fusion avec le contenu canonique √† chaque nouvelle version
      const prevVersion = localStorage.getItem('flash9x16_version');
      if (prevVersion !== APP_VERSION) {
        upgradeData();                          // migrer l'ancien sch√©ma si besoin
        reconcileAllSubjectsWithCanonical();    // fusionner avec les nouvelles cartes/chapitres
        saveData();
        localStorage.setItem('flash9x16_version', APP_VERSION);
      } else {
        // Assurer la coh√©rence m√™me sans changement de version
        upgradeData();
        reconcileAllSubjectsWithCanonical();
      }
    
      applyTheme();
      applyUI();
      Nav.clear();
      goDeck(false);
    }
    init();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/sql-wasm.js"></script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</body>
</html>
