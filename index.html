<!DOCTYPE html> 
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <title>Physique Flashcards</title>
  <style>
    /* --- VARIABLES & THEME --- */
    :root {
      --bg: #0b1020; --surface: #12172b; --card: #161c33; --text: #e6ecff; --muted: #8aa0d3;
      --primary: #6366f1; --primary-600: #5457e6; --green: #22c55e; --blue: #3b82f6; --amber: #f59e0b; --red: #ef4444;
      --border: #232a48;
      --fs-term: 20px; --fs-def: 24px; --radius-md: 14px;
      
      /* Buttons */
      --btn-neutral-bg: rgba(255,255,255,.06); --btn-neutral-fg: #e6ecff; --btn-neutral-bd: #232a48; --btn-neutral-bg-h: rgba(255,255,255,.10);
      --btn-soft-primary-bg: color-mix(in srgb,var(--primary) 22%,transparent); --btn-soft-primary-bg-h: color-mix(in srgb,var(--primary) 34%,transparent);
      --btn-soft-primary-fg: #dbe4ff; --btn-soft-primary-bd: color-mix(in srgb,var(--primary) 55%,transparent);
      --btn-soft-red-bg: rgba(239,68,68,.18); --btn-soft-red-bg-h: rgba(239,68,68,.28); --btn-soft-red-fg: #fecaca; --btn-soft-red-bd: rgba(239,68,68,.45);
      --btn-soft-amber-bg: rgba(245,158,11,.18); --btn-soft-amber-bg-h: rgba(245,158,11,.28); --btn-soft-amber-fg: #fde68a; --btn-soft-amber-bd: rgba(245,158,11,.45);
      --btn-soft-blue-bg: rgba(59,130,246,.18); --btn-soft-blue-bg-h: rgba(59,130,246,.28); --btn-soft-blue-fg: #bfdbfe; --btn-soft-blue-bd: rgba(59,130,246,.45);
      --btn-soft-green-bg: rgba(34,197,94,.18); --btn-soft-green-bg-h: rgba(34,197,94,.28); --btn-soft-green-fg: #bbf7d0; --btn-soft-green-bd: rgba(34,197,94,.45);
      --btn-solid-primary-bg: var(--primary); --btn-solid-primary-bg-h: var(--primary-600); --btn-solid-primary-fg: #fff; --btn-solid-primary-bd: var(--primary-600);
    }
    :root[data-theme="light"] {
      --bg: linear-gradient(180deg,#f8fafc 0%,#eef2f7 100%); --surface: #fff; --card: #fff; --text: #0f172a; --muted: #475569;
      --primary: #3b82f6; --primary-600: #2563eb; --border: #cbd5e1;
      --btn-neutral-bg: #f1f5f9; --btn-neutral-fg: #0f172a; --btn-neutral-bd: #cbd5e1; --btn-neutral-bg-h: #e2e8f0;
      --btn-soft-primary-bg: color-mix(in srgb,var(--primary) 14%,white 86%); --btn-soft-primary-bg-h: color-mix(in srgb,var(--primary) 22%,white 78%);
      --btn-soft-primary-fg: color-mix(in srgb,var(--primary) 78%,black 22%); --btn-soft-primary-bd: color-mix(in srgb,var(--primary) 35%,white 65%);
      --btn-soft-red-bg: #fee2e2; --btn-soft-red-bg-h: #fecaca; --btn-soft-red-fg: #991b1b; --btn-soft-red-bd: #fca5a5;
      --btn-soft-amber-bg: #fef3c7; --btn-soft-amber-bg-h: #fde68a; --btn-soft-amber-fg: #92400e; --btn-soft-amber-bd: #fcd34d;
      --btn-soft-blue-bg: #dbeafe; --btn-soft-blue-bg-h: #bfdbfe; --btn-soft-blue-fg: #1e3a8a; --btn-soft-blue-bd: #93c5fd;
      --btn-soft-green-bg: #dcfce7; --btn-soft-green-bg-h: #bbf7d0; --btn-soft-green-fg: #14532d; --btn-soft-green-bd: #86efac;
    }
    :root[data-theme="light"] .definition, :root[data-theme="light"] .card-item .back { color: var(--text)!important; opacity: 1!important; }
    :root[data-theme="light"] .muted { color: #475569!important; }
    :root[data-theme="light"] .legend-item { color: #0f172a!important; border-color: #e2e8f0!important; background: 0 0!important; }
    :root[data-theme="light"] .revision-bar, :root[data-theme="light"] .review-actions-bar { background: rgba(241,245,249,.9)!important; border-top: 1px solid #e2e8f0!important; }
    :root[data-theme="light"] .btn--ghost { --btn-bg-h: rgba(0,0,0,.06); }
    :root[data-theme="light"] .img-counter, :root[data-theme="light"] .img-close { background: rgba(255,255,255,.9); color: #0f172a; }

    /* --- RESET & LAYOUT --- */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; overflow: hidden; font-size: 17px; -webkit-font-smoothing: antialiased; }
    .wrapper { height: 100dvh; width: 100%; display: flex; align-items: center; justify-content: center; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
    .phone { aspect-ratio: 9/16; height: 100%; width: auto; max-width: 100%; max-height: 100%; display: grid; grid-template-rows: var(--row-top,52px) var(--row-main,1fr) var(--row-actions,52px) var(--row-rev,64px); position: relative; min-height: 0; touch-action: pan-y; overflow: hidden; }
    @media(min-width: 1024px) { .phone { aspect-ratio: auto; width: 100%; height: 100dvh; } .topbar, main#view, .bottom-actions, .revision-bar { max-width: 1200px; margin: 0 auto; width: 100%; } main#view { padding: 16px 20px; } }

    /* --- COMPONENTS --- */
    .topbar { position: sticky; top: 0; z-index: 10; display: flex; align-items: center; padding: 0 10px; }
    .topbar .back { appearance: none; border: 0; outline: 0; background: 0 0; color: var(--text); padding: 8px 10px; margin-right: 4px; border-radius: 10px; display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 700; }
    .topbar .back:hover { background: rgba(255,255,255,.06); }
    .topbar .title { font-weight: 800; font-size: 16px; margin-left: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
    .spacer { flex: 1; }
    
    main#view { min-height: 0; height: 100%; display: flex; flex-direction: column; overflow: hidden; padding: 8px; gap: 10px; }
    .hidden { display: none!important; } .muted { color: var(--muted); } .center { text-align: center; } .mt6 { margin-top: 6px; } .mt8 { margin-top: 8px; }
    .scroll-y { overflow: auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; touch-action: pan-y; } .scroll-lock { overflow: hidden; touch-action: none!important; }
    .list, .flexcol { display: flex; flex-direction: column; gap: 8px; min-height: 0; } .stack { display: flex; flex-direction: column; gap: 6px; }
    .row, .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; } .grid2 { gap: 10px; } .row-4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
    .input { width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--text); font-size: 14px; outline: none; appearance: none; }
    .input:focus { border-color: var(--primary); }
    
    .card, .deck-item, .review-card, .legend-item, .kpi .k, .stat, .chip { background: 0 0; border: 0; border-radius: var(--radius-md); pointer-events: auto; }
    
    /* Deck & Lists */
    .deck-item { display: flex; align-items: center; justify-content: space-between; padding: 0 8px; cursor: pointer; user-select: none; position: relative; overflow: hidden; touch-action: pan-y; transition: background-color 0.3s ease; }
    .deck-item .slide { display: flex; align-items: center; gap: 8px; padding: 8px 0; transition: transform .18s ease; will-change: transform; width: 100%; position: relative; z-index: 2; }
    .deck-item .right-action { position: absolute; top: 0; right: 0; height: 100%; width: 92px; display: flex; align-items: center; justify-content: center; z-index: 1; }
    .deck-item.reveal-delete .slide { transform: translateX(-92px); }
    .deck-item.drop-target { outline: 2px dashed var(--primary); outline-offset: -2px; border-radius: var(--radius-md); background: color-mix(in srgb,var(--primary) 8%,transparent); }
    .deck-item.dragging-origin { opacity: .3; }
    .drag-ghost { position: fixed; left: 0; top: 0; pointer-events: none; z-index: 9999; transform: translate(-9999px,-9999px) scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,.35); background: rgba(0,0,0,.08); border-radius: var(--radius-md); }
    
    .folder-badge { font-weight: bold; color: var(--primary); margin-left: 6px; font-size: 12px; }

    /* Stats & Charts */
    .section-title { font-weight: 900; font-size: 14px; color: var(--primary); letter-spacing: .3px; margin: 0 0 6px; }
    .kpi { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; } .kpi .k { padding: 0; } .k .label, .stat .label { color: var(--muted); font-size: 12px; } .k .value, .val { font-weight: 900; font-size: 17px; margin-top: 2px; }
    .chip { display: inline-flex; align-items: center; gap: 8px; padding: 0; color: var(--muted); font-size: 12px; }
    .chip-pie { width: 18px; height: 18px; border-radius: 50%; background: conic-gradient(var(--primary) var(--progress,0%),var(--border) var(--progress,0%)); vertical-align: middle; display: inline-block; }
    .legend { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; position: relative; z-index: 2; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; color: #dbe4ff; cursor: pointer; user-select: none; transition: opacity .15s; position: relative; z-index: 2; }
    .legend-item.inactive { opacity: .45; filter: grayscale(20%); }
    /* Style pour la coche de s√©lection */
.legend-item .check-icon { 
  display: inline-flex; align-items: center; justify-content: center; 
  width: 18px; height: 18px; margin-right: 6px; border-radius: 4px; 
  border: 2px solid var(--border); color: transparent; font-size: 12px; font-weight: 900; 
  transition: 0.2s;
}
.legend-item:not(.inactive) .check-icon { 
  background: var(--primary); border-color: var(--primary); color: #fff; 
}
.legend-item.inactive .check-icon {
  background: transparent;
}
    .dot { width: 10px; height: 10px; border-radius: 50%; } .dot.gray { background: #9ca3af; } .dot.red { background: var(--red); } .dot.amber { background: var(--amber); } .dot.blue { background: var(--blue); } .dot.green { background: var(--green); }
    .chart-wrap { display: flex; align-items: center; justify-content: center; height: 200px; position: relative; z-index: 1; } 
    canvas#gradeChart { width: 180px; height: 180px; pointer-events: auto; }
    canvas#bar7 { width: 100%; height: 68px; display: block; } .bar7-labels { display: grid; grid-template-columns: repeat(7,1fr); gap: 6px; margin-top: 4px; font-size: 12px; color: var(--muted); text-align: center; cursor: pointer; }
    
    main#view > .card { overflow-y: auto; -webkit-overflow-scrolling: touch; min-height: 0; }

    /* Review */
    .review-wrap { position: relative; flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
    .review-top { display: flex; justify-content: space-between; color: var(--muted); font-size: 13px; flex-shrink: 0; padding-bottom: 4px; }
    .review-card { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; min-height: 0; padding: 0; transition: background-color 0.4s ease; }
    
    /* Background tints for grading */
    .review-card.tint-facile { background-color: rgba(34, 197, 94, 0.15)!important; }
    .review-card.tint-bien { background-color: rgba(59, 130, 246, 0.15)!important; }
    .review-card.tint-difficile { background-color: rgba(245, 158, 11, 0.15)!important; }
    .review-card.tint-echec { background-color: rgba(239, 68, 68, 0.15)!important; }

    .review-scroller { flex: 1; width: 100%; height: 100%; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; padding: 10px; touch-action: pan-y; user-select: none; }
    .review-scroller > * { margin-top: auto; margin-bottom: auto; width: 100%; }
    .term, .definition { font-size: var(--fs-term)!important; font-weight: 600; text-align: center; white-space: pre-wrap; word-wrap: break-word; } 
    .definition { font-size: var(--fs-def)!important; font-weight: 900; }
    /* --- Aper√ßu Typo --- */
.preview-box { background: var(--card); border: 2px dashed var(--border); border-radius: 14px; margin: 10px 14px; padding: 20px; text-align: center; min-height: 120px; display: flex; flex-direction: column; justify-content: center; gap: 15px; }
.preview-recto { font-size: var(--fs-term); font-weight: 600; color: var(--text); }
.preview-verso { font-size: var(--fs-def); font-weight: 900; color: var(--primary); border-top: 1px dashed var(--border); padding-top: 10px; }

    /* MathJax & Img */
    mjx-container { overflow-x: auto; overflow-y: hidden; max-width: 100% !important; display: inline-block !important; padding: 4px 0; white-space: normal !important; vertical-align: middle; }
    mjx-mtext { white-space: normal !important; display: inline !important; }
    mjx-math { white-space: normal !important; max-width: 100%; }
    .img-placeholder { display: block; background: rgba(255,255,255,0.05); color: #8aa0d3; padding: 15px; border: 2px dashed rgba(255,255,255,0.1); border-radius: 8px; margin: 15px auto; font-style: italic; font-size: 0.85rem; text-align: center; }
    img { display: block; max-width: 100%; height: auto; margin: 10px auto; border-radius: 8px; background: var(--border); user-select: none; object-fit: contain; }

    .bottom-actions, .revision-bar, .review-actions-bar { padding: 8px 10px calc(8px + env(safe-area-inset-bottom)); display: none; background: 0 0; border-top: 0; }
    .bottom-actions { gap: 8px; grid-template-columns: 1fr 1fr; } .review-actions-bar { grid-row: 4; backdrop-filter: blur(8px) saturate(140%); }
    
    .btn, .navbtn, .action, .rev-btn { background: var(--btn-bg,var(--btn-neutral-bg)); color: var(--btn-fg,var(--btn-neutral-fg)); border: 1px solid var(--btn-bd,var(--btn-neutral-bd)); border-radius: var(--radius-md); padding: 10px 12px; font-weight: 900; cursor: pointer; transition: .15s; width: 100%; appearance: none; outline: 0; font-size: 15px; }
    .btn:hover { background: var(--btn-bg-h,var(--btn-bg,var(--btn-neutral-bg-h))); } .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn--primary { --btn-bg: var(--btn-soft-primary-bg); --btn-bg-h: var(--btn-soft-primary-bg-h); --btn-fg: var(--btn-soft-primary-fg); --btn-bd: var(--btn-soft-primary-bd); }
    .btn--red { --btn-bg: var(--btn-soft-red-bg); --btn-bg-h: var(--btn-soft-red-bg-h); --btn-fg: var(--btn-soft-red-fg); --btn-bd: var(--btn-soft-red-bd); }
    .btn--amber { --btn-bg: var(--btn-soft-amber-bg); --btn-bg-h: var(--btn-soft-amber-bg-h); --btn-fg: var(--btn-soft-amber-fg); --btn-bd: var(--btn-soft-amber-bd); }
    .btn--blue { --btn-bg: var(--btn-soft-blue-bg); --btn-bg-h: var(--btn-soft-blue-bg-h); --btn-fg: var(--btn-soft-blue-fg); --btn-bd: var(--btn-soft-blue-bd); }
    .btn--green { --btn-bg: var(--btn-soft-green-bg); --btn-bg-h: var(--btn-soft-green-bg-h); --btn-fg: var(--btn-soft-green-fg); --btn-bd: var(--btn-soft-green-bd); }
    .btn--solid.btn--primary { --btn-bg: var(--btn-solid-primary-bg); --btn-bg-h: var(--btn-solid-primary-bg-h); --btn-fg: var(--btn-solid-primary-fg); --btn-bd: var(--btn-solid-primary-bd); }
    .btn--ghost { --btn-bg: transparent; --btn-bg-h: rgba(255,255,255,.06); --btn-fg: var(--muted); --btn-bd: var(--border); } .btn--tiny { padding: 6px 8px; font-size: 13px; border-radius: 8px; }
    
    .cards-grid { display: grid; grid-template-columns: 1fr; gap: 10px; } @media(min-width: 480px) { .cards-grid { grid-template-columns: 1fr 1fr; } }
    .card-block { position: relative; border: 2px solid transparent; border-radius: 14px; padding: 14px; background: 0 0; max-height: none; overflow: hidden; display: flex; flex-direction: column; }
    .card-block .term, .card-block .definition { margin: auto 0; width: 100%; word-break: break-word; }
    .card-block .definition { display: none; text-align: center; margin-top: 6px; } .card-block.flipped .definition { display: block; } .card-block .term { text-align: center; }
    .cb-time { position: absolute; right: 10px; bottom: 8px; font-size: 12px; color: var(--muted); }
    .card-block.grade-echec { border-color: var(--red); } .card-block.grade-difficile { border-color: var(--amber); } .card-block.grade-bien { border-color: var(--blue); } .card-block.grade-facile { border-color: var(--green); } .card-block.grade-unseen { border-color: #9ca3af; }
    
    .subject-menu { position: absolute; top: 52px; left: 10px; background: var(--surface); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius-md); min-width: 220px; box-shadow: 0 10px 30px rgba(0,0,0,.35); padding: 6px; z-index: 1000; display: none; }
    .subject-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 10px; cursor: pointer; } .subject-item:hover { background: rgba(255,255,255,.06); } .subject-item .name { font-weight: 800; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .subject-item .meta { font-size: 12px; color: var(--muted); } .subject-item .subject-actions { margin-left: auto; display: flex; gap: 6px; }
    .wheel { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-md); background: rgba(255,255,255,.04); touch-action: none; user-select: none; cursor: ns-resize; }
    .wheel .name, .wheel .wheel-value { font-weight: 800; font-size: 13px; } .wheel .hint { color: var(--muted); font-size: 12px; } .wheel .wheel-value { margin-left: auto; font-weight: 900; }
    .swatches { display: flex; gap: 8px; flex-wrap: wrap; } .swatch { width: 26px; height: 26px; border-radius: 8px; border: 1px solid var(--border); background: var(--sw,#6366f1); cursor: pointer; position: relative; } .swatch.is-active::after { content: ''; position: absolute; inset: -3px; border: 2px solid var(--primary); border-radius: 10px; }
    .img-lightbox { position: fixed; inset: 0; display: none; background: 0 0; z-index: 10000; } .img-lightbox.open { display: block; }
    .img-stage { position: absolute; inset: 0; width: 100%; height: 100%; overflow: hidden; touch-action: none; cursor: grab; } .img-canvas { position: absolute; top: 0; left: 0; transform-origin: 0 0; will-change: transform; }
    
    
    
    /* --- Nouveaux contr√¥les Settings --- */
.s-control { display: flex; align-items: center; gap: 15px; padding: 0 14px 15px; /* Removed background and border-radius to blend */ }

/* Styles Slider CORRIG√âS */
.s-slider-container { flex: 1; display: flex; align-items: center; height: 40px; position: relative; }
.s-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--border); border-radius: 3px; outline: none; cursor: grab; }
.s-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: var(--primary); border-radius: 50%; cursor: pointer; border: 3px solid var(--surface); box-shadow: 0 1px 3px rgba(0,0,0,0.3); margin-top: 0; /* Alignement */ position: relative; z-index: 2; }

/* Styles Stepper (- / +) */
.s-stepper { display: flex; align-items: center; gap: 10px; background: var(--border); border-radius: 8px; padding: 4px; margin-left: auto; }
.step-btn { width: 32px; height: 32px; border-radius: 6px; border: none; background: var(--surface); color: var(--text); font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.step-btn:active { transform: scale(0.9); background: var(--primary); color: #fff; }
.step-val { min-width: 30px; text-align: center; font-weight: 900; font-size: 15px; }
    
    /* --- SETTINGS iOS STYLE --- */
    .settings-page { padding: 0 12px; }
    .settings-hero { font-size: 28px; font-weight: 900; padding: 16px 4px 12px; }
    .settings-section { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 14px; overflow: hidden; }
    .settings-section .section-title { padding: 10px 14px 6px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.4px; color: var(--muted); margin: 0; }
    .settings-row { display: flex; align-items: center; padding: 11px 14px; border-bottom: 1px solid var(--border); gap: 12px; cursor: pointer; transition: background 0.15s; }
    .settings-row:last-child { border-bottom: none; }
    .settings-row:active { background: rgba(255,255,255,0.04); }
    .settings-row .s-icon { width: 30px; height: 30px; border-radius: 7px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; color: #fff; }
    .s-icon.blue { background: #3b82f6; } .s-icon.green { background: #22c55e; } .s-icon.red { background: #ef4444; }
    .s-icon.dynamic { background: var(--primary) !important; transition: background 0.3s ease; }
/* On garde l'ic√¥ne rouge pour la zone dangereuse */
.s-icon.danger { background: var(--red) !important; }.s-icon.purple { background: #8b5cf6; } .s-icon.orange { background: #f59e0b; } .s-icon.gray { background: #6b7280; }
    .s-icon.teal { background: #14b8a6; } .s-icon.pink { background: #ec4899; }
    .settings-row .s-label { flex: 1; min-width: 0; }
    .settings-row .s-title { font-weight: 600; font-size: 15px; }
    .settings-row .s-sub { font-size: 12px; color: var(--muted); margin-top: 1px; }
    .settings-row .s-value { color: var(--muted); font-size: 14px; }
    .settings-row .s-chevron { color: var(--muted); font-size: 16px; opacity: 0.6; }
    .s-toggle { width: 48px; height: 28px; border-radius: 14px; background: var(--border); position: relative; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
    .s-toggle.on { background: var(--primary); }
    .s-toggle::after { content: ''; position: absolute; width: 24px; height: 24px; border-radius: 50%; background: #fff; top: 2px; left: 2px; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .s-toggle.on::after { transform: translateX(20px); }
    .settings-section .swatches { padding: 0; gap: 6px; }
    .settings-section .swatch { width: 24px; height: 24px; }
    .settings-footer { text-align: center; padding: 20px; color: var(--muted); font-size: 12px; }
    .toast { position: fixed; bottom: calc(80px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--surface); color: var(--text); padding: 12px 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 8px 32px rgba(0,0,0,0.3); font-weight: 600; font-size: 14px; z-index: 9999; opacity: 0; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s; pointer-events: none; max-width: 90%; text-align: center; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { border-left: 4px solid var(--green); } .toast.error { border-left: 4px solid var(--red); } .toast.info { border-left: 4px solid var(--primary); }
    
    .progress-bar { position: absolute; top: 0; left: 0; height: 3px; background: linear-gradient(90deg, var(--primary), var(--green)); border-radius: 0 3px 3px 0; transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 5; }
    
    @keyframes fadeSlideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    main#view > * { animation: fadeSlideIn 0.25s ease-out; }
    
    .card-block, .deck-item { transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s, background-color 0.3s; }
    .card-block:active, .deck-item:active { transform: scale(0.98); }
    
    .skeleton { background: linear-gradient(90deg, var(--border) 25%, var(--surface) 50%, var(--border) 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; border-radius: 8px; }
    @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    
    .focus-mode .topbar, .focus-mode .review-top { opacity: 0.3; transition: opacity 0.3s; }
    .focus-mode .topbar:hover, .focus-mode .review-top:hover { opacity: 1; }
    
    img { opacity: 1 !important; transition: none; }
    /* --- MODE ZEN / IMMERSION --- */
.zen-mode { --bg: #000000 !important; --surface: #000000 !important; --card: #000000 !important; --text: #e6ecff; }
.zen-mode .topbar, .zen-mode .revision-bar, .zen-mode .bottom-actions, .zen-mode .progress-bar { display: none !important; }
.zen-mode .review-card { border: none !important; background: transparent !important; }
.zen-mode .review-top { opacity: 0.3; margin-top: 20px; font-size: 11px; justify-content: center; gap: 15px; }
.zen-mode #undoBtn { display: none; } /* On cache le undo pour √©purer */
.zen-exit-btn { position: fixed; top: 20px; right: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.15); border-radius: 50%; color: #fff; border: none; font-size: 20px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100; backdrop-filter: blur(4px); }
</style>
</head>
<body>
  <div class="wrapper">
    <div class="phone" id="app">
      <header class="topbar">
        <button class="back" id="backBtn" title="Retour">‚Üê Retour</button>
        <div class="title" id="title">Deck</div>
        <div class="spacer"></div>
      </header>
      <main id="view"></main>
      <div class="bottom-actions" id="bottomActions">
        <button class="action btn" id="cardsBtn">Cartes</button>
        <button class="action btn" id="settingsBtn">Param√®tres</button>
      </div>
      <footer class="revision-bar" id="revisionBar">
        <button id="startReviewBtn" class="rev-btn btn btn--solid btn--primary">R√©vision</button>
      </footer>
      <footer id="reviewActionsBar" class="review-actions-bar" aria-live="polite"></footer>
    </div>
  </div>

<script src="data.js"></script>

<!-- AJOUTEZ CETTE LIGNE ICI : -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script>

/* --- CORE APP LOGIC --- */
const D = document, W = window, LS = localStorage, M = Math, KEY = 'flashcards9x16_data', APP_VER = '2026-01-31-00';

const GRADES = ['unseen','echec','difficile','bien','facile'];
const GRADE_INIT = () => ({unseen:0,echec:0,difficile:0,bien:0,facile:0});
const GRADE_FILTERS = () => ({unseen:!0,echec:!0,difficile:!0,bien:!0,facile:!0});

const $ = (s,p=D) => p.querySelector(s), $$ = (s,p=D) => [...p.querySelectorAll(s)];
const clamp = (n,mn,mx) => n<mn?mn:n>mx?mx:n;

const slugify = s => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
const dateKey = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const todayKey = () => dateKey(new Date());
const getDayStart = () => { const d = new Date(); d.setHours(0,0,0,0); return d.getTime() };
const avg = a => !a?.length ? 0 : a.reduce((x,y)=>x+y,0)/a.length;
const deepClone = o => JSON.parse(JSON.stringify(o));
const isSucc = g => g==='facile'||g==='bien';
const ppLat = s => s ? s.replace(/\[\/?latex\]/gi,'').replace(/\\newline\s*/g,'<br/>') : s;
const mathCache = new Set();
const clearMathCache = () => mathCache.clear();
const tsLat = e => { 
  if(!W.MathJax?.typesetPromise) return Promise.resolve();
  const id = e?.id || (e?.dataset?.id) || null;
  if(id && mathCache.has(id)) return Promise.resolve();
  if(id) mathCache.add(id);
  return W.MathJax.typesetPromise(e?[e]:null).catch(()=>{});
};
const getEmoji = t => C_EMOJIS[t]||'';
const extractId = c => String(c).match(/-(\d+)$/)?.[1]||null;
const getSides = (c,ch) => ch?.settings?.langSwap ? {f:c.back,b:c.front} : {f:c.front,b:c.back};
const fmtDur = ms => { const s=M.round(ms/1000); return`${M.floor(s/60)}:${String(s%60).padStart(2,'0')}` };
function fmtDayFR(k){ const [Y,M,D]=k.split('-').map(Number), d=new Date(Y,M-1,D); return`${['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'][d.getDay()]} ${String(D).padStart(2,'0')} ${['janv.','f√©vr.','mars','avr.','mai','juin','juil.','ao√ªt','sept.','oct.','nov.','d√©c.'][M-1]} ${Y}` }

/* --- NEW HELPERS (Perf & UX) --- */


/* --- UI/UX HELPERS --- */
function toast(msg, type = 'info', duration = 2500) {
  let el = $('#toast'); if(!el) { el = D.createElement('div'); el.id = 'toast'; D.body.appendChild(el); }
  el.textContent = msg; el.className = `toast ${type}`;
  requestAnimationFrame(() => { el.classList.add('show'); setTimeout(() => el.classList.remove('show'), duration); });
}

const haptic = (style = 'light') => {
  if(!navigator.vibrate) return;
  const patterns = { light: 10, medium: 20, heavy: 30, success: [10, 50, 10], error: [30, 50, 30] };
  navigator.vibrate(patterns[style] || 10);
};

function getStreak(c) {
  let streak = 0; const today = new Date();
  for(let i = 0; i < 365; i++) {
    const d = new Date(today); d.setDate(today.getDate() - i);
    if((c.stats.dailyReviews[dateKey(d)] || 0) > 0) streak++; else if(i > 0) break;
  }
  return streak;
}

function bindPullRefresh(container, onRefresh) {
  let startY = 0, pulling = false, indicator = null;
  container.addEventListener('touchstart', e => { if(container.scrollTop <= 5) { startY = e.touches[0].clientY; pulling = true; } }, {passive:!0});
  container.addEventListener('touchmove', e => {
    if(!pulling) return; const delta = e.touches[0].clientY - startY;
    if(delta > 0 && delta < 120) {
      if(!indicator) { indicator = D.createElement('div'); indicator.innerHTML = '‚Üª'; indicator.style.cssText = 'text-align:center;padding:10px;color:var(--muted);font-size:20px;transition:transform 0.2s'; container.prepend(indicator); }
      indicator.style.transform = `rotate(${delta * 3}deg)`;
    }
  }, {passive:!0});
  container.addEventListener('touchend', e => {
    if(indicator) { if(e.changedTouches[0].clientY - startY > 80) { haptic('medium'); onRefresh(); } indicator.remove(); indicator = null; }
    pulling = false;
  });
}

function bindSwipeNav() {
  const wrap = $('.review-wrap'); if(!wrap) return;
  let startX = 0, startY = 0, deltaX = 0;
  wrap.addEventListener('touchstart', e => { if(e.touches.length!==1)return; startX=e.touches[0].clientX; startY=e.touches[0].clientY; deltaX=0 }, {passive:!0});
  wrap.addEventListener('touchmove', e => { if(e.touches.length!==1)return; deltaX=e.touches[0].clientX-startX; if(Math.abs(e.touches[0].clientY-startY)>Math.abs(deltaX)) deltaX=0 }, {passive:!0});
  wrap.addEventListener('touchend', () => {
    const r = State.review; if(!r || Math.abs(deltaX) < 80) return;
    if(deltaX > 0 && r.history.length > 0) { haptic('medium'); undoRev(); }
    else if(deltaX < 0 && r.flipped) { haptic('light'); toast('Difficile (Swipe)', 'info', 1000); subG('difficile'); }
  });
}

let saveTimeout = null;
const debouncedSave = () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveData, 2000); };


W.MathJax = { tex:{inlineMath:[['$','$'],['\\(','\\)']], displayMath:[['$$','$$'],['\\[','\\]']], processEscapes:!0}, options:{skipHtmlTags:['script','style','textarea']}, startup:{typeset:!1} };

function formatText(text) {
    if (!text) return '';
    let formatted = text.replace(/(?:>>>|>>)?\s*\[IMAGE_ID:\s*(.+?)\](?:\s*<<<)?/g, (match, filename) => {
        const cleanName = filename.trim();
        return `<img src="images/${cleanName}" alt="Sch√©ma" loading="lazy">`;
    });
    formatted = formatted.replace(/\\\[\s*\\text\s*\{([^{}]+)\}\s*\\\]/g, function(match, content) {
        if (content.includes(' ')) return content;
        return match;
    });
    formatted = formatted.replace(/\n/g, '<br>');
    formatted = formatted.replace(/\[latex\]/g, '').replace(/\[\/latex\]/g, '');
    formatted = formatted.replace(/\[\$\]/g, '\\(').replace(/\[\/\$\]/g, '\\)');
    return formatted;
}

const parsePhysicsData = (rawData) => {
    if (!rawData) return [];
    const decks = rawData.split(/={10,}\s*DECK\s*:\s*/);
    const result = [];
    let idCounter = 0;
    decks.forEach(deckBlock => {
        if (!deckBlock.trim()) return;
        const lines = deckBlock.split('\n');
        const deckCode = lines[0].trim();
        const deckName = (typeof PHY_MAP !== 'undefined' && PHY_MAP[deckCode]) ? PHY_MAP[deckCode].title : deckCode;
        const content = deckBlock.substring(deckCode.length).replace(/^=+/gm, '').trim();
        const cards = content.split(/-{10,}/);
        cards.forEach(rawCard => {
            if (!rawCard.trim()) return;
            const qMatch = rawCard.match(/Q:\s*([\s\S]*?)(?=R:)/);
            const rMatch = rawCard.match(/R:\s*([\s\S]*)/);
            if (qMatch && rMatch) {
                result.push({
                    id: 'phy-' + (idCounter++),
                    front: formatText(qMatch[1].trim()),
                    back: formatText(rMatch[1].trim()),
                    chapter: deckName
                });
            }
        });
    });
    return result;
};

/* --- LIGHTBOX --- */
const LB = { el:null, stage:null, cnv:null, img:null, cnt:null, imgs:[], idx:0, bw:0, bh:0, s:1, mnS:1, mxS:5, x:0, y:0, ptrs:new Map(), sDist:0, sS:1, sX:0, sY:0, psX:0, psY:0, tm:!1 };
function ensureLB(){
  if(LB.el)return LB.el; const el=D.createElement('div'); el.className='img-lightbox'; el.innerHTML='<div class="img-stage" id="lbStg" tabindex="-1"><div class="img-canvas" id="lbCnv"><img id="lbImg" alt=""></div></div><div class="img-counter" id="lbCnt">1/1</div>'; D.body.appendChild(el);
  LB.el=el; LB.stage=el.querySelector('#lbStg'); LB.cnv=el.querySelector('#lbCnv'); LB.img=el.querySelector('#lbImg'); LB.cnt=el.querySelector('#lbCnt');
  const pd=e=>{ LB.stage.setPointerCapture?.(e.pointerId); LB.ptrs.set(e.pointerId,{x:e.clientX,y:e.clientY}); if(LB.ptrs.size===1){LB.psX=LB.x;LB.psY=LB.y;LB.sX=e.clientX;LB.sY=e.clientY;LB.sS=LB.s;LB.tm=!1}else if(LB.ptrs.size===2){const p=[...LB.ptrs.values()];LB.sDist=M.hypot(p[0].x-p[1].x,p[0].y-p[1].y)||1;LB.sS=LB.s;LB.tm=!0} e.preventDefault() };
  const pm=e=>{ if(!LB.ptrs.has(e.pointerId))return; LB.ptrs.set(e.pointerId,{x:e.clientX,y:e.clientY}); const dx=e.clientX-LB.sX, dy=e.clientY-LB.sY; if(M.abs(dx)>6||M.abs(dy)>6)LB.tm=!0; if(LB.ptrs.size>=2){const p=[...LB.ptrs.values()];setLBScale(LB.sS*(M.hypot(p[0].x-p[1].x,p[0].y-p[1].y)/LB.sDist||1))}else setLBPan(LB.psX+dx,LB.psY+dy); e.preventDefault() };
  const pu=e=>{ if(LB.ptrs.has(e.pointerId))LB.ptrs.delete(e.pointerId); if(LB.ptrs.size===0){if(!LB.tm){const r=LB.img.getBoundingClientRect();if(!(e.clientX>=r.left&&e.clientX<=r.right&&e.clientY>=r.top&&e.clientY<=r.bottom))closeLB()}LB.sDist=0}else if(LB.ptrs.size===1){const p=[...LB.ptrs.values()][0];LB.sX=p.x;LB.sY=p.y;LB.psX=LB.x;LB.psY=LB.y;LB.sS=LB.s;LB.sDist=0} };
  let lt=0; LB.stage.addEventListener('pointerdown',e=>{pd(e);const n=Date.now();if(n-lt<250){setLBScale(LB.s>LB.mnS+0.001?LB.mnS:M.min(LB.mxS,LB.mnS*2.2));LB.tm=!0}lt=n});
  LB.stage.addEventListener('pointermove',pm); LB.stage.addEventListener('pointerup',pu); LB.stage.addEventListener('pointercancel',pu); LB.stage.addEventListener('lostpointercapture',pu);
  LB.stage.addEventListener('wheel',e=>{e.preventDefault();setLBScale(LB.s+(e.deltaY>0?-.15:.15)*LB.s)},{passive:!1}); W.addEventListener('resize',()=>{if(LB.el.classList.contains('open'))refitLB()}); return el;
}
function openLB(img,sc){ ensureLB(); const l=[...sc.querySelectorAll('img')]; LB.imgs=l.map(i=>({src:i.currentSrc||i.src,alt:i.alt||'',w:i.naturalWidth||800,h:i.naturalHeight||600})); LB.idx=M.max(0,l.indexOf(img)); LB.el.classList.add('open'); D.body.dataset._ov=D.body.style.overflow||''; D.body.style.overflow='hidden'; LB.el.focus?.(); showLB(LB.idx,!0) }
function closeLB(){ LB.el.classList.remove('open'); LB.imgs=[]; LB.idx=0; D.body.style.overflow=D.body.dataset._ov||'' }
function safeCloseLB(){ try{if(LB?.el?.classList.contains('open'))closeLB()}catch(e){} }
function showLB(i,init=!1){ if(!LB.imgs.length)return; LB.idx=(i+LB.imgs.length)%LB.imgs.length; const t=LB.imgs[LB.idx]; LB.img.src=t.src; LB.img.alt=t.alt; LB.bw=t.w; LB.bh=t.h; if(LB.cnt)LB.cnt.textContent=`${LB.idx+1}/${LB.imgs.length}`; refitLB(init) }
function refitLB(init=!1){ const sw=LB.stage.clientWidth, sh=LB.stage.clientHeight, fit=M.min(sw/LB.bw,sh/LB.bh); LB.mnS=fit; if(init){LB.s=fit;LB.x=(sw-LB.s*LB.bw)/2;LB.y=(sh-LB.s*LB.bh)/2;applyLB()}else setLBScale(fit,!0) }
function applyLB(){ const sw=LB.stage.clientWidth, sh=LB.stage.clientHeight, w=LB.s*LB.bw, h=LB.s*LB.bh; LB.x=w<=sw?(sw-w)/2:clamp(LB.x,sw-w,0); LB.y=h<=sh?(sh-h)/2:clamp(LB.y,sh-h,0); LB.cnv.style.width=LB.bw+'px'; LB.cnv.style.height=LB.bh+'px'; LB.cnv.style.transform=`translate(${LB.x}px,${LB.y}px) scale(${LB.s})` }
function setLBPan(nx,ny){ LB.x=nx; LB.y=ny; applyLB() }
function setLBScale(ns,f=!1){ const os=LB.s, s=clamp(ns,LB.mnS,LB.mxS); if(!f&&M.abs(s-os)<1e-4)return; const cx=LB.stage.clientWidth/2, cy=LB.stage.clientHeight/2; LB.s=s; LB.x=cx-s*((cx-LB.x)/os); LB.y=cy-s*((cy-LB.y)/os); applyLB() }

/* --- DATA LOADING --- */
const parseRaw = r => r.split(/\r?\n/).map(l=>{ const p=l.split('|'); return p.length!==4 ? null : {id:p[0].trim(),front:p[1].trim(),back:p[2].trim(),chapter:p[3].trim()} }).filter(Boolean);

const dataEN = parseRaw(RAW_EN);
const dataPHY = parsePhysicsData(RAW_PHY);

const Media = {
  db: null, cache: new Map(),
  async open(){ if(this.db)return this.db; this.db=await new Promise((s,j)=>{const r=indexedDB.open('flash9x16_media',1);r.onupgradeneeded=()=>{if(!r.result.objectStoreNames.contains('files'))r.result.createObjectStore('files',{keyPath:'key'})};r.onsuccess=()=>s(r.result);r.onerror=()=>j(r.error)}); return this.db },
  async save(k,b,m={}){ const d=await this.open(), tx=d.transaction('files','readwrite'); tx.objectStore('files').put({key:k,blob:b,meta:m,ts:Date.now()}); data.mediaIndex=data.mediaIndex||{}; data.mediaIndex[k]={name:m.name||k,type:b.type,size:b.size}; saveData() },
  async urlFor(k){ if(this.cache.has(k))return this.cache.get(k); const d=await this.open(); return new Promise((s,j)=>{const r=d.transaction('files','readonly').objectStore('files').get(k);r.onsuccess=()=>{if(!r.result?.blob)return j('Missing');const u=URL.createObjectURL(r.result.blob);this.cache.set(k,u);s(u)};r.onerror=()=>j(r.error)}) },
  revokeAll(){ for(const u of this.cache.values())URL.revokeObjectURL(u); this.cache.clear() },
  async clearAll(){ const d=await this.open(), tx=d.transaction('files','readwrite'); tx.objectStore('files').clear(); this.revokeAll(); data.mediaIndex={}; saveData() },
  rwHTML(h,m){ return String(h||'').replace(/(<img\b[^>]?\bsrc=["'])([^"']+)(["'][^>]*>)/gi,(x,p,src,s)=>{const k=m[src.replace(/^.*[\\\/]/,'').replace(/^_+/,'')]||null;return k?`${p}media://${k}${s}`:x}) },
  async resolve(el){ const i=[...el.querySelectorAll('img[src^="media://"]')]; await Promise.all(i.map(async x=>{try{x.src=await Media.urlFor(x.getAttribute('src').replace(/^media:\/\//,''))}catch{}})) }
};
const ensureSQL = (()=>{ let p; return ()=>{ if(!p)p=initSqlJs({locateFile:f=>`https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/${f}`}); return p } })();

async function importFiles(fs){ for(const f of fs){ const n=f.name.toLowerCase(); if(n.endsWith('.apkg')) await impApkg(f); else if(n.endsWith('.csv')||n.endsWith('.tsv')) await impDelim(f); else if(n.endsWith('.json')) await impJSON(f) } }

async function impApkg(f){
  try {
    const b = await f.arrayBuffer();
    let z;
    try { z = await JSZip.loadAsync(b); } catch(e) { throw new Error("Ce fichier n'est pas un ZIP/APKG valide."); }
    let mm = {}; 
    const me = z.file(/^media(\.json)?$/i)[0];
    if(me) { try { mm = JSON.parse(await me.async('string')); } catch(e) {} }
    const iId = `apkg-${slugify(f.name.replace(/\.[^.]+$/,''))}-${Date.now()}`;
    const mnk = {};
    for(const [ns,rn] of Object.entries(mm)){ 
        const e = z.file(new RegExp(`^${ns}$`))[0]; 
        if(!e) continue; 
        const k = `${iId}/${rn||ns}`; 
        await Media.save(k, await e.async('blob'), {name:rn||ns}); 
        mnk[rn] = k; mnk[ns] = k; 
    }
    let col = z.file("collection.anki2");
    if (!col) col = z.file(/collection\.anki2(1|\.db)?/i)[0];
    if(!col) throw new Error("Fichier de donn√©es introuvable dans l'archive.");
    const dbData = new Uint8Array(await col.async('uint8array'));
    const header = String.fromCharCode.apply(null, dbData.subarray(0, 50));
    if (header.includes("Please update") || header.includes("Anki version")) { alert("Fichier non support√© (Nouveau format Anki). Veuillez exporter avec 'Support anciennes versions'."); return; }
    if (!header.startsWith("SQLite")) { alert("Format inconnu."); return; }
    const SQL = await ensureSQL();
    let db;
    try { db = new SQL.Database(dbData); } catch(sqlErr) { throw new Error("Base de donn√©es corrompue."); }
    let dk = {};
    try { const r = db.exec('select decks from col limit 1'); if(r[0]?.values[0]) dk = JSON.parse(r[0].values[0][0]||'{}'); } catch(e) {}
    let rows;
    try { rows = db.exec('select cards.id, cards.nid, cards.did, cards.ord, notes.flds from cards join notes on notes.id=cards.nid'); } catch(e) { db.close(); throw new Error("Erreur DB."); }
    if(!rows || !rows[0]) { db.close(); throw new Error("Paquet vide."); }
    const byD = new Map(), cols = rows[0].columns, vals = rows[0].values;
    for(const r of vals){ 
        const row = Object.fromEntries(cols.map((c,i) => [c,r[i]]));
        const dn = (dk[row.did]?.name || `Deck ${row.did}`).replace(/::/g,' ‚Ä∫ ');
        const fl = (row.flds||'').split('\x1f');
        let frontVal = fl[0] || 'Vide';
        let backVal = fl[1] || '';
        if (row.ord == 1 && fl.length >= 2) { frontVal = fl[1]; backVal = fl[0]; } 
        if (fl.length > 2) { backVal += '<br><br>' + fl.slice(2).join('<br>'); }
        const ca = byD.get(dn) || []; 
        ca.push({ id: String(row.id), front: Media.rwHTML(frontVal, mnk), back: Media.rwHTML(backVal, mnk) }); 
        byD.set(dn, ca);
    }
    db.close();
    const chs = []; 
    for(const [n,arr] of byD){
      const cds = arr.map(r => ({ id: `${slugify(n)}-${r.id}`, front: r.front, back: r.back, grade: 'unseen', timesReviewed:0, lastReviewed:0, lastMs:0, avgMs:0, perfEma:.5, ef:2.5, intervalDays:0, dueAt:0, streak:0, successes:0, failures:0 }));
      chs.push({ id: 'chap-'+slugify(n), title: n, description: `${getEmoji(n)||'üì¶'} ${n}`, settings: {sessionSize:10, dailyGoal:10, reviewOrder:'front-first', langSwap:!1}, filters: {grades:GRADE_FILTERS()}, stats: {gradeCounts:{...GRADE_INIT(), unseen:cds.length}, totalReviews:0, dailyReviews:{}, dailyChanges:{}, dailyDurMs:{}, dailyDurCount:{}, dailyLog:{}}, cards: cds, imported: !0 });
    }
    const sj = { id: `import-${slugify(f.name)}`, title: f.name.replace(/\.[^.]+$/,''), chapters: chs, imported: !0 }; 
    data.subjects.push(sj); data.app.currentSubjectId = sj.id; saveData();
  } catch(e) { console.error(e); alert("Erreur import : " + e.message); }
}

async function impDelim(f){ const t=await f.text(), sep=t.includes('\t')?'\t':(t.includes(';')?';':','), l=t.split(/\r?\n/).filter(Boolean); let h=l[0].split(sep).map(s=>s.trim().toLowerCase()), st=0; if(!h.includes('front')) h=['front','back','chapter']; else st=1; const recs=[]; for(let i=st;i<l.length;i++){ const c=l[i].split(sep), r=Object.fromEntries(h.map((x,j)=>[x,c[j]||''])); recs.push({front:r.front||c[0]||'',back:r.back||c[1]||'',chapter:r.chapter||'G√©n√©ral'}) } await impSimpSub(f.name.replace(/\.[^.]+$/,''),recs) }
async function impJSON(f){ const o=JSON.parse(await f.text()); if(Array.isArray(o)) impSimpSub(f.name.replace(/\.[^.]+$/,''),o); else if(o.cards) impSimpSub(o.subject||f.name,o.cards) }
async function impSimpSub(n,l){
  const by={}; l.forEach(x=>{ const c=(x.chapter||'G√©n√©ral').trim()||'G√©n√©ral'; (by[c]=by[c]||[]).push({front:Media.rwHTML(String(x.front||''),{}),back:Media.rwHTML(String(x.back||''),{})}) });
  const chs=Object.entries(by).map(([cn,arr])=>{
    const cds=arr.map((r,i)=>({id:`${slugify(cn)}-${i}-${Date.now()}`,front:r.front,back:r.back,grade:'unseen',timesReviewed:0,lastReviewed:0,lastMs:0,avgMs:0,perfEma:.5,ef:2.5,intervalDays:0,dueAt:0,streak:0,successes:0,failures:0}));
    return{id:'chap-'+slugify(cn),title:cn,description:`üì¶ ${cn}`,settings:{sessionSize:10,dailyGoal:10,reviewOrder:'front-first',langSwap:!1},filters:{grades:GRADE_FILTERS()},stats:{gradeCounts:{...GRADE_INIT(), unseen:cds.length},totalReviews:0,dailyReviews:{},dailyChanges:{},dailyDurMs:{},dailyDurCount:{},dailyLog:{}},cards:cds,imported:!0}
  });
  const s={id:`import-${slugify(n)}-${Date.now()}`,title:n,chapters:chs,imported:!0}; data.subjects.push(s); data.app.currentSubjectId=s.id; saveData(); goDeck(!1)
}

let data;
const ChartHit={}, Bar7Hit={};
function buildChs(l){ 
  const by={}; 
  l.forEach(r=>{ const n=r.chapter||'Sans cat√©gorie'; (by[n]=by[n]||[]).push(r) }); 
  let sortedKeys = Object.keys(by);
  if(typeof PHY_MAP !== 'undefined') {
      const orderMap = {};
      Object.values(PHY_MAP).forEach((v, i) => orderMap[v.title] = i);
      sortedKeys.sort((a, b) => {
          const idxA = orderMap[a] !== undefined ? orderMap[a] : 999;
          const idxB = orderMap[b] !== undefined ? orderMap[b] : 999;
          return idxA - idxB;
      });
  }
  return {
      chapters: sortedKeys.map(n=>{ 
          const cds=by[n].map(r=>({ id:`${slugify(n)}-${r.id}`, front:r.front, back:r.back, grade:'unseen', timesReviewed:0, lastReviewed:0, lastMs:0, avgMs:0, perfEma:.5, ef:2.5, intervalDays:0, dueAt:0, streak:0, successes:0, failures:0 })); 
          return {
              id:'chap-'+slugify(n), title:n, description: getEmoji(n) ? `${getEmoji(n)} ${n}` : n, settings:{sessionSize:10,dailyGoal:10,reviewOrder:'front-first',langSwap:!1}, filters:{grades:GRADE_FILTERS()}, stats:{gradeCounts:{...GRADE_INIT(),unseen:cds.length},totalReviews:0,dailyReviews:{},dailyChanges:{},dailyDurMs:{},dailyDurCount:{},dailyLog:{}}, cards:cds
          } 
      }), 
      app:{currentChapterId:null,theme:'dark',prefs:{fsTerm:22,fsDef:24,accent:'indigo',showEmoji:!0,radius:14}}
  };
}
const buildSub=(t,l) => ({id:slugify(t),title:t,chapters:buildChs(l).chapters,groups:[]}), buildCanon=() => [buildSub('Physique',dataPHY), buildSub('Anglais',dataEN)];

function loadData(){ try{const r=LS.getItem(KEY);if(r){const p=JSON.parse(r);if(p.subjects)return p;if(p.chapters)return{subjects:[{id:'anglais',title:'Anglais',chapters:p.chapters,groups:[]}],app:p.app||{theme:'light',currentSubjectId:'anglais'}}}}catch{} const s=buildCanon(); return{subjects:s,app:{currentSubjectId:s[0]?.id,theme:'light',prefs:{fsTerm:22,fsDef:24,accent:'indigo'}}} }
function saveData(){ try{LS.setItem(KEY,JSON.stringify(data))}catch{} }

function pruneStats(){ const c=new Date(); c.setDate(c.getDate()-180); const k=dateKey(c); data.subjects.forEach(s=>s.chapters.forEach(ch=>{ ['dailyReviews','dailyDurMs','dailyDurCount','dailyChanges','dailyLog'].forEach(x=>{const m=ch.stats[x]||{};Object.keys(m).forEach(d=>{if(d<k)delete m[d]})}); if(ch.stats.dailyLog)Object.values(ch.stats.dailyLog).forEach(a=>{if(a.length>200)a.splice(0,a.length-200)}) })) }
const getSub = () => data.subjects.find(x=>x.id===data.app.currentSubjectId)||data.subjects[0];
const setSub = id => { if(data.subjects.find(s=>s.id===id)){data.app.currentSubjectId=id;saveData()} };
const getChs = () => getSub()?.chapters||[];
const updChDesc = c => { 
  // Priorit√© √† l'√©moji personnalis√©, sinon √©moji automatique par nom, sinon rien
  const e = c.emoji || getEmoji(c.title) || ''; 
  c.description = (e ? e + ' ' : '') + c.title; 
};
function uniqId(s,b){ const ids=new Set((s.chapters||[]).map(c=>c.id)); if(!ids.has(b))return b; let i=2,d=b; while(ids.has(d))d=b+'-'+i++; return d }
function moveCh(fid,cid,tid){ if(fid===tid)return!1; const f=data.subjects.find(s=>s.id===fid), t=data.subjects.find(s=>s.id===tid); if(!f||!t)return!1; const i=f.chapters.findIndex(c=>c.id===cid); if(i<0)return!1; const ch=f.chapters[i]; ensGrps(f).forEach(g=>g.chapIds=g.chapIds.filter(id=>id!==cid)); valGrps(f); f.chapters.splice(i,1); ch.id=uniqId(t,ch.id); (t.chapters=t.chapters||[]).push(ch); valGrps(t); if(f.chapters.length===0){data.subjects=data.subjects.filter(s=>s.id!==f.id);if(data.app.currentSubjectId===f.id)data.app.currentSubjectId=data.subjects[0]?.id} saveData(); return!0 }
function renSub(id,t,e){ const s=data.subjects.find(x=>x.id===id); if(!s)return!1; if(t)s.title=t.trim(); s.emoji=(e||'').trim(); saveData(); return!0 }
const ensGrps = s => { if(!Array.isArray(s.groups))s.groups=[]; return s.groups };
const findGrp = (s,id) => ensGrps(s).find(g=>g.id===id);
const findGrpCh = (s,cid) => ensGrps(s).find(g=>g.chapIds.includes(cid));
const grpEmojis = (s,g) => { const z=new Set(); g.chapIds.forEach(id=>{const c=s.chapters.find(x=>x.id===id),e=c?(c.emoji||getEmoji(c.title)||''):'';if(e)z.add(e)}); return[...z].join(', ') };
const valGrps = s => { const all=new Set(s.chapters.map(c=>c.id)); s.groups=ensGrps(s).map(g=>({...g,chapIds:g.chapIds.filter(x=>all.has(x))})).filter(g=>g.chapIds.length>=2) };

function buildGrpStats(s,g){
  const chs=g.chapIds.map(id=>s.chapters.find(c=>c.id===id)).filter(Boolean), c=GRADE_INIT();
  chs.forEach(ch=>{ const k=getLive(ch); for(let x in c)c[x]+=k[x] });
  const st={totalReviews:chs.reduce((a,b)=>a+(b.stats.totalReviews||0),0),dailyReviews:{},dailyDurMs:{},dailyDurCount:{},dailyChanges:{}}, base=new Date();
  for(let i=0;i<60;i++){
    const d=new Date(base); d.setDate(base.getDate()-i); const k=dateKey(d);
    st.dailyReviews[k]=chs.reduce((a,b)=>a+(b.stats.dailyReviews[k]||0),0); st.dailyDurMs[k]=chs.reduce((a,b)=>a+(b.stats.dailyDurMs[k]||0),0);
    st.dailyDurCount[k]=chs.reduce((a,b)=>a+(b.stats.dailyDurCount[k]||0),0);
    st.dailyChanges[k]=chs.reduce((acc,ch)=>{const v=ch.stats.dailyChanges[k];if(v){acc.changed+=v.changed||0;acc.total+=v.total||0}return acc},{changed:0,total:0})
  }
  return {counts:c, stats:st}
}
function buildVirt(s,g){
  const chs=g.chapIds.map(id=>s.chapters.find(c=>c.id===id)).filter(Boolean), cards=[];
  chs.forEach(ch=>ch.cards.forEach(c=>cards.push({...c,id:`virt-${ch.id}-${c.id}`,_origin:{chapId:ch.id,cardId:c.id}})));
  return {id:'group-'+g.id,_groupId:g.id,title:g.title||`Fichier (${grpEmojis(s,g)})`,emoji:g.emoji||'',description:(g.emoji?g.emoji+' ':'')+(g.title||'Fichier'),virtual:!0,_ids:g.chapIds.slice(),settings:{sessionSize:10,dailyGoal:10,reviewOrder:'front-first',langSwap:!1},filters:g.filters?deepClone(g.filters):{grades:GRADE_FILTERS()},stats:{gradeCounts:buildGrpStats(s,g).counts,...buildGrpStats(s,g).stats},cards,deadline:g.deadline,lastUsed:g.lastUsed}
}
function addGrp(s,ids){ const u=[...new Set(ids)].filter(Boolean); if(u.length<2)return; ensGrps(s).push({id:'g'+Date.now().toString(36),chapIds:u,createdAt:Date.now(),title:'',emoji:'',lastUsed:Date.now()}) }
function toGrp(s,gid,cid){ const g=findGrp(s,gid); if(g&&!g.chapIds.includes(cid))g.chapIds.push(cid) }
function remGrp(s,gid,ids){ const g=findGrp(s,gid); if(g)g.chapIds=g.chapIds.filter(x=>!ids.includes(x)) }
function delGrp(s,gid){ s.groups=ensGrps(s).filter(g=>g.id!==gid) }

const Nav = {
  stack: [],
  scrollPos: 0,
  push(){ 
    // Sauvegarder la position de scroll actuelle
    const list = $('#dL');
    this.scrollPos = list ? list.scrollTop : 0;
    this.stack.push(deepClone({view:State.view,chapterId:State.chapterId,review:State.review,dailyKey:State.dailyKey,scrollPos:this.scrollPos})) 
  },
  back(){ 
    if(!this.stack.length)return; 
    const p=this.stack.pop(); 
    if(!this.stack.length||(!p.chapterId?.startsWith('group-')))State.virtualChapter=null; 
    State.view=p.view; State.chapterId=p.chapterId; State.review=p.review; State.dailyKey=p.dailyKey; 
    this.scrollPos = p.scrollPos || 0;
    render(!1) 
  },
  clear(){ this.stack=[]; this.scrollPos=0 }
};

const State = { view:'deck', chapterId:null, review:null, cardsIndex:0, dailyKey:null, virtualChapter:null };
const _real = id => getChs().find(c=>c.id===id), getCh = id => (State.virtualChapter?.id===id) ? State.virtualChapter : _real(id);
function updFilt(ch,key){ let t=ch; if(ch.virtual&&ch._groupId){const g=findGrp(getSub(),ch._groupId);if(g){if(!g.filters)g.filters={grades:GRADE_FILTERS()};t=g}} togFilt(t,key); if(t!==ch)ch.filters=t.filters; saveData(); goChapter(ch.id,!1) }
const delImpCh = id => { const s=getSub(), i=s.chapters.findIndex(c=>c.id===id); if(i<0||!s.chapters[i].imported||!confirm('Supprimer ?'))return!1; ensGrps(s).forEach(g=>g.chapIds=g.chapIds.filter(x=>x!==id)); valGrps(s); s.chapters.splice(i,1); if(!s.chapters.length&&s.imported){data.subjects=data.subjects.filter(x=>x.id!==s.id);data.app.currentSubjectId=data.subjects[0]?.id} saveData(); return!0 };

/* --- DEADLINE & LOGIC --- */
function getDeckTint(item, type) {
    // 1. R√©cup√©rer les stats
    let k;
    if (type === 'chapter') k = item.stats.gradeCounts || getLive(item);
    else k = buildGrpStats(getSub(), item).counts;

    const totalGraded = k.echec + k.difficile + k.bien + k.facile;
    
    // -- COULEUR DE BASE (Moyenne des notes) --
    // Rouge (Fail) : 239, 68, 68
    // Bleu (Bien)  : 59, 130, 246
    // Vert (Easy)  : 34, 197, 94
    
    let r = 0, g = 0, b = 0, a = 0;

    if (totalGraded > 0) {
        const wRed = (k.echec + k.difficile) / totalGraded;
        const wBlue = k.bien / totalGraded;
        const wGreen = k.facile / totalGraded;

        r = (239 * wRed) + (59 * wBlue) + (34 * wGreen);
        g = (68 * wRed) + (130 * wBlue) + (197 * wGreen);
        b = (68 * wRed) + (246 * wBlue) + (94 * wGreen);
        a = 0.25; // Opacit√© de base pour la couleur du deck
    }

    // -- COUCHE URGENCE (Date limite) --
    if (item.deadline) {
        const now = new Date(); now.setHours(0,0,0,0);
        const ddl = new Date(item.deadline); ddl.setHours(0,0,0,0);
        const diff = (ddl - now) / 864e5; // Jours restants

        // Calcul de l'intensit√© du rouge (0 = pas d'urgence, 1 = urgence max)
        let urgency = 0;
        
        if (diff <= 0) urgency = 1;      // Aujourd'hui ou retard (bien que retard soit supprim√© au chargement)
        else if (diff <= 7) urgency = 1 - (diff / 7); // D√©grad√© sur 7 jours
        
        if (urgency > 0) {
            // Cible Rouge Urgence
            const tR = 239, tG = 68, tB = 68;
            
            if (totalGraded === 0) {
                // Si tout est "Non vu", on part du transparent vers le rouge
                r = tR; g = tG; b = tB;
                a = 0.5 * urgency; // Max opacit√© 0.5
            } else {
                // Si on a une couleur de base, on l'√©crase progressivement
                r = r * (1 - urgency) + tR * urgency;
                g = g * (1 - urgency) + tG * urgency;
                b = b * (1 - urgency) + tB * urgency;
                
                // L'opacit√© augmente aussi pour devenir plus "solide"
                a = 0.25 + (0.25 * urgency); 
            }
        }
    }

    if (a <= 0.01) return '';
    return `rgba(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)}, ${a})`;
}


// Nettoie les dates d√©pass√©es
function checkExpiredDates(list) {
    const now = new Date(); 
    now.setHours(0,0,0,0); // On compare √† minuit aujourd'hui
    let changed = false;
    
    list.forEach(item => {
        if (item.deadline) {
            const ddl = new Date(item.deadline);
            ddl.setHours(0,0,0,0);
            // Si la date limite est strictement avant aujourd'hui, on l'enl√®ve
            if (ddl < now) {
                item.deadline = null;
                changed = true;
            }
        }
    });
    return changed;
}

function getDailyGoalCalc(ch) {
    if(!ch.deadline) return null;
    
    const now = new Date(); now.setHours(0,0,0,0);
    const ddl = new Date(ch.deadline); ddl.setHours(0,0,0,0);
    const diffTime = ddl - now;
    // Nombre de jours inclusifs (si c'est pour demain, days=1)
    let days = Math.ceil(diffTime / 864e5);
    
    // Si c'est aujourd'hui ou en retard, on consid√®re qu'il reste "1 jour de travail" (aujourd'hui)
    if (days <= 0) days = 1;

    const k = ch.stats.gradeCounts || getLive(ch);
    
    // Pool 1 : Non vues + Echec + Difficile
    let pool = k.unseen + k.echec + k.difficile;
    let label = "cartes (Mauvaises)";
    
    // Pool 2 : Si tout est vu et correct, on perfectionne les "Bien"
    if (pool === 0) {
        pool = k.bien;
        label = "cartes (Bien)";
        
        // Si vraiment tout est facile
        if (pool === 0) return { val: 0, text: "Objectif atteint !", pool: 0 };
    }
    
    // Calcul par jour
    const daily = Math.ceil(pool / days);
    
    return { val: daily, text: `${label} / jour`, pool: pool };
}
/* --- NAVIGATION & UI --- */

const backBtn=$('#backBtn'), titleEl=$('#title'), botAct=$('#bottomActions'), revBar=$('#revisionBar'), startBtn=$('#startReviewBtn');

function renSubMenu(){
  let m=$('#subjectMenu'); if(!m){m=D.createElement('div');m.id='subjectMenu';m.className='subject-menu';D.body.appendChild(m)}
  m.innerHTML=data.subjects.map(s=>`<div class="subject-item" data-id="${s.id}"><div class="name">${s.emoji?s.emoji+' ':''}${s.title}</div><div class="meta">${s.chapters?.length||0} chap.</div>${s.id===data.app.currentSubjectId?'<div class="muted">‚úì</div>':''}<div class="subject-actions"><button class="btn btn--tiny rs">‚úèÔ∏è</button>${!(s.chapters?.length)?'<button class="btn btn--tiny ds">üóëÔ∏è</button>':''}</div></div>`).join('');
  $$('.subject-item',m).forEach(el=>{
    el.onclick=e=>{if(e.target.closest('button'))return;const id=el.dataset.id;if(id!==data.app.currentSubjectId){setSub(id);closeSubMenu();goDeck(!1)}else closeSubMenu();e.stopPropagation()};
    const r=el.querySelector('.rs'); if(r)r.onclick=e=>{e.stopPropagation();const id=el.dataset.id,s=data.subjects.find(x=>x.id===id),t=prompt('Nom:',s.title);if(t){renSub(id,t,prompt('Emoji:',s.emoji));renSubMenu();setTop({title:`Deck ‚Ä¢ ${getSub().title}`});goDeck(!1)}};
    const d=el.querySelector('.ds'); if(d)d.onclick=e=>{e.stopPropagation();const id=el.dataset.id;if(confirm('Supprimer ?')){data.subjects=data.subjects.filter(s=>s.id!==id);if(data.app.currentSubjectId===id)data.app.currentSubjectId=data.subjects[0]?.id;closeSubMenu();goDeck(!1);saveData()}}
  })
}
const openSubMenu = () => { renSubMenu(); const m=$('#subjectMenu'), r=titleEl.getBoundingClientRect(); m.style.top=`${r.bottom+6}px`; m.style.left=`${r.left}px`; m.style.display='block'; setTimeout(()=>D.addEventListener('click',clsOnOut),0) };
const closeSubMenu = () => { const m=$('#subjectMenu'); if(m)m.style.display='none'; D.removeEventListener('click',clsOnOut) };
const clsOnOut = e => { if(!$('#subjectMenu')?.contains(e.target)&&e.target!==titleEl)closeSubMenu() };

titleEl.onclick = () => { if(State.view!=='deck')goDeck(!1); else($('#subjectMenu')?.style.display==='block')?closeSubMenu():openSubMenu() };
backBtn.onclick = () => { if(State.view==='recap'){if(Nav.stack.length)Nav.stack.pop();const t=State.review?.chapterId||State.chapterId;State.review=null;hideRevAct();if(t?.startsWith('group-')){const g=findGrp(getSub(),t.replace('group-',''));if(g){State.virtualChapter=buildVirt(getSub(),g);goChapter(State.virtualChapter.id,!1)}else goDeck(!1)}else if(t)goChapter(t,!1);else goDeck(!1)}else{if(State.view==='review'&&State.review&&!State.review.end&&!confirm('Quitter la r√©vision ?'))return;Nav.back()} };
$('#cardsBtn').onclick = () => goCards(State.chapterId); $('#settingsBtn').onclick = () => openSet(State.chapterId); startBtn.onclick = () => startRev(State.chapterId);

function setTop({title,showBack}){ backBtn.classList.toggle('hidden',showBack===!1); if(title)titleEl.textContent=title }
function setBot({actions,revision,sz=10,en=true,av=null,cid=null}){ botAct.style.display=actions?'grid':'none'; revBar.style.display=revision?'block':'none'; $('#app').style.setProperty('--row-actions',actions?'52px':'0px'); $('#app').style.setProperty('--row-rev',revision?'64px':'0px'); if(av==null&&cid){const c=getCh(cid);av=c?cntAv(c):0} startBtn.textContent=`R√©vision ‚Ä¢ ${av>0?M.min(sz,av):sz} cartes${revision&&(av>0)?` ‚Ä¢ ${av} dispo`:''}`; startBtn.disabled=!en||(av||0)<=0 }
function render(push=true){ if(State.view==='deck')goDeck(push); else if(State.view==='chapter')goChapter(State.chapterId,push); else if(State.view==='cards')goCards(State.chapterId,push); else if(State.view==='review')goReview(push); else if(State.view==='recap')goRecap(push); else if(State.view==='settings')openSet(State.chapterId,push); else if(State.view==='daily')goDaily(State.chapterId,State.dailyKey,push) }
const hideRevAct = () => { $('#reviewActionsBar').style.display='none' };

function goDeck(push=true){
  safeCloseLB(); Media.revokeAll(); clearMathCache();
  if(push) Nav.push(); 
  State.view='deck'; State.chapterId=null; 
  const s=getSub(); 
  setTop({title:`Deck ‚Ä¢ ${s.emoji?s.emoji+' ':''}${s.title}`, showBack:!1}); 
  setBot({actions:!1, revision:!1}); hideRevAct();

  let needsSave = false;
  if (checkExpiredDates(ensGrps(s))) needsSave = true;
  if (checkExpiredDates(s.chapters)) needsSave = true;
  if (needsSave) debouncedSave();

  const v=$('#view'), grps=ensGrps(s), chs=(s.chapters||[]), inG=new Set(grps.flatMap(g=>g.chapIds));
  const sorter = (a, b) => {
      if (a.deadline && !b.deadline) return -1;
      if (!a.deadline && b.deadline) return 1;
      if (a.deadline && b.deadline) { const diff = new Date(a.deadline) - new Date(b.deadline); if (diff !== 0) return diff; }
      return (b.lastUsed || 0) - (a.lastUsed || 0);
  };

  grps.sort(sorter);
  const visibleChs = chs.filter(c=>!inG.has(c.id)).sort(sorter);

  v.innerHTML=`<div class="card flexcol" style="flex:1"><div class="deck-head"><div class="section-title">Chapitres & Fichiers</div><div class="actions"><button class="btn btn--ghost btn--tiny" id="impB">Importer</button><input id="impI" type="file" class="hidden" accept="*/*" multiple/></div></div><div id="dL" class="scroll-y" style="flex:1;min-height:0;padding-right:4px"><div class="list">${grps.map(g=>{const{counts:c}=buildGrpStats(s,g),tot=Object.values(c).reduce((a,b)=>a+b,0),pct=tot?M.round((tot-c.unseen)*100/tot):0; const tint = getDeckTint(g, 'group'); return`<div class="deck-item" data-type="group" data-id="${g.id}" style="${tint?`background-color:${tint};transition:background-color 0.3s`:''}"><div class="slide"><div style="min-width:0;flex:1"><div class="title-line" style="font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:18px">${g.title?((g.emoji?g.emoji+' ':'')+g.title):`üìÅ Fichier (${grpEmojis(s,g)})`}</div><div class="mt6" style="display:flex;flex-wrap:wrap;gap:6px"><span class="chip-pie" style="--progress:${pct}%"></span><span class="chip">üü• ${c.echec}</span><span class="chip">üü® ${c.difficile}</span><span class="chip">üü¶ ${c.bien}</span><span class="chip">üü© ${c.facile}</span><span class="folder-badge">‚Ä¢ ${g.chapIds.length} chap.</span></div></div><div class="muted" style="font-size:18px;padding-left:8px">‚Ä∫</div></div></div>`}).join('')}${visibleChs.map(c=>{const k=getLive(c),tot=c.cards.length,pct=tot?M.round((tot-k.unseen)/tot*100):0; const tint = getDeckTint(c, 'chapter'); return`<div class="deck-item" data-type="chapter" data-id="${c.id}" style="${tint?`background-color:${tint};transition:background-color 0.3s`:''}">${c.imported?`<div class="right-action"><button class="btn btn--solid btn--red btn--tiny delCh" data-cid="${c.id}">Supprimer</button></div>`:''}<div class="slide"><div style="min-width:0;flex:1"><div class="title-line" style="font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:18px">${c.description||c.title}</div><div class="mt6" style="display:flex;flex-wrap:wrap;gap:6px"><span class="chip-pie" style="--progress:${pct}%"></span><span class="chip">üü• ${k.echec}</span><span class="chip">üü® ${k.difficile}</span><span class="chip">üü¶ ${k.bien}</span><span class="chip">üü© ${k.facile}</span></div></div><div class="muted" style="font-size:18px;padding-left:8px">‚Ä∫</div></div></div>`}).join('')}</div></div></div>`;
  
  $('#impB').onclick=()=>$('#impI').click(); 
  $('#impI').onchange = async e => { try { await importFiles([...e.target.files]); toast('Import termin√© !', 'success'); goDeck(!1); } catch(x) { console.error(x); toast('Erreur import', 'error'); } finally { e.target.value=''; } }; 
  
  if(!push && Nav.scrollPos > 0) { setTimeout(() => { const list = $('#dL'); if(list) list.scrollTop = Nav.scrollPos; }, 50); }
  const list = $('#dL'); if(list) bindPullRefresh(list, () => { toast('Actualisation...', 'info', 1000); goDeck(false); });
  bindDeck();
}
function bindDeck(){
  const l=$('#dL'); if(!l)return; const sub=getSub(); l.onclick=e=>{if(e.target.matches('.delCh')){e.stopPropagation();if(delImpCh(e.target.dataset.cid))goDeck(!1)}};
  $$('.deck-item').forEach(el=>{
    const t=el.dataset.type, id=el.dataset.id; let sx=0, sy=0, dx=0, dy=0, st='idle', tm, g, raf, sd=0;
    const auto=()=>{if(sd!==0)l.scrollTop+=6*sd;if(st==='dragging')raf=requestAnimationFrame(auto)};
    const mG=(x,y)=>{if(g)g.style.transform=`translate(${x-75}px,${y-75}px) scale(1.02)`};
    
    // Modification: Swipe plus strict et gestion pointer capture
    const d=e=>{
        if(e.target.closest('button'))return;
        sx=e.clientX;sy=e.clientY;dx=dy=0;st='pressed';
        clearTimeout(tm);
        // NE PAS capturer le pointer sur Android pour permettre le scroll natif
        if(!/android/i.test(navigator.userAgent)) el.setPointerCapture?.(e.pointerId);

        if(t==='chapter')tm=setTimeout(()=>{st='dragging';el.classList.add('dragging-origin');D.body.classList.add('dragging-active');l.classList.add('scroll-lock');openSubMenu();g=el.cloneNode(!0);g.className='drag-ghost';g.style.width=el.offsetWidth+'px';D.body.appendChild(g);mG(sx,sy);raf=requestAnimationFrame(auto)},500);else if(t==='group')tm=setTimeout(()=>{st='idle';if(confirm("D√©composer ?"))delGrp(sub,id);saveData();goDeck(!1)},700)
    };
    
    const m=e=>{if(st==='idle'||st==='swiping')return;dx=e.clientX-sx;dy=e.clientY-sy;if(st==='pressed'&&M.abs(dx)>10){clearTimeout(tm);if(dx<0&&el.querySelector('.right-action')){st='swiping';el.classList.add('reveal-delete');e.preventDefault()}}else if(st==='dragging'){e.preventDefault();mG(e.clientX,e.clientY);const r=l.getBoundingClientRect();sd=e.clientY<r.top+r.height*.2?-1:(e.clientY>r.bottom-r.height*.2?1:0);$$('.deck-item,.subject-item').forEach(n=>n.classList.remove('drop-target'));const tg=D.elementFromPoint(e.clientX,e.clientY)?.closest('.deck-item,.subject-item');if(tg&&tg!==el)tg.classList.add('drop-target')}};
    
    const u=e=>{
        clearTimeout(tm);
        if(st==='dragging'){const sEl=D.elementFromPoint(e.clientX,e.clientY)?.closest('.subject-item');if(sEl){const to=sEl.dataset.id;if(to&&to!==sub.id&&moveCh(sub.id,id,to))setSub(to)}else{const tg=D.elementFromPoint(e.clientX,e.clientY)?.closest('.deck-item');if(tg&&tg!==el)hDrop(sub,{type:t,id},{type:tg.dataset.type,id:tg.dataset.id})}goDeck(!1)}
        // Modification: Seuil plus strict pour le click (hypot < 8 et dy < 6)
        else if(st==='pressed' && M.hypot(dx,dy)<8 && M.abs(dy)<6){if(t==='group')openGrp(sub,id);else goChapter(id)}
        
        cancelAnimationFrame(raf);st='idle';if(g)g.remove();g=null;el.classList.remove('dragging-origin');D.body.classList.remove('dragging-active');l.classList.remove('scroll-lock');$$('.deck-item,.subject-item').forEach(n=>n.classList.remove('drop-target'));closeSubMenu()
    };
    el.addEventListener('pointerdown',d); el.addEventListener('pointermove',m); el.addEventListener('pointerup',u); el.addEventListener('pointercancel',u); el.oncontextmenu=e=>e.preventDefault()
  }); l.onscroll=()=>{$$('.reveal-delete').forEach(n=>n.classList.remove('reveal-delete'))}
}
function hDrop(s,src,dst){
  if(src.type!=='chapter')return; const sG=findGrpCh(s,src.id);
  if(dst.type==='chapter'){if(src.id===dst.id)return;const dG=findGrpCh(s,dst.id);if(!sG&&!dG)addGrp(s,[src.id,dst.id]);else if(sG&&!dG)toGrp(s,sG.id,dst.id);else if(!sG&&dG)toGrp(s,dG.id,src.id);else if(sG!==dG){remGrp(s,sG.id,[src.id]);toGrp(s,dG.id,src.id)}}
  else if(dst.type==='group'){if(sG&&sG.id!==dst.id)remGrp(s,sG.id,[src.id]);toGrp(s,dst.id,src.id)} valGrps(s); saveData()
}
function openGrp(s,gid){ const g=findGrp(s,gid); if(g){State.virtualChapter=buildVirt(s,g);goChapter(State.virtualChapter.id)} }

function goChapter(id,push=true){
  safeCloseLB(); Media.revokeAll(); clearMathCache(); if(push)Nav.push(); State.view='chapter'; State.chapterId=id; const c=getCh(id); if(!c){Nav.back();return} setTop({title:c.title}); updRevBar(c); hideRevAct(); const k=c.stats.gradeCounts||getLive(c), sel=c.filters.grades, v=$('#view');
  
  const dailyCalc = getDailyGoalCalc(c);
  
  v.innerHTML=`<div class="card" style="flex:1;display:flex;flex-direction:column"><div class="section-title">${c.virtual?c.description:(getEmoji(c.title)?getEmoji(c.title)+' ':'')+'Statistiques'}</div><div class="kpi"><div class="k"><div class="label">Non vues</div><div class="value">${k.unseen}</div></div><div class="k"><div class="label">Total</div><div class="value">${c.cards.length}</div></div></div><div class="chart-wrap"><canvas id="gradeChart" width="180" height="180"></canvas></div><div class="legend" id="legend">${GRADES.map(x=>{
  const act = sel[x]; // Est-ce que ce grade est s√©lectionn√© ?
  const color = x==='unseen'?'gray':(x==='echec'?'red':(x==='difficile'?'amber':(x==='bien'?'blue':'green')));
  const label = x.charAt(0).toUpperCase() + x.slice(1);
  
  return `<div class="legend-item ${act?'':'inactive'}" data-key="${x}">
    <span class="check-icon">${act?'‚úì':''}</span>
    <span class="dot ${color}"></span> 
    <span style="flex:1">${label}</span>
    <b class="count">${k[x]}</b>
  </div>`
}).join('')}</div><div class="kpi mt8"><div class="k"><div class="label">Auj.</div><div class="value">${getTod(c)}</div></div><div class="k"><div class="label">üî• Streak</div><div class="value">${getStreak(c)} j</div></div></div><div class="kpi mt8"><div class="k"><div class="label">R√©ussite</div><div class="value">${getSucc(c)}%</div></div><div class="k"><div class="label">Moy. 7j</div><div class="value">${get7dAvgMs(c)?M.round(get7dAvgMs(c)/100)/10+'s':'‚Äî'}</div></div></div>
  
  <div class="mt8" style="padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:10px;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:13px;font-weight:bold;color:var(--muted)">Date Limite:</span>
        <input type="date" id="deadlineInput" class="input" style="width:auto;padding:4px 8px;" value="${c.deadline||''}">
    </div>
    ${dailyCalc ? `<div class="mt6" style="font-size:13px;color:var(--primary);display:flex;justify-content:space-between"><span>Objectif fix√©: <b>${c._goalCache?.size || dailyCalc.val}</b>/jour</span><span>Reste: <b>${cntAv(c)}</b> dispo</span></div>` : ''}
  </div>

  <div class="bar7-wrap mt8"><div class="label" style="color:var(--primary)">Activit√© 7j</div><canvas id="bar7" width="220" height="60"></canvas><div class="bar7-labels" id="bar7Labels"></div></div></div>`;
  
  drawChart('gradeChart',k,sel); $('#gradeChart').onclick=e=>hChartClk(e,'gradeChart',c); $$('.legend-item').forEach(el=>el.onclick=()=>updFilt(c,el.dataset.key)); drawBars('bar7',getLastN(c,7)); $('#bar7').onclick=e=>opDayBar(e,'bar7',c.id); $('#bar7Labels').innerHTML=getLbls(7).map((j,i)=>`<div onclick="goDaily('${c.id}','${dayKeyIdx(7,i)}')">${j.substring(0,3)}</div>`).join('');
  
  $('#deadlineInput').onchange = (e) => {
      const val = e.target.value;
      if (c.virtual && c._groupId) { const g = findGrp(getSub(), c._groupId); if (g) g.deadline = val; } else { c.deadline = val; }
      debouncedSave(); goChapter(c.id, false); 
  };
}
function updRevBar(c){ const n=cntAv(c); setBot({actions:!0,revision:!0,sz:c.settings.sessionSize,en:c.cards.length>0,av:n,cid:c.id}) }

/* --- RECHERCHE --- */
async function goCards(cid,push=true){
  safeCloseLB(); Media.revokeAll(); if(push)Nav.push(); 
  State.view='cards'; State.chapterId=cid; 
  const c=getCh(cid), pool=c.cards.filter(x=>c.filters.grades[x.grade||'unseen']), v=$('#view'); 
  setTop({title:`${c.title} ‚Ä¢ Cartes`}); setBot({actions:!1,revision:!1}); hideRevAct();
  v.innerHTML=`<div style="flex:1;display:flex;flex-direction:column;min-height:0"><div style="flex-shrink:0"><div class="section-title">Cartes (${pool.length})</div><div style="margin-bottom:10px"><input type="text" id="cardSearch" class="input" placeholder="Rechercher..." autocomplete="off" spellcheck="false"></div></div><div id="cardsGrid" class="scroll-y" style="flex:1;min-height:0;padding-right:4px"><div class="cards-grid" id="gridCont"></div></div></div>`;

  const render = async (q='') => {
    const norm = s => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const cleanQ = norm(q);
    let filtered = [];
    if (!cleanQ) { filtered = pool; } else {
        const scored = pool.map(x => {
            const {f,b} = getSides(x,c); const tf = norm(f); const tb = norm(b);
            const fStart = tf.startsWith(cleanQ); const bStart = tb.startsWith(cleanQ); const fIn = tf.includes(cleanQ); const bIn = tb.includes(cleanQ);
            if (!fIn && !bIn) return null;
            let score = 2; let len = 100000; 
            if (fStart || bStart) { score = 1; len = Math.min(fStart ? tf.length : 100000, bStart ? tb.length : 100000); } else { score = 2; len = Math.min(fIn ? tf.length : 100000, bIn ? tb.length : 100000); }
            return { card: x, score, len };
        }).filter(x => x !== null);
        scored.sort((a, b) => { if (a.score !== b.score) return a.score - b.score; return a.len - b.len; });
        filtered = scored.map(s => s.card);
    }
    const grid = $('#gridCont');
    grid.innerHTML = '';
    
    // CORRECTION : Cr√©ation via DOM pour √©viter l'imbrication si balises non ferm√©es
    if(filtered.length === 0) {
       grid.innerHTML = `<div class="muted center" style="grid-column:1/-1;padding:20px">Aucune carte trouv√©e.</div>`;
    } else {
       filtered.forEach(x => {
          const {f,b} = getSides(x,c);
          const el = D.createElement('div');
          el.className = `card-block grade-${x.grade||'unseen'}`;
          el.dataset.id = x.id;
          el.innerHTML = `<div class="term">${ppLat(f)}</div><div class="definition">${ppLat(b)}</div>${x.avgMs?`<div class="cb-time">${fmtDur(x.avgMs)}</div>`:''}`;
          grid.appendChild(el);
       });
    }
    await Media.resolve(grid); await tsLat(grid);
  };
  await render(); 
  $('#cardSearch').oninput = (e) => render(e.target.value);
  $('#cardsGrid').onclick=e=>{ const b=e.target.closest('.card-block'); if(b){ $$('.card-block').forEach(x=>{if(x!==b)x.classList.remove('flipped')}); b.classList.toggle('flipped'); } };
}

async function goDaily(cid,k,push=true){
  safeCloseLB(); Media.revokeAll(); if(push)Nav.push(); State.view='daily'; State.chapterId=cid; State.dailyKey=k; const c=getCh(cid), sub=getSub(); setTop({title:`Activit√© ‚Ä¢ ${fmtDayFR(k)}`}); setBot({actions:!1,revision:!1});
  const log=c.virtual?(findGrp(sub,c._groupId)?getLogGrp(sub,findGrp(sub,c._groupId),k):[]):(c.stats.dailyLog[k]||[]), v=$('#view'); if(!log.length){v.innerHTML=`<div class="card"><div class="section-title">Activit√© ${fmtDayFR(k)}</div><div class="muted">Aucune donn√©e.</div></div>`;return}
  log.sort((a,b)=>a.ts-b.ts); const byC=new Map(); for(const e of log){const cur=byC.get(e.cardId)||{f:e.prev,l:e.next,ts:e.ts,lts:e.ts,_c:e._chapId};if(e.ts>cur.lts){cur.l=e.next;cur.lts=e.ts}byC.set(e.cardId,cur)}
  const rows=[...byC].map(([id,i])=>{const ch=c.virtual?_real(i._c):c,card=ch.cards.find(x=>x.id===id);return card?{t:ppLat(getSides(card,ch).f),d:ppLat(getSides(card,ch).b),b:i.f,a:i.l}:null}).filter(Boolean);
  v.innerHTML=`<div class="card" style="flex:1;display:flex;flex-direction:column;min-height:0"><div class="section-title">Activit√© ${fmtDayFR(k)}</div><div id="dayL" class="scroll-y" style="flex:1"><div class="list">${rows.map(r=>`<div class="grid2"><div class="card-block grade-${r.b}"><div class="term">${r.t}</div><div class="definition">${r.d}</div></div><div class="card-block grade-${r.a}"><div class="term">${r.t}</div><div class="definition">${r.d}</div></div></div>`).join('')}</div></div></div>`;
  await Media.resolve(v); await tsLat(v); $('#dayL').onclick=e=>{const b=e.target.closest('.card-block');if(b)b.classList.toggle('flipped')}
}
function getLogGrp(s,g,k){ return g.chapIds.flatMap(cid=>{const ch=s.chapters.find(c=>c.id===cid);return(ch?.stats?.dailyLog?.[k]||[]).map(e=>({...e,_chapId:cid}))}) }

function goReview(push=true){ safeCloseLB(); Media.revokeAll(); if(push)Nav.push(); State.view='review'; setTop({title:'R√©vision'}); setBot({actions:!1,revision:!0}); $('#revisionBar').style.display='none'; $('#reviewActionsBar').style.display='block'; $('#app').classList.toggle('focus-mode', data.app.prefs.focusMode); renRev() }

function renRev(){
  const v=$('#view'), r=State.review, {card,chap}=getCur(), idx=r.index+1, tot=r.queue.length, {f,b}=getSides(card,chap), ff=chap.settings.reviewOrder!=='back-first';
  const fT=ppLat(f), bT=ppLat(b), progress=((r.index)/tot)*100;
  
  // Gestion du Mode Zen
  const isZen = data.app.prefs.focusMode; // On utilise la pref "Focus" comme "Zen"
  const app = $('#app');
  if(isZen) app.classList.add('zen-mode'); else app.classList.remove('zen-mode');

  const undoBtn = r.history.length ? `<button id="undoBtn" style="background:0 0;border:0;color:var(--muted);font-size:18px;padding:0 8px;cursor:pointer">‚Ü∫</button>` : '';
  
  // TTS & Nettoyage texte
  const currentTextRaw = !r.flipped ? (ff?card.front:card.back) : (ff?card.back:card.front);
  const cleanSpeak = currentTextRaw.replace(/<[^>]*>/g, '').replace(/\[.*?\]/g, '');

  v.innerHTML=`<div class="review-wrap">
    ${!isZen ? `<div class="progress-bar" style="width:${progress}%"></div>` : ''}
    
    <!-- Bouton Exit Zen (visible seulement si Zen actif) -->
    ${isZen ? `<button id="exitZen" class="zen-exit-btn">‚úï</button>` : ''}

    <div class="review-top">
      <div style="display:flex;align-items:center">${undoBtn} ${r.mode==='multi'?'Multi':chap.title}</div>
      <div>${idx} / ${tot}</div>
    </div>

    <div class="review-card">
        <!-- Bouton TTS -->
        <button id="ttsBtn" style="position:absolute; top:10px; right:${isZen?'auto':'10px'}; left:${isZen?'10px':'auto'}; background:rgba(255,255,255,0.1); border:none; border-radius:50%; width:36px; height:36px; cursor:pointer; font-size:18px; z-index:10; display:flex; align-items:center; justify-content:center;">üîä</button>
        
        <div class="review-scroller">
            ${!r.flipped ? 
                `<div class="term" data-face="${ff?'front':'back'}">${fT}</div>` : 
                `<div class="stack"><div class="term" data-face="front">${fT}</div><div class="definition" data-face="back" style="margin-top:20px;padding-top:20px;border-top:1px dashed var(--border)">${bT}</div></div>`
            }
        </div>
    </div>
  </div>`;
  
  // Setup et Bindings
  const scroller = v.querySelector('.review-scroller');
  const finishSetup = () => { 
      Media.resolve(v); 
      initGest(); 
      bindSwipeNav(); 
      
      $('#ttsBtn').onclick = (e) => { e.stopPropagation(); speakText(cleanSpeak); };
      
      // Binding pour quitter le mode Zen temporairement
      if(isZen && $('#exitZen')) {
          $('#exitZen').onclick = () => {
              data.app.prefs.focusMode = false;
              renRev(); // Recharge l'interface normale
              saveData();
          };
      }
  };

  if(scroller) tsLat(scroller).then(finishSetup);
  else finishSetup();

  if(r.history.length && $('#undoBtn')) $('#undoBtn').onclick = undoRev; 
  
  let lastTap = 0;
  $('.review-scroller').addEventListener('click', e => {
    if(e.target.closest('img')) return;
    const now = Date.now();
    if(now - lastTap < 300 && !r.flipped) { haptic('light'); r.flipped = true; renRev(); }
    lastTap = now;
  });

  const bar=$('#reviewActionsBar');
  // En mode Zen, on affiche quand m√™me la barre d'action mais on peut la styliser diff√©remment si besoin
  // Ici elle reste en bas (le CSS du zen-mode ne cache pas .review-actions-bar, juste topbar/bottom/revision)
  
  if(!r.flipped){
      bar.innerHTML=`<button class="btn btn--solid btn--primary" id="flipBtn">Retourner</button>`;
      $('#flipBtn').onclick=()=>{haptic('light');r.flipped=!0;renRev()}
  } else {
      bar.innerHTML=`<div class="row-4">${['echec','difficile','bien','facile'].map(g=>`<button class="btn btn--${g==='echec'?'red':(g==='difficile'?'amber':(g==='bien'?'blue':'green'))}" id="g_${g}">${g}</button>`).join('')}</div>`;
      ['echec','difficile','bien','facile'].forEach(g=>$('#g_'+g).onclick=()=>subG(g))
  }
}



function goRecap(push=true){
  safeCloseLB(); Media.revokeAll(); if(push)Nav.push(); State.view='recap'; const c=getCh(State.review.chapterId)||State.virtualChapter||getCh(State.review.multiChaps[0]); setTop({title:'R√©capitulatif'}); setBot({actions:!1,revision:!1}); hideRevAct();
  const dur=(State.review.answers||[]).reduce((s,a)=>s+(a.ms||0),0), n=State.review.answers.length;
  
  // --- MODIFICATION: Suppression de la stat "Objectif" ---
  $('#view').innerHTML=`<div class="card recap" style="flex:1"><div><h2>R√©capitulatif</h2><div class="subtitle">${c.title}</div></div><div class="grid2"><div class="stat"><div class="label">Moy. 7j</div><div class="val">${get7dAvg(c)}</div></div><div class="stat"><div class="label">Changement</div><div class="val">${getTodCh(c).total>0?M.round(getTodCh(c).changed/getTodCh(c).total*100):0}%</div></div><div class="stat"><div class="label">Fait</div><div class="val">${getTod(c)}</div></div></div><div class="grid2"><div class="stat"><div class="label">Session</div><div class="val">${n}</div></div><div class="stat"><div class="label">Dur√©e</div><div class="val">${fmtDur(dur)}</div></div></div><div class="cta"><button class="btn btn--solid btn--primary" id="contBtn">Continuer</button></div></div>`;
  
  $('#contBtn').onclick=()=>startRev(c.id,!1)
}
function startRev(cid,push=true){
  if(!cid)return; const c=getCh(cid); 
  if(c.virtual&&c._ids)return startRevMulti(c._ids,c.id,c.filters,push);
  
  // --- MODIFICATION START (Daily Goal Locking) ---
  if(c.deadline) {
      const dayStart = getDayStart();
      // Recalculer seulement si pas de cache ou cache p√©rim√©
      if(!c._goalCache || c._goalCache.day !== dayStart) {
          const calc = getDailyGoalCalc(c);
          c._goalCache = { day: dayStart, size: calc?.val || 10, pool: calc?.pool || 0 };
      }
      c.settings.sessionSize = c._goalCache.size;
  }
  // --- MODIFICATION END ---

  const pool=c.cards.filter(x=>c.filters.grades[x.grade||'unseen']); 
  if(!pool.length){alert('Aucune carte.');return}
  
  // UPDATE LAST USED
  c.lastUsed = Date.now();
  saveData();

  const q=bldQ(c,pool,c.settings.sessionSize); 
  State.review={chapterId:cid,queue:q.map(x=>x.id),index:0,flipped:!1,answers:[],history:[],start:Date.now(),end:null,cardStart:Date.now()}; 
  goReview(push)
}
function startRevMulti(ids,vid,flt,push=true){
  const all=ids.map(_real).filter(Boolean), pool=[]; all.forEach(ch=>ch.cards.forEach(c=>{if(flt.grades[c.grade||'unseen'])pool.push({chapId:ch.id,card:c})})); if(!pool.length){alert('Aucune carte.');return}
  const scored=pool.map(i=>{const g=i.card.grade||'unseen',base={unseen:6,echec:5,difficile:3.5,bien:2,facile:1}[g]||1,due=(i.card.dueAt&&i.card.dueAt>0)?(Date.now()-i.card.dueAt>0?(1+M.min(3,(Date.now()-i.card.dueAt)/864e5)):0.85):1.15;return{chapId:i.chapId,cardId:i.card.id,w:base*due*(1+(1-(i.card.perfEma||.5))*1.6)*(1+M.min(2,(i.card.avgMs||0)/3000))*(0.9+M.random()*.2)}}).sort((a,b)=>b.w-a.w), sz=M.round(all.reduce((s,c)=>s+(c.settings.sessionSize||10),0)/all.length)||10;
  
  // UPDATE LAST USED FOR GROUP
  if(vid.startsWith('group-')){
     const sub = getSub();
     const g = findGrp(sub, vid.replace('group-',''));
     if(g) { g.lastUsed = Date.now(); saveData(); }
  }

  State.review={mode:'multi',chapterId:vid,multiChaps:ids.slice(),queue:scored.slice(0,sz),index:0,flipped:!1,answers:[],start:Date.now(),end:null,cardStart:Date.now()}; goReview(push)
}

function bldQ(c,pool,sz){
  const sh=a=>{for(let i=a.length-1;i>0;i--){const j=M.floor(M.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};
  const nc=[], lc=[], dr=[], ot=[];
  pool.forEach(x=>{
      const g=x.grade||'unseen';
      if(g==='unseen') nc.push(x);
      else if(g==='echec'||g==='difficile') lc.push(x);
      else if(x.dueAt<=Date.now()) dr.push(x);
      else ot.push(x);
  });
  return [...sh(lc),...sh(dr),...sh(nc),...sh(ot)].slice(0,sz)
}

function getCur(){ const r=State.review; if(r.mode==='multi'){const i=r.queue[r.index],ch=_real(i.chapId);return{card:ch.cards.find(x=>x.id===i.cardId),chap:ch}}else{const ch=getCh(r.chapterId);return{card:ch.cards.find(x=>x.id===r.queue[r.index]),chap:ch}} }

function undoRev(){
  const r = State.review; if(!r.history.length) return;
  const snap = r.history.pop(); r.index = snap.idx; 
  const {card, chap} = getCur(); Object.assign(card, snap.cardState); chap.stats = snap.statsState; 
  if(r.answers.length > snap.ansIdx) r.answers.splice(snap.ansIdx);
  r.flipped = true; saveData(); renRev();
}
  
function subG(nxt){
  const r=State.review, now=Date.now(), {card,chap}=getCur(); if(!card||!chap){goDeck(!1);return}
  
  // CORRECTION : Flash Couleur de fond au lieu de l'image (Teinte douce)
  haptic(nxt === 'facile' ? 'success' : nxt === 'echec' ? 'error' : 'light'); 
  
  const cardEl = $('.review-card');
  if(cardEl) {
    // Retire toutes les anciennes teintes
    cardEl.classList.remove('tint-facile', 'tint-bien', 'tint-difficile', 'tint-echec');
    // Force le reflow pour relancer l'animation si besoin (astuce)
    void cardEl.offsetWidth;
    // Ajoute la nouvelle teinte
    cardEl.classList.add(`tint-${nxt}`);
    
    // Retire la teinte apr√®s un court d√©lai
    setTimeout(() => {
        cardEl.classList.remove(`tint-${nxt}`);
    }, 400);
  }

  r.history.push({ idx: r.index, cardState: deepClone(card), statsState: deepClone(chap.stats), ansIdx: r.answers.length });
  const ms=M.max(0,now-(r.cardStart||now)), prev=card.grade||'unseen', wZ=!chap.stats.gradeCounts[nxt];
  card.grade=nxt; syncG(chap); card.perfEma=(1-.3)*(card.perfEma??.5)+.3*(nxt==='facile'?1:nxt==='bien'?0.75:nxt==='difficile'?0.35:0);
  schNx(card,nxt,now); card.lastReviewed=now; card.lastMs=ms; card.avgMs=card.avgMs?M.round(card.avgMs*.7+ms*.3):ms; card.timesReviewed++;
  if(isSucc(nxt))card.successes++;else card.failures++; chap.stats.totalReviews++; const k=todayKey();
  chap.stats.dailyReviews[k]=(chap.stats.dailyReviews[k]||0)+1; chap.stats.dailyDurMs[k]=(chap.stats.dailyDurMs[k]||0)+ms; chap.stats.dailyDurCount[k]=(chap.stats.dailyDurCount[k]||0)+1;
  const dc=chap.stats.dailyChanges[k]||{changed:0,total:0}; dc.total++; if(prev!==nxt)dc.changed++; chap.stats.dailyChanges[k]=dc;
  (chap.stats.dailyLog[k]=chap.stats.dailyLog[k]||[]).push({cardId:card.id,prev,next:nxt,ms,ts:now}); if(wZ&&nxt!=='unseen')chap.filters.grades[nxt]=!0;
  r.answers.push({cardId:card.id,prev,next:nxt,ms});
  if(r.index<r.queue.length-1){r.index++;r.flipped=!1;r.cardStart=Date.now();debouncedSave();renRev()}else{r.end=Date.now();debouncedSave();goRecap(!1)}
}
function schNx(c,g,now){
  const q={'facile':5,'bien':4,'difficile':2,'echec':1}[g]||0; let ef=c.ef||2.5; ef=ef+(0.1-(5-q)*(0.08+(5-q)*0.02)); if(ef<1.3)ef=1.3; c.ef=ef;
  if(q<3){c.intervalDays=(g==='echec')?0.02:0.5;c.streak=(c.streak<=0?c.streak-1:-1)}else{c.intervalDays=(c.intervalDays<1e-6)?1:(c.intervalDays<1.5?6:M.round(c.intervalDays*ef));c.streak=(c.streak>=0?c.streak+1:1)}
  c.streak=clamp(c.streak,-8,12); c.dueAt=now+c.intervalDays*864e5
}

const getLive=c=>{const o=GRADE_INIT();c.cards.forEach(x=>o[x.grade||'unseen']++);return o}, syncG=c=>c.stats.gradeCounts=getLive(c), getTod=c=>c.stats.dailyReviews[todayKey()]||0, getTodCh=c=>c.stats.dailyChanges[todayKey()]||{changed:0,total:0}, cntAv=c=>c.cards.filter(x=>c.filters.grades[x.grade||'unseen']).length;
const getSucc=c=>{const k=c.stats.gradeCounts,g=k.bien+k.facile,t=g+k.echec+k.difficile;return t?M.round(g/t*100):0}, get7dAvgMs=c=>{const b=new Date();let s=0,cnt=0;for(let i=0;i<7;i++){const d=new Date(b);d.setDate(b.getDate()-i);const k=dateKey(d);s+=(c.stats.dailyDurMs[k]||0);cnt+=(c.stats.dailyDurCount[k]||0)}return cnt?M.round(s/cnt):0}, get7dAvg=c=>{const b=new Date(),arr=[];for(let i=0;i<7;i++){const d=new Date(b);d.setDate(b.getDate()-i);arr.push(c.stats.dailyReviews[dateKey(d)]||0)}return M.round(avg(arr))}, getWk=c=>{const b=new Date();let s=0;for(let i=0;i<7;i++){const d=new Date(b);d.setDate(b.getDate()-i);s+=(c.stats.dailyReviews[dateKey(d)]||0)}return s}, getLastN=(c,n)=>{const a=[],b=new Date();for(let i=n-1;i>=0;i--){const d=new Date(b);d.setDate(b.getDate()-i);a.push(c.stats.dailyReviews[dateKey(d)]||0)}return a}, getLbls=n=>{const a=[],b=new Date();for(let i=n-1;i>=0;i--){const d=new Date(b);d.setDate(b.getDate()-i);a.push(['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'][d.getDay()])}return a}, dayKeyIdx=(n,i)=>{const b=new Date();b.setDate(b.getDate()-((n-1)-i));return dateKey(b)};

function drawBars(cid,v){ const el=D.getElementById(cid); if(!el)return; const ctx=el.getContext('2d'), dpr=W.devicePixelRatio||1, w=el.clientWidth, h=60; el.width=w*dpr; el.height=h*dpr; ctx.scale(dpr,dpr); const max=M.max(1,...v), barW=M.floor((w-36)/7); ctx.fillStyle='#94a3b8'; ctx.fillRect(0,h-14,w,1); let x=0; const bars=[]; v.forEach(n=>{const bh=M.max(3,(n/max)*(h-20));ctx.fillStyle='#6366f1';ctx.fillRect(x,h-14-bh,barW,bh);ctx.fillStyle='#e2e8f0';ctx.fillText(n,x+barW/2-3,h);bars.push({x,w:barW});x+=barW+6}); Bar7Hit[cid]={cssW:w,bars} }
function opDayBar(e,id,cid){ const h=Bar7Hit[id]; if(!h)return; const x=e.clientX-e.target.getBoundingClientRect().left, i=h.bars.findIndex(b=>x>=b.x&&x<=b.x+b.w); if(i>=0)goDaily(cid,dayKeyIdx(7,i)) }
function drawChart(id,k,sel){ const el=D.getElementById(id); if(!el)return; const ctx=el.getContext('2d'), w=180, h=180, cx=90, cy=90, R=84, r=54; ctx.clearRect(0,0,w,h); const segs=[{k:'unseen',c:'#9ca3af'},{k:'echec',c:'#ef4444'},{k:'difficile',c:'#f59e0b'},{k:'bien',c:'#3b82f6'},{k:'facile',c:'#22c55e'}], tot=segs.reduce((s,x)=>s+(k[x.k]||0),0), arcs=[]; if(!tot){ctx.beginPath();ctx.arc(cx,cy,R,0,6.28);ctx.lineWidth=30;ctx.strokeStyle='#cbd5e1';ctx.stroke();ChartHit[id]={cx,cy,innerR:r,outerR:R,arcs:[]};return} let start=-1.57; segs.forEach(s=>{const v=k[s.k];if(!v)return;const ang=(v/tot)*6.28,end=start+ang,act=!sel||sel[s.k];ctx.beginPath();ctx.arc(cx,cy,69,start,end);ctx.lineWidth=30;ctx.strokeStyle=s.c;ctx.globalAlpha=act?0.9:0.2;ctx.stroke();ctx.globalAlpha=1;arcs.push({key:s.k,start,end});start=end}); ctx.fillStyle='#0ea5e9'; ctx.font='bold 18px sans-serif'; ctx.textAlign='center'; ctx.fillText(tot,cx,cy+5); ChartHit[id]={cx,cy,innerR:r,outerR:R,arcs} }
function hChartClk(e,id,ch){ const h=ChartHit[id]; if(!h)return; const r=e.target.getBoundingClientRect(), dx=(e.clientX-r.left)*(180/r.width)-h.cx, dy=(e.clientY-r.top)*(180/r.height)-h.cy, d=M.hypot(dx,dy); if(d<h.innerR||d>h.outerR)return; let a=M.atan2(dy,dx); if(a<-1.57)a+=6.28; const hit=h.arcs.find(s=>a>=s.start&&a<=s.end); if(hit)updFilt(ch,hit.key) }

function togFilt(c,k){ 
  const s=c.filters.grades, keys=Object.keys(s), actCnt=keys.reduce((n,x)=>n+(s[x]?1:0),0);
  if(actCnt===keys.length){ keys.forEach(x=>s[x]=(x===k)); }
  else if(actCnt===1&&s[k]){ keys.forEach(x=>s[x]=!0); }
  else { s[k]=!s[k]; if(!s[k]&&actCnt===1) s[k]=!0; }
}
const getPreviewTxt = () => {
    // On cherche dans les chapitres de Physique
    const phy = data.subjects.find(s => s.title.toLowerCase().includes('physique')) || data.subjects[0];
    const allCards = phy.chapters.flatMap(ch => ch.cards).filter(c => !c.front.includes('<img') && !c.back.includes('<img'));
    if (!allCards.length) return { f: "La constante de Planck", b: "h = 6,626 x 10‚Åª¬≥‚Å¥ J.s" };
    const r = allCards[M.floor(M.random() * allCards.length)];
    return { f: r.front.replace(/<br>/g, ' '), b: r.back.replace(/<br>/g, ' ') };
};
function openSet(cid,push=true){
  safeCloseLB(); Media.revokeAll(); if(!cid)cid=State.chapterId; const c=getCh(cid); if(!c)return; if(push)Nav.push(); State.view='settings'; setTop({title:'Param√®tres'}); setBot({actions:!1}); hideRevAct(); const v=$('#view'), P=data.app.prefs;
  const isDark = data.app.theme==='dark';
  const hasDeadline = !!c.deadline;
  const prev = getPreviewTxt();
  
  v.innerHTML=`<div class="settings-page scroll-y" style="flex:1">
    <div class="settings-hero">Param√®tres</div>

    <div class="settings-section">
      <div class="section-title">Chapitre</div>
      <div class="settings-row" id="rowTitle"><div class="s-icon dynamic">‚úèÔ∏è</div><div class="s-label"><div class="s-title">Nom du chapitre</div><div class="s-sub">${c.title}</div></div><div class="s-chevron">‚Ä∫</div></div>
      <div class="settings-row" id="rowEmoji"><div class="s-icon dynamic">üòä</div><div class="s-label"><div class="s-title">Emoji</div></div><div class="s-value">${c.emoji || getEmoji(c.title) || 'Aucun'}</div><div class="s-chevron">‚Ä∫</div></div>
      <div class="settings-row" id="rowLang"><div class="s-icon dynamic">üîÑ</div><div class="s-label"><div class="s-title">Ordre des langues</div><div class="s-sub">${c.settings.langSwap?'Verso ‚Üí Recto':'Recto ‚Üí Verso'}</div></div><div class="s-chevron">‚Ä∫</div></div>
    </div>

    <div class="settings-section">
      <div class="section-title">Apparence</div>
      <div class="settings-row" id="rowTheme"><div class="s-icon dynamic">üåì</div><div class="s-label"><div class="s-title">Mode sombre</div></div><div class="s-toggle ${isDark?'on':''}"></div></div>
      <div class="settings-row" id="rowFocus"><div class="s-icon dynamic">üéØ</div><div class="s-label"><div class="s-title">Mode Immersion (Zen)</div>
<div class="s-sub">Interface invisible en r√©vision</div><div class="s-sub">Masque l'interface en r√©vision</div></div><div class="s-toggle ${P.focusMode?'on':''}"></div></div>
      <div class="settings-row" style="cursor:default">
        <div class="s-icon dynamic">üé®</div>
        <div class="s-label"><div class="s-title">Couleur</div></div>
        <div class="swatches">${['indigo','blue','teal','emerald','rose','amber','violet'].map(x=>`<button class="swatch ${P.accent===x?'is-active':''}" data-accent="${x}" style="--sw:var(--${x==='indigo'?'primary':x})"></button>`).join('')}</div>
      </div>
    </div>

    <div class="settings-section">
      <div class="section-title">Typographie (Aper√ßu direct)</div>
      <div class="preview-box">
        <div class="preview-recto" id="preT"></div>
        <div class="preview-verso" id="preD"></div>
      </div>
      
      <!-- TAILLE RECTO -->
      <div class="settings-row" style="cursor:default; border-bottom:none;">
        <div class="s-icon dynamic">Aa</div>
        <div class="s-label"><div class="s-title">Taille Recto</div></div>
        <div class="s-value" id="valT">${P.fsTerm}px</div>
      </div>
      <div class="s-control">
         <button class="step-btn" id="subT">-</button>
         <div class="s-slider-container" style="margin:0 10px; flex:1">
            <input type="range" class="s-slider" id="sldT" min="12" max="60" value="${P.fsTerm}">
         </div>
         <button class="step-btn" id="addT">+</button>
      </div>

      <!-- TAILLE VERSO -->
      <div class="settings-row" style="cursor:default; border-bottom:none;">
        <div class="s-icon dynamic">Aa</div>
        <div class="s-label"><div class="s-title">Taille Verso</div></div>
        <div class="s-value" id="valD">${P.fsDef}px</div>
      </div>
      <div class="s-control">
         <button class="step-btn" id="subD">-</button>
         <div class="s-slider-container" style="margin:0 10px; flex:1">
            <input type="range" class="s-slider" id="sldD" min="14" max="72" value="${P.fsDef}">
         </div>
         <button class="step-btn" id="addD">+</button>
      </div>
    </div>

    <!-- SESSION (Slider + Boutons 1 par 1) -->
    <div class="settings-section">
      <div class="section-title">Session</div>
      <div class="settings-row" style="cursor:default; border-bottom:none;">
        <div class="s-icon dynamic">üìö</div>
        <div class="s-label"><div class="s-title">Taille session</div><div class="s-sub">Nombre de cartes par r√©vision</div></div>
        <div class="s-value" id="valS">${c.settings.sessionSize}</div>
      </div>
      <div class="s-control">
         <button class="step-btn" id="subS">-</button>
         <div class="s-slider-container" style="margin:0 10px; flex:1">
            <input type="range" class="s-slider" id="sldS" min="1" max="200" value="${c.settings.sessionSize}">
         </div>
         <button class="step-btn" id="addS">+</button>
      </div>
    </div>

    <div class="settings-section">
      <div class="section-title">Donn√©es</div>
      <div class="settings-row" id="rowExp"><div class="s-icon dynamic">üì§</div><div class="s-label"><div class="s-title">Exporter</div><div class="s-sub">Sauvegarder toutes les donn√©es</div></div><div class="s-chevron">‚Ä∫</div></div>
      <div class="settings-row" id="rowImp"><div class="s-icon dynamic">üì•</div><div class="s-label"><div class="s-title">Importer</div><div class="s-sub">Restaurer une sauvegarde</div></div><div class="s-chevron">‚Ä∫</div></div>
      <input type="file" id="impF" class="hidden">
    </div>

    <div class="settings-section">
      <div class="section-title">Zone dangereuse</div>
      <div class="settings-row" id="rowRstC"><div class="s-icon dynamic">üîÑ</div><div class="s-label"><div class="s-title">R√©initialiser ce chapitre</div><div class="s-sub">Remettre toutes les cartes √† "Non vu"</div></div></div>
      <div class="settings-row" id="rowRstA"><div class="s-icon danger">üí•</div><div class="s-label"><div class="s-title">R√©initialiser l'application</div><div class="s-sub">Supprimer toutes les donn√©es</div></div></div>
    </div>

    <div class="settings-footer">
      Flashcards v${APP_VER}<br>
      <span style="opacity: 0.7; font-size: 0.9em;">JB. C</span>
    </div>
  </div>`;

  // --- 1. Rendu LaTeX ---
  const preBox = v.querySelector('.preview-box');
  $('#preT').innerHTML = ppLat(prev.f);
  $('#preD').innerHTML = ppLat(prev.b);
  Media.resolve(preBox);
  tsLat(preBox);

  // --- 2. Helper G√©n√©rique pour Slider + Boutons ---
  // Permet de g√©rer la typo ET la session avec la m√™me logique
  const setupControl = (sldId, subId, addId, valId, obj, prop, suffix = '', cssVar = null, fontPrev = null) => {
      const sld = $(sldId), sub = $(subId), add = $(addId), val = $(valId), pre = fontPrev ? $(fontPrev) : null;
      
      const update = (v) => {
          v = parseInt(v);
          const min = parseInt(sld.min), max = parseInt(sld.max);
          if(v < min) v = min; 
          if(v > max) v = max;
          
          obj[prop] = v;
          sld.value = v;
          val.textContent = v + suffix;
          
          if(cssVar) D.documentElement.style.setProperty(cssVar, v + 'px');
          if(pre) pre.style.fontSize = v + 'px';
      };

      sld.oninput = () => update(sld.value);
      sld.onchange = () => { debouncedSave(); haptic('light'); };

      sub.onclick = (e) => { e.stopPropagation(); update(parseInt(sld.value) - 1); debouncedSave(); haptic('light'); };
      add.onclick = (e) => { e.stopPropagation(); update(parseInt(sld.value) + 1); debouncedSave(); haptic('light'); };
  };

  // --- 3. Initialisation des contr√¥les ---
  
  // Font Recto
  setupControl('#sldT', '#subT', '#addT', '#valT', P, 'fsTerm', 'px', '--fs-term', '#preT');
  // Font Verso
  setupControl('#sldD', '#subD', '#addD', '#valD', P, 'fsDef', 'px', '--fs-def', '#preD');
  // Session Size
  setupControl('#sldS', '#subS', '#addS', '#valS', c.settings, 'sessionSize', '');

  // --- 4. Bindings Classiques ---
  
  $('#rowTitle').onclick=()=>{
    const t=prompt('Nouveau titre:', c.title);
    if(t && t.trim()){
      const newTitle = t.trim();
      if(c.virtual && c._groupId){
        const g = findGrp(getSub(), c._groupId);
        if(g) g.title = newTitle;
        c.title = newTitle;
      } else {
        const real = _real(c.id);
        if(real) real.title = newTitle;
        c.title = newTitle;
      }
      updChDesc(c);
      debouncedSave();
      openSet(cid, !1);
    }
  };

  $('#rowEmoji').onclick=()=>{
    const emojiActuel = c.emoji || getEmoji(c.title) || '';
    const e = prompt('Emoji (laissez vide pour l\'√©moji par d√©faut) :', emojiActuel);
    if (e !== null) {
      const newEmoji = e.trim();
      if (c.virtual && c._groupId) {
        const g = findGrp(getSub(), c._groupId);
        if (g) g.emoji = newEmoji;
        c.emoji = newEmoji;
      } else {
        const real = _real(c.id);
        if (real) real.emoji = newEmoji;
        c.emoji = newEmoji;
      }
      updChDesc(c);
      debouncedSave();
      openSet(cid, !1);
    }
  };

  $('#rowLang').onclick=()=>{c.settings.langSwap=!c.settings.langSwap;debouncedSave();openSet(cid,!1)};
  $('#rowTheme').onclick=()=>{data.app.theme=isDark?'light':'dark';debouncedSave();applyTh();openSet(cid,!1)};
  $('#rowFocus').onclick=()=>{P.focusMode=!P.focusMode;debouncedSave();openSet(cid,!1)};
  
  $$('.swatch').forEach(b=>b.onclick=e=>{
    e.stopPropagation();
    P.accent=b.dataset.accent;
    debouncedSave();
    applyUI();
    $$('.swatch').forEach(x=>x.classList.toggle('is-active',x===b));
    $$('.s-icon.dynamic').forEach(icon => { icon.style.background = `var(--primary)`; });
    haptic('light');
  });
  
  $('#rowExp').onclick=()=>{const a=D.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(data)],{type:'application/json'}));a.download=`flashcards-${dateKey(new Date())}.json`;a.click()};
  $('#rowImp').onclick=()=>$('#impF').click();
  $('#impF').onchange=async e=>{if(confirm("√âcraser toutes les donn√©es ?")){data=JSON.parse(await e.target.files[0].text());upgrade();applyTh();applyUI();saveData();goDeck(!1)}};
  
  $('#rowRstC').onclick=()=>{if(confirm('R√©initialiser ce chapitre ?')){c.cards.forEach(x=>{x.grade='unseen';x.timesReviewed=0;x.ef=2.5;x.intervalDays=0;x.dueAt=0;x.streak=0});c.stats={gradeCounts:GRADE_INIT(),totalReviews:0,dailyReviews:{},dailyChanges:{},dailyDurMs:{},dailyDurCount:{},dailyLog:{}};saveData();openSet(cid,!1)}};
  $('#rowRstA').onclick=async()=>{if(confirm('‚ö†Ô∏è Supprimer TOUTES les donn√©es ?')){await Media.clearAll();LS.removeItem(KEY);location.reload()}};
}

// Fonction g√©n√©rique pour les steppers
function setupStepper(subBtn, addBtn, valDisplay, obj, prop, min, max, step) {
    $(subBtn).onclick = (e) => { e.stopPropagation(); let v = obj[prop]; v -= step; if(v < min) v = min; obj[prop] = v; $(valDisplay).textContent = v; debouncedSave(); haptic('light'); };
    $(addBtn).onclick = (e) => { e.stopPropagation(); let v = obj[prop]; v += step; if(v > max) v = max; obj[prop] = v; $(valDisplay).textContent = v; debouncedSave(); haptic('light'); };
}

function bindW(el,{get,set,min,max,step=1}){ const val=el.querySelector('.wheel-value'), ren=()=>val.textContent=get(), com=()=>{saveData();applyUI()}; ren(); let sy=null, sv=null; const pd=e=>{e.preventDefault();e.stopPropagation()}; el.onpointerdown=e=>{sy=e.clientY;sv=get();el.setPointerCapture?.(e.pointerId);pd(e)}; el.onpointermove=e=>{if(sy==null)return;set(sv+M.round((sy-e.clientY)/6)*step);ren();applyUI();pd(e)}; el.onpointerup=()=>{if(sy!=null)com();sy=null}; el.onwheel=e=>{e.preventDefault();set(get()+(e.deltaY>0?-step:step));ren();com()} }
function initGest(){ const s=$('.review-scroller'); if(s)$$('img',s).forEach(i=>i.onclick=e=>{e.preventDefault();openLB(i,s)}); bindSz() }

function bindSz() {
    const elements = $$('.review-card .term, .review-card .definition');
    const getDist = (t) => Math.hypot(t[0].pageX - t[1].pageX, t[0].pageY - t[1].pageY);
    elements.forEach(el => {
        let startDist = 0; let startVal = 0; const isTerm = el.classList.contains('term');
        el.addEventListener('touchstart', (e) => { if (e.touches.length === 2) { if (e.cancelable) e.preventDefault(); startDist = getDist(e.touches); startVal = isTerm ? data.app.prefs.fsTerm : data.app.prefs.fsDef; } }, { passive: false });
        el.addEventListener('touchmove', (e) => { if (e.touches.length === 2 && startDist > 0) { if (e.cancelable) e.preventDefault(); const dist = getDist(e.touches); const scale = dist / startDist; const newVal = clamp(Math.round(startVal * scale), 12, 90); if (isTerm) { data.app.prefs.fsTerm = newVal; } else { data.app.prefs.fsDef = newVal; } applyUI(); } }, { passive: false });
        el.addEventListener('touchend', (e) => { if (e.touches.length < 2 && startDist > 0) { startDist = 0; saveData(); } });
    });
}

function applyTh(){ D.documentElement.dataset.theme=data.app.theme }
function applyUI(){ const p=data.app.prefs; D.documentElement.style.setProperty('--fs-term',p.fsTerm+'px'); D.documentElement.style.setProperty('--fs-def',p.fsDef+'px'); const pl={indigo:['#6366f1','#5457e6'],blue:['#3b82f6','#2563eb'],teal:['#14b8a6','#0d9488'],emerald:['#10b981','#059669'],rose:['#f43f5e','#e11d48'],amber:['#f59e0b','#d97706'],violet:['#8b5cf6','#7c3aed']}, c=pl[p.accent]||pl.indigo; D.documentElement.style.setProperty('--primary',c[0]); D.documentElement.style.setProperty('--primary-600',c[1]) }
function reconcile(){ const c=buildCanon(), o=data.subjects||[]; data.subjects=c.map(x=>{const old=o.find(z=>z.title===x.title)||{},chs=x.chapters.map(nc=>{const oc=(old.chapters||[]).find(z=>z.title===nc.title);return oc?{...nc,stats:{...oc.stats},cards:nc.cards.map(cd=>{const oldC=oc.cards.find(z=>extractId(z.id)===extractId(cd.id));return oldC?{...cd,grade:oldC.grade,ef:oldC.ef,intervalDays:oldC.intervalDays,dueAt:oldC.dueAt}:cd})}:nc});return{...x,chapters:chs,groups:old.groups||[]}}); o.forEach(x=>{if(!data.subjects.find(z=>z.id===x.id))data.subjects.push(x)}); if(!data.subjects.find(x=>x.id===data.app.currentSubjectId))data.app.currentSubjectId=data.subjects[0].id }
function upgrade(){ if(!data.app)data.app={theme:'dark'}; data.app.prefs={fsTerm:22,fsDef:24,accent:'indigo',radius:14,...(data.app.prefs||{})}; data.subjects.forEach(s=>{valGrps(s);s.emoji=s.emoji||'';s.chapters.forEach(c=>{c.emoji=c.emoji||'';updChDesc(c);c.stats.dailyLog=c.stats.dailyLog||{};syncG(c)})}) }
function init(){ 
  Media.open(); 
  setInterval(saveData, 30000); // Backup toutes les 30s
  data=loadData(); 
  if(data.app?.version!==APP_VER){reconcile();data.app.version=APP_VER;saveData()} 
  pruneStats(); upgrade(); applyTh(); applyUI(); Nav.clear(); goDeck(!1) 
}

init();
</script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</body>
</html>
