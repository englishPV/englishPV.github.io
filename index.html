<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Flashcards 9:16</title>
  <style>
    :root{
      --bg:#0b1020;
      --surface:#12172b;
      --card:#161c33;
      --text:#e6ecff;
      --muted:#8aa0d3;
      --primary:#6366f1;
      --primary-600:#5457e6;
      --green:#22c55e;
      --blue:#3b82f6;
      --amber:#f59e0b;
      --red:#ef4444;
      --ring:#e5e7eb;
      --border:#232a48;

      --fs-term:20px;
      --fs-def:24px;
      --fs-front-list:16px;
      --fs-back-list:18px;
      --radius-md:14px;

      /* Tokens Boutons Dark (par d√©faut) */
      --btn-neutral-bg: rgba(255,255,255,.06);
      --btn-neutral-fg: #e6ecff;
      --btn-neutral-bd: #232a48;
      --btn-neutral-bg-h: rgba(255,255,255,.10);

      --btn-soft-primary-bg: color-mix(in srgb, var(--primary) 22%, transparent);
      --btn-soft-primary-bg-h: color-mix(in srgb, var(--primary) 34%, transparent);
      --btn-soft-primary-fg: #dbe4ff;
      --btn-soft-primary-bd: color-mix(in srgb, var(--primary) 55%, transparent);

      --btn-soft-red-bg: rgba(239,68,68,.18);
      --btn-soft-red-bg-h: rgba(239,68,68,.28);
      --btn-soft-red-fg: #fecaca;
      --btn-soft-red-bd: rgba(239,68,68,.45);

      --btn-soft-amber-bg: rgba(245,158,11,.18);
      --btn-soft-amber-bg-h: rgba(245,158,11,.28);
      --btn-soft-amber-fg: #fde68a;
      --btn-soft-amber-bd: rgba(245,158,11,.45);

      --btn-soft-blue-bg: rgba(59,130,246,.18);
      --btn-soft-blue-bg-h: rgba(59,130,246,.28);
      --btn-soft-blue-fg: #bfdbfe;
      --btn-soft-blue-bd: rgba(59,130,246,.45);

      --btn-soft-green-bg: rgba(34,197,94,.18);
      --btn-soft-green-bg-h: rgba(34,197,94,.28);
      --btn-soft-green-fg: #bbf7d0;
      --btn-soft-green-bd: rgba(34,197,94,.45);

      --btn-solid-primary-bg: var(--primary);
      --btn-solid-primary-bg-h: var(--primary-600);
      --btn-solid-primary-fg: #fff;
      --btn-solid-primary-bd: var(--primary-600);

      --btn-solid-red-bg:#ef4444;  --btn-solid-red-bg-h:#dc2626;  --btn-solid-red-fg:#fff;  --btn-solid-red-bd:#dc2626;
      --btn-solid-amber-bg:#f59e0b;--btn-solid-amber-bg-h:#d97706;--btn-solid-amber-fg:#0f172a;--btn-solid-amber-bd:#d97706;
      --btn-solid-blue-bg:#3b82f6; --btn-solid-blue-bg-h:#2563eb; --btn-solid-blue-fg:#fff;  --btn-solid-blue-bd:#2563eb;
      --btn-solid-green-bg:#22c55e;--btn-solid-green-bg-h:#16a34a;--btn-solid-green-fg:#0f172a;--btn-solid-green-bd:#16a34a;
    }

    :root[data-theme="light"]{
      --bg:linear-gradient(180deg,#f8fafc 0%,#eef2f7 100%);
      --surface:#ffffff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --primary:#3b82f6;
      --primary-600:#2563eb;
      --border:#cbd5e1;

      /* Tokens Boutons Light */
      --btn-neutral-bg:#f1f5f9;
      --btn-neutral-fg:#0f172a;
      --btn-neutral-bd:#cbd5e1;
      --btn-neutral-bg-h:#e2e8f0;

      --btn-soft-primary-bg: color-mix(in srgb, var(--primary) 14%, white 86%);
      --btn-soft-primary-bg-h: color-mix(in srgb, var(--primary) 22%, white 78%);
      --btn-soft-primary-fg: color-mix(in srgb, var(--primary) 78%, black 22%);
      --btn-soft-primary-bd: color-mix(in srgb, var(--primary) 35%, white 65%);

      --btn-soft-red-bg:#fee2e2;   --btn-soft-red-bg-h:#fecaca;   --btn-soft-red-fg:#991b1b;   --btn-soft-red-bd:#fca5a5;
      --btn-soft-amber-bg:#fef3c7; --btn-soft-amber-bg-h:#fde68a; --btn-soft-amber-fg:#92400e; --btn-soft-amber-bd:#fcd34d;
      --btn-soft-blue-bg:#dbeafe;  --btn-soft-blue-bg-h:#bfdbfe;  --btn-soft-blue-fg:#1e3a8a;  --btn-soft-blue-bd:#93c5fd;
      --btn-soft-green-bg:#dcfce7; --btn-soft-green-bg-h:#bbf7d0; --btn-soft-green-fg:#14532d; --btn-soft-green-bd:#86efac;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
      font-size:17px;
    }

    .wrapper{
      height:100dvh; width:100%;
      display:flex; align-items:center; justify-content:center;
      padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .phone{
      aspect-ratio:9/16;
      height:100%; width:auto; max-width:100%; max-height:100%;
      display:grid;
      grid-template-rows: var(--row-top,52px) var(--row-main,1fr) var(--row-actions,52px) var(--row-rev,64px);
      position:relative; min-height:0; touch-action:pan-y; overflow:hidden; background:transparent; border:0; border-radius:0; box-shadow:none;
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; padding:0 10px;
      background:transparent; border-bottom:0;
    }

    .topbar .back{
      appearance:none; border:0; outline:0; background:transparent; color:var(--text);
      padding:8px 10px; margin-right:4px; border-radius:10px;
      display:flex; align-items:center; gap:8px; cursor:pointer; font-weight:700;
    }
    .topbar .back:hover{background:rgba(255,255,255,.06)}
    .topbar .title{font-weight:800; font-size:16px; letter-spacing:.2px; margin-left:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer;}
    .topbar .spacer{flex:1}

    main#view{
      min-height:0; height:100%;
      display:flex; flex-direction:column; overflow:hidden;
      padding:8px; gap:10px; justify-content:flex-start;
    }

    /* Utilities */
    .hidden{display:none!important}
    .muted{color:var(--muted)}
    .center{text-align:center}
    .mt6{margin-top:6px}
    .mt8{margin-top:8px}
    .scroll-y{overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; touch-action:pan-y;}
    .list{display:flex; flex-direction:column; gap:8px}
    .stack{display:flex; flex-direction:column; gap:6px}
    .flexcol{display:flex; flex-direction:column; min-height:0}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:6px}
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row-4{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; width:100%}
    .face-label{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.3px}

    /* Cards/containers base (flat) */
    .card,.deck-item,.review-card,.viewer,.card-item,.legend-item,.kpi .k,.stat,.chip{
      background:transparent; border:0; box-shadow:none;
      border-radius:var(--radius-md);
    }

    .section-title{font-weight:900; font-size:14px; color:var(--primary); letter-spacing:.3px; margin:0 0 6px}

    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .kpi .k{padding:0}
    .k .label{color:var(--muted); font-size:12px}
    .k .value{font-weight:900; font-size:17px; margin-top:2px}

    /* Deck list */
    .deck-wrap{display:flex; align-items:center; gap:8px}
    .decks{display:grid; grid-template-columns:1fr; gap:8px; flex:1}
    .deck-item{display:flex; align-items:center; justify-content:space-between; padding:8px 0; cursor:pointer}
    .deck-item:hover{outline:none}
    .deck-meta{color:var(--muted); font-size:13px}

    /* Chips */
    .chip{display:inline-flex; align-items:center; gap:8px; padding:0; border-radius:0; color:var(--muted); cursor:pointer; user-select:none; font-size:12px}
    .chip.toggle{opacity:.75}
    .chip.toggle.active{opacity:1; border-color:#6b7cff; box-shadow:inset 0 0 0 1px rgba(107,124,255,.35)}
    .chip-pie{width:18px; height:18px; border-radius:50%;
      background:conic-gradient(var(--primary) var(--progress,0%), var(--border) var(--progress,0%)); display:inline-block; vertical-align:middle}
    .legend{display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:6px}
    .legend-item{display:flex; align-items:center; gap:6px; padding:0; font-size:13px; color:#dbe4ff; cursor:pointer; user-select:none; transition:opacity .15s ease, filter .15s ease}
    .legend-item.inactive{opacity:.45; filter:grayscale(20%)}
    .legend-item .count{font-weight:900}
    .legend-item[data-key="unseen"] .count{color:#9ca3af}
    .legend-item[data-key="echec"] .count{color:var(--red)}
    .legend-item[data-key="difficile"] .count{color:var(--amber)}
    .legend-item[data-key="bien"] .count{color:var(--blue)}
    .legend-item[data-key="facile"] .count{color:var(--green)}

    /* Dots */
    .dot{width:10px; height:10px; border-radius:50%}
    .dot.gray{background:#9ca3af}
    .dot.red{background:var(--red)}
    .dot.amber{background:var(--amber)}
    .dot.blue{background:var(--blue)}
    .dot.green{background:var(--green)}

    /* Chart */
    .chart-wrap{display:flex; align-items:center; justify-content:center; height:200px}
    canvas#gradeChart{width:180px; height:180px}

    /* Bottom bars */
    .bottom-actions{display:none; padding:8px 10px; gap:8px; grid-template-columns:1fr 1fr; background:transparent; border-top:0; box-shadow:none}
    .revision-bar{padding:8px 10px calc(8px + env(safe-area-inset-bottom)); background:transparent; border-top:0; box-shadow:none; display:none}
    .review-actions-bar{display:none; grid-row:4; padding:8px 10px calc(8px + env(safe-area-inset-bottom)); backdrop-filter:blur(8px) saturate(140%);}

    /* Review view */
    .review-wrap{position:relative; flex:1; min-height:0; display:flex; flex-direction:column; padding-bottom:0}
    .review-top{display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:13px}
    .review-card{flex:1; display:flex; align-items:center; justify-content:center; padding:8px; text-align:center; cursor:ns-resize}
    .size-toast{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:calc(64px + env(safe-area-inset-bottom) + 8px);
      background:rgba(0,0,0,.55); color:#fff; font-weight:800; font-size:12px; padding:6px 10px; border-radius:999px;
      pointer-events:none; z-index:3; display:none;
    }
    :root[data-theme="light"] .size-toast{background:rgba(0,0,0,.15); color:#0f172a}

    /* Cards view */
    .cards-wrap{display:flex; flex-direction:column; gap:8px; height:100%}
    .cards-top{display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px}
    .viewer{flex:1; display:flex; align-items:center; justify-content:center; padding:12px; text-align:center}
    .viewer .front{font-weight:900; font-size:20px}
    .viewer .back{color:#d9e6ff; opacity:.95; font-size:15px; margin-top:6px}
    .viewer-actions{display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px}
    .small{font-size:13px; color:var(--muted)}

    /* Recap */
    .recap{display:flex; flex-direction:column; gap:8px}
    .recap h2{margin:0; font-size:18px}
    .recap .subtitle{color:var(--muted); margin-top:-2px; font-size:12px}
    .stat{padding:0}
    .label{color:var(--muted); font-size:11px}
    .val{font-weight:900; font-size:16px; margin-top:2px}
    .cta{margin-top:4px}

    /* Typo sizes */
    .term{font-size:var(--fs-term)!important; font-weight:600}
    .definition{font-size:var(--fs-def)!important; font-weight:900}
    .card-item .front{font-size:var(--fs-front-list); font-weight:600}
    .card-item .back{font-size:var(--fs-back-list); font-weight:800; color:var(--text); opacity:.95}

    /* Wheel control */
    .wheel{
      display:flex; align-items:center; gap:12px; padding:10px 12px;
      border:1px solid var(--border); border-radius:var(--radius-md);
      background:rgba(255,255,255,.04); touch-action:none; user-select:none; cursor:ns-resize;
    }
    .wheel .name{font-weight:800; font-size:13px}
    .wheel .hint{color:var(--muted); font-size:12px}
    .wheel .wheel-value{margin-left:auto; font-weight:900; font-size:13px}

    /* Settings */
    .settings-page{display:flex; flex-direction:column; gap:14px; padding:6px 4px}
    .settings-hero{font-weight:900; font-size:18px; letter-spacing:.2px; color:var(--primary)}
    .settings-sub{color:var(--muted); font-size:12px; margin-top:-2px}
    .settings-section{display:flex; flex-direction:column; gap:8px}
    .settings-section .section-title{font-size:12px; font-weight:900; color:var(--primary); letter-spacing:.4px; text-transform:uppercase; margin:10px 0 2px!important}
    .swatches{display:flex; gap:8px; flex-wrap:wrap}
    .swatch{width:26px; height:26px; border-radius:8px; border:1px solid var(--border); background:var(--sw,#6366f1); cursor:pointer; position:relative}
    .swatch.is-active::after{content:''; position:absolute; inset:-3px; border:2px solid var(--primary); border-radius:10px}

    /* 7-day activity */
    .bar7-wrap{margin-top:8px}
    canvas#bar7{width:100%; height:68px; display:block}
    .bar7-labels{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:4px; font-size:12px; color:var(--muted); text-align:center}
    .bar7-labels > div { cursor: pointer; }

    /* Cards grid */
    .cards-grid{display:grid; grid-template-columns:1fr; gap:10px}
    @media(min-width:480px){.cards-grid{grid-template-columns:1fr 1fr}}
    @media(min-width:900px){.cards-grid{grid-template-columns:1fr 1fr 1fr}}
    .card-block{position:relative; border:2px solid transparent; border-radius:14px; padding:14px; background:transparent}
    .card-block .term{text-align:center}
    .card-block .definition{display:none; text-align:center; margin-top:6px}
    .card-block.flipped .definition{display:block}
    .cb-time{position:absolute; right:10px; bottom:8px; font-size:12px; color:var(--muted)}
    .card-block.grade-echec{border-color:var(--red)}
    .card-block.grade-difficile{border-color:var(--amber)}
    .card-block.grade-bien{border-color:var(--blue)}
    .card-block.grade-facile{border-color:var(--green)}
    .card-block.grade-unseen{border-color:#9ca3af}


    /* Light theme boosts */
    :root[data-theme="light"] .definition,
    :root[data-theme="light"] .card-item .back{color:var(--text)!important; opacity:1!important}
    :root[data-theme="light"] .muted{color:#475569!important}
    :root[data-theme="light"] .legend-item{color:#0f172a!important; border-color:#e2e8f0!important; background:transparent!important}
    :root[data-theme="light"] .chip{color:#334155!important; border-color:#cbd5e1!important; background:#f8fafc!important}
    :root[data-theme="light"] .revision-bar{
      background:linear-gradient(180deg,rgba(248,250,252,0),rgba(241,245,249,.9))!important;
      border-top:1px solid #e2e8f0!important;
    }
    :root[data-theme="light"] .topbar{
      background:transparent!important;
      border-bottom:1px solid #e2e8f0!important;
    }

    /* === SYST√àME DE BOUTONS AVEC VARIANTES (SOFT/SOLID) === */
    .btn,
    .bottom-actions .action,
    .navbtn,
    .review-actions-bar .btn,
    .rev-btn{
      background: var(--btn-bg, var(--btn-neutral-bg));
      color: var(--btn-fg, var(--btn-neutral-fg));
      border: 1px solid var(--btn-bd, var(--btn-neutral-bd));
      border-radius: var(--radius-md);
      padding: 10px 12px;
      font-weight: 900;
      cursor: pointer;
      transition: background .15s ease, border-color .15s ease, color .15s ease, box-shadow .15s ease;
      width: 100%;
      appearance: none;
      outline: 0;
      font-size: 15px;
    }
    .btn:hover,
    .bottom-actions .action:hover,
    .navbtn:hover,
    .review-actions-bar .btn:hover,
    .rev-btn:hover{
      background: var(--btn-bg-h, var(--btn-bg, var(--btn-neutral-bg-h)));
    }
    .btn:disabled, .rev-btn:disabled, .navbtn:disabled, .action:disabled {opacity:.6; cursor:not-allowed}
    .btn:focus-visible{outline:2px solid var(--btn-bd, var(--btn-neutral-bd)); outline-offset:2px}

    /* Variantes SOFT (pastel) */
    .btn--primary{ --btn-bg:var(--btn-soft-primary-bg); --btn-bg-h:var(--btn-soft-primary-bg-h); --btn-fg:var(--btn-soft-primary-fg); --btn-bd:var(--btn-soft-primary-bd); }
    .btn--red    { --btn-bg:var(--btn-soft-red-bg);     --btn-bg-h:var(--btn-soft-red-bg-h);     --btn-fg:var(--btn-soft-red-fg);     --btn-bd:var(--btn-soft-red-bd); }
    .btn--amber  { --btn-bg:var(--btn-soft-amber-bg);   --btn-bg-h:var(--btn-soft-amber-bg-h);   --btn-fg:var(--btn-soft-amber-fg);   --btn-bd:var(--btn-soft-amber-bd); }
    .btn--blue   { --btn-bg:var(--btn-soft-blue-bg);    --btn-bg-h:var(--btn-soft-blue-bg-h);    --btn-fg:var(--btn-soft-blue-fg);    --btn-bd:var(--btn-soft-blue-bd); }
    .btn--green  { --btn-bg:var(--btn-soft-green-bg);   --btn-bg-h:var(--btn-soft-green-bg-h);   --btn-fg:var(--btn-soft-green-fg);   --btn-bd:var(--btn-soft-green-bd); }

    /* Ton SOLID (plein) ‚Äì combine avec la couleur */
    .btn--solid.btn--primary{ --btn-bg:var(--btn-solid-primary-bg); --btn-bg-h:var(--btn-solid-primary-bg-h); --btn-fg:var(--btn-solid-primary-fg); --btn-bd:var(--btn-solid-primary-bd); }
    .btn--solid.btn--red    { --btn-bg:var(--btn-solid-red-bg);     --btn-bg-h:var(--btn-solid-red-bg-h);     --btn-fg:var(--btn-solid-red-fg);     --btn-bd:var(--btn-solid-red-bd); }
    .btn--solid.btn--amber  { --btn-bg:var(--btn-solid-amber-bg);   --btn-bg-h:var(--btn-solid-amber-bg-h);   --btn-fg:var(--btn-solid-amber-fg);   --btn-bd:var(--btn-solid-amber-bd); }
    .btn--solid.btn--blue   { --btn-bg:var(--btn-solid-blue-bg);    --btn-bg-h:var(--btn-solid-blue-bg-h);    --btn-fg:var(--btn-solid-blue-fg);    --btn-bd:var(--btn-solid-blue-bd); }
    .btn--solid.btn--green  { --btn-bg:var(--btn-solid-green-bg);   --btn-bg-h:var(--btn-solid-green-bg-h);   --btn-fg:var(--btn-solid-green-fg);   --btn-bd:var(--btn-solid-green-bd); }

    /* Desktop wide */
    @media (pointer:fine) and (min-width:1024px){
      .phone{aspect-ratio:auto; width:100%; height:100dvh}
      .topbar, main#view, .bottom-actions, .revision-bar{max-width:1200px; margin:0 auto; width:100%}
      main#view{padding:16px 20px}
    }

    /* Subject menu (s√©lecteur de mati√®re) */
    .subject-menu{
      position: absolute;
      top: 52px;
      left: 10px;
      background: var(--surface);
      color: var(--text);
      border:1px solid var(--border);
      border-radius: var(--radius-md);
      min-width: 220px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      padding: 6px;
      z-index: 1000;
      display:none;
    }
    .subject-item{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:10px; cursor:pointer;
    }
    .subject-item:hover{ background: rgba(255,255,255,.06) }
    .subject-item .name{ font-weight:800; flex:1 }
    .subject-item .meta{ font-size:12px; color:var(--muted) }
    :root[data-theme="light"] .subject-item:hover{ background: rgba(0,0,0,.06) }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="phone" id="app">
      <header class="topbar">
        <button class="back" id="backBtn" title="Retour"><span aria-hidden="true">‚Üê</span><span>Retour</span></button>
        <div class="title" id="title">Deck</div>
        <div class="spacer"></div>
      </header>

      <main id="view"></main>

      <div class="bottom-actions" id="bottomActions">
        <button class="action btn" id="cardsBtn">Cartes</button>
        <button class="action btn" id="settingsBtn">Param√®tres</button>
      </div>

      <footer class="revision-bar" id="revisionBar">
        <button id="startReviewBtn" class="rev-btn btn btn--solid btn--primary">R√©vision ‚Ä¢ 10 cartes</button>
      </footer>

      <footer id="reviewActionsBar" class="review-actions-bar" aria-live="polite"></footer>
    </div>
  </div>

  <script>
    // ---------- Donn√©es & stockage ----------
    const STORAGE_KEY = 'flash9x16_data_v3';

    // Cat√©gories Anglais
    const CD="Democracy",CG="Genetics",CI="Immigration",CIT="International Relations",CU="Labor",CR="Crime",PC="Capital Punishment",CF="Status of Women";
    // Chapitres Physique (constantes pratiques pour le raw)
    const PM = "M2";

    // Emojis chapitres
    const CHAPTER_EMOJIS = {
      [CD]:'üèõÔ∏è',[CG]:'üß¨',[CI]:'üß≥',[CIT]:'üåê',[CU]:'üíº',[CR]:'‚öñÔ∏è',[PC]:'üíÄ',[CF]:'‚ôÄÔ∏è',
      'Politique':'üèõÔ∏è','Business':'üíº','Education':'üéì','Thanksgiving':'ü¶É',
      // === Physique (nouvelles mati√®res/chapitres) ===
      'M2':'‚öôÔ∏è'
    };

    // Liste brute Anglais (id|fr|en|chap)
    const cardsRawText = `
0|monarchie|monarchy|${CD}
1|monarque de droit divin|a monarch by divine right|${CD}
2|souverain|sovereign|${CD}
3|aristocratie|aristocracy|${CD}
4|oligarchie|oligarchy|${CD}
5|dictateur|a dictator|${CD}
6|dictature|dictatorship|${CD}
7|autoritaire|authoritarian|${CD}
8|autoritarisme|authoritarianism|${CD}
9|totalitaire|totalitarian|${CD}
10|totalitarisme|totalitarianism|${CD}
11|homme fort|a strongman|${CD}
12|tyran|a tyrant, an autocrat|${CD}
13|despote|a despot|${CD}
14|despote √©clair√©|an enlightened despot|${CD}
15|junte militaire|a military junta|${CD}
16|coup d'√âtat|a coup, a coup d'√©tat|${CD}
17|gouvernement autoritaire|a regime|${CD}
18|r√©gime de Vichy / de Pinochet|the Vichy / Pinochet regime|${CD}
19|r√©gime r√©pressif|a repressive regime|${CD}
20|r√©gime politique|a political system|${CD}
21|se d√©mocratiser|to become more democratic|${CD}
22|prendre le pouvoir|to take, seize power|${CD}
23|arriver au pouvoir|to come to power|${CD}
24|arriver au pouvoir (d√©mocratiquement)|to come into office|${CD}
25|√™tre au pouvoir|to be in power|${CD}
26|rester au pouvoir|to remain, stay in power|${CD}
27|s'accrocher au pouvoir|to cling to power|${CD}
28|bonne gouvernance|good governance|${CD}
29|mal administrer, mal g√©rer|to misrule, mismanage|${CD}
30|mauvaise administration|misrule|${CD}
31|mauvaise gestion|mismanagement|${CD}
32|tenir un dirigeant pour responsable|to hold a leader to account|${CD}
33|√™tre responsable devant les √©lecteurs|to be accountable to the electorate|${CD}
34|responsabilit√©|accountability|${CD}
35|corruption|corruption, sleaze, bribery|${CD}
36|corrompu|corrupt|${CD}
37|pot-de-vin|a bribe|${CD}
38|acheter, soudoyer qn|to bribe sb|${CD}
39|√©tat de droit, r√®gne de la loi|the rule of law|${CD}
40|multipartisme|multi-party system|${CD}
41|syst√®me de parti unique|single-party system|${CD}
42|√©lections libres et r√©guli√®res|free and fair elections|${CD}
43|fraude √©lectorale|vote rigging, ballot rigging, electoral fraud|${CD}
44|l'√©lection √©tait truqu√©e|the election was rigged|${CD}
45|opposant politique|a political opponent|${CD}
46|dissident|a dissident|${CD}
47|b√¢illonner / museler la presse / l'opposition|to gag / muzzle the press / the opposition|${CD}
48|d√©clarer l'√©tat d'urgence|to declare a state of emergency|${CD}
49|bafouer la constitution|to trample the constitution|${CD}
50|censurer|to censor|${CD}
51|censure|censorship|${CD}
52|bloquer / restreindre l'acc√®s √† internet|to block / restrict internet access|${CD}
...
910|le harc√®lement|harassment|${CF}
911|le harc√®lement sexuel|sexual harassment|${CF}
912|la parit√©|parity|${CF}
913|sous-repr√©sent√©|under-represented|${CF}
914|instaurer des quotas|to introduce quotas|${CF}
915|l‚Äôinstauration de quotas|the introduction of quotas|${CF}
916|la discrimination positive|affirmative action|${CF}
917|l‚Äô√©galit√© des chances|equal opportunity|${CF}
918|√©galitaire|egalitarian|${CF}
919|l‚Äô√©galitarisme|egalitarianism|${CF}
920|atteindre l‚Äô√©galit√© avec les hommes|to achieve equality with men|${CF}
`.trim();

    // Donn√©es Physique (id|fr|en|chapitre)
    // Donn√©es Physique (id|fr|en|chapitre) - Format M2 avec chemins d'images corrig√©s
// Donn√©es Physique (id|fr|en|chapitre) - Format M2 avec chemins d'images corrig√©s
const physicsRawText = `
10000|<span style="color: rgb(255, 170, 0);">(Shems)</span> Qu'est-ce qu'un referentiel galil√©en?|Un r√©f√©rentiel galil√©en est un r√©f√©rentiel dans lequel le principe d'inertie est v√©rifi√©e, √† savoir que tout objet isol√© ou pseudiisol√© est soit immobile soit en mouvement rectiligne uniforme dans ce r√©f√©rentiel .&nbsp;&nbsp;|${PM}
10001|<span style="color: rgb(0, 255, 0);">V.Iulian</span> <br>Tout r√©f√©rentiel <b style="color:yellow;">en translation rectiligne et uniforme par</b> rapport √† un r√©f√©rentiel galil√©en est galil√©en||${PM}
10002|<span style="color: rgb(0, 255, 0);">V.Iulian</span><br>Si la translation de R' par rapport a R galil√©en n‚Äôest pas rectiligne ou pas uniforme, R‚Ä≤<b style="color:yellow;">n‚Äôest pas galil√©en</b>||${PM}
10003|<span style="color: rgb(0, 255, 0);">V.Iulian</span> <br>Un r√©f√©rentiel en rotation autour d‚Äôun axe fixe d‚Äôun r√©f√©rentiel galil√©en <b style="color:yellow;">n‚Äôest jamais galil√©en.</b>||${PM}
10004|<span style="color: rgb(0, 255, 0);"><u><b>(MAG)</b></u></span><img src="images/paste-9cd3560a5f9a5c4100721b04ab4c28ceaaaf93e5.jpg">|<img src="images/paste-5a57528bd9551b29f65139e8d4887065d643d4ac.jpg">|${PM}
10005|<span style="color: rgb(0, 255, 0);"><u><b>(MAG)</b></u></span><img src="images/paste-d77f3722e5a6b97cce4097de2c62d12a8d197b00.jpg">|<img src="images/paste-94c2181742a47574197e38c01becf17fe5e14056.jpg"><br>Avec O' un point fixe de R'|${PM}
10006|<span style="color: rgb(0, 255, 0);"><u><b>(MAG)</b></u></span><img src="images/paste-cb677b12d3a6508a44f3f9b492a67a4a71774fca.jpg">|Cas de R' en translation par rapport √† R: $\\vec{f_{ic}}=\\vec{0}$ donc&nbsp;$P(\\vec{f_{ic}})=0$<br><br>Cas de R' en rotation par rapport √† R: $P(\\vec{f_ic}) = (-2m \\vec{\\Omega}_{R'/R} \\wedge \\vec{v}_{M/R'} ). \\vec{v}_{M/R'}=0$<br><br>TPC:&nbsp;$\\frac{dEc_{/R'}}{dt}=\\sum_i P(\\vec{F_i})/R'+P(\\vec{f_{ie}})/R'$|${PM}
10007|<span style="color: rgb(255, 170, 0);"><u><b>(MAG)</b></u></span>Justifier que fic ne travaille pas et exprimer le TEC dans R' non gal.|$P(\\vec{f_ic}) = 0$<br>En effet lorsque&nbsp;R' est en translation par rapport √† R $\\vec{f_{ic}}=\\vec{0}$ donc&nbsp;$P(\\vec{f_{ic}})=0$<br><br>et lorsque R' en rotation par rapport √† R: $P(\\vec{f_ic}) = (-2m \\vec{\\Omega}_{R'/R} \\wedge \\vec{v}_{M/R'} ). \\vec{v}_{M/R'}=0$<br>csq1:&nbsp;$W(\\vec{f_{ic}})=\\int P(\\vec{f_{ic}}).dt=0$ i.e.&nbsp;$\\vec{f_{ic}}$ ne travaille pas.<br><br>csq2: TEC dans R':&nbsp;$\\Delta Ec_{/R'}=\\sum_i W(\\vec{F_i})/R'+W(\\vec{f_{ie}})/R'$|${PM}
10008|<b><span style="color: rgb(255, 170, 0);">(MAG)</span></b><span style="color: rgb(0, 85, 255);">&nbsp;sur l'expl d'un man√®ge avec si√®ges suspendus √† des cha√Ænes:</span><span style="color: rgb(255, 170, 0);"><u><br></u></span><img src="images/paste-a933d76dcbeef4f62508fa32bd894eade0892cea.jpg"><br><img src="images/paste-162500c424b12166f0f9f7c8345e074e19a42672.jpg">|<img src="images/paste-7d986b294569fcc662beb25c0076c304bcdbb34e.jpg">|${PM}
10009|<span style="color: rgb(255, 170, 0);">(Orlan M) </span>Exprimer la force d'inertie de Coriolis et la force d'inertie d'entrainement dans le cas d'une rotation de R' par rapport √† R|$\\vec{f_ic} = -2m \\vec{\\Omega}_{R'/R} \\wedge \\vec{v}_{M/R'}&nbsp;$<br>et<br>$\\vec{f_ie} = m \\Omega^2 \\overrightarrow{HM}&nbsp;$|${PM}
10010|<span style="color: rgb(0, 255, 0);">(INC)</span> TEM dans R' rep√®re non galil√©en|<br>[latex] Si $\\vec{f_{ie}} $ est conservative, $\\vec{f_{ie}}$ d√©rive d'une √©nergie potentielle $E_{p,f_{ie}}$ qui est contenue dans $E_m$ et qui est tq: $W(\\vec{f_{ie}})=-\\Delta E_{p,f_{ie}}$ \\newline<br><br>Alors TEM: $\\Delta Em_{/R'}=\\sum_i W(\\vec{F}_{iNC/R'}) $ \\newline<br><br>Si $\\vec{f}_{ie}$ est non conservative \\newline<br>TEM: $\\Delta Em_{/R'}=\\sum_i W(\\vec{F}_{iNC/R'})+W(\\vec{f_{ie/R'}}) $[/latex]<br>|${PM}
10011|<span style="color: rgb(255, 170, 0);">(Orlan M) </span>En partant du PFD √©crit dans un r√©f√©rentiel galil√©en R, √©tablir l'expression du PFD dans un r√©frentiel R' non galileen.|On part de la loi de composition des vitesses $m \\vec{a}_{M/R} = m \\vec{a}_{M/R'} + \\vec{a_c} + \\vec{a_e}&nbsp;&nbsp;$<br>de plus $m \\vec{a}_{M/R} = \\sum_i \\vec{F_i} $<br>En r√©arrangant les termes on a $m \\vec{a}_{M/R'} = \\sum_i \\vec{F_i} -m \\vec{a_c} - m \\vec{a_e} $<br>avec $ - m \\vec{a_e} $ qui est la force d'inertie d'entrainement et $&nbsp;- m \\vec{a_c} $ qui est la force d'inertie de coriolis|${PM}
10012|<span style="color: rgb(255, 170, 0);">(Orlan M)</span> Exprimer $ \\vec{f_{ic}} $ et $ \\vec{f_{ie}} $ dans le cas d'une translation de R' par rapport √† R|&nbsp;$ \\vec{f_{ic}} = \\vec{0} $ et&nbsp;&nbsp;$ \\vec{a_c} = \\vec{0} $ dans ce cas<br>et<br>$ \\vec{f_{ie}} = -m(\\frac{d^2 \\vec{OO'}}{dt^2})_R $|${PM}
`.trim();

    // Parsing g√©n√©rique multi-mati√®res
    function parseCardsRaw(raw){
      return raw.split(/\r?\n/).map(l=>{
        const p=l.split('|'); if(p.length!==4) return null;
        const [id,f,e,c]=p;
        return {id:id.trim(),front:f.trim(),back:e.trim(),chapter:c.trim()};
      }).filter(Boolean);
    }
    const flashcardDataEN  = parseCardsRaw(cardsRawText);
    const flashcardDataPHY = parseCardsRaw(physicsRawText);

    // ---------- Utils ----------
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const ChartHit = {}; // hitmap donut
    const Bar7Hit = {}; // { [canvasId]: { cssW, cssH, bars: [{x,w}] } }

    const dateKey = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const todayKey = ()=>dateKey(new Date());
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const formatDuration = (ms)=>{const sec=Math.round(ms/1000); const m=Math.floor(sec/60); const s=sec%60; return `${m}:${String(s).padStart(2,'0')}`;};
    const avg = a=>!a?.length?0:a.reduce((x,y)=>x+y,0)/a.length;
    const deepClone = o=>JSON.parse(JSON.stringify(o));
    const pickN = (arr,n)=>{const c=arr.slice(); for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [c[i],c[j]]=[c[j],c[i]];} return c.slice(0,n);};
    const isSuccess = g=>g==='facile'||g==='bien';
    
    function preprocessLaTeX(s){
  if (!s) return s;
  // NOTE : J'ai adapt√© la regex pour correspondre √† vos balises [latex] et non ```math...
  return s
    .replace(/\[latex\]/gi, '')         // on enl√®ve [latex]
    .replace(/\[\/latex\]/gi, '')       // on enl√®ve [/latex]
    .replace(/\\newline\s*/g, '<br/>'); // \newline -> <br> (en dehors des maths)
}

// Typeset MathJax dans un conteneur donn√©
function typesetLatex(container){
  if (window.MathJax && window.MathJax.typesetPromise) {
    // On s'assure que le conteneur est bien un √©l√©ment du DOM
    const el = (typeof container === 'string') ? $(container) : container;
    if (el) {
      return window.MathJax.typesetPromise([el]).catch(err=>console.warn('MathJax error:', err));
    }
  }
  return Promise.resolve(); // Retourne une promesse r√©solue si MathJax n'est pas pr√™t
}

    
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[', '\\]']],
        processEscapes: true,
        packages: {'[+]': ['noerrors', 'noundefined']} // √©vite les plantages si une macro manque
      },
      options: {
        skipHtmlTags: ['script','noscript','style','textarea','pre','code']
      },
      startup: { typeset: false } // on d√©clenche manuellement apr√®s chaque rendu
    };
    
    function formatDayKeyFR(key){
      // key = "YYYY-MM-DD"
      const [Y,M,D]=key.split('-').map(Number);
      const d=new Date(Y, M-1, D);
      const jours=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
      const mois=['janv.','f√©vr.','mars','avr.','mai','juin','juil.','ao√ªt','sept.','oct.','nov.','d√©c.'];
      return `${jours[d.getDay()]} ${String(D).padStart(2,'0')} ${mois[M-1]} ${Y}`;
    }

    const slugify=s=>s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    const emojiFor=title=>CHAPTER_EMOJIS[title]||'';

    // --- Helper: extrait l'ID num√©rique (rowId) √† la fin d'un card.id (ex: "democracy-123" -> "123")
    function extractRowId(cardId) {
      const m = String(cardId).match(/-(\d+)$/);
      return m ? m[1] : null;
    }

    // ---------- Construction donn√©es ----------
    function buildChaptersFromFlashcards(list){
      const byChap={}; list.forEach(r=>{const n=r.chapter||'Sans cat√©gorie'; (byChap[n]=byChap[n]||[]).push(r);});
      const chapters = Object.keys(byChap).map(name=>{
        const id='chap-'+slugify(name);
        const cards=byChap[name].map(r=>({
          id:`${slugify(name)}-${r.id}`, front:r.front, back:r.back,
          grade:'unseen', timesReviewed:0, lastReviewed:0, lastMs:0, avgMs:0,
          perfEma:0.5, ef:2.5, intervalDays:0, dueAt:0, streak:0, successes:0, failures:0
        }));
        return {
          id, title:name, description: emojiFor(name)?`${emojiFor(name)} ${name}`:name,
          settings:{sessionSize:10, dailyGoal:10, reviewOrder:'front-first', langSwap:false},
          filters:{grades:{unseen:true, echec:true, difficile:true, bien:true, facile:true}},
          stats:{
            gradeCounts:{unseen:cards.length,echec:0,difficile:0,bien:0,facile:0},
            totalReviews:0, dailyReviews:{}, dailyChanges:{}, dailyDurMs:{}, dailyDurCount:{}, dailyLog: {}
          },
          cards
        };
      });
      return {chapters, app:{currentChapterId:chapters[0]?.id||null, theme:'dark', prefs:{fsTerm:22, fsDef:24, accent:'indigo', showEmoji:true, radius:14}}};
    }

    // Construit un "Subject" (mati√®re) √† partir d'une liste raw
    function buildSubjectFromList(title, list){
      const built = buildChaptersFromFlashcards(list); // r√©utilise votre builder existant
      return { id: slugify(title), title, chapters: built.chapters };
    }

    // Canonique: mati√®res disponibles (Anglais, Physique)
    function buildCanonicalSubjects(){
      const en  = buildSubjectFromList('Anglais',  flashcardDataEN);
      const phy = buildSubjectFromList('Physique', flashcardDataPHY);
      return [en, phy];
    }

    function loadData(){
      // 1) Tente localStorage
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          // Si d√©j√† en mode "subjects", on renvoie tel quel
          if (Array.isArray(parsed.subjects)) return parsed;
          // Sinon (legacy): on enveloppe l'ancien format "chapters" dans une mati√®re "Anglais"
          if (Array.isArray(parsed.chapters)) {
            return {
              subjects: [{ id:'anglais', title:'Anglais', chapters: parsed.chapters }],
              app: parsed.app || { theme:'dark', prefs:{ fsTerm:22, fsDef:24, accent:'indigo', showEmoji:true, radius:14 }, currentSubjectId:'anglais' }
            };
          }
        }
      }catch(e){}

      // 2) Tente cookie backup (ancienne version) et applique la m√™me logique
      try{
        const c = readCookieBackup();
        if(c){
          const parsed = JSON.parse(c);
          if (Array.isArray(parsed.subjects)) return parsed;
          if (Array.isArray(parsed.chapters)) {
            return {
              subjects: [{ id:'anglais', title:'Anglais', chapters: parsed.chapters }],
              app: parsed.app || { theme:'dark', prefs:{ fsTerm:22, fsDef:24, accent:'indigo', showEmoji:true, radius:14 }, currentSubjectId:'anglais' }
            };
          }
        }
      }catch(e){}

      // 3) Premi√®re ex√©cution: cr√©e les deux mati√®res √† partir des donn√©es canoniques
      const subjects = buildCanonicalSubjects();
      return {
        subjects,
        app:{
          currentSubjectId: subjects[0]?.id || null,
          theme:'dark',
          prefs:{ fsTerm:22, fsDef:24, accent:'indigo', showEmoji:true, radius:14 }
        }
      };
    }

    function saveData(){
      try{
        const str=JSON.stringify(data);
        localStorage.setItem(STORAGE_KEY,str);
        writeCookieBackup(str);
      }catch(e){console.warn('Save error',e);}
    }

    // Cookies backup
    function setCookie(name,value,days=365){try{document.cookie=`${name}=${encodeURIComponent(value)}; max-age=${days*86400}; path=/; SameSite=Lax;`;}catch(e){}}
    function getCookie(name){try{const m=document.cookie.split(';').map(s=>s.trim()).find(s=>s.startsWith(name+'=')); return m?decodeURIComponent(m.split('=').slice(1).join('=')):null;}catch(e){return null;}}
    function delCookie(name){document.cookie=`${name}=; max-age=0; path=/; SameSite=Lax;`;}
    function writeCookieBackup(str){const CHUNK=3400; const parts=Math.ceil(str.length/CHUNK); for(let i=0;i<parts;i++) setCookie(`F9X16_B${i}`,str.slice(i*CHUNK,(i+1)*CHUNK)); for(let i=parts;i<10;i++) delCookie(`F9X16_B${i}`); setCookie('F9X16_BN',String(parts));}
    function readCookieBackup(){const n=parseInt(getCookie('F9X16_BN')||'0',10); if(!n) return null; let out=''; for(let i=0;i<n;i++){const p=getCookie(`F9X16_B${i}`); if(p==null) return null; out+=p;} return out;}

    let data = loadData();

    // ---------- Helpers de mati√®re ----------
    function getCurrentSubject(){
      const id = data?.app?.currentSubjectId;
      const s = data?.subjects?.find(x=>x.id===id);
      return s || data?.subjects?.[0] || null;
    }
    function setCurrentSubject(id){
      if (!data?.subjects?.find(s=>s.id===id)) return;
      data.app.currentSubjectId = id;
      saveData();
    }
    function getCurrentChapters(){
      const s=getCurrentSubject();
      return s?.chapters || [];
    }
    function getChapter(id){
      return getCurrentChapters().find(c=>c.id===id);
    }

    // ---------- √âtat UI + Nav ----------
    const State = {view:'deck', chapterId:null, review:null, cardsIndex:0, dailyKey: null};
    const Nav = {
      stack:[],
      push(){
        this.stack.push(deepClone({
          view:State.view, chapterId:State.chapterId, review:State.review,
          cardsIndex:State.cardsIndex, dailyKey: State.dailyKey
        }));
      },
      back(){
        if(!this.stack.length) return;
        const prev=this.stack.pop();
        State.view=prev.view; State.chapterId=prev.chapterId; State.review=prev.review;
        State.cardsIndex=prev.cardsIndex||0; State.dailyKey=prev.dailyKey||null;
        renderByState(false);
      },
      clear(){this.stack=[];}
    };

    // ---------- DOM persistants ----------
    const backBtn=$('#backBtn');
    const titleEl=$('#title');
    const bottomActions=$('#bottomActions');
    const revisionBar=$('#revisionBar');
    const startReviewBtn=$('#startReviewBtn');

    // ----- Subject menu (UI) -----
    const subjectMenuId = 'subjectMenu';
    function ensureSubjectMenu(){
      let m = document.getElementById(subjectMenuId);
      if(!m){
        m = document.createElement('div');
        m.id = subjectMenuId;
        m.className = 'subject-menu';
        document.body.appendChild(m);
      }
      return m;
    }
    function renderSubjectMenu(){
      const m = ensureSubjectMenu();
      const list = data.subjects || [];
      const currentId = data.app.currentSubjectId;
      m.innerHTML = list.map(s=>`
        <div class="subject-item" data-id="${s.id}">
          <div class="name">${s.title}</div>
          <div class="meta">${s.chapters?.length||0} chap.</div>
          ${s.id===currentId ? '<div class="muted">‚úì</div>': ''}
        </div>
      `).join('');
      m.querySelectorAll('.subject-item').forEach(el=>{
        el.addEventListener('click', (e)=>{
          const id = el.getAttribute('data-id');
          if(id && id!==currentId){
            setCurrentSubject(id);
            closeSubjectMenu();
            goDeck(false);
          }else{
            closeSubjectMenu();
          }
          e.stopPropagation();
        });
      });
    }
    function positionSubjectMenu(){
      const m = ensureSubjectMenu();
      const rect = titleEl.getBoundingClientRect();
      const top = rect.bottom + 6 + window.scrollY;
      const left = rect.left + window.scrollX;
      m.style.top = `${top}px`;
      m.style.left = `${Math.max(8, left - 10)}px`;
    }
    function openSubjectMenu(){
      renderSubjectMenu();
      positionSubjectMenu();
      const m = ensureSubjectMenu();
      m.style.display='block';
      setTimeout(()=>document.addEventListener('click', onDocClickClose), 0);
    }
    function closeSubjectMenu(){
      const m = ensureSubjectMenu();
      m.style.display='none';
      document.removeEventListener('click', onDocClickClose);
    }
    function onDocClickClose(e){
      const m = document.getElementById(subjectMenuId);
      if(!m) return;
      if(m.contains(e.target) || e.target===titleEl) return;
      closeSubjectMenu();
    }
    // Ouvre le menu quand on est sur "Deck" (sinon on revient au Deck)
    titleEl.addEventListener('click', ()=>{
      if(State.view!=='deck'){ goDeck(false); return; }
      const m = document.getElementById(subjectMenuId);
      if(m && m.style.display==='block') closeSubjectMenu();
      else openSubjectMenu();
    });


    backBtn.addEventListener('click',()=>{
      if(State.view==='review' && State.review && State.review.end==null){
        if(!confirm('Quitter la r√©vision en cours ?')) return;
      }
      if(State.view!=='chapter'){
        if(State.chapterId) return goChapter(State.chapterId,false);
        return goDeck(false);
      }else{
        return goDeck(false);
      }
    });
    $('#cardsBtn').addEventListener('click',()=>goCards(State.chapterId));
    $('#settingsBtn').addEventListener('click',()=>openSettings(State.chapterId));
    startReviewBtn.addEventListener('click',()=>startReview(State.chapterId));

    // ---------- Rendu ----------
    function setTopbar({title,showBack}={}){
      const visible = typeof showBack==='boolean' ? showBack : (State.view!=='deck');
      backBtn.classList.toggle('hidden',!visible);
      if(title) titleEl.textContent=title;
    }

    function setBottomVisibility({actions=false, revision=false, sessionSize=10, enabled=true, available=null, chapterId=null}={}){
      bottomActions.style.display = actions?'grid':'none';
      revisionBar.style.display = revision?'block':'none';
      const phoneEl=$('#app');
      phoneEl.style.setProperty('--row-actions', actions?'52px':'0px');
      phoneEl.style.setProperty('--row-rev', revision?'64px':'0px');

      if(available==null && chapterId){
        const chap=getChapter(chapterId); available = chap?countAvailable(chap):0;
      }
      if(available==null) available=0;
      const planned = available>0 ? Math.min(sessionSize,available):0;
      startReviewBtn.textContent = `R√©vision ‚Ä¢ ${planned||sessionSize} cartes${revision ? (available>0? ` ‚Ä¢ ${available} dispo`:'') : ''}`;
      startReviewBtn.disabled = !enabled || available<=0;
    }

    function renderByState(push=true){
      switch(State.view){
        case 'deck': return goDeck(push);
        case 'chapter': return goChapter(State.chapterId,push);
        case 'cards': return goCards(State.chapterId,push);
        case 'review': return goReview(push);
        case 'recap': return goRecap(push);
        case 'settings': return openSettings(State.chapterId,push);
        case 'daily': return goDaily(State.chapterId, State.dailyKey, push);
      }
    }
    function hideReviewActionsBar(){const el=$('#reviewActionsBar'); if(el){el.style.display='none'; el.innerHTML='';}}

    // Deck
    function goDeck(push=true){
      if(push) Nav.push();
      State.view='deck';
      State.chapterId=null;
      const subj = getCurrentSubject();
      setTopbar({title:`Deck ‚Ä¢ ${subj?.title||''}`, showBack:false});
      setBottomVisibility({actions:false, revision:false});
      hideReviewActionsBar();
      renderDeck();
    }

    function renderDeck(){
      const v=$('#view');
      const chapters=getCurrentChapters(); // <-- au lieu de data.chapters

      v.innerHTML = `
        <div class="card flexcol" style="flex:1;">
          <div class="section-title">Chapitres</div>
          <div id="deckList" class="scroll-y" style="flex:1; min-height:0; padding-right:4px;">
            <div class="list">
              ${chapters.map(ch=>{
                const {unseen,echec,difficile,bien,facile}=getLiveGradeCounts(ch);
                const total=ch.cards?.length??0;
                const viewed=Math.max(0,total-unseen);
                const pct= total ? Math.round((viewed/total)*100):0;
                return `
                  <div class="deck-item" data-id="${ch.id}">
                    <div style="min-width:0">
                      <div style="font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:18px;">
                        ${ch.description||ch.title}
                      </div>
                      <div class="mt6" style="display:flex; flex-wrap:wrap; gap:6px">
                        <span class="chip-pie" title="Progression : ${pct}%" style="--progress:${pct}%"></span>
                        <span class="chip" title="√âchec">üü• ${echec}</span>
                        <span class="chip" title="Difficile">üü® ${difficile}</span>
                        <span class="chip" title="Bien">üü¶ ${bien}</span>
                        <span class="chip" title="Facile">üü© ${facile}</span>
                      </div>
                    </div>
                    <div class="muted" style="font-size:18px">‚Ä∫</div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;
      $$('.deck-item').forEach(el=>el.addEventListener('click',()=>goChapter(el.getAttribute('data-id'))));
    }

    // Chapter
    function goChapter(chapterId,push=true){
      if(push) Nav.push();
      State.view='chapter'; State.chapterId=chapterId;
      const chap=getChapter(chapterId);
      setTopbar({title:chap?.title||'Statistiques'});
      setBottomVisibility({
        actions:true, revision:true, sessionSize:chap.settings.sessionSize,
        enabled:(chap.cards && chap.cards.length>0),
        available:countAvailable(chap), chapterId:chap.id
      });
      hideReviewActionsBar();
      renderChapter(chapterId);
    }

    function renderChapter(chapterId){
      const v=$('#view'); const chap=getChapter(chapterId);
      const sel=chap.filters.grades||{};
      const counts=getLiveGradeCounts(chap);
      const {unseen,echec,difficile,bien,facile}=counts;

      const today=getTodayCount(chap);
      const week=getWeekCount(chap);
      const success=getSuccessRate(chap);
      const avg7=get7DayAvgMs(chap);
      const dueNow=getDueNow(chap);
      const streak=getStreakDays(chap);
      const emoji=emojiFor(chap.title);

      v.innerHTML = `
        <div class="card" style="flex:1; display:flex; flex-direction:column;">
          <div class="section-title">${emoji?emoji+' ':''}Statistiques</div>
          <div class="kpi">
            <div class="k"><div class="label">Cartes non vues</div><div class="value">${unseen}</div></div>
            <div class="k"><div class="label">Total cartes</div><div class="value">${chap.cards.length}</div></div>
          </div>

          <div class="chart-wrap"><canvas id="gradeChart" width="180" height="180" aria-label="Diagramme des scores"></canvas></div>

          <div class="legend" id="legend">
            <div class="legend-item ${sel.unseen?'':'inactive'}" data-key="unseen"><span class="dot gray"></span> Non vus: <b class="count">${unseen}</b></div>
            <div class="legend-item ${sel.echec?'':'inactive'}" data-key="echec"><span class="dot red"></span> √âchec: <b class="count">${echec}</b></div>
            <div class="legend-item ${sel.difficile?'':'inactive'}" data-key="difficile"><span class="dot amber"></span> Difficile: <b class="count">${difficile}</b></div>
            <div class="legend-item ${sel.bien?'':'inactive'}" data-key="bien"><span class="dot blue"></span> Bien: <b class="count">${bien}</b></div>
            <div class="legend-item ${sel.facile?'':'inactive'}" data-key="facile"><span class="dot green"></span> Facile: <b class="count">${facile}</b></div>
          </div>

          <div class="kpi mt8">
            <div class="k"><div class="label">Aujourd'hui</div><div class="value">${today}</div></div>
            <div class="k"><div class="label">Cette semaine</div><div class="value">${week}</div></div>
          </div>
          <div class="kpi mt8">
            <div class="k"><div class="label">Taux de r√©ussite</div><div class="value">${success}%</div></div>
            <div class="k"><div class="label">Temps moyen (7j)</div><div class="value">${avg7? (Math.round(avg7/100)/10)+'s':'‚Äî'}</div></div>
          </div>
          <div class="kpi mt8">
            <div class="k"><div class="label">√Ä r√©viser maintenant</div><div class="value">${dueNow}</div></div>
            <div class="k"><div class="label">S√©rie (jours)</div><div class="value">${streak}</div></div>
          </div>

          <div class="bar7-wrap">
            <div class="label" style="color:var(--primary)">Activit√© 7 jours</div>
            <canvas id="bar7" width="220" height="60"></canvas>
            <div class="bar7-labels" id="bar7Labels"></div>
          </div>
        </div>
      `;

      // Chart donut
      drawGradeChart('gradeChart',counts,chap.filters.grades);
      const canvas=$('#gradeChart'); canvas.style.cursor='pointer';
      canvas.onclick=(ev)=>handleChartClick(ev,'gradeChart',chap,counts);

      // L√©gende clic
      $$('#legend .legend-item').forEach(el=>{
        const key=el.getAttribute('data-key');
        const act=()=>{handleLegendClick(key,chap);};
        el.addEventListener('click',act);
        el.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' ') {e.preventDefault(); act();}});
        el.setAttribute('tabindex','0');
        el.setAttribute('role','button');
      });

      // R√©vision bar refresh
      updateRevisionBarForChapter(chap);

      // 7-day bars
      drawBars7('bar7', getLastNDaysArray(chap,7));
      const lbl=$('#bar7Labels');
      if(lbl){const noms=getLastNDaysLabelsFR(7); lbl.innerHTML=noms.map(j=>`<div>${j.substring(0,3)}</div>`).join('');}

      // Clic sur le canvas bar-chart
      const barCanvas = document.getElementById('bar7');
      if (barCanvas) {
        barCanvas.style.cursor = 'pointer';
        barCanvas.onclick = (ev) => openDayFromBarClick(ev, 'bar7', chap.id, 7);
      }

      // Clic sur les labels
      const labelsWrap = document.getElementById('bar7Labels');
      if (labelsWrap) {
        Array.from(labelsWrap.children).forEach((el, i) => {
          el.style.cursor = 'pointer';
          el.title = 'Voir les cartes de ce jour';
          el.onclick = () => goDaily(chap.id, dayKeyFromIndex(7, i));
        });
      }

      // Redraw on resize (debounced)
      (function(){
        let t; const redraw=()=>drawBars7('bar7',getLastNDaysArray(chap,7));
        window.removeEventListener('resize', window._bar7ResizeHandler || (()=>{}));
        window._bar7ResizeHandler=()=>{clearTimeout(t); t=setTimeout(redraw,150);};
        window.addEventListener('resize', window._bar7ResizeHandler);
      })();
    }

    function updateRevisionBarForChapter(chap){
      const available=countAvailable(chap);
      setBottomVisibility({actions:true, revision:true, sessionSize:chap.settings.sessionSize, enabled:available>0, available});
    }

    // Cards
    function goCards(chapterId,push=true){
      if(push) Nav.push();
      State.view='cards'; State.chapterId=chapterId;
      const chap=getChapter(chapterId);
      setTopbar({title:`${chap.title} ‚Ä¢ Cartes`});
      setBottomVisibility({actions:false, revision:false});
      hideReviewActionsBar();
      renderCards(chapterId);
    }

    function renderCards(chapterId){
  const v=$('#view'); const chap=getChapter(chapterId);
  const sel=chap.filters.grades||{};
  const pool=chap.cards.filter(c=>sel[(c.grade||'unseen')]);

  v.innerHTML = `
    <div style="flex:1; display:flex; flex-direction:column; min-height:0;">
      <div class="section-title">Cartes (${pool.length})</div>
      <div id="cardsGrid" class="scroll-y" style="flex:1; min-height:0; padding-right:4px;">
        <div class="cards-grid">
          ${pool.map(c=>{
            // MODIFICATION : Utiliser preprocessLaTeX
            const {frontText,backText}=getCardSides(c,chap);
            const f = preprocessLaTeX(frontText);
            const b = preprocessLaTeX(backText);
            const gradeClass=`grade-${c.grade||'unseen'}`;
            const timeStr=c.avgMs?formatDuration(c.avgMs):'';
            return `
              <div class="card-block ${gradeClass}" data-id="${c.id}">
                <div class="term">${f}</div>
                <div class="definition">${b}</div>
                ${timeStr?`<div class="cb-time">${timeStr}</div>`:''}
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;

  // AJOUT : Lancer le rendu MathJax sur la nouvelle vue
  typesetLatex(v);

  const grid=$('#cardsGrid');
  grid.addEventListener('click',e=>{
    const block=e.target.closest('.card-block'); if(!block) return;
    $$('.card-block').forEach(b=>{if(b!==block) b.classList.remove('flipped');});
    block.classList.toggle('flipped');
  });
}
    // Daily Activity View
    function goDaily(chapterId, dayKey, push=true){
      if (push) Nav.push();
      State.view='daily';
      State.chapterId=chapterId;
      State.dailyKey=dayKey;
      const chap=getChapter(chapterId);
      setTopbar({ title:`Activit√© ‚Ä¢ ${formatDayKeyFR(dayKey)}` });
      setBottomVisibility({ actions:false, revision:false });
      hideReviewActionsBar();
      renderDaily(chap, dayKey);
    }

    function renderDaily(chap, dayKey){
  const v = document.getElementById('view');
  const log = (chap.stats.dailyLog && chap.stats.dailyLog[dayKey]) ? chap.stats.dailyLog[dayKey].slice() : [];
  if (!log.length){
    v.innerHTML = `
      <div class="card" style="flex:1; display:flex; flex-direction:column;">
        <div class="section-title">Activit√© du ${formatDayKeyFR(dayKey)}</div>
        <div class="muted">Aucune donn√©e pour ce jour.</div>
      </div>
    `;
    return;
  }

  log.sort((a,b)=>a.ts-b.ts);
  const byCard = new Map();
  for (const e of log){
    const curr = byCard.get(e.cardId) || { firstPrev:null, firstTs:Infinity, lastNext:null, lastTs:-Infinity, events:[] };
    if (e.ts < curr.firstTs){ curr.firstTs = e.ts; curr.firstPrev = e.prev; }
    if (e.ts > curr.lastTs) { curr.lastTs = e.ts; curr.lastNext = e.next; }
    curr.events.push(e);
    byCard.set(e.cardId, curr);
  }

  const rows = [];
  for (const [cardId, info] of byCard){
    const card = chap.cards.find(c=>c.id===cardId);
    if (!card) continue;
    
    // MODIFICATION : Utiliser preprocessLaTeX ici
    const {frontText, backText} = getCardSides(card, chap);
    rows.push({
      id: cardId,
      term: preprocessLaTeX(frontText),
      def:  preprocessLaTeX(backText),
      before: info.firstPrev || 'unseen',
      after: info.lastNext || (card.grade || 'unseen')
    });
  }

  rows.sort((a,b)=>{
    const ca = (a.before!==a.after), cb=(b.before!==b.after);
    if (ca!==cb) return ca? -1: 1;
    // On compare sur la version texte brut pour le tri, pas HTML
    const cardA = chap.cards.find(c=>c.id===a.id);
    const cardB = chap.cards.find(c=>c.id===b.id);
    return cardA.front.localeCompare(cardB.front, 'fr');
  });

  v.innerHTML = `
    <div class="card" style="flex:1; display:flex; flex-direction:column; min-height:0;">
      <div class="section-title">Activit√© du ${formatDayKeyFR(dayKey)} ‚Ä¢ ${rows.length} carte(s)</div>
      <div id="dailyList" class="scroll-y" style="flex:1; min-height:0; padding-right:4px;">
        <div class="list" style="gap:10px">
          ${rows.map(r=>`
            <div class="grid2">
              <div class="card-block grade-${r.before}" data-id="${r.id}" data-side="before" title="Avant ce jour">
                <div class="term">${r.term}</div>
                <div class="definition">${r.def}</div>
              </div>
              <div class="card-block grade-${r.after}" data-id="${r.id}" data-side="after" title="Apr√®s ce jour">
                <div class="term">${r.term}</div>
                <div class="definition">${r.def}</div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
      <div class="small muted mt6">Astuce: touchez une carte pour afficher/masquer la d√©finition.</div>
    </div>
  `;

  // AJOUT : Lancer le rendu MathJax sur la nouvelle vue
  typesetLatex(v);

  const list = document.getElementById('dailyList');
  list.addEventListener('click', (e)=>{
    const block = e.target.closest('.card-block');
    if (!block) return;
    block.classList.toggle('flipped');
  });
}

    // Review
    function goReview(push=true){
      if(push) Nav.push();
      State.view='review';
      setTopbar({title:'R√©vision'});

      setBottomVisibility({actions:false, revision:true}); // r√©serve la rang√©e
      revisionBar.style.display='none'; // masque bouton
      $('#reviewActionsBar').style.display='block'; // affiche barre d'actions

      renderReview();
    }

    function renderReviewFooter(){
      const bar=$('#reviewActionsBar'); if(!bar) return;
      const r=State.review;
      if(!r.flipped){
        bar.innerHTML=`<button class="btn btn--solid btn--primary" id="flipBtn">Retourner</button>`;
        $('#flipBtn').onclick=()=>{r.flipped=true; renderReview();};
      }else{
        bar.innerHTML=`
          <div class="row-4">
            <button class="btn btn--red" id="grade_echec">√âchec</button>
            <button class="btn btn--amber" id="grade_difficile">Difficile</button>
            <button class="btn btn--blue" id="grade_bien">Bien</button>
            <button class="btn btn--green" id="grade_facile">Facile</button>
          </div>`;
        $('#grade_echec').onclick=()=>submitGrade('echec');
        $('#grade_difficile').onclick=()=>submitGrade('difficile');
        $('#grade_bien').onclick=()=>submitGrade('bien');
        $('#grade_facile').onclick=()=>submitGrade('facile');
      }
    }

    function renderReview(){
  const v=$('#view'); const r=State.review; const chap=getChapter(r.chapterId);
  const total=r.queue.length; const current=getCurrentCard(); const idx=r.index+1;

  // MODIFICATION : Utiliser preprocessLaTeX pour toutes les faces
  const {frontText,backText}=getCardSides(current,chap);
  const frontHTML = preprocessLaTeX(frontText);
  const backHTML  = preprocessLaTeX(backText);

  const frontFirst = chap.settings.reviewOrder!=='back-first';
  const prompt = frontFirst ? frontHTML : backHTML;
  const isPromptFront=frontFirst; const promptClass=isPromptFront?'term':'definition'; const promptFace=isPromptFront?'front':'back';

  v.innerHTML = `
    <div class="review-wrap">
      <div class="review-top"><div>${chap.title}</div><div>${idx} / ${total}</div></div>
      <div class="review-card">
        <div>
          ${!r.flipped
            ? `<div class="${promptClass}" data-face="${promptFace}">${prompt}</div>`
            : `<div class="stack"><div class="term" data-face="front">${frontHTML}</div><div class="definition" data-face="back" style="margin-top:6px">${backHTML}</div></div>`
          }
        </div>
      </div>
    </div>
  `;

  // AJOUT : Lancer le rendu MathJax sur la nouvelle vue
  typesetLatex(v);

  bindReviewSizeControls();
  renderReviewFooter();
}

    // Recap
    function goRecap(push=true){
      if(push) Nav.push();
      State.view='recap';
      setTopbar({title:'R√©capitulatif'});
      setBottomVisibility({actions:false, revision:false});
      hideReviewActionsBar();
      renderRecap();
    }

    function renderRecap(){
      const v=$('#view'); const r=State.review; const chap=getChapter(r.chapterId);
      const totalSession=r.answers.length; const duration=r.end-r.start; const avgPerCard=totalSession?duration/totalSession:0;
      const todayChange=getTodayChange(chap); const todayReviews=getTodayCount(chap);
      v.innerHTML = `
        <div class="card recap" style="flex:1">
          <div><h2>R√©capitulatif</h2><div class="subtitle">${chap.title}</div></div>
          <div class="grid2">
            <div class="stat"><div class="label">R√©visions/jour (7j)</div><div class="val">${get7DayAverage(chap)}</div></div>
            <div class="stat"><div class="label">Changement de classe aujourd'hui</div><div class="val">${todayChange.total>0?Math.round((todayChange.changed/todayChange.total)*100):0}%</div></div>
            <div class="stat"><div class="label">Objectif quotidien</div><div class="val">${chap.settings.dailyGoal}</div></div>
            <div class="stat"><div class="label">R√©visions aujourd'hui</div><div class="val">${todayReviews}/${chap.settings.dailyGoal}</div></div>
          </div>
          <div class="grid2">
            <div class="stat"><div class="label">Total r√©visions (session)</div><div class="val">${totalSession}</div></div>
            <div class="stat"><div class="label">Dur√©e (session)</div><div class="val">${formatDuration(duration)}</div></div>
            <div class="stat"><div class="label">Temps moyen/carte</div><div class="val">${formatDuration(avgPerCard)}</div></div>
          </div>
          <div class="cta"><button class="btn btn--solid btn--primary" id="continueBtn">Continuer</button></div>
        </div>
      `;
      $('#continueBtn').addEventListener('click',()=>startReview(r.chapterId));
    }

    // ---------- Logique r√©vision ----------
    function startReview(chapterId){
      if(!chapterId) return;
      const chap=getChapter(chapterId);
      const sel=chap.filters.grades;
      const pool=chap.cards.filter(c=>sel[(c.grade||'unseen')]);
      const size=Math.min(chap.settings.sessionSize,pool.length);
      if(size<=0){alert('Aucune carte disponible avec les filtres s√©lectionn√©s.'); return;}
      const queue=buildSmartQueue(chap,pool,size).map(c=>c.id);
      State.review={chapterId, queue, index:0, flipped:false, answers:[], start:Date.now(), end:null, cardStart:Date.now()};
      goReview();
    }

    function buildSmartQueue(chap,pool,size){
      const now=Date.now();
      const baseWMap={unseen:6,echec:5,difficile:3.5,bien:2,facile:1};
      const scored=pool.map(c=>{
        const g=c.grade||'unseen'; const baseW=baseWMap[g]??1;
        let dueBoost=1;
        if(c.dueAt && c.dueAt>0){
          const delta=now-c.dueAt;
          dueBoost = delta>0 ? (1+Math.min(3,delta/864e5)) : 0.85;
        }else{ dueBoost=1.15; }
        const ema=typeof c.perfEma==='number' ? c.perfEma : 0.5;
        const perfBoost=1+(1-ema)*1.6;
        const s=c.streak||0;
        const streakAdj = s>=3 ? (1/(1+0.12*(s-2))) : (s<0 ? (1+0.18*Math.min(8,Math.abs(s))) : 1);
        const t=c.avgMs||0; const timeBoost=1+Math.min(2,t/3000);
        const jitter=0.9+Math.random()*0.2;
        return {card:c, weight:baseW*dueBoost*perfBoost*streakAdj*timeBoost*jitter};
      });
      scored.sort((a,b)=>b.weight-a.weight);
      return scored.slice(0,size).map(x=>x.card);
    }

    function getCurrentCard(){
      const r=State.review; const chap=getChapter(r.chapterId);
      const id=r.queue[r.index]; return chap.cards.find(c=>c.id===id);
    }

    function submitGrade(nextGrade){
      const r=State.review; const chap=getChapter(r.chapterId); const card=getCurrentCard(); const now=Date.now();
      const duration=Math.max(0, now-(r.cardStart||now));
      const prevGrade=card.grade||'unseen'; const next=nextGrade;

      const wasZeroBeforeNext=(chap.stats.gradeCounts[next]||0)===0;
      card.grade=next;
      syncGradeCounts(chap);

      // Perf + planification
      const alpha=0.3; const q01=gradeNorm01(next);
      card.perfEma = (1-alpha)*(card.perfEma??0.5) + alpha*q01;
      scheduleNext(card,next,now);

      // Temps + counters
      card.lastReviewed=now; card.lastMs=duration;
      card.avgMs = card.avgMs ? Math.round(card.avgMs*0.7 + duration*0.3) : duration;
      card.timesReviewed=(card.timesReviewed||0)+1;
      if(isSuccess(next)) card.successes+=1; else card.failures+=1;

      // Stats jour
      chap.stats.totalReviews += 1;
      const tk=todayKey();
      chap.stats.dailyReviews[tk]=(chap.stats.dailyReviews[tk]||0)+1;
      chap.stats.dailyDurMs[tk]=(chap.stats.dailyDurMs[tk]||0)+duration;
      chap.stats.dailyDurCount[tk]=(chap.stats.dailyDurCount[tk]||0)+1;
      const dc=chap.stats.dailyChanges[tk]||{changed:0,total:0};
      dc.total+=1; if(prevGrade!==next) dc.changed+=1; chap.stats.dailyChanges[tk]=dc;

      // journal d√©taill√© par carte
      const log = chap.stats.dailyLog[tk] || [];
      log.push({ cardId: card.id, prev: prevGrade, next, ms: duration, ts: now });
      chap.stats.dailyLog[tk] = log;

      if(wasZeroBeforeNext && next!=='unseen'){ chap.filters.grades[next]=true; }

      // Trace + nav
      r.answers.push({cardId:card.id, prev:prevGrade, next, ms:duration});
      if(r.index < r.queue.length-1){
        r.index+=1; r.flipped=false; r.cardStart=Date.now();
        saveData(); renderReview();
      }else{
        r.end=Date.now(); saveData(); goRecap();
      }
    }

    // ---------- Helpers chapitres/stats ----------
    function getCardSides(card,chap){
      return chap?.settings?.langSwap ? {frontText:card.back, backText:card.front} : {frontText:card.front, backText:card.back};
    }
    function getLiveGradeCounts(chap){
      const c={unseen:0,echec:0,difficile:0,bien:0,facile:0};
      (chap.cards||[]).forEach(x=>{const g=x.grade||'unseen'; c[g]!=null ? c[g]++ : c.unseen++;});
      return c;
    }
    function syncGradeCounts(chap){chap.stats=chap.stats||{}; chap.stats.gradeCounts=getLiveGradeCounts(chap);}

    function getTodayCount(chap){return chap.stats.dailyReviews[todayKey()]||0;}
    function getTodayChange(chap){return chap.stats.dailyChanges[todayKey()]||{changed:0,total:0};}
    function get7DayAverage(chap){
      const base=new Date(); const days=[];
      for(let i=6;i>=0;i--){const d=new Date(base); d.setDate(base.getDate()-i); days.push(chap.stats.dailyReviews[dateKey(d)]||0);}
      return Math.round(avg(days));
    }
    function getWeekCount(chap){
      const base=new Date(); let sum=0;
      for(let i=0;i<7;i++){const d=new Date(base); d.setDate(base.getDate()-i); sum+=(chap.stats.dailyReviews[dateKey(d)]||0);}
      return sum;
    }
    function getSuccessRate(chap){
      const gc=chap.stats.gradeCounts||{};
      const good=(gc.bien||0)+(gc.facile||0);
      const attempt=good+(gc.echec||0)+(gc.difficile||0);
      return attempt===0?0:Math.round((good/attempt)*100);
    }
    function get7DayAvgMs(chap){
      if(!chap.stats.dailyDurMs||!chap.stats.dailyDurCount) return 0;
      const base=new Date(); let sum=0,cnt=0;
      for(let i=0;i<7;i++){
        const d=new Date(base); d.setDate(base.getDate()-i);
        const k=dateKey(d); sum+=(chap.stats.dailyDurMs[k]||0); cnt+=(chap.stats.dailyDurCount[k]||0);
      }
      return cnt?Math.round(sum/cnt):0;
    }
    function countAvailable(chap){const sel=chap.filters.grades; return chap.cards.filter(c=>sel[(c.grade||'unseen')]).length;}
    function getDueNow(chap){const now=Date.now(); return chap.cards.filter(c=>c.dueAt && c.dueAt>0 && c.dueAt<=now).length;}
    function getStreakDays(chap){
      const base=new Date(); let streak=0;
      for(let i=0;i<365;i++){const d=new Date(base); d.setDate(base.getDate()-i); const n=chap.stats.dailyReviews[dateKey(d)]||0; if(n>0) streak++; else break;}
      return streak;
    }

    function getLastNDaysArray(chap,n){
      const arr=[]; const base=new Date();
      for(let i=n-1;i>=0;i--){const d=new Date(base); d.setDate(base.getDate()-i); arr.push(chap.stats.dailyReviews[dateKey(d)]||0);}
      return arr;
    }
    function getLastNDaysLabelsFR(n){
      const noms=[]; const base=new Date(); const J=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
      for(let i=n-1;i>=0;i--){const d=new Date(base); d.setDate(base.getDate()-i); noms.push(J[d.getDay()]);}
      return noms;
    }

    function dayKeyFromIndex(n, index) {
      const base = new Date();
      const offset = (n - 1) - index; // ex: n=7, index 0 => offset 6 jours
      const d = new Date(base);
      d.setHours(0,0,0,0);
      d.setDate(base.getDate() - offset);
      return dateKey(d);
    }

    function openDayFromBarClick(evt, canvasId, chapId, n=7) {
      const hit = Bar7Hit[canvasId];
      if (!hit) return;
      const rect = evt.target.getBoundingClientRect();
      const xCSS = (evt.clientX - rect.left) * (hit.cssW / rect.width);
      const i = hit.bars.findIndex(b => xCSS >= b.x && xCSS <= b.x + b.w);
      if (i < 0) return;
      const key = dayKeyFromIndex(n, i);
      goDaily(chapId, key);
    }

    // ---------- Bar chart ----------
    function drawBars7(canvasId, values) {
      const el = document.getElementById(canvasId);
      if (!el) return;
      const ctx = el.getContext('2d');

      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const cssW = Math.round(el.clientWidth || el.getBoundingClientRect().width || 220);
      const cssH = Math.round(parseFloat(getComputedStyle(el).height) || el.height || 60);

      if (el.width !== cssW * dpr || el.height !== cssH * dpr) {
        el.width = cssW * dpr;
        el.height = cssH * dpr;
      }

      ctx.setTransform(1, 0, 0, 1, 0, 0);
      ctx.clearRect(0, 0, el.width, el.height);
      ctx.scale(dpr, dpr);

      const w = cssW, h = cssH;
      const max = Math.max(1, ...values);
      const n = values.length;
      const gap = 6;
      const totalGap = gap * (n - 1);
      const barW = Math.max(6, Math.floor((w - totalGap) / n));

      const primary = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#6366f1';
      const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim() || '#0f172a';

      const fontPx = Math.max(9, Math.min(10, Math.floor(barW * 0.7)));
      const textPad = fontPx + 4;
      const baseY = h - textPad - 2;
      const minH = 3;

      ctx.strokeStyle = 'rgba(148,163,184,0.35)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, baseY + 0.5);
      ctx.lineTo(w, baseY + 0.5);
      ctx.stroke();

      ctx.font = `bold ${fontPx}px ui-sans-serif, system-ui`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';

      let x = 0;
      const bars = [];
      values.forEach(v => {
        const bhRaw = Math.round((v / max) * (h - textPad - 8));
        const bh = Math.max(minH, bhRaw);
        const y = baseY - bh;

        ctx.fillStyle = primary;
        ctx.globalAlpha = 0.95;
        ctx.fillRect(x, y, barW, bh);
        ctx.globalAlpha = 1;

        ctx.fillStyle = textColor;
        ctx.fillText(String(v), x + barW / 2, baseY + 2);

        ctx.fillStyle = 'rgba(0,0,0,0.15)';
        ctx.fillRect(x, baseY, barW, 2);

        bars.push({ x, w: barW });
        x += barW + gap;
      });

      Bar7Hit[canvasId] = { cssW: w, cssH: h, bars };
    }


    // ---------- Donut ----------
    function drawGradeChart(canvasId,counts,activeKeys=null){
      const el=document.getElementById(canvasId); if(!el) return;
      const ctx=el.getContext('2d'); const w=el.width,h=el.height;
      ctx.clearRect(0,0,w,h);
      const cx=w/2, cy=h/2; const outerR=Math.min(w,h)/2-6; const innerR=outerR*0.65;

      const css=getComputedStyle(document.documentElement);
      const segments=[
        {key:'unseen',color:'#9ca3af'},
        {key:'echec',color:css.getPropertyValue('--red').trim()},
        {key:'difficile',color:css.getPropertyValue('--amber').trim()},
        {key:'bien',color:css.getPropertyValue('--blue').trim()},
        {key:'facile',color:css.getPropertyValue('--green').trim()},
      ];
      const total=segments.reduce((s,seg)=>s+(counts[seg.key]||0),0);
      const arcs=[];
      if(total===0){
        ctx.beginPath(); ctx.arc(cx,cy,outerR,0,Math.PI*2); ctx.arc(cx,cy,innerR,0,Math.PI*2,true);
        ctx.fillStyle='#cbd5e1'; ctx.globalAlpha=.25; ctx.fill(); ctx.globalAlpha=1;
        ctx.fillStyle='#64748b'; ctx.font='bold 12px ui-sans-serif, system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillText('Aucune donn√©e',cx,cy);
        ChartHit[canvasId]={cx,cy,innerR,outerR,arcs:[]}; return;
      }
      let start=-Math.PI/2;
      segments.forEach(seg=>{
        const val=counts[seg.key]||0; if(val<=0) return;
        const a=(val/total)*Math.PI*2; const end=start+a;
        const active=!activeKeys || !!activeKeys[seg.key];

        ctx.beginPath(); ctx.arc(cx,cy,outerR,start,end); ctx.arc(cx,cy,innerR,end,start,true);
        ctx.fillStyle=seg.color; ctx.globalAlpha=active?0.9:0.22; ctx.fill(); ctx.globalAlpha=1;

        arcs.push({key:seg.key,start,end}); start=end;
      });

      ctx.fillStyle='#0ea5e9'; ctx.font='bold 18px ui-sans-serif, system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(String(total),cx,cy-4);
      ctx.fillStyle='#64748b'; ctx.font='10px ui-sans-serif, system-ui'; ctx.fillText('cartes',cx,cy+10);

      ChartHit[canvasId]={cx,cy,innerR,outerR,arcs};
    }

    function toggleFilterKey(chap,key){
      const sel=chap.filters.grades; const total=Object.keys(sel).length; const active=Object.keys(sel).filter(k=>sel[k]); const isSelected=!!sel[key];
      if(active.length===total){Object.keys(sel).forEach(k=>sel[k]=false); sel[key]=true;}
      else if(active.length===1 && isSelected){sel[key]=true;}
      else{
        sel[key]=!isSelected;
        if(Object.keys(sel).filter(k=>sel[k]).length===0){sel[key]=true;}
      }
    }
    function handleChartClick(evt,canvasId,chap){
      const map=ChartHit[canvasId]; if(!map||!map.arcs.length) return;
      const rect=evt.target.getBoundingClientRect(); const scaleX=evt.target.width/rect.width; const scaleY=evt.target.height/rect.height;
      const x=(evt.clientX-rect.left)*scaleX; const y=(evt.clientY-rect.top)*scaleY;
      const dx=x-map.cx, dy=y-map.cy; const r=Math.hypot(dx,dy); if(r<map.innerR||r>map.outerR) return;
      let a=Math.atan2(dy,dx); while(a<-Math.PI/2) a+=2*Math.PI; while(a>3*Math.PI/2) a-=2*Math.PI;
      const hit=map.arcs.find(s=>a>=s.start && a<=s.end); if(!hit) return;
      toggleFilterKey(chap,hit.key); saveData(); renderChapter(chap.id);
    }
    function handleLegendClick(key,chap){toggleFilterKey(chap,key); saveData(); renderChapter(chap.id);}

    // ---------- Th√®me / UI ----------
    function applyTheme(){document.documentElement.setAttribute('data-theme', (data?.app?.theme)||'dark');}
    function applyUI(){
      const p=data.app.prefs||{};
      document.documentElement.style.setProperty('--fs-term',(p.fsTerm||20)+'px');
      document.documentElement.style.setProperty('--fs-def',(p.fsDef||24)+'px');
      document.documentElement.style.setProperty('--radius-md',(p.radius||14)+'px');
      const palette={
        indigo:['#6366f1','#5457e6'], blue:['#3b82f6','#2563eb'], teal:['#14b8a6','#0d9488'],
        emerald:['#10b981','#059669'], rose:['#f43f5e','#e11d48'], amber:['#f59e0b','#d97706'], violet:['#8b5cf6','#7c3aed']
      };
      const acc=palette[p.accent]||palette.indigo;
      document.documentElement.style.setProperty('--primary',acc[0]);
      document.documentElement.style.setProperty('--primary-600',acc[1]);
    }

    function upgradeData(){
      data.app=data.app||{};
      if(!('theme' in data.app)) data.app.theme='dark';
      data.app.prefs=data.app.prefs||{};
      if(typeof data.app.prefs.fsTerm!=='number') data.app.prefs.fsTerm=22;
      if(typeof data.app.prefs.fsDef!=='number') data.app.prefs.fsDef=24;
      if(!data.app.prefs.accent) data.app.prefs.accent='indigo';
      if(typeof data.app.prefs.showEmoji!=='boolean') data.app.prefs.showEmoji=true;
      if(typeof data.app.prefs.radius!=='number') data.app.prefs.radius=14;

      if(!Array.isArray(data.subjects)){
        // Migration depuis ancien format
        data.subjects = [{ id:'anglais', title:'Anglais', chapters: data.chapters||[] }];
        delete data.chapters;
        if(!data.app.currentSubjectId) data.app.currentSubjectId='anglais';
      }

      data.subjects.forEach(subj=>{
        (subj.chapters||[]).forEach(ch=>{
          ch.settings=ch.settings||{};
          if(typeof ch.settings.langSwap!=='boolean') ch.settings.langSwap=false;
          ch.stats=ch.stats||{};
          if (!ch.stats.dailyLog) ch.stats.dailyLog = {};
          (ch.cards||[]).forEach(c=>{
            if(typeof c.perfEma!=='number') c.perfEma=0.5;
            if(typeof c.ef!=='number') c.ef=2.5;
            if(typeof c.intervalDays!=='number') c.intervalDays=0;
            if(typeof c.dueAt!=='number') c.dueAt=0;
            if(typeof c.streak!=='number') c.streak=0;
            if(typeof c.successes!=='number') c.successes=0;
            if(typeof c.failures!=='number') c.failures=0;
          });
          syncGradeCounts(ch);
        });
      });
      saveData();
    }

    // ---------- Param√®tres ----------
    function openSettings(chapterId,push=true){
      if(!chapterId) chapterId=State.chapterId;
      const chap=getChapter(chapterId); if(!chap) return;

      if(push) Nav.push();
      const v=$('#view'); State.view='settings';
      setTopbar({title:`${chap.title} ‚Ä¢ Param√®tres`});
      setBottomVisibility({actions:false, revision:false});
      hideReviewActionsBar();

      v.innerHTML = `
        <div class="settings-page scroll-y" style="flex:1; min-height:0;">
          <div>
            <div class="settings-hero">Param√®tres</div>
            <div class="settings-sub">Personnalisez l‚Äôaffichage, les langues et vos objectifs</div>
          </div>

          <div class="settings-section">
            <div class="section-title">Apparence</div>
            <div class="mt6 muted" style="font-size:13px">‚Ä¢ Th√®me: <b id="themeLbl">${data.app.theme==='light'?'Clair':'Sombre'}</b></div>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn" id="toggleTheme">Basculer Clair/Sombre</button>
            </div>
            <div class="mt6 muted" style="font-size:13px">Couleur d‚Äôaccent</div>
            <div class="swatches" id="accentSwatches">
              <button class="swatch" data-accent="indigo" style="--sw:#6366f1" aria-label="Indigo"></button>
              <button class="swatch" data-accent="blue" style="--sw:#3b82f6" aria-label="Bleu"></button>
              <button class="swatch" data-accent="teal" style="--sw:#14b8a6" aria-label="Teal"></button>
              <button class="swatch" data-accent="emerald" style="--sw:#10b981" aria-label="√âmeraude"></button>
              <button class="swatch" data-accent="rose" style="--sw:#f43f5e" aria-label="Rose"></button>
              <button class="swatch" data-accent="amber" style="--sw:#f59e0b" aria-label="Ambre"></button>
              <button class="swatch" data-accent="violet" style="--sw:#8b5cf6" aria-label="Violet"></button>
            </div>
          </div>

          <div class="settings-section">
            <div class="section-title">Langues</div>
            <div class="mt6 muted" style="font-size:13px">Recto ‚Üí Verso: <b id="langOrderLbl">${chap.settings.langSwap?'EN ‚Üí FR':'FR ‚Üí EN'}</b></div>
            <button class="btn" id="toggleLangSwap">Basculer FR ‚Üî EN</button>
          </div>

          <div class="settings-section">
            <div class="section-title">Typographie</div>
            <div class="card" id="typoPreview" style="margin-bottom:8px; padding:10px; position:relative;">
              <div class="term">Exemple recto (Front)</div>
              <div class="definition" style="margin-top:6px">Exemple verso (Back)</div>
              <div class="muted" style="font-size:12px; margin-top:6px">Glissez ‚Üë‚Üì pour ajuster via les roues ou directement ici.</div>
              <div id="typoToast" class="size-toast"></div>
            </div>
            <div class="wheel" id="wheelFsTerm"><div class="name">Recto (Front)</div><div class="hint">Glissez ‚Üë‚Üì</div><div class="wheel-value"></div></div>
            <div class="wheel mt6" id="wheelFsDef"><div class="name">Verso (Back)</div><div class="hint">Glissez ‚Üë‚Üì</div><div class="wheel-value"></div></div>
          </div>

          <div class="settings-section">
            <div class="section-title">Session & Objectif</div>
            <div class="wheel" id="wheelSession"><div class="name">Taille session</div><div class="hint">Glissez ‚Üë‚Üì</div><div class="wheel-value"></div></div>
            <div class="wheel mt6" id="wheelGoal"><div class="name">Objectif quotidien</div><div class="hint">Glissez ‚Üë‚Üì</div><div class="wheel-value"></div></div>
          </div>

          <div class="settings-section">
            <div class="section-title">R√©initialiser</div>
            <div class="mt6 muted" style="font-size:13px">Remettre √† z√©ro la progression (grades, stats, temps).</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
              <button class="btn" id="resetChapterBtn">Reset chapitre</button>
              <button class="btn btn--solid btn--red" id="resetAllBtn">Reset application</button>
            </div>
          </div>
        </div>
      `;

      const P=data.app.prefs;

      const refreshTheme=()=>{$('#themeLbl').textContent=data.app.theme==='light'?'Clair':'Sombre';};
      const refreshLang=()=>{$('#langOrderLbl').textContent=chap.settings.langSwap?'EN ‚Üí FR':'FR ‚Üí EN';};

      $('#toggleLangSwap').onclick=()=>{chap.settings.langSwap=!chap.settings.langSwap; saveData(); refreshLang(); renderByState(false);};
      $('#toggleTheme').onclick=()=>{data.app.theme=data.app.theme==='light'?'dark':'light'; saveData(); applyTheme(); refreshTheme();};

      const activeAccent=data.app.prefs.accent||'indigo';
      $$('#accentSwatches .swatch').forEach(sw=>{
        const key=sw.getAttribute('data-accent');
        sw.classList.toggle('is-active', key===activeAccent);
        sw.onclick=()=>{data.app.prefs.accent=key; saveData(); applyUI(); $$('#accentSwatches .swatch').forEach(x=>x.classList.toggle('is-active', x.getAttribute('data-accent')===key));};
      });

      bindWheel($('#wheelFsTerm'),{get:()=>P.fsTerm, set:v=>{P.fsTerm=v}, min:12,max:60,step:1,unit:'px'});
      bindWheel($('#wheelFsDef'),{get:()=>P.fsDef, set:v=>{P.fsDef=v}, min:14,max:72,step:1,unit:'px'});
      bindWheel($('#wheelSession'),{get:()=>chap.settings.sessionSize,set:v=>{chap.settings.sessionSize=v}, min:5,max:200,step:5,unit:' cartes'});
      bindWheel($('#wheelGoal'),{get:()=>chap.settings.dailyGoal,set:v=>{chap.settings.dailyGoal=v}, min:5,max:500,step:5,unit:' cartes'});

      $('#resetChapterBtn').onclick=()=>{
        if(!confirm('R√©initialiser la progression de ce chapitre ?')) return;
        resetChapter(chap.id); saveData(); openSettings(chapterId,false);
      };
      $('#resetAllBtn').onclick=resetAll;

      bindTypoPreviewDrag();
    }

    /**
     * R√©conciliation
     */
    function reconcileChaptersWithCanonical(canonChapters, oldChapters){
      const savedCardByRowId = new Map();
      for (const ch of (oldChapters||[])) {
        for (const c of (ch.cards||[])) {
          const rid = extractRowId(c.id);
          if (rid != null && !savedCardByRowId.has(rid)) savedCardByRowId.set(rid, c);
        }
      }
      const PROG_KEYS = [
        'grade','timesReviewed','lastReviewed','lastMs','avgMs',
        'perfEma','ef','intervalDays','dueAt','streak','successes','failures'
      ];

      return canonChapters.map(cCh => {
        const sCh = (oldChapters||[]).find(x => x.title === cCh.title) || null;
        const merged = {
          id: cCh.id,
          title: cCh.title,
          description: cCh.description,
          settings: { ...cCh.settings, ...(sCh?.settings || {}) },
          filters: { grades: { ...cCh.filters.grades, ...(sCh?.filters?.grades || {}) } },
          stats: sCh?.stats ? { ...sCh.stats } : { ...cCh.stats },
          cards: []
        };
        const byRowId = new Map();
        if (sCh) {
          (sCh.cards||[]).forEach(sc => {
            const rid = extractRowId(sc.id);
            if (rid!=null) byRowId.set(rid, sc);
          });
        }
        merged.cards = cCh.cards.map(cc=>{
          const rid = extractRowId(cc.id);
          const sc = byRowId.get(rid) || savedCardByRowId.get(rid);
          if (sc){
            const copy = { ...cc };
            PROG_KEYS.forEach(k => { if (sc[k] !== undefined) copy[k] = sc[k]; });
            return copy;
          }
          return { ...cc };
        });
        merged.stats.gradeCounts = getLiveGradeCounts(merged);
        return merged;
      });
    }

    function reconcileAllSubjectsWithCanonical(){
      const canonSubjects = buildCanonicalSubjects();
      const oldSubjects = Array.isArray(data.subjects) ? data.subjects : [];

      const newSubjects = [];
      // Aligne les sujets existants avec les canoniques (par titre/id)
      canonSubjects.forEach(cSub=>{
        const sSub = oldSubjects.find(s => s.id===cSub.id || s.title===cSub.title);
        const merged = {
          id: cSub.id,
          title: cSub.title,
          chapters: reconcileChaptersWithCanonical(cSub.chapters, sSub?.chapters || [])
        };
        newSubjects.push(merged);
      });

      // Ajoute (rare) les sujets non-canoniques conserv√©s (si vous en ajoutez plus tard c√¥t√© code)
      oldSubjects.forEach(sSub=>{
        if(!newSubjects.find(ns=>ns.id===sSub.id)) newSubjects.push(sSub);
      });

      data.subjects = newSubjects;
      if (!data.app.currentSubjectId || !data.subjects.find(s=>s.id===data.app.currentSubjectId)) {
        data.app.currentSubjectId = data.subjects[0]?.id || null;
      }
      saveData();
    }

    // ---------- Contr√¥les taille texte ----------
    function bindReviewSizeControls(){
      const faces=document.querySelectorAll('.review-card [data-face]'); if(!faces.length) return;
      const P=data.app.prefs||{};
      const applyVars=()=>{
        document.documentElement.style.setProperty('--fs-term',(P.fsTerm||20)+'px');
        document.documentElement.style.setProperty('--fs-def',(P.fsDef||24)+'px');
      };
      faces.forEach(el=>{
        const face=el.getAttribute('data-face');
        let startY=null,startVal=null;
        const getVal=()=> face==='front' ? (P.fsTerm||20) : (P.fsDef||24);
        const setVal=v=>{
          if(face==='front') P.fsTerm=clamp(v,12,60);
          else P.fsDef=clamp(v,14,72);
          applyVars();
        };
        const commit=()=>saveData();

        el.addEventListener('pointerdown',e=>{startY=e.clientY; startVal=getVal(); el.setPointerCapture?.(e.pointerId); e.preventDefault(); e.stopPropagation();});
        el.addEventListener('pointermove',e=>{if(startY==null) return; const dy=startY-e.clientY; const delta=Math.round(dy/6); setVal(startVal+delta); e.preventDefault(); e.stopPropagation();});
        const end=e=>{if(startY!=null) commit(); startY=null; startVal=null; e.preventDefault(); e.stopPropagation();};
        el.addEventListener('pointerup',end); el.addEventListener('pointercancel',end);
        el.addEventListener('wheel',e=>{e.preventDefault(); const dir=e.deltaY>0?-1:1; setVal(getVal()+dir); commit();},{passive:false});
      });
    }

    function bindTypoPreviewDrag(){
      const box=$('#typoPreview'); if(!box) return;
      const termEl=box.querySelector('.term'); const defEl=box.querySelector('.definition'); const toast=$('#typoToast'); const P=data.app.prefs||{};
      let startY=null,startTerm=null,startDef=null,target='both';
      const showToast=msg=>{if(!toast) return; toast.textContent=msg; toast.style.display='block';};
      const hideToast=()=>{if(toast) toast.style.display='none';};
      const updateVars=()=>{
        document.documentElement.style.setProperty('--fs-term',(P.fsTerm||20)+'px');
        document.documentElement.style.setProperty('--fs-def',(P.fsDef||24)+'px');
      };
      const start=e=>{
        const t=e.target.closest('.term, .definition, #typoPreview'); if(!t) return;
        startY=(e.touches?e.touches[0].clientY:e.clientY); startTerm=P.fsTerm||20; startDef=P.fsDef||24;
        target = t.classList.contains('term')?'term' : t.classList.contains('definition')?'def':'both';
        e.preventDefault();
      };
      const move=e=>{
        if(startY==null) return;
        const y=(e.touches?e.touches[0].clientY:e.clientY);
        const dy=startY-y; const delta=Math.round(dy/6);
        if(target==='term'||target==='both') P.fsTerm=clamp(startTerm+delta,12,60);
        if(target==='def'||target==='both') P.fsDef=clamp(startDef+delta,14,72);
        updateVars(); showToast(`Recto ${P.fsTerm}px ‚Ä¢ Verso ${P.fsDef}px`);
      };
      const end=()=>{
        if(startY!=null) saveData();
        startY=null; startTerm=null; startDef=null; target='both'; setTimeout(hideToast,200);
      };
      box.addEventListener('pointerdown',start);
      box.addEventListener('pointermove',move);
      box.addEventListener('pointerup',end);
      box.addEventListener('pointercancel',end);
      box.addEventListener('touchstart',start,{passive:false});
      box.addEventListener('touchmove',move,{passive:false});
      box.addEventListener('touchend',end,{passive:false});

      const wheelOn=(el,which)=>{
        el.addEventListener('wheel',(e)=>{
          e.preventDefault();
          const dir=e.deltaY>0?-1:1;
          if(which==='term'||which==='both') P.fsTerm=clamp((P.fsTerm||20)+dir,12,60);
          if(which==='def'||which==='both') P.fsDef=clamp((P.fsDef||24)+dir,14,72);
          updateVars(); saveData(); showToast(`Recto ${P.fsTerm}px ‚Ä¢ Verso ${P.fsDef}px`); setTimeout(hideToast,250);
        },{passive:false});
      };
      wheelOn(termEl,'term'); wheelOn(defEl,'def'); wheelOn(box,'both');
    }

    function bindWheel(node,{get,set,min,max,step=1,unit='px',onApply}){
      const valueEl=node.querySelector('.wheel-value');
      const render=()=>{valueEl.textContent=get()+unit;};
      const commit=()=>{saveData(); applyUI(); if(onApply) onApply();};
      const setVal=v=>{set(clamp(v,min,max)); render(); applyUI();};
      const pd=e=>{e.preventDefault(); e.stopPropagation();};

      let startY=null,startV=null;
      node.addEventListener('pointerdown',e=>{startY=e.clientY; startV=get(); node.setPointerCapture?.(e.pointerId); pd(e);});
      node.addEventListener('pointermove',e=>{if(startY==null) return; const dy=startY-e.clientY; const delta=Math.round(dy/6)*step; setVal(startV+delta); pd(e);});
      const end=e=>{if(startY!=null) commit(); startY=null; startV=null; pd(e);};
      node.addEventListener('pointerup',end); node.addEventListener('pointercancel',end);
      node.addEventListener('wheel',e=>{e.preventDefault(); const dir=e.deltaY>0?-step:step; setVal(get()+dir); commit();},{passive:false});
      render();
    }

    function gradeQuality5(g){switch(g){case'facile':return 5; case'bien':return 4; case'difficile':return 2; case'echec':return 1; default:return 0;}}
    function gradeNorm01(g){switch(g){case'facile':return 1.0; case'bien':return 0.75; case'difficile':return 0.35; case'echec':return 0.0; default:return 0.5;}}

    function scheduleNext(card,grade,now=Date.now()){
      const q=gradeQuality5(grade);
      let EF=card.ef||2.5; EF = EF + (0.1 - (5-q)*(0.08+(5-q)*0.02)); if(EF<1.3) EF=1.3; card.ef=EF;
      if(q<3){
        card.intervalDays = (grade==='echec')?0.02:0.5;
        card.dueAt=now+card.intervalDays*864e5;
        card.streak=(card.streak<=0?card.streak-1:-1);
      }else{
        let next; if(card.intervalDays<1e-6) next=1; else if(card.intervalDays<1.5) next=6; else next=Math.round(card.intervalDays*EF);
        card.intervalDays=next; card.dueAt=now+next*864e5;
        card.streak=(card.streak>=0?card.streak+1:1);
      }
      card.streak=Math.max(-8,Math.min(12,card.streak));
    }

    // ---------- Reset helpers ----------
    function resetChapter(chapId){
      const chap=getChapter(chapId); if(!chap) return;
      chap.cards.forEach(c=>{
        c.grade='unseen'; c.timesReviewed=0; c.lastReviewed=0; c.lastMs=0; c.avgMs=0; c.perfEma=0.5;
        c.ef=2.5; c.intervalDays=0; c.dueAt=0; c.streak=0; c.successes=0; c.failures=0;
      });
      chap.stats.gradeCounts={unseen:chap.cards.length,echec:0,difficile:0,bien:0,facile:0};
      chap.stats.totalReviews=0;
      chap.stats.dailyReviews = {};
      chap.stats.dailyChanges = {};
      chap.stats.dailyDurMs = {};
      chap.stats.dailyDurCount = {};
      chap.stats.dailyLog = {};
      saveData(); alert('Chapitre r√©initialis√©.');
    }

    function resetAll(){
      if(!confirm('R√©initialiser toute l‚Äôapplication ?')) return;
      const theme=data.app?.theme||'dark';
      const prefs=deepClone(data.app?.prefs||{});
      const subjects = buildCanonicalSubjects();
      data = { subjects, app: { theme, prefs, currentSubjectId: subjects[0]?.id || null } };
      upgradeData();
      applyTheme();
      applyUI();
      saveData();
      goDeck(false);
      alert('Application r√©initialis√©e.');
    }

    // ---------- Init ----------
    function init(){
      if(navigator.storage && navigator.storage.persist){
        navigator.storage.persist().then(granted=>console.log('persist granted?',granted));
      }
      window.addEventListener('visibilitychange',()=>{if(document.visibilityState==='hidden') saveData();});
      window.addEventListener('pagehide',saveData);
      window.addEventListener('beforeunload',saveData);
      setInterval(saveData,15000);
      window.addEventListener('storage',(e)=>{
        if(e.key===STORAGE_KEY && e.newValue){
          try{data=JSON.parse(e.newValue); renderByState(false);}catch(err){}
        }
      });

      // IMPORTANT: r√©concilier d'abord avec le voc canonique (multi-mati√®res)
      reconcileAllSubjectsWithCanonical();

      // S'assure que les champs manquants sont compl√©t√©s apr√®s la fusion
      upgradeData();
      applyTheme();
      applyUI();
      Nav.clear();
      goDeck(false);
    }
    init();
  </script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</body>
</html>
